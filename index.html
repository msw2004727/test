<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>怪獸養成對戰 Demo - 前後端整合 (V19 - 十項優化)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* CSS 樣式與您 V18 版本相似，此處為了簡潔省略大部分，實際檔案中會包含完整樣式 */
        /* 主要新增/修改的樣式會在此處或行內呈現 */
        :root {
            /* Dark Theme (Default) */
            --bg-primary-dark: #0d1117;
            --bg-panel-dark: #161b22;
            --bg-slot-dark: #010409;
            --border-color-dark: #30363d;
            --text-primary-dark: #c9d1d9;
            --text-secondary-dark: #8b949e;
            --accent-color-dark: #58a6ff;
            --accent-hover-dark: #79c0ff;
            --success-color-dark: #3fb950;
            --danger-color-dark: #f85149;
            --danger-hover-dark: #da3633;
            --warning-color-dark: #d29922;
            --button-text-dark: #c9d1d9;
            --button-primary-bg-dark: var(--accent-color-dark);
            --button-primary-hover-bg-dark: var(--accent-hover-dark);
            --button-primary-text-dark: #ffffff;

            --button-secondary-bg-dark: #21262d;
            --button-secondary-hover-bg-dark: #30363d;
            --button-secondary-text-dark: var(--text-primary-dark);

            --button-danger-bg-dark: var(--danger-color-dark);
            --button-danger-hover-bg-dark: var(--danger-hover-dark);
            --button-danger-text-dark: #ffffff;

            --button-success-bg-dark: var(--success-color-dark);
            --button-success-hover-bg-dark: color-mix(in srgb, var(--success-color-dark) 85%, black);
            --button-success-text-dark: #ffffff;

            --button-warning-bg-dark: var(--warning-color-dark);
            --button-warning-hover-bg-dark: color-mix(in srgb, var(--warning-color-dark) 85%, black);
            --button-warning-text-dark: #ffffff;


            /* Element Colors (Text & Background) Dark Theme */
            --element-fire-text-dark: #f97583;       --element-fire-bg-dark: rgba(249, 117, 131, 0.15);
            --element-water-text-dark: #79c0ff;      --element-water-bg-dark: rgba(121, 192, 255, 0.15);
            --element-wood-text-dark: #56d364;       --element-wood-bg-dark: rgba(86, 211, 100, 0.15);
            --element-gold-text-dark: #e3b341;       --element-gold-bg-dark: rgba(227, 179, 65, 0.2);
            --element-earth-text-dark: #b08860;      --element-earth-bg-dark: rgba(176, 136, 96, 0.15);
            --element-light-text-dark: #f0f6fc;      --element-light-bg-dark: rgba(200, 200, 210, 0.2);
            --element-dark-text-dark: #848d97;       --element-dark-bg-dark: rgba(132, 141, 151, 0.15);
            --element-poison-text-dark: #d87ff8;     --element-poison-bg-dark: rgba(216, 127, 248, 0.15);
            --element-wind-text-dark: #6ef0db;       --element-wind-bg-dark: rgba(110, 240, 219, 0.15);
            --element-mix-text-dark: #a0a0c0;        --element-mix-bg-dark: rgba(160, 160, 192, 0.15);
            --element-無-text-dark: var(--text-secondary-dark); --element-無-bg-dark: rgba(139, 148, 158, 0.1);


            /* Rarity Colors (Text & Background) Dark Theme */
            --rarity-common-text-dark: var(--text-primary-dark);
            --rarity-rare-text-dark: var(--accent-color-dark);
            --rarity-elite-text-dark: #ff704d;
            --rarity-legendary-text-dark: var(--element-gold-text-dark);
            --rarity-mythical-text-dark: var(--element-poison-text-dark);


            /* Light Theme */
            --bg-primary-light: #ffffff;
            --bg-panel-light: #f6f8fa;
            --bg-slot-light: #eaeef2;
            --border-color-light: #d0d7de;
            --text-primary-light: #1f2328;
            --text-secondary-light: #57606a;
            --accent-color-light: #0969da;
            --accent-hover-light: #0550ae;
            --success-color-light: #1a7f37;
            --danger-color-light: #cf222e;
            --danger-hover-light: #a40e26;
            --warning-color-light: #9a6700;
            --button-text-light: #24292f;
            --button-primary-bg-light: var(--accent-color-light);
            --button-primary-hover-bg-light: var(--accent-hover-light);
            --button-primary-text-light: #ffffff;

            --button-secondary-bg-light: #f0f2f5;
            --button-secondary-hover-bg-light: #e1e4e8;
            --button-secondary-text-light: var(--text-primary-light);

            --button-danger-bg-light: var(--danger-color-light);
            --button-danger-hover-bg-light: var(--danger-hover-light);
            --button-danger-text-light: #ffffff;

            --button-success-bg-light: var(--success-color-light);
            --button-success-hover-bg-light: color-mix(in srgb, var(--success-color-light) 85%, black);
            --button-success-text-light: #ffffff;

            --button-warning-bg-light: var(--warning-color-light);
            --button-warning-hover-bg-light: color-mix(in srgb, var(--warning-color-light) 85%, black);
            --button-warning-text-light: #ffffff;


            /* Element Colors (Text & Background) Light Theme */
            --element-fire-text-light: #c0392b;       --element-fire-bg-light: rgba(192, 57, 43, 0.1);
            --element-water-text-light: #2980b9;      --element-water-bg-light: rgba(41, 128, 185, 0.1);
            --element-wood-text-light: #1e8449;       --element-wood-bg-light: rgba(30, 132, 73, 0.1);
            --element-gold-text-light: #b08800;       --element-gold-bg-light: rgba(176, 136, 0, 0.15);
            --element-earth-text-light: #a15c38;      --element-earth-bg-light: rgba(161, 92, 56, 0.1);
            --element-light-text-light: #525252;      --element-light-bg-light: rgba(230, 230, 230, 0.5);
            --element-dark-text-light: #32383e;       --element-dark-bg-light: rgba(50, 56, 62, 0.1);
            --element-poison-text-light: #732d91;     --element-poison-bg-light: rgba(115, 45, 145, 0.1);
            --element-wind-text-light: #16a085;       --element-wind-bg-light: rgba(22, 160, 133, 0.1);
            --element-mix-text-light: #57606a;        --element-mix-bg-light: rgba(87, 96, 106, 0.1);
            --element-無-text-light: var(--text-secondary-light); --element-無-bg-light: rgba(200, 200, 200, 0.1);


            /* Rarity Colors (Text & Background) Light Theme */
            --rarity-common-text-light: var(--text-primary-light);
            --rarity-rare-text-light: var(--accent-color-light);
            --rarity-elite-text-light: #d32f2f;
            --rarity-legendary-text-light: var(--element-gold-text-light);
            --rarity-mythical-text-light: var(--element-poison-text-light);


            /* Applied Theme Variables */
            --bg-primary: var(--bg-primary-dark);
            --bg-panel: var(--bg-panel-dark);
            --bg-slot: var(--bg-slot-dark);
            --border-color: var(--border-color-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --accent-color: var(--accent-color-dark);
            --accent-hover: var(--accent-hover-dark);
            --success-color: var(--success-color-dark);
            --danger-color: var(--danger-color-dark);
            --danger-hover: var(--danger-hover-dark);
            --warning-color: var(--warning-color-dark);

            --button-text: var(--button-text-dark);
            --button-primary-bg: var(--button-primary-bg-dark);
            --button-primary-hover-bg: var(--button-primary-hover-bg-dark);
            --button-primary-text: var(--button-primary-text-dark);

            --button-secondary-bg: var(--button-secondary-bg-dark);
            --button-secondary-hover-bg: var(--button-secondary-hover-bg-dark);
            --button-secondary-text: var(--button-secondary-text-dark);

            --button-danger-bg: var(--button-danger-bg-dark);
            --button-danger-hover-bg: var(--button-danger-hover-bg-dark);
            --button-danger-text: var(--button-danger-text-dark);

            --button-success-bg: var(--button-success-bg-dark);
            --button-success-hover-bg: var(--button-success-hover-bg-dark);
            --button-success-text: var(--button-success-text-dark);

            --button-warning-bg: var(--button-warning-bg-dark);
            --button-warning-hover-bg: var(--button-warning-hover-bg-dark);
            --button-warning-text: var(--button-warning-text-dark);

            /* Applied Element Colors */
            --element-fire-text: var(--element-fire-text-dark);       --element-fire-bg: var(--element-fire-bg-dark);
            --element-water-text: var(--element-water-text-dark);      --element-water-bg: var(--element-water-bg-dark);
            --element-wood-text: var(--element-wood-text-dark);       --element-wood-bg: var(--element-wood-bg-dark);
            --element-gold-text: var(--element-gold-text-dark);       --element-gold-bg: var(--element-gold-bg-dark);
            --element-earth-text: var(--element-earth-text-dark);      --element-earth-bg: var(--element-earth-bg-dark);
            --element-light-text: var(--element-light-text-dark);      --element-light-bg: var(--element-light-bg-dark);
            --element-dark-text: var(--element-dark-text-dark);       --element-dark-bg: var(--element-dark-bg-dark);
            --element-poison-text: var(--element-poison-text-dark);     --element-poison-bg: var(--element-poison-bg-dark);
            --element-wind-text: var(--element-wind-text-dark);       --element-wind-bg: var(--element-wind-bg-dark);
            --element-mix-text: var(--element-mix-text-dark);        --element-mix-bg: var(--element-mix-bg-dark);
            --element-無-text: var(--element-無-text-dark); --element-無-bg: var(--element-無-bg-dark);


            /* Applied Rarity Colors */
            --rarity-common-text: var(--rarity-common-text-dark);
            --rarity-rare-text: var(--rarity-rare-text-dark);
            --rarity-elite-text: var(--rarity-elite-text-dark);
            --rarity-legendary-text: var(--rarity-legendary-text-dark);
            --rarity-mythical-text: var(--rarity-mythical-text-dark);
        }

        body.light-theme {
            --bg-primary: var(--bg-primary-light);
            --bg-panel: var(--bg-panel-light);
            --bg-slot: var(--bg-slot-light);
            --border-color: var(--border-color-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --accent-color: var(--accent-color-light);
            --accent-hover: var(--accent-hover-light);
            --success-color: var(--success-color-light);
            --danger-color: var(--danger-color-light);
            --danger-hover: var(--danger-hover-light);
            --warning-color: var(--warning-color-light);

            --button-text: var(--button-text-light);
            --button-primary-bg: var(--button-primary-bg-light);
            --button-primary-hover-bg: var(--button-primary-hover-bg-light);
            --button-primary-text: var(--button-primary-text-light);

            --button-secondary-bg: var(--button-secondary-bg-light);
            --button-secondary-hover-bg: var(--button-secondary-hover-bg-light);
            --button-secondary-text: var(--button-secondary-text-light);

            --button-danger-bg: var(--button-danger-bg-light);
            --button-danger-hover-bg: var(--button-danger-hover-bg-light);
            --button-danger-text: var(--button-danger-text-light);

            --button-success-bg: var(--button-success-bg-light);
            --button-success-hover-bg: var(--button-success-hover-bg-light);
            --button-success-text: var(--button-success-text-light);

            --button-warning-bg: var(--button-warning-bg-light);
            --button-warning-hover-bg: var(--button-warning-hover-bg-light);
            --button-warning-text: var(--button-warning-text-light);

            /* Applied Element Colors - Light Theme */
            --element-fire-text: var(--element-fire-text-light);       --element-fire-bg: var(--element-fire-bg-light);
            --element-water-text: var(--element-water-text-light);      --element-water-bg: var(--element-water-bg-light);
            --element-wood-text: var(--element-wood-text-light);       --element-wood-bg: var(--element-wood-bg-light);
            --element-gold-text: var(--element-gold-text-light);       --element-gold-bg: var(--element-gold-bg-light);
            --element-earth-text: var(--element-earth-text-light);      --element-earth-bg: var(--element-earth-bg-light);
            --element-light-text: var(--element-light-text-light);      --element-light-bg: var(--element-light-bg-light);
            --element-dark-text: var(--element-dark-text-light);       --element-dark-bg: var(--element-dark-bg-light);
            --element-poison-text: var(--element-poison-text-light);     --element-poison-bg: var(--element-poison-bg-light);
            --element-wind-text: var(--element-wind-text-light);       --element-wind-bg: var(--element-wind-bg-light);
            --element-mix-text: var(--element-mix-text-light);        --element-mix-bg: var(--element-mix-bg-light);
            --element-無-text: var(--element-無-text-light); --element-無-bg: var(--element-無-bg-light);


            /* Applied Rarity Colors - Light Theme */
            --rarity-common-text: var(--rarity-common-text-light);
            --rarity-rare-text: var(--rarity-rare-text-light);
            --rarity-elite-text: var(--rarity-elite-text-light);
            --rarity-legendary-text: var(--rarity-legendary-text-light);
            --rarity-mythical-text: var(--rarity-mythical-text-light);
        }

        /* Helper classes for element text colors */
        .text-element-fire { color: var(--element-fire-text); }
        .text-element-water { color: var(--element-water-text); }
        .text-element-wood { color: var(--element-wood-text); }
        .text-element-gold { color: var(--element-gold-text); }
        .text-element-earth { color: var(--element-earth-text); }
        .text-element-light { color: var(--element-light-text); }
        .text-element-dark { color: var(--element-dark-text); }
        .text-element-poison { color: var(--element-poison-text); }
        .text-element-wind { color: var(--element-wind-text); }
        .text-element-mix { color: var(--element-mix-text); }
        .text-element-無 { color: var(--element-無-text); }


        /* Helper classes for rarity text colors */
        .text-rarity-common { color: var(--rarity-common-text); }
        .text-rarity-rare { color: var(--rarity-rare-text); }
        .text-rarity-elite { color: var(--rarity-elite-text); }
        .text-rarity-legendary { color: var(--rarity-legendary-text); }
        .text-rarity-mythical { color: var(--rarity-mythical-text); }


        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
            font-size: 1rem; /* Default base font size */
        }
        .main-container { /* This will be hidden initially by #game-container */
            width: 100%;
            max-width: 700px;
            background-color: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 1px solid var(--border-color);
            position: relative;
            transition: background-color 0.3s, border-color 0.3s;
        }
        @media (min-width: 768px) {
            .main-container { padding: 20px; gap: 20px; }
        }

        #theme-switcher {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-shadow: none;
        }
        #theme-switcher:hover {
            color: var(--accent-color);
            border-color: var(--accent-color);
        }


        .panel {
            background-color: var(--bg-slot);
            border-radius: 8px;
            padding: 15px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .panel-title-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 5px;
        }
        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 0; border-bottom: none; padding-bottom: 0;
        }
        .panel-title-hint { font-size: 0.875rem; color: var(--text-secondary); }
        @media (min-width: 768px) { .panel-title { font-size: 1.3rem; } }

        .dna-item, .dna-slot, .inventory-slot-empty, .temp-backpack-slot, .inventory-delete-slot, .dna-draw-button {
            border: 1px solid var(--border-color);
            border-radius: 5px; padding: 6px; text-align: center; font-size: 0.875rem;
            transition: background-color 0.2s, box-shadow 0.2s, border-color 0.2s, color 0.2s;
            position: relative; min-height: 48px; display: flex;
            align-items: center; justify-content: center;
            flex-direction: column; /* Allow text to wrap if needed */
            box-sizing: border-box;
        }
        .dna-item { cursor: grab; }
        .dna-slot, .temp-backpack-slot { cursor: pointer; }
        .inventory-slot-empty, .temp-backpack-slot.empty { color: var(--text-secondary); border-style: dashed; cursor: default; background-color: var(--bg-panel); }

        .inventory-delete-slot {
            background-color: rgba(248, 81, 73, 0.5);
            color: var(--text-primary-dark);
            border-style: dashed;
            border-color: var(--danger-hover-dark);
            cursor: pointer;
        }
        body.light-theme .inventory-delete-slot {
            background-color: rgba(207, 34, 46, 0.5);
            color: var(--text-primary-light);
            border-color: var(--danger-hover-light);
        }
        .inventory-delete-slot.drag-over {
            background-color: rgba(218, 54, 51, 0.7) !important;
            border-color: white !important;
        }
        body.light-theme .inventory-delete-slot.drag-over {
            background-color: rgba(164, 14, 38, 0.7) !important;
        }

        .dna-draw-button {
            background-color: var(--button-success-bg);
            color: var(--button-success-text);
            font-weight: 500;
            cursor: pointer;
        }
        .dna-draw-button:hover {
            background-color: var(--button-success-hover-bg);
        }


        @media (min-width: 768px) { .dna-item, .dna-slot, .inventory-slot-empty, .temp-backpack-slot, .inventory-delete-slot, .dna-draw-button { padding: 8px; font-size: 0.9rem; min-height: 55px;} }

        .dna-item:hover, .dna-slot:hover:not(.occupied), .temp-backpack-slot:hover:not(.occupied):not(.empty) {
            border-color: var(--accent-color);
            box-shadow: 0 0 6px color-mix(in srgb, var(--accent-color) 30%, transparent);
        }
        .temp-backpack-slot.empty:hover {
             background-color: var(--accent-hover); border-color: var(--accent-color);
        }
        .dna-slot.occupied, .temp-backpack-slot.occupied { border-style: solid; }
        .inventory-slot-empty.drag-over, .temp-backpack-slot.empty.drag-over { border-color: var(--accent-color); background-color: var(--accent-hover); }

        .monster-snapshot-panel { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .monster-snapshot-area {
            width: 100%; height: 220px; background-color: var(--bg-primary);
            border-radius: 8px; display: grid;
            grid-template-columns: 1fr auto; grid-template-rows: auto auto 1fr auto;
            position: relative; overflow: hidden; border: 1px solid var(--border-color);
            padding: 8px; box-sizing: border-box;
            transition: background-color 0.3s, border-color 0.3s;
        }
         @media (min-width: 768px) { .monster-snapshot-area { height: 260px; padding: 12px; } }

        .monster-snapshot-img-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 0; }
        .monster-snapshot-img-bg img { max-width: 75%; max-height: 75%; object-fit: contain; opacity: 0.7; }
        body.light-theme .monster-snapshot-img-bg img { opacity: 0.9; }


        .snapshot-achievement-title {
            grid-column: 1 / -1; grid-row: 1 / 2; text-align: center;
            font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);
            z-index: 1; margin-bottom: 2px; text-shadow: 1px 1px 1px color-mix(in srgb, var(--bg-primary) 50%, transparent);
            background-color: color-mix(in srgb, var(--bg-panel) 50%, transparent);
            padding: 2px 6px; border-radius: 4px; display: inline-block; margin: 0 auto;
        }
        .snapshot-nickname {
            grid-column: 1 / -1; grid-row: 2 / 3; text-align: center;
            font-size: 1.3rem; font-weight: bold; color: var(--accent-color);
            z-index: 1; margin-bottom: 5px; text-shadow: 1px 1px 2px color-mix(in srgb, var(--bg-primary) 70%, transparent);
            padding: 3px 8px; background-color: color-mix(in srgb, var(--bg-slot) 60%, transparent); border-radius: 5px;
            border: 1px solid var(--border-color); display: inline-block; margin: 0 auto;
        }
        .snapshot-win-loss {
            position: absolute; top: 8px; right: 8px;
            font-size: 0.875rem; color: var(--text-secondary); z-index: 2;
            text-align: right; padding: 3px 5px; background-color: color-mix(in srgb, var(--bg-panel) 70%, transparent); border-radius: 4px;
        }
         .snapshot-win-loss span { display: block; }

        .snapshot-main-content { grid-column: 1 / -1; grid-row: 3 / 4; display: flex; align-items: center; justify-content: center; position: relative; z-index: 1; }
        .snapshot-evaluation {
            position: absolute;
            bottom: 8px;
            right: 8px;
            font-size: 1.1rem; font-weight: bold; color: var(--success-color);
            z-index: 1;
            text-shadow: 1px 1px 2px color-mix(in srgb, var(--bg-primary) 70%, transparent);
            padding: 4px 10px; background-color: color-mix(in srgb, var(--bg-slot) 70%, transparent); border-radius: 5px;
            border: 1px solid var(--border-color);
        }
         @media (min-width: 768px) { .snapshot-evaluation { font-size: 1.2rem; bottom: 12px; right: 12px; } }

        /* General Button Styling */
        button {
            padding: 10px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        @media (min-width: 768px) { button { padding: 12px 16px; font-size: 0.95rem; } }
        button:active { transform: translateY(1px); }
        button:disabled {
            background-color: color-mix(in srgb, var(--button-secondary-bg, #888888) 50%, var(--bg-primary, #111111)) !important;
            color: var(--text-secondary) !important;
            cursor: not-allowed !important;
            box-shadow: none !important;
            border: 1px solid color-mix(in srgb, var(--border-color, #555555) 50%, var(--bg-primary, #111111)) !important;
        }
        button:disabled:hover { background-color: color-mix(in srgb, var(--button-secondary-bg, #888888) 50%, var(--bg-primary, #111111)) !important;  }


        /* Primary Action Buttons (Accent Color) */
        button.primary, #theme-switcher /* Theme switcher uses accent */ {
            background-color: var(--button-primary-bg);
            color: var(--button-primary-text);
        }
        button.primary:hover, #theme-switcher:hover {
            background-color: var(--button-primary-hover-bg);
        }

        /* Secondary Buttons */
        button.secondary, .top-nav-button, .farm-time-btn {
            background-color: var(--button-secondary-bg);
            color: var(--button-secondary-text);
            border: 1px solid var(--border-color);
        }
        button.secondary:hover, .top-nav-button:hover, .farm-time-btn:hover {
            background-color: var(--button-secondary-hover-bg);
        }

        /* Danger Buttons */
        button.danger, .farm-monster-item button.farm-monster-release-btn, #confirm-action-btn.danger {
            background-color: var(--button-danger-bg);
            color: var(--button-danger-text);
        }
        button.danger:hover, .farm-monster-item button.farm-monster-release-btn:hover, #confirm-action-btn.danger:hover {
            background-color: var(--button-danger-hover-bg);
        }

        /* Success Buttons */
        button.success, #combine-button, .farm-monster-item button.farm-complete-btn {
            background-color: var(--button-success-bg);
            color: var(--button-success-text);
        }
        button.success:hover, #combine-button:hover, .farm-monster-item button.farm-complete-btn:hover {
            background-color: var(--button-success-hover-bg);
        }

        /* Warning Buttons */
        button.warning, .farm-monster-item button.farm-monster-cultivate-btn {
            background-color: var(--button-warning-bg);
            color: var(--button-warning-text);
        }
        button.warning:hover, .farm-monster-item button.farm-monster-cultivate-btn:hover {
            background-color: var(--button-warning-hover-bg);
        }

        /* Farm Battle Button Specific */
        .farm-monster-item button.farm-battle-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            font-size: 1.2rem;
            line-height: 1;
            border: none;
            box-shadow: none;
        }


        .top-nav-button {
            width: auto;
            padding: 0.5rem 0.5rem;
            min-width: 0;
            font-size: 0.75rem;
            height: 38px;
            display: flex; align-items: center; justify-content: center;
            flex-grow: 1;
            text-align: center;
            line-height: 1.2;
            background-color: var(--accent-color); /* Uniform color */
            color: var(--button-primary-text); /* Text color for accent */
            border: 1px solid var(--accent-hover-dark);
        }
        .top-nav-button:hover {
            background-color: var(--accent-hover-dark);
        }
        .top-nav-button:disabled {
             background-color: color-mix(in srgb, var(--accent-color) 50%, var(--bg-primary)) !important;
        }

         .top-buttons-container {
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 0.2rem;
            margin-top: 0.5rem;
        }


        #combine-button {
            width: auto; min-width:110px; max-width: 160px; margin: 0 auto; display: block;
            font-weight: bold;
        }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.75); align-items: center; justify-content: center; padding: 10px;}
        .modal-content { background-color: var(--bg-panel); color: var(--text-primary); margin: auto; padding: 20px; border-radius: 8px; width: 100%; max-width: 500px; box-shadow: 0 8px 25px rgba(0,0,0,0.5); position: relative; border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s, color 0.3s;}
        .modal-content.large { max-width: 650px; }
        .modal-content.xlarge { max-width: 800px; }
        .modal-content.feedback-wide { max-width: 600px; }
        @media (max-width: 640px) {
            .modal-content.feedback-wide { max-width: 95%; }
        }

        .modal-close { color: var(--text-secondary); position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer;}
        .modal-close:hover, .modal-close:focus { color: var(--text-primary); text-decoration: none; }
        .modal-header { font-size: 1.3rem; font-weight: 600; margin-bottom: 15px; color: var(--accent-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; text-align: center;}
        .modal-body { font-size: 0.95rem; line-height: 1.6; max-height: 70vh; overflow-y: auto; }
        .modal-footer { margin-top: 20px; display:flex; justify-content: center; gap: 15px; }
        .modal-footer button { padding: 12px 25px; font-size: 1rem;}
        .loading-spinner { border:4px solid var(--border-color); border-top:4px solid var(--accent-color); border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:20px auto; }


        .dna-combination-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 8px; }
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); /* 自動填充，最小85px */
            gap: 8px;
            align-items: stretch; /* 讓格子等高 */
        }
        .temp-backpack-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            gap: 8px;
        }


        .dna-panel-title {
            font-size: 1.2rem; font-weight: 600; color: var(--accent-color);
            margin-bottom: 0; border-bottom: none; padding-bottom: 0;
        }
        body.light-theme .dna-panel-title { color: #0550ae; }
        .dna-panel-hint { font-size: 0.875rem; color: var(--text-secondary); }
        body.light-theme .dna-panel-hint { color: #424a53; }


        .details-section { background-color: var(--bg-primary); padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s;}
        .details-section-title { font-size: 1.05rem; font-weight: 500; color: var(--accent-color); margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dashed var(--border-color); }
        .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px 14px; }
        .details-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; padding: 5px 0; }
        .details-label { font-weight: 500; color: var(--text-secondary); margin-right: 10px; white-space: nowrap; }
        .details-value { color: var(--text-primary); font-weight: bold; text-align: right; font-size: 1rem; }
        .details-value.boosted { color: var(--success-color); font-weight: bold; }
        .details-value.debuffed { color: var(--danger-color); }
        .creation-time-centered { text-align: center; font-size: 0.875rem; color: var(--text-secondary); margin-top: 10px; }
        .element-composition-item { font-size: 0.875rem; }
        .skill-entry { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .skill-entry:last-child { border-bottom: none; margin-bottom: 0; }
        .skill-name { font-weight: bold; color: var(--accent-hover); font-size: 0.95rem; }
        .skill-details { font-size: 0.875rem; color: var(--text-secondary); margin-left: 10px; }
        .monster-info-header { text-align: center; margin-bottom: 15px; }
        .monster-info-name-styled {
            font-size: 1.6rem; font-weight: bold; color: var(--accent-color);
            padding: 6px 18px; background-color: var(--bg-slot); border-radius: 8px;
            display: inline-block; border: 1px solid var(--border-color);
        }
        .monster-description-area { font-size: 0.9rem; margin-top: 10px; padding: 10px; background-color: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color); line-height: 1.6; }
        .personality-text { font-style: italic; line-height: 1.6; font-size: 0.9rem;}
        .ai-generated-text { margin-top: 5px; font-size: 0.9rem; line-height: 1.5; }


        .action-buttons-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px; }

        .scrolling-hints-container { height: 22px; overflow: hidden; position: relative; background-color: var(--bg-primary); border-radius: 4px; padding: 0 10px; margin-top: 10px; border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s;}
        .scrolling-hint-text { position: absolute; width: 100%; text-align: center; line-height: 22px; font-size: 0.875rem; color: var(--text-secondary); animation: scrollHint 15s linear infinite; opacity: 0; }
        .scrolling-hint-text:nth-child(1) { animation-delay: 0s; } .scrolling-hint-text:nth-child(2) { animation-delay: 5s; } .scrolling-hint-text:nth-child(3) { animation-delay: 10s; }
        @keyframes scrollHint { 0% { opacity: 0; transform: translateY(100%); } 10%, 23% { opacity: 1; transform: translateY(0); } 33% { opacity: 0; transform: translateY(-100%); } 100% { opacity: 0; transform: translateY(-100%); } }

        .tab-buttons { display: flex; flex-wrap: wrap; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .tab-button { padding: 10px 15px; cursor: pointer; background-color: transparent; border: none; color: var(--text-secondary); font-size: 0.9rem; border-bottom: 3px solid transparent; margin-bottom: -1px; transition: color 0.2s, border-bottom-color 0.2s; white-space: nowrap; }
        .tab-button.active { color: var(--accent-color); border-bottom-color: var(--accent-color); font-weight: 500; }
        .tab-content { display: none; } .tab-content.active { display: block; }

        .leaderboard-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .leaderboard-table th, .leaderboard-table td { padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .leaderboard-table th { color: var(--accent-color); font-weight: 500; cursor: pointer; }
        .leaderboard-table th:hover { color: var(--accent-hover); }
        .leaderboard-table td { color: var(--text-primary); }
        .leaderboard-table .leaderboard-element-cell span { font-weight: bold; }
        .leaderboard-table tr:last-child td { border-bottom: none; }
        .leaderboard-table tr:hover td { background-color: var(--bg-slot); } body.light-theme .leaderboard-table tr:hover td { background-color: #f8f9fa; }
        .leaderboard-table .challenge-btn-cell { width: 80px; text-align: center;}


        .titles-medals-section { margin-top: 15px; }
        .titles-list, .achievements-list, .owned-monsters-list { list-style: none; padding-left: 0; }
        .titles-list li, .achievements-list li, .owned-monsters-list li { background-color: var(--bg-primary); padding: 6px 10px; border-radius: 4px; margin-bottom: 6px; font-size: 0.9rem; border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s;}
        .owned-monsters-list li { display: flex; justify-content: space-between; align-items: center; }
        .owned-monsters-list .monster-name { font-weight: bold; }
        .owned-monsters-list .monster-score { color: var(--success-color); }
        .medals-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .medal-emoji { font-size: 1.3rem; }

        /* Monster Farm Styles - Point 1: Mobile Layout Redesign */
        .farm-header-grid, .farm-monster-item {
            display: grid;
            gap: 0.5rem; /* Reduced gap for mobile */
            padding: 0.5rem;
            font-size: 0.8rem; /* Smaller font for mobile */
            align-items: center;
        }

        /* Desktop and larger screens: Original grid */
        @media (min-width: 640px) {
            .farm-header-grid {
                grid-template-columns: minmax(50px, auto) minmax(80px, 1.5fr) minmax(100px, 1.8fr) minmax(50px, 0.7fr) minmax(60px, auto) minmax(60px, auto);
                font-size: 0.875rem;
                padding: 8px 8px 4px 8px;
                border-bottom: 2px solid var(--accent-color);
                font-weight: 600;
                color: var(--text-secondary);
            }
            .farm-monster-item {
                grid-template-columns: minmax(50px, auto) minmax(80px, 1.5fr) minmax(100px, 1.8fr) minmax(50px, 0.7fr) minmax(60px, auto) minmax(60px, auto);
                font-size: 0.9rem;
                padding: 10px 8px;
                border-bottom: 1px solid var(--border-color);
            }
            .farm-monster-item:last-child { border-bottom: none; }
        }

        /* Mobile screens: Stacked or more compact grid */
        @media (max-width: 639px) {
            .farm-header-grid {
                grid-template-columns: 40px 1fr 1fr 50px; /*出戰, 怪獸, 狀態, 養成/放生區 */
                font-size: 0.75rem; /* Even smaller font for headers on mobile */
            }
            .farm-header-grid > div:nth-child(4), /* 總評價 Header */
            .farm-header-grid > div:nth-child(5)  /* 原資訊 Header (已移除) */
             {
                display: none; /* Hide score header on mobile */
            }
             .farm-header-grid > div:nth-child(6) { /* 原放生 Header */
                display: none; /* Hide original release header, actions will be combined */
            }


            .farm-monster-item {
                grid-template-columns: 40px 1fr 1fr 70px; /* 出戰, 怪獸名, 狀態, 動作按鈕組 */
                grid-template-areas:
                    "battle name status actions"
                    ". score score actions"; /* Score below name/status */
                row-gap: 0.25rem;
                font-size: 0.8rem;
            }
            .farm-monster-item .farm-battle-btn { grid-area: battle; }
            .farm-monster-item .farm-monster-name { grid-area: name; font-weight: bold; color: var(--accent-hover); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
            .farm-monster-item .farm-monster-status { grid-area: status; font-style: italic; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
            .farm-monster-item .farm-monster-score { grid-area: score; font-size: 0.75rem; color: var(--success-color); padding-left: 5px;}
            .farm-monster-actions-group {
                grid-area: actions;
                display: flex;
                flex-direction: column; /* Stack buttons vertically */
                gap: 0.25rem; /* Small gap between buttons */
                align-items: stretch; /* Make buttons take full width of their cell */
            }
            .farm-monster-item button {
                padding: 4px 6px; /* Smaller padding for mobile buttons */
                font-size: 0.75rem; /* Smaller font for mobile buttons */
                min-width: auto; /* Allow buttons to be smaller */
                width: 100%; /* Make buttons fill their container in the column */
            }
             .farm-monster-item .farm-monster-info-btn { /* This button is being removed per point 4 */
                display: none;
            }
        }


        .farm-monster-item .farm-monster-status.active { color: var(--warning-color); font-weight: bold; }
        .farm-monster-item .farm-monster-status.battling { color: var(--danger-color); font-weight: bold; }

        .farm-monster-item .farm-monster-cultivate-btn { background-color: var(--button-warning-bg); color: var(--button-warning-text); }
        .farm-monster-item .farm-monster-cultivate-btn:hover { background-color: var(--button-warning-hover-bg); }


        #release-monster-image-placeholder {
            width: 100px; height: 75px; background-color: var(--bg-slot);
            border: 1px dashed var(--border-color); border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.875rem; color: var(--text-secondary); margin: 10px auto;
        }
        #release-monster-image-placeholder img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .log-entry {
            padding: 7px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .log-entry:last-child { border-bottom: none; }
        .log-entry .log-time { font-weight: bold; color: var(--text-primary); margin-right: 8px; }
        .log-entry .log-message {}

        .feedback-skill-entry { margin-bottom: 6px; }
        .feedback-skill-name { font-weight: bold; color: var(--accent-hover); font-size: 0.9rem;}
        .feedback-skill-description { font-size: 0.875rem; color: var(--text-secondary); margin-left: 10px;}

        /* Cultivation Modal Styles */
        #cultivation-setup-modal .modal-body, #training-results-modal .modal-body {
            text-align: left;
        }
        #cultivation-setup-modal button, #training-results-modal button {
            margin-top: 10px;
        }
        #start-cultivation-btn { /* Increased height for "開始修煉" button */
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .cultivation-hint {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        .training-result-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--border-color);
        }
        .training-result-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .training-result-section h5 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 8px;
        }
        .training-result-section p, .training-result-section div {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        .temp-backpack-item-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }
        #add-all-to-temp-backpack-btn {
            padding: 8px 10px;
            height: auto;
            font-size: 0.9rem;
        }
        #newbie-guide-search-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        #newbie-guide-search-results p {
            padding: 5px;
            border-bottom: 1px solid var(--border-color-dark);
        }
         #newbie-guide-search-results p:last-child {
            border-bottom: none;
        }

        /* Friends List Modal */
        #friends-list-search-input {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        #friends-list-container {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px;
        }
        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .friend-item:last-child {
            border-bottom: none;
        }
        .friend-item .friend-name {
            font-weight: 500;
        }
        .friend-item .friend-status {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        .friend-item .friend-status.online {
            color: var(--success-color);
        }
        .friend-item .friend-status.offline {
            color: var(--text-secondary);
        }

        /* Auth Screen Styles */
        #auth-screen {
            display: flex; /* Initially show auth screen */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100vh; /* Full viewport height */
            background-color: var(--bg-primary);
        }
        .auth-container {
            background-color: var(--bg-panel);
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            text-align: center;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border-color);
        }
        .auth-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 25px;
        }
        .auth-input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        .auth-button {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        /* 新增：註冊按鈕高亮樣式 */
        #show-register-form-btn.highlighted-register {
            background-color: var(--button-success-bg) !important;
            color: var(--button-success-text) !important;
            border: 2px solid var(--button-success-hover-bg) !important;
            box-shadow: 0 0 12px color-mix(in srgb, var(--button-success-bg) 60%, transparent) !important;
            font-weight: bold !important;
        }
        #show-register-form-btn.highlighted-register:hover {
            background-color: var(--button-success-hover-bg) !important;
        }

        .auth-error-message {
            color: var(--danger-color);
            font-size: 0.875rem;
            margin-top: -10px;
            margin-bottom: 15px;
            min-height: 1.2em; /* Reserve space to prevent layout shift */
        }
        #game-container {
            display: none; /* Initially hide game content */
            width: 100%;
            /* flex-direction: column; align-items: center; */ /* This was causing issues with main-container width */
        }
        /* Battle Log Modal Specific Styles */
        #battle-log-modal .modal-content { max-width: 700px; }
        #battle-log-area {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap; /* Allows line breaks and preserves spaces */
            color: var(--text-primary);
        }
        #battle-log-area p { margin-bottom: 5px; }
        #battle-log-area .turn-divider {
            border-top: 1px dashed var(--accent-color);
            margin-top: 10px;
            margin-bottom: 10px;
            padding-top: 5px;
            font-weight: bold;
            color: var(--accent-color);
        }
        #battle-log-area .battle-start, #battle-log-area .battle-end {
            font-weight: bold;
            color: var(--success-color);
            text-align: center;
            padding: 5px 0;
            border-top: 1px solid var(--success-color);
            border-bottom: 1px solid var(--success-color);
            margin: 10px 0;
        }
         #battle-log-area .battle-end.winner { color: var(--success-color); }
         #battle-log-area .battle-end.loser { color: var(--danger-color); }
         #battle-log-area .battle-end.draw { color: var(--warning-color); }

        #battle-log-area .crit-hit { color: var(--danger-color); font-weight: bold; }
        #battle-log-area .heal-action { color: var(--success-color); }
        #battle-log-area .defeated { color: var(--danger-color); font-weight: bold; text-transform: uppercase; }

        /* DNA Draw Modal Styles */
        #dna-draw-modal .modal-content { max-width: 600px; }
        #dna-draw-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            max-height: 300px; /* Limit height for scrolling */
            overflow-y: auto; /* Enable scrolling for many items */
        }
        .dna-draw-result-item {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 8px;
            text-align: center;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 70px;
        }
        .dna-draw-result-item .dna-name { font-weight: bold; margin-bottom: 4px; }
        .dna-draw-result-item .dna-type { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;}
        .dna-draw-result-item .dna-rarity { font-size: 0.8rem; }
        .dna-draw-result-item button {
            margin-top: 8px;
            padding: 5px 8px;
            font-size: 0.8rem;
        }

    </style>
</head>
<body>
    <div id="auth-screen">
        <div class="auth-container">
            <h1 class="auth-title">怪獸異世界</h1>
            <button id="show-login-form-btn" class="auth-button primary">使用暱稱/密碼登入</button>
            <button id="show-register-form-btn" class="auth-button secondary highlighted-register">重新開始遊戲 (創建帳號)</button>
        </div>
    </div>

    <div id="register-modal" class="modal">
        <div class="modal-content" style="max-width: 420px;">
            <span class="modal-close" onclick="closeModal('register-modal');">&times;</span> <h3 class="modal-header">創建您的訓獸師帳號</h3>
            <div class="modal-body">
                <input type="text" id="register-nickname" class="auth-input" placeholder="請輸入您的暱稱" required>
                <input type="password" id="register-password" class="auth-input" placeholder="請設定您的密碼" required>
                <div id="register-error" class="auth-error-message"></div>
                <button id="register-submit-btn" class="auth-button success">創建並進入異世界</button>
            </div>
        </div>
    </div>

    <div id="login-modal" class="modal">
        <div class="modal-content" style="max-width: 420px;">
            <span class="modal-close" onclick="closeModal('login-modal');">&times;</span> <h3 class="modal-header">訓獸師登入</h3>
            <div class="modal-body">
                <input type="text" id="login-nickname" class="auth-input" placeholder="您的暱稱" required>
                <input type="password" id="login-password" class="auth-input" placeholder="您的密碼" required>
                <div id="login-error" class="auth-error-message"></div>
                <button id="login-submit-btn" class="auth-button primary">登入異世界</button>
            </div>
        </div>
    </div>

    <div id="official-announcement-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="modal-close" onclick="closeModal('official-announcement-modal');">&times;</span>
            <h3 class="modal-header">📢 遊戲官方公告</h3>
            <div class="modal-body">
                <div id="announcement-ad-banner" style="background-color: var(--bg-slot); border: 1px solid var(--border-color); color: var(--text-primary); text-align: center; padding: 20px; border-radius: 6px; margin-bottom: 15px;">
                    -- 這裡是廣告欄位 (可放置圖片或文字) --
                </div>
                <div id="announcement-content">
                    <p>親愛的<span id="announcement-player-name" class="font-bold text-[var(--accent-color)]">玩家</span>您好，</p>
                    <p>感謝您參與怪獸異世界的冒險！遊戲目前仍在開發與測試階段，我們將持續努力帶來更多精彩內容與優化！</p>
                    <p>若有任何建議或遇到問題，歡迎隨時透過遊戲內回饋系統與我們聯繫。</p>
                    <p style="text-align: right; margin-top: 20px;">怪獸異世界營運團隊 敬上</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="primary" onclick="closeModal('official-announcement-modal');">我知道了</button>
            </div>
        </div>
    </div>


    <div id="game-container" style="display: none; width:100%; display:flex; flex-direction:column; align-items:center;">
        <div class="main-container">
            <button id="theme-switcher" title="切換主題">
                <span id="theme-icon">🌙</span>
            </button>
            <button id="logout-btn" class="absolute top-10 right-10 mt-10 text-xs secondary p-1">登出</button>

            <div class="monster-snapshot-panel panel">
                <div id="monster-snapshot-area" class="monster-snapshot-area">
                    <div class="monster-snapshot-img-bg">
                        <img id="monster-image" src="https://placehold.co/200x150/161b22/8b949e?text=怪獸&font=noto-sans-tc" alt="怪獸圖片">
                    </div>
                    <div id="snapshot-achievement-title" class="snapshot-achievement-title">初出茅廬</div>
                    <div id="snapshot-nickname" class="snapshot-nickname">-</div>
                    <div id="snapshot-win-loss" class="snapshot-win-loss">
                        <span>勝: 0</span>
                        <span>敗: 0</span>
                    </div>
                    <div id="snapshot-main-content" class="snapshot-main-content">
                        </div>
                    <div id="snapshot-evaluation" class="snapshot-evaluation">總評價: 0</div>
                </div>
                <div class="top-buttons-container">
                    <button id="monster-info-button" class="top-nav-button" disabled>當前怪獸</button> <button id="player-info-button" class="top-nav-button">玩家資訊</button>
                    <button id="show-monster-leaderboard-btn" class="top-nav-button">怪獸排行</button>
                    <button id="show-player-leaderboard-btn" class="top-nav-button">玩家排行</button>
                    <button id="friends-list-btn" class="top-nav-button">好友名單</button>
                    <button id="newbie-guide-btn" class="top-nav-button">新手上路</button>
                </div>
            </div>

            <div class="panel">
                <div class="tab-buttons" id="dna-farm-tabs">
                    <button class="tab-button active" onclick="openDnaFarmTab(event, 'dna-inventory-content')">🧬 DNA管理</button>
                    <button class="tab-button" onclick="openDnaFarmTab(event, 'monster-farm-content')">🏡 怪物農場</button>
                    <button class="tab-button" onclick="openDnaFarmTab(event, 'exchange-content')">⚖️ 交易所</button>
                    <button class="tab-button" onclick="openDnaFarmTab(event, 'homestead-content')">🛠️ 家園建設</button>
                    <button class="tab-button" onclick="openDnaFarmTab(event, 'guild-content')">🛡️ 工會系統</button>
                </div>

                <div id="dna-inventory-content" class="tab-content active">
                    <div id="dna-combination-panel-wrapper" class="panel mb-4">
                        <h2 class="panel-title dna-panel-title">🧬 DNA組合</h2>
                        <div id="dna-combination-slots" class="dna-combination-grid mt-2">
                            </div>
                        <div class="action-buttons-grid mt-3">
                            <button id="combine-button" class="success" disabled>怪物合成</button>
                        </div>
                    </div>

                    <div class="panel-title-container" style="border-bottom: none; margin-bottom: 5px;">
                         <h2 class="panel-title dna-panel-title">🔬 DNA碎片</h2>
                         <span class="panel-title-hint dna-panel-hint">※DNA碎片可自由拖曳，拖曳至刪除區可刪除</span>
                    </div>
                    <div id="inventory-items" class="inventory-grid mt-2">
                        </div>


                    <div class="mt-4">
                        <h3 class="panel-title dna-panel-title text-sm mb-2">🎒 臨時背包 (拾取物)</h3>
                        <div id="temporary-backpack-items" class="temp-backpack-grid">
                            </div>
                    </div>
                </div>

                <div id="monster-farm-content" class="tab-content">
                    <div class="panel-title-container" style="border-bottom: none; margin-bottom: 5px;">
                         <h2 class="panel-title dna-panel-title">🏡 怪物農場</h2>
                         <span class="panel-title-hint dna-panel-hint">※最多收納10隻怪獸</span>
                    </div>
                    <div id="farm-headers" class="farm-header-grid mt-2">
                        <div>出戰</div>
                        <div>怪物</div>
                        <div>狀態</div>
                        <div class="hidden sm:block">總評價</div> <div>養成</div>
                        <div>放生</div>
                    </div>
                    <div id="farmed-monsters-list">
                        <p class="text-center text-sm text-[var(--text-secondary)] py-4">農場空空如也，快去組合怪獸吧！</p>
                    </div>
                </div>

                <div id="exchange-content" class="tab-content">
                    <p class="text-center text-lg text-[var(--text-secondary)] py-10">⚖️ 交易所功能尚未開放，敬請期待！</p>
                </div>
                <div id="homestead-content" class="tab-content">
                    <p class="text-center text-lg text-[var(--text-secondary)] py-10">🛠️ 家園建設功能尚未開放，敬請期待！</p>
                </div>
                <div id="guild-content" class="tab-content">
                    <p class="text-center text-lg text-[var(--text-secondary)] py-10">🛡️ 工會系統功能尚未開放，敬請期待！</p>
                </div>


                <div class="scrolling-hints-container">
                    <div class="scrolling-hint-text">💡 金木水火土屬性相生相剋！</div>
                    <div class="scrolling-hint-text">💡 相同DNA組合產生的怪物是相同的！</div>
                    <div class="scrolling-hint-text">💡 招式是怪物依據特性隨機配置！</div>
                </div>
            </div>
        </div>
    </div>

    <div id="monster-leaderboard-modal" class="modal">
        <div class="modal-content large">
            <span class="modal-close" onclick="closeModal('monster-leaderboard-modal')">&times;</span>
            <h3 class="modal-header">怪獸排行榜</h3>
            <div id="monster-leaderboard-tabs-container"> <div id="monster-leaderboard-element-tabs" class="tab-buttons">
                    </div>
            </div>
            <div id="monster-leaderboard-table-container" class="modal-body">
                <table id="monster-leaderboard-table" class="leaderboard-table"></table>
            </div>
        </div>
    </div>

    <div id="player-leaderboard-modal" class="modal">
        <div class="modal-content large">
            <span class="modal-close" onclick="closeModal('player-leaderboard-modal')">&times;</span>
            <h3 class="modal-header">玩家英雄榜</h3>
            <div id="player-leaderboard-table-container" class="modal-body">
                <table id="player-leaderboard-table" class="leaderboard-table"></table>
            </div>
        </div>
    </div>

    <div id="monster-info-modal" class="modal">
        <div class="modal-content large">
            <span class="modal-close" onclick="closeModal('monster-info-modal')">&times;</span>
            <div id="monster-info-modal-header-content" class="monster-info-header">
                </div>
            <div class="tab-buttons" id="monster-info-tabs">
                <button class="tab-button active" onclick="openGenericTab(event, 'monster-details-tab', 'monster-info-modal')">📜 詳細資訊</button>
                <button class="tab-button" onclick="openGenericTab(event, 'monster-logs-tab', 'monster-info-modal')">🐾 活動紀錄</button>
            </div>
            <div id="monster-details-tab" class="tab-content active modal-body">
                </div>
            <div id="monster-logs-tab" class="tab-content modal-body">
                <div id="monster-activity-logs" class="max-h-[300px] overflow-y-auto">
                    <p class="text-center text-sm text-[var(--text-secondary)] py-4">尚無活動紀錄。</p>
                </div>
            </div>
        </div>
    </div>

    <div id="player-info-modal" class="modal">
        <div class="modal-content large"> <span class="modal-close" onclick="closeModal('player-info-modal')">&times;</span>
            <h3 class="modal-header">👤 玩家資訊</h3>
            <div id="player-info-modal-body" class="modal-body">
                </div>
        </div>
    </div>

    <div id="feedback-modal" class="modal">
        <div class="modal-content feedback-wide"> <span id="feedback-modal-close-x" class="modal-close" onclick="closeModal('feedback-modal')">&times;</span>
            <h3 id="feedback-modal-title" class="modal-header text-center">處理中...</h3>
            <div id="feedback-modal-body-content" class="modal-body text-left">
                 <div id="feedback-modal-spinner" class="loading-spinner" style="display: none;"></div>
                 <div id="feedback-modal-message"></div>
                 <div id="feedback-monster-details" style="display:none;" class="mt-3">
                    </div>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirmation-modal-title" class="modal-header text-center">⚠️ 提示</h3> <div id="confirmation-modal-body" class="modal-body">
                <div id="release-monster-image-placeholder" style="display:none;">
                    <img id="release-monster-img-preview" src="" alt="預覽">
                </div>
                </div>
            <div class="modal-footer"> <button id="confirm-action-btn" class="danger">✔️ 確定</button>
                <button id="cancel-action-btn" class="secondary" onclick="closeModal('confirmation-modal')">❌ 取消</button>
            </div>
        </div>
    </div>

    <div id="cultivation-setup-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="modal-close" onclick="closeModal('cultivation-setup-modal')">&times;</span>
            <h3 id="cultivation-setup-modal-title" class="modal-header">🌱 怪獸養成</h3>
            <div class="modal-body">
                <p class="mb-2">正在為 <strong id="cultivation-monster-name" class="text-[var(--accent-color)]"></strong> 進行養成計畫。</p>
                <button id="start-cultivation-btn" class="w-full primary">💪 開始修煉</button>
                <p class="cultivation-hint text-base mt-2">提示：修煉期間，怪獸將無法放生或出戰。</p>
                <p class="cultivation-hint text-sm mt-1">修煉時長上限為 <span id="max-cultivation-time">999</span> 秒。</p>
            </div>
        </div>
    </div>

    <div id="training-results-modal" class="modal">
        <div class="modal-content large">
            <span class="modal-close" onclick="closeTrainingResultsModal()">&times;</span>
            <h3 id="training-results-modal-title" class="modal-header">🎉 修煉成果 🎉</h3>
            <div class="modal-body">
                <div class="training-result-section">
                    <h5>📜 冒險故事</h5>
                    <p id="training-story-result"></p>
                </div>
                <div class="training-result-section">
                    <h5>📈 成長紀錄</h5>
                    <div id="training-growth-result"></div>
                </div>
                <div class="training-result-section">
                    <h5>💎 拾獲物品</h5>
                    <div id="training-items-result" class="mb-2"></div>
                    <button id="add-all-to-temp-backpack-btn" class="w-full secondary mt-2">一鍵全數加入背包</button>
                </div>
            </div>
             <div class="modal-footer" style="justify-content: flex-end;">
                <button class="secondary" onclick="closeTrainingResultsModal()">關閉</button>
            </div>
        </div>
    </div>

    <div id="newbie-guide-modal" class="modal">
        <div class="modal-content large">
            <span class="modal-close" onclick="closeModal('newbie-guide-modal')">&times;</span>
            <h3 class="modal-header">📖 新手上路指南</h3>
            <div class="modal-body">
                <input type="text" id="newbie-guide-search-input" placeholder="搜尋指南內容..." class="mb-4">
                <div id="newbie-guide-content-area" class="max-h-[50vh] overflow-y-auto">
                    </div>
            </div>
        </div>
    </div>

    <div id="reminder-modal" class="modal">
        <div class="modal-content" style="max-width: 380px;">
            <h3 id="reminder-modal-title" class="modal-header text-center">溫馨提醒</h3>
            <div id="reminder-modal-body" class="modal-body text-center">
                <p>您有尚未加入背包的修煉拾獲物品，確定要關閉嗎？關閉後未加入的物品將會消失。</p>
            </div>
            <div class="modal-footer">
                <button id="reminder-confirm-close-btn" class="danger">仍要關閉</button>
                <button id="reminder-cancel-btn" class="secondary" onclick="closeModal('reminder-modal')">返回查看</button>
            </div>
        </div>
    </div>

    <div id="friends-list-modal" class="modal">
        <div class="modal-content large">
            <span class="modal-close" onclick="closeModal('friends-list-modal')">&times;</span>
            <h3 class="modal-header">🧑‍🤝‍🧑 好友名單</h3>
            <div class="modal-body">
                <input type="text" id="friends-list-search-input" placeholder="搜尋玩家暱稱..." class="mb-3">
                <div id="friends-list-container">
                    <p class="text-center text-sm text-[var(--text-secondary)]">輸入暱稱搜尋其他玩家。</p>
                </div>
            </div>
        </div>
    </div>

    <div id="battle-log-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('battle-log-modal')">&times;</span>
            <h3 class="modal-header">⚔️ 戰鬥記錄 ⚔️</h3>
            <div id="battle-log-area" class="modal-body">
                </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('battle-log-modal')">關閉</button>
            </div>
        </div>
    </div>

    <div id="dna-draw-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('dna-draw-modal')">&times;</span>
            <h3 class="modal-header">🧬 DNA 抽取結果</h3>
            <div class="modal-body">
                <div id="dna-draw-results-grid">
                    </div>
                <p class="text-sm text-[var(--text-secondary)] mt-3 text-center">點擊物品可將其加入臨時背包。</p>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('dna-draw-modal')">關閉</button>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCACjjC1S-9gj6hKCyfAedzH9kTf_JZwDE", // 請替換成您自己的金鑰
            authDomain: "aigame-fb578.firebaseapp.com",
            projectId: "aigame-fb578",
            storageBucket: "aigame-fb578.appspot.com",
            messagingSenderId: "932095431807",
            appId: "1:932095431807:web:28aab493c770166102db4a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- API Base URL ---
        const API_BASE_URL = 'https://d1d5ef45-d04b-4a1c-be4b-64a0680c6847-00-xxpggv06ka2e.sisko.replit.dev/api/MD';

        // --- DOM Elements ---
        const authScreen = document.getElementById('auth-screen');
        const gameContainer = document.getElementById('game-container');
        const showLoginFormBtn = document.getElementById('show-login-form-btn');
        const showRegisterFormBtn = document.getElementById('show-register-form-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const registerModal = document.getElementById('register-modal');
        const registerNicknameInput = document.getElementById('register-nickname');
        const registerPasswordInput = document.getElementById('register-password');
        const registerSubmitBtn = document.getElementById('register-submit-btn');
        const registerErrorDiv = document.getElementById('register-error');
        const loginModal = document.getElementById('login-modal');
        const loginNicknameInput = document.getElementById('login-nickname');
        const loginPasswordInput = document.getElementById('login-password');
        const loginSubmitBtn = document.getElementById('login-submit-btn');
        const loginErrorDiv = document.getElementById('login-error');

        const officialAnnouncementModal = document.getElementById('official-announcement-modal');
        const announcementPlayerName = document.getElementById('announcement-player-name');

        const monsterImageElement = document.getElementById('monster-image');
        const snapshotAchievementTitle = document.getElementById('snapshot-achievement-title');
        const snapshotNickname = document.getElementById('snapshot-nickname');
        const snapshotWinLoss = document.getElementById('snapshot-win-loss');
        const snapshotEvaluation = document.getElementById('snapshot-evaluation');
        const dnaCombinationPanelWrapper = document.getElementById('dna-combination-panel-wrapper');
        const dnaCombinationSlotsContainer = document.getElementById('dna-combination-slots');
        const combineButton = document.getElementById('combine-button');
        const monsterInfoButton = document.getElementById('monster-info-button');
        const playerInfoButton = document.getElementById('player-info-button');
        const inventoryItemsContainer = document.getElementById('inventory-items');
        const temporaryBackpackItemsContainer = document.getElementById('temporary-backpack-items');
        const showMonsterLeaderboardBtn = document.getElementById('show-monster-leaderboard-btn');
        const showPlayerLeaderboardBtn = document.getElementById('show-player-leaderboard-btn');
        const newbieGuideBtn = document.getElementById('newbie-guide-btn');
        const friendsListBtn = document.getElementById('friends-list-btn');
        const themeSwitcherBtn = document.getElementById('theme-switcher');
        const themeIcon = document.getElementById('theme-icon');
        const monsterLeaderboardModal = document.getElementById('monster-leaderboard-modal');
        const playerLeaderboardModal = document.getElementById('player-leaderboard-modal');
        const monsterLeaderboardTable = document.getElementById('monster-leaderboard-table');
        const playerLeaderboardTable = document.getElementById('player-leaderboard-table');
        const monsterLeaderboardElementTabs = document.getElementById('monster-leaderboard-element-tabs');
        const monsterLeaderboardTabsContainer = document.getElementById('monster-leaderboard-tabs-container');
        const monsterInfoModalHeaderContent = document.getElementById('monster-info-modal-header-content');
        const monsterDetailsTab = document.getElementById('monster-details-tab');
        const monsterActivityLogsContainer = document.getElementById('monster-activity-logs');
        const playerInfoModalBody = document.getElementById('player-info-modal-body');
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackModalTitle = document.getElementById('feedback-modal-title');
        const feedbackModalBodyContent = document.getElementById('feedback-modal-body-content');
        const feedbackModalMessage = document.getElementById('feedback-modal-message');
        const feedbackModalSpinner = document.getElementById('feedback-modal-spinner');
        const feedbackModalCloseX = document.getElementById('feedback-modal-close-x');
        const feedbackMonsterDetailsDiv = document.getElementById('feedback-monster-details');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationModalBodyEl = document.getElementById('confirmation-modal-body');
        const confirmationModalTitleEl = document.getElementById('confirmation-modal-title');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const releaseMonsterImagePlaceholder = document.getElementById('release-monster-image-placeholder');
        const releaseMonsterImgPreview = document.getElementById('release-monster-img-preview');
        const dnaFarmTabsContainer = document.getElementById('dna-farm-tabs');
        const dnaInventoryContent = document.getElementById('dna-inventory-content');
        const monsterFarmContent = document.getElementById('monster-farm-content');
        const farmedMonstersListContainer = document.getElementById('farmed-monsters-list');
        const cultivationSetupModal = document.getElementById('cultivation-setup-modal');
        const cultivationMonsterName = document.getElementById('cultivation-monster-name');
        const startCultivationBtn = document.getElementById('start-cultivation-btn');
        const maxCultivationTimeSpan = document.getElementById('max-cultivation-time'); // For point 9
        const trainingResultsModal = document.getElementById('training-results-modal');
        const trainingResultsModalTitle = document.getElementById('training-results-modal-title');
        const trainingStoryResult = document.getElementById('training-story-result');
        const trainingGrowthResult = document.getElementById('training-growth-result');
        const trainingItemsResult = document.getElementById('training-items-result');
        const addAllToTempBackpackBtn = document.getElementById('add-all-to-temp-backpack-btn');
        const newbieGuideModal = document.getElementById('newbie-guide-modal');
        const newbieGuideSearchInput = document.getElementById('newbie-guide-search-input');
        const newbieGuideContentArea = document.getElementById('newbie-guide-content-area');
        const friendsListModal = document.getElementById('friends-list-modal');
        const friendsListSearchInput = document.getElementById('friends-list-search-input');
        const friendsListContainer = document.getElementById('friends-list-container');
        const reminderModal = document.getElementById('reminder-modal');
        const reminderConfirmCloseBtn = document.getElementById('reminder-confirm-close-btn');
        const battleLogModal = document.getElementById('battle-log-modal');
        const battleLogArea = document.getElementById('battle-log-area');
        const dnaDrawModal = document.getElementById('dna-draw-modal');
        const dnaDrawResultsGrid = document.getElementById('dna-draw-results-grid');


        // --- Game State & Data ---
        let currentLoggedInUser = null;
        let currentPlayerNickname = "";
        let currentMonster = null; // 當前主要顯示/操作的怪獸 (通常是出戰怪獸)
        let playerOwnedDNA = [];
        let farmedMonsters = []; // 玩家農場中的怪獸列表
        let playerStats = { rank: 0, wins: 0, losses: 0, score: 0, titles: [], achievements: [], medals: 0, nickname: "" };
        let gameSettings = {
            dnaFragments: [],
            rarities: {},
            skills: {},
            personalities: [],
            titles: [],
            healthConditions: [],
            newbieGuide: []
        };
        const MAX_FARM_SLOTS = 10;
        const MAX_CULTIVATION_SECONDS = 999; // Point 9: Cultivation time limit
        let battlingMonsterId = null; // 當前出戰怪獸的 ID
        let currentCultivationMonster = null; // 當前正在設定養成的怪獸
        let itemsFromCurrentTraining = []; // 當前修煉拾獲的物品
        const NUM_INVENTORY_SLOTS = 10;
        const NUM_TEMP_BACKPACK_SLOTS = 18;
        const NUM_COMBINATION_SLOTS = 5;
        let inventoryDisplaySlots = new Array(NUM_INVENTORY_SLOTS).fill(null);
        let temporaryBackpackSlots = new Array(NUM_TEMP_BACKPACK_SLOTS).fill(null);
        let combinationSlotsData = new Array(NUM_COMBINATION_SLOTS).fill(null);
        let itemToDeleteInfo = null;
        let monsterToReleaseInfo = null;
        let monsterToChallengeInfo = null;
        let monsterLeaderboardData = []; // 包含真實玩家怪獸和 NPC 怪獸
        let playerLeaderboardData = [];
        let npcMonsters = []; // Point 5: For NPC monsters

        // --- Helper Functions ---
        function getContrastColor(hexColor) {
            const currentThemeIsLight = document.body.classList.contains('light-theme');
            if (!hexColor) {
                return currentThemeIsLight ? 'var(--text-primary-light)' : 'var(--text-primary-dark)';
            }
            let R, G, B;
            hexColor = hexColor.replace("#", "");
            if (hexColor.length === 3) {
                R = parseInt(hexColor.substring(0, 1) + hexColor.substring(0, 1), 16);
                G = parseInt(hexColor.substring(1, 2) + hexColor.substring(1, 2), 16);
                B = parseInt(hexColor.substring(2, 3) + hexColor.substring(2, 3), 16);
            } else if (hexColor.length === 6) {
                R = parseInt(hexColor.substring(0, 2), 16);
                G = parseInt(hexColor.substring(2, 4), 16);
                B = parseInt(hexColor.substring(4, 6), 16);
            } else {
                return currentThemeIsLight ? 'var(--text-primary-light)' : 'var(--text-primary-dark)';
            }
            const yiq = (R * 299 + G * 587 + B * 114) / 1000;
            return yiq >= 128 ? (currentThemeIsLight ? '#000000' : '#FFFFFF' ): (currentThemeIsLight ? '#FFFFFF' : '#000000');
        }

        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                if (themeIcon) themeIcon.textContent = '☀️';
            } else {
                document.body.classList.remove('light-theme');
                if (themeIcon) themeIcon.textContent = '🌙';
            }
            localStorage.setItem('theme', theme);
            if (typeof updateMonsterSnapshotDisplay === 'function') updateMonsterSnapshotDisplay(currentMonster);
            if (typeof populateInventory === 'function') populateInventory();
            if (typeof populateTemporaryBackpack === 'function') populateTemporaryBackpack();
        }

        function populateInventory() {
            if (!inventoryItemsContainer) {
                console.error("populateInventory: inventoryItemsContainer 元素未找到!");
                return;
            }
            inventoryItemsContainer.innerHTML = ''; // 清空

            for (let i = 0; i < NUM_INVENTORY_SLOTS; i++) {
                const item = inventoryDisplaySlots[i];
                const slotDiv = createDnaElement(item, i, 'inventory');
                inventoryItemsContainer.appendChild(slotDiv);
            }

            const drawDnaBtnElement = document.createElement('div');
            drawDnaBtnElement.id = 'draw-dna-button-grid-item';
            drawDnaBtnElement.className = 'dna-draw-button';
            drawDnaBtnElement.innerHTML = '🧬<br>抽DNA';
            drawDnaBtnElement.addEventListener('click', handleDrawDnaButtonClick);
            inventoryItemsContainer.appendChild(drawDnaBtnElement);

            const deleteSlotDiv = document.createElement('div');
            deleteSlotDiv.className = 'inventory-delete-slot';
            deleteSlotDiv.innerHTML = '🗑️<br>刪除區';
            deleteSlotDiv.dataset.droptype = "delete";
            deleteSlotDiv.addEventListener('dragover', handleDragOver);
            deleteSlotDiv.addEventListener('dragleave', handleDragLeave);
            deleteSlotDiv.addEventListener('drop', handleDropOnDeleteSlot);
            inventoryItemsContainer.appendChild(deleteSlotDiv);
        }

        // Point 10: DNA Draw Rarity & Count
        function handleDrawDnaButtonClick() {
            console.log("抽DNA按鈕被點擊 (V19)");
            const drawnDnaForModal = [];
            if (gameSettings.dnaFragments && gameSettings.dnaFragments.length > 0) {
                // Filter for "普通" (Common) and "稀有" (Rare) DNA
                const drawableDna = gameSettings.dnaFragments.filter(
                    f => f.rarity === "普通" || f.rarity === "稀有"
                );

                if (drawableDna.length > 0) {
                    for (let i = 0; i < 6; i++) { // Draw 6 DNA fragments
                        const randomDnaTemplate = drawableDna[Math.floor(Math.random() * drawableDna.length)];
                        const newDnaInstance = JSON.parse(JSON.stringify(randomDnaTemplate));
                        newDnaInstance.tempId = `drawn_${Date.now()}_${i}`;
                        drawnDnaForModal.push(newDnaInstance);
                    }
                } else {
                     console.warn("沒有可抽取的普通或稀有等級DNA。");
                }
            }

            if (dnaDrawResultsGrid) {
                dnaDrawResultsGrid.innerHTML = '';
                if (drawnDnaForModal.length > 0) {
                    drawnDnaForModal.forEach(dna => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'dna-draw-result-item';
                        const rarityStyle = getRarityStyling(dna.rarity);
                        const elementStyle = getElementStyling(dna.type);
                        itemDiv.innerHTML = `
                            <div class="dna-name" style="color: ${rarityStyle.text};">${dna.name}</div>
                            <div class="dna-type" style="color: ${elementStyle.text}; background-color: ${elementStyle.bg}; padding: 1px 3px; border-radius: 3px; font-size: 0.75rem;">${dna.type}</div>
                            <div class="dna-rarity" style="color: ${rarityStyle.text}; font-size: 0.75rem;">${dna.rarity}</div>
                            <button class="add-drawn-to-temp-backpack-btn secondary text-xs p-1 mt-1" data-dna='${JSON.stringify(dna)}'>加入背包</button>
                        `;
                        dnaDrawResultsGrid.appendChild(itemDiv);
                    });

                    document.querySelectorAll('.add-drawn-to-temp-backpack-btn').forEach(btn => {
                        btn.onclick = (e) => {
                            const dnaToAdd = JSON.parse(e.target.dataset.dna);
                            addToTemporaryBackpack(dnaToAdd);
                            e.target.textContent = '已加入';
                            e.target.disabled = true;
                            if (currentLoggedInUser) savePlayerData();
                        };
                    });
                } else {
                    dnaDrawResultsGrid.innerHTML = '<p class="text-center text-sm text-[var(--text-secondary)]">未能抽到任何DNA，請稍後再試或檢查遊戲設定。</p>';
                }
            }
            openModal('dna-draw-modal');
        }


        function populateTemporaryBackpack() {
            if (!temporaryBackpackItemsContainer) {
                console.error("populateTemporaryBackpack: temporaryBackpackItemsContainer is null!");
                return;
            }
            temporaryBackpackItemsContainer.innerHTML = '';
            for (let i = 0; i < NUM_TEMP_BACKPACK_SLOTS; i++) {
                const item = temporaryBackpackSlots[i];
                const slotDiv = createDnaElement(item, i, 'temporary');
                temporaryBackpackItemsContainer.appendChild(slotDiv);
            }
        }

        function initializeInventoryDisplay() {
            if (playerOwnedDNA && playerOwnedDNA.length > 0) {
                 playerOwnedDNA.slice(0, NUM_INVENTORY_SLOTS).forEach((dna, index) => {
                    inventoryDisplaySlots[index] = dna ? {...dna, baseId: dna.baseId || dna.id.split('_')[0] + '_' + dna.id.split('_')[1] + '_' + dna.id.split('_')[2]} : null;
                });
            } else if (currentLoggedInUser && gameSettings.dnaFragments && gameSettings.dnaFragments.length > 0) {
                console.log("新玩家，給予初始DNA。");
                playerOwnedDNA = [];
                const initialDnaCount = 6;
                const availableDnaForNewPlayer = gameSettings.dnaFragments.filter(
                    f => f.rarity === "普通" || f.rarity === "稀有"
                );

                if (availableDnaForNewPlayer.length > 0) {
                    for(let i=0; i < initialDnaCount; i++) {
                        const randomDnaTemplate = availableDnaForNewPlayer[Math.floor(Math.random() * availableDnaForNewPlayer.length)];
                        const newDnaInstance = JSON.parse(JSON.stringify(randomDnaTemplate));
                        newDnaInstance.baseId = newDnaInstance.id;
                        newDnaInstance.id = `${newDnaInstance.baseId}_initial_${Date.now()}_${i}`;
                        if (i < NUM_INVENTORY_SLOTS) {
                            inventoryDisplaySlots[i] = newDnaInstance;
                        }
                        playerOwnedDNA.push(newDnaInstance);
                    }
                    if (currentLoggedInUser) {
                        savePlayerData();
                    }
                } else {
                    console.warn("無法給予初始DNA，因為設定中沒有普通或稀有等級的DNA。");
                }
            }
            populateInventory();
            populateTemporaryBackpack();
        }


        function createCombinationSlots() {
            if (!dnaCombinationSlotsContainer) return;
            dnaCombinationSlotsContainer.innerHTML = '';
            for (let i = 0; i < NUM_COMBINATION_SLOTS; i++) {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'dna-slot';
                slotDiv.dataset.slotId = i;
                slotDiv.dataset.droptype = "combination";
                slotDiv.textContent = `組合槽 ${i + 1}`;
                slotDiv.addEventListener('dragover', handleDragOver);
                slotDiv.addEventListener('dragleave', handleDragLeave);
                slotDiv.addEventListener('drop', handleDrop);
                slotDiv.addEventListener('click', handleComboSlotClick);
                dnaCombinationSlotsContainer.appendChild(slotDiv);
            }
        }

        function openGenericTab(evt, tabName, modalOrTabContainerId) {
            let i, tabcontent, tablinks;
            const containerElement = document.getElementById(modalOrTabContainerId);
            if (!containerElement) return;
            tabcontent = containerElement.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tablinks = containerElement.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            const currentTabContent = containerElement.querySelector(`#${tabName}`);
            if(currentTabContent) {
                currentTabContent.style.display = "block";
                currentTabContent.classList.add("active");
            }
            if(evt && evt.currentTarget) {
                evt.currentTarget.classList.add("active");
            }
        }

        function openDnaFarmTab(evt, tabName) {
            const panel = document.getElementById('dna-farm-tabs')?.closest('.panel');
            if (!panel) return;
            const tabContents = panel.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].style.display = "none";
                tabContents[i].classList.remove("active");
            }
            const tabButtons = panel.getElementsByClassName("tab-button");
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }
            const currentTabContent = panel.querySelector(`#${tabName}`);
            if (currentTabContent) {
                currentTabContent.style.display = "block";
                currentTabContent.classList.add("active");
            }
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add("active");
            }
        }

        function getElementStyling(elementType) {
            if (!elementType) elementType = '無';
            const typeKey = elementType.toLowerCase();
            const defaultStyle = { text: 'var(--element-mix-text)', bg: 'var(--element-mix-bg)' };
            switch(typeKey) {
                case '火': return { text: 'var(--element-fire-text)', bg: 'var(--element-fire-bg)' };
                case '水': return { text: 'var(--element-water-text)', bg: 'var(--element-water-bg)' };
                case '木': return { text: 'var(--element-wood-text)', bg: 'var(--element-wood-bg)' };
                case '金': return { text: 'var(--element-gold-text)', bg: 'var(--element-gold-bg)' };
                case '土': return { text: 'var(--element-earth-text)', bg: 'var(--element-earth-bg)' };
                case '光': return { text: 'var(--element-light-text)', bg: 'var(--element-light-bg)' };
                case '暗': return { text: 'var(--element-dark-text)', bg: 'var(--element-dark-bg)' };
                case '毒': return { text: 'var(--element-poison-text)', bg: 'var(--element-poison-bg)' };
                case '風': return { text: 'var(--element-wind-text)', bg: 'var(--element-wind-bg)' };
                case '無': return { text: 'var(--element-無-text)', bg: 'var(--element-無-bg)' };
                default: return defaultStyle;
            }
        }

        function getRarityData(rarityName) {
            if (!gameSettings.rarities || Object.keys(gameSettings.rarities).length === 0) {
                console.warn("getRarityData: gameSettings.rarities is not loaded yet. Using fallback.");
                const fallbackRarities = {
                    COMMON: { name: "普通", textVarKey: "--rarity-common-text", statMultiplier: 1.0, skillLevelBonus: 0, resistanceBonus: 1 },
                    RARE: { name: "稀有", textVarKey: "--rarity-rare-text", statMultiplier: 1.15, skillLevelBonus: 1, resistanceBonus: 2},
                    ELITE: { name: "精英", textVarKey: "--rarity-elite-text", statMultiplier: 1.3, skillLevelBonus: 2, resistanceBonus: 3},
                };
                const key = Object.keys(fallbackRarities).find(k => fallbackRarities[k].name === rarityName);
                return key ? fallbackRarities[key] : fallbackRarities.COMMON;
            }
            const rarityKey = Object.keys(gameSettings.rarities).find(key => gameSettings.rarities[key].name === rarityName);
            return rarityKey ? gameSettings.rarities[rarityKey] : gameSettings.rarities.COMMON || { name: "普通", textVarKey: "--rarity-common-text", statMultiplier: 1.0, skillLevelBonus: 0, resistanceBonus: 1 };
        }

        function getRarityStyling(rarityName) {
            const rarityData = getRarityData(rarityName);
            return {
                text: `var(${rarityData.textVarKey || '--rarity-common-text'})`,
            };
        }

        let currentMonsterSort = { column: 'score', order: 'desc' };
        let currentPlayerSort = { column: 'score', order: 'desc' };

        function sortLeaderboardData(data, column, order) {
            return [...data].sort((a, b) => {
                let valA = a[column];
                let valB = b[column];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (column === 'rank') {
                    valA = parseInt(valA) || Infinity;
                    valB = parseInt(valB) || Infinity;
                }

                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // Point 5: NPC Monsters for Leaderboard
        function initializeNpcMonsters() {
            npcMonsters = [];
            const npcElements = ['火', '水', '木', '金', '土', '光', '暗', '毒', '風', '無'];
            const npcNamesPrefix = ["訓練用", "初級", "挑戰者", "守衛"];
            const npcNamesSuffix = ["小兵", "魔偶", "石像", "傀儡", "試煉者"];

            for (let i = 0; i < 20; i++) {
                const mainElement = npcElements[i % npcElements.length];
                const baseAttack = 10 + Math.floor(Math.random() * 10); // 10-19
                const baseDefense = 8 + Math.floor(Math.random() * 10);  // 8-17
                const baseHp = 50 + Math.floor(Math.random() * 30);     // 50-79
                const baseSpeed = 5 + Math.floor(Math.random() * 8);      // 5-12
                const baseCrit = 1 + Math.floor(Math.random() * 5);       // 1-5

                let npcSkills = [];
                const elementSkills = gameSettings.skills[mainElement] || gameSettings.skills['無'] || [];
                if (elementSkills.length > 0) {
                    npcSkills.push(JSON.parse(JSON.stringify(elementSkills[Math.floor(Math.random() * elementSkills.length)])));
                    if (npcSkills[0]) npcSkills[0].level = 1; // NPC skills are level 1
                }
                if (npcSkills.length === 0) { // Fallback skill
                    npcSkills.push({ name: "撞擊", power: 10, crit: 3, probability: 100, story: "基礎撞擊。", type: "無", level: 1 });
                }

                const score = (baseHp / 2) + (baseAttack * 2) + (baseDefense * 2) + baseSpeed + (baseCrit * 3);

                npcMonsters.push({
                    id: `npc_${i + 1}`,
                    nickname: `${npcNamesPrefix[i % npcNamesPrefix.length]}${mainElement}屬性${npcNamesSuffix[i % npcNamesSuffix.length]} #${i + 1}`,
                    elements: [mainElement],
                    elementComposition: { [mainElement]: 100 },
                    hp: baseHp,
                    mp: 20 + Math.floor(Math.random() * 10),
                    attack: baseAttack,
                    defense: baseDefense,
                    speed: baseSpeed,
                    crit: baseCrit,
                    skills: npcSkills,
                    rarity: "普通", // NPCs are common rarity for this tier
                    title: "初級挑戰者",
                    description: `一個用於初級挑戰的${mainElement}屬性NPC怪獸。`,
                    personality: { name: "標準", text: "為戰鬥而生的標準程式。", color: "var(--text-secondary)" },
                    aiEvaluation: "這是一個標準的訓練用NPC。",
                    creationTime: Date.now(),
                    monsterTitles: ["訓練夥伴"],
                    monsterMedals: 0,
                    farmStatus: {},
                    activityLog: [],
                    healthConditions: [],
                    resistances: {},
                    score: Math.floor(score),
                    isNPC: true // Flag to identify NPC
                });
            }
            console.log("Generated NPC Monsters:", npcMonsters);
        }


        async function populateMonsterLeaderboard(filterElement = '所有') {
            if (!monsterLeaderboardTable) return;
            monsterLeaderboardTable.innerHTML = `<thead><tr>
                <th data-sort="rank">排名</th>
                <th data-sort="title">稱號</th>
                <th data-sort="nickname">暱稱</th>
                <th class="text-center" data-sort="mainElement">主要屬性</th>
                <th data-sort="score">總評價</th>
                <th class="challenge-btn-cell">挑戰</th>
            </tr></thead><tbody></tbody>`;
            const tbody = monsterLeaderboardTable.querySelector('tbody');
            if (!tbody) return;

            let displayData = [];

            if (filterElement === 'NPC') {
                if(npcMonsters.length === 0) initializeNpcMonsters(); // Generate NPCs if not already done
                displayData = sortLeaderboardData(npcMonsters, currentMonsterSort.column, currentMonsterSort.order);
            } else {
                // TODO: Fetch actual player monster data from backend for leaderboard
                // For now, using mock data or empty
                monsterLeaderboardData = []; // Placeholder for actual data
                let filteredData = monsterLeaderboardData;
                if (filterElement !== '所有') {
                    filteredData = monsterLeaderboardData.filter(m => m.elements && m.elements.includes(filterElement));
                }
                displayData = sortLeaderboardData(filteredData, currentMonsterSort.column, currentMonsterSort.order);
            }


            if (displayData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-[var(--text-secondary)]">${filterElement === 'NPC' ? 'NPC怪獸列表載入中或尚無NPC。' : '此屬性尚無怪獸上榜。'}</td></tr>`;
                return;
            }

            displayData.forEach((monster, index) => {
                const row = tbody.insertRow();
                const mainEl = monster.elements && monster.elements.length > 0 ? monster.elements[0] : '無';
                const elStyle = getElementStyling(mainEl);

                row.innerHTML = `
                    <td>${monster.isNPC ? `NPC #${index + 1}`: (monster.rank || index + 1)}</td>
                    <td>${monster.title || '新秀'}</td>
                    <td>${monster.nickname}</td>
                    <td class="leaderboard-element-cell text-center"><span style="color:${elStyle.text}; background-color:${elStyle.bg}; padding: 2px 5px; border-radius: 3px;">${mainEl}</span></td>
                    <td>${monster.score || 0}</td>
                    <td class="challenge-btn-cell"><button class="challenge-monster-btn primary text-xs p-1">挑戰</button></td>
                `;
                const challengeBtn = row.querySelector('.challenge-monster-btn');
                if (challengeBtn) {
                    challengeBtn.onclick = () => promptChallengeMonster(monster);
                }
            });
        }


        async function populatePlayerLeaderboard() {
            playerLeaderboardTable.innerHTML = `<thead><tr>
                <th data-sort="rank">排名</th>
                <th data-sort="nickname">暱稱</th>
                <th data-sort="wins">勝場</th>
                <th data-sort="losses">敗場</th>
                <th data-sort="score">積分</th>
                <th data-sort="representativeMonsterName">代表怪獸</th>
            </tr></thead><tbody><tr><td colspan="6" class="text-center p-4 text-[var(--text-secondary)]">玩家排行榜資料載入中或尚無資料...</td></tr></tbody>`;
            // Actual data fetching from backend needed here
        }


        function addSortListenersToTable(tableElement, type) {
            const headers = tableElement.querySelectorAll('th[data-sort]');
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sort;
                    if (type === 'monster') {
                        if (currentMonsterSort.column === sortKey) {
                            currentMonsterSort.order = currentMonsterSort.order === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentMonsterSort.column = sortKey;
                            currentMonsterSort.order = 'desc';
                        }
                        const activeElementTab = monsterLeaderboardElementTabs.querySelector('.tab-button.active');
                        populateMonsterLeaderboard(activeElementTab ? activeElementTab.dataset.element : '所有');
                    } else if (type === 'player') {
                        if (currentPlayerSort.column === sortKey) {
                            currentPlayerSort.order = currentPlayerSort.order === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentPlayerSort.column = sortKey;
                            currentPlayerSort.order = 'desc';
                        }
                        populatePlayerLeaderboard();
                    }
                });
            });
        }

        // Point 5: Add NPC tab
        function setupMonsterLeaderboardTabs() {
            const elements = ['所有', '火', '水', '木', '金', '土', '光', '暗', '毒', '風', '無', 'NPC']; // Added NPC
            if (!monsterLeaderboardElementTabs) return;
            monsterLeaderboardElementTabs.innerHTML = '';
            elements.forEach(el => {
                const tabButton = document.createElement('button');
                tabButton.className = 'tab-button';
                tabButton.textContent = el;
                tabButton.dataset.element = el; // Used for filtering, NPC will be a special case
                if (el === '所有') tabButton.classList.add('active');

                tabButton.onclick = (e) => {
                    monsterLeaderboardElementTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    populateMonsterLeaderboard(el); // Pass 'NPC' or element name
                };
                monsterLeaderboardElementTabs.appendChild(tabButton);
            });
        }


        async function promptChallengeMonster(opponentMonsterData) {
            monsterToChallengeInfo = opponentMonsterData;
            const playerMonster = battlingMonsterId ? farmedMonsters.find(m => m.id === battlingMonsterId) : currentMonster;
            if (!playerMonster) {
                showFeedbackModal("挑戰失敗", "你需要先指定一隻出戰怪獸才能挑戰！", false, true, false);
                return;
            }
            confirmationModalTitleEl.textContent = "挑戰確認";
            confirmationModalBodyEl.innerHTML = `確定要讓 <strong style="color:var(--accent-color);">${playerMonster.nickname}</strong> 挑戰怪獸 <strong style="color:var(--accent-color);">${monsterToChallengeInfo.nickname}</strong> (總評價: ${monsterToChallengeInfo.score})？<br><br><strong class="text-[var(--danger-color)]">注意：對戰結果將記錄到您的戰績！</strong>`;
            if(releaseMonsterImagePlaceholder) releaseMonsterImagePlaceholder.style.display = 'none';
            confirmActionBtn.className = 'danger';
            confirmActionBtn.textContent = '確認挑戰';

            confirmActionBtn.onclick = async () => {
                closeModal('confirmation-modal');
                showFeedbackModal("戰鬥準備", `正在準備 ${playerMonster.nickname} 與 ${monsterToChallengeInfo.nickname} 的對決...`, true, false);
                try {
                    const idToken = await auth.currentUser?.getIdToken();
                    const response = await fetch(`${API_BASE_URL}/battle/simulate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(idToken && {'Authorization': `Bearer ${idToken}`})
                        },
                        body: JSON.stringify({
                            monster1_data: playerMonster,
                            monster2_data: monsterToChallengeInfo
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: "戰鬥模擬請求失敗。" }));
                        throw new Error(errorData.error || errorData.message || `HTTP error! status: ${response.status}`);
                    }
                    const battleResult = await response.json();
                    displayBattleLog(battleResult.log);

                    // Update player stats only if the opponent is not an NPC or if specific logic for NPC rewards exists
                    if (!opponentMonsterData.isNPC) { // Example: Only update for non-NPC battles
                        if (battleResult.winner_id === playerMonster.id) {
                            playerStats.wins = (playerStats.wins || 0) + 1;
                            if (playerMonster.resume) playerMonster.resume.wins = (playerMonster.resume.wins || 0) + 1; else playerMonster.resume = {wins:1, losses:0};
                            addLogEntry(playerMonster, `成功挑戰並擊敗了 ${monsterToChallengeInfo.nickname}！`);
                            showFeedbackModal("挑戰勝利！", `${playerMonster.nickname} 戰勝了 ${monsterToChallengeInfo.nickname}！`, false, true, false);
                        } else if (battleResult.loser_id === playerMonster.id) {
                            playerStats.losses = (playerStats.losses || 0) + 1;
                             if (playerMonster.resume) playerMonster.resume.losses = (playerMonster.resume.losses || 0) + 1; else playerMonster.resume = {wins:0, losses:1};
                            addLogEntry(playerMonster, `挑戰 ${monsterToChallengeInfo.nickname} 失敗。`);
                            showFeedbackModal("挑戰失敗...", `${playerMonster.nickname} 不敵 ${monsterToChallengeInfo.nickname}。`, false, true, false);
                        } else {
                            addLogEntry(playerMonster, `與 ${monsterToChallengeInfo.nickname} 的戰鬥平手。`);
                            showFeedbackModal("平手", `與 ${monsterToChallengeInfo.nickname} 的戰鬥平手。`, false, true, false);
                        }
                        openAndPopulatePlayerInfoModal(playerStats, currentLoggedInUser?.uid);
                        updateMonsterSnapshotDisplay(currentMonster); // currentMonster is the player's battling monster
                        if (currentLoggedInUser) savePlayerData();
                    } else { // Handle NPC battle outcome (e.g., log, show feedback, but maybe no stat changes)
                         if (battleResult.winner_id === playerMonster.id) {
                            showFeedbackModal("NPC挑戰勝利！", `${playerMonster.nickname} 戰勝了NPC ${monsterToChallengeInfo.nickname}！`, false, true, false);
                            addLogEntry(playerMonster, `成功挑戰並擊敗了NPC ${monsterToChallengeInfo.nickname}！`);
                        } else if (battleResult.loser_id === playerMonster.id) {
                            showFeedbackModal("NPC挑戰失敗...", `${playerMonster.nickname} 不敵NPC ${monsterToChallengeInfo.nickname}。`, false, true, false);
                            addLogEntry(playerMonster, `挑戰NPC ${monsterToChallengeInfo.nickname} 失敗。`);
                        } else {
                            showFeedbackModal("NPC挑戰平手", `與NPC ${monsterToChallengeInfo.nickname} 的戰鬥平手。`, false, true, false);
                            addLogEntry(playerMonster, `與NPC ${monsterToChallengeInfo.nickname} 的戰鬥平手。`);
                        }
                        // Optionally save log or other NPC-specific data
                         if (currentLoggedInUser) savePlayerData(); // Save logs if monster object was modified
                    }

                } catch (error) {
                    console.error("戰鬥模擬錯誤:", error);
                    showFeedbackModal("錯誤", `戰鬥模擬失敗: ${error.message}`, false, true, false);
                }
            };
            openModal('confirmation-modal');
        }

        function displayBattleLog(logEntries) {
            if(!battleLogArea) return;
            battleLogArea.innerHTML = '';
            (logEntries || []).forEach(entry => {
                const p = document.createElement('p');
                if (entry.startsWith("--- 回合")) {
                    p.className = 'turn-divider';
                    p.textContent = entry;
                } else if (entry.includes("爆擊！")) {
                    p.innerHTML = entry.replace("爆擊！", '<span class="crit-hit">爆擊！</span>');
                } else if (entry.includes("回復了")) {
                     p.innerHTML = entry.replace(/回復了 [\d\.]+ HP/g, (match) => `<span class="heal-action">${match}</span>`);
                } else if (entry.includes("被擊倒了！")) {
                    p.innerHTML = entry.replace("被擊倒了！", '<span class="defeated">被擊倒了！</span>');
                } else if (entry.includes("獲勝！")) {
                    p.className = 'battle-end winner';
                    p.textContent = entry;
                } else if (entry.includes("戰鬥結束") && entry.includes("平手")) {
                     p.className = 'battle-end draw';
                     p.textContent = entry;
                } else if (entry.startsWith("戰鬥開始！")) {
                    p.className = 'battle-start';
                    p.textContent = entry;
                } else {
                   p.textContent = entry;
                }
                battleLogArea.appendChild(p);
            });
            battleLogArea.scrollTop = battleLogArea.scrollHeight;
            openModal('battle-log-modal');
        }

        function createDnaElement(item, index, sourceType) {
            const sD = document.createElement('div');
            sD.dataset.droptype = sourceType;
            let uniqueIdPart = item ? (item.id || item.tempId || `gen-${sourceType}-${index}`) : `empty-${sourceType}-${index}`;
            sD.id = `${sourceType}-slot-${uniqueIdPart}`;

            if (sourceType === 'inventory') {
                sD.dataset.inventorySlotIndex = index;
            } else if (sourceType === 'temporary') {
                sD.dataset.slotIndex = index;
            }

            if (item) {
                sD.className = 'dna-item';
                sD.textContent = item.name;
                sD.draggable = true;
                const elementStyle = getElementStyling(item.type);
                const rarityStyle = getRarityStyling(item.rarity);
                sD.style.backgroundColor = elementStyle.bg;
                sD.style.color = rarityStyle.text;
                sD.style.borderColor = elementStyle.text;
                const dnaInfoToStore = {...item, baseId: item.baseId || item.id.split('_')[0] + '_' + item.id.split('_')[1] + '_' + item.id.split('_')[2]};
                sD.dataset.dnaInfo = JSON.stringify(dnaInfoToStore);
                sD.addEventListener('dragstart', handleDragStart);
            } else {
                sD.className = sourceType === 'inventory' ? 'inventory-slot-empty' : 'temp-backpack-slot empty';
                sD.textContent = '空位';
            }
            sD.addEventListener('dragover', handleDragOver);
            sD.addEventListener('dragleave', handleDragLeave);
            sD.addEventListener('drop', handleDrop);
            if (sourceType === 'temporary' && item) {
                sD.title = `點擊將 ${item.name} 移至DNA碎片庫`;
                sD.onclick = () => moveFromTempToInventory(index);
            }
            return sD;
        }

        function moveFromTempToInventory(tempSlotIndex) {
            const itemToMove = temporaryBackpackSlots[tempSlotIndex];
            if (!itemToMove) return;
            const emptyMainSlot = inventoryDisplaySlots.findIndex((slot, index) => slot === null && index < NUM_INVENTORY_SLOTS);
            if (emptyMainSlot !== -1) {
                inventoryDisplaySlots[emptyMainSlot] = itemToMove;
                temporaryBackpackSlots[tempSlotIndex] = null;
                populateInventory();
                populateTemporaryBackpack();
                if (currentLoggedInUser) savePlayerData();
            } else {
                showFeedbackModal("提示", "DNA碎片庫已滿！請先清出空間。", false, true, false);
            }
        }

        function handleDropOnDeleteSlot(e) {
            e.preventDefault();
            const targetDropZone = e.target.closest('[data-droptype="delete"]');
            if (!targetDropZone) return;
            targetDropZone.classList.remove('drag-over');

            const dnaDataString = e.dataTransfer.getData('application/json');
            const sourceType = e.dataTransfer.getData('text/source-type');
            const sourceIndexString = e.dataTransfer.getData('text/source-index');

            if (!dnaDataString || !sourceType || sourceIndexString === null || sourceIndexString === undefined) return;

            const sourceIndex = parseInt(sourceIndexString, 10);
            const droppedDNA = JSON.parse(dnaDataString);

            promptDeleteItem(droppedDNA.id || droppedDNA.tempId, sourceIndex, sourceType, droppedDNA.name);
        }

        function promptDeleteItem(itemId, itemSlotIndex, itemSourceType, itemNameOverride = null) {
            itemToDeleteInfo = { id: itemId, slotIndex: itemSlotIndex, sourceType: itemSourceType };
            const itemName = itemNameOverride || (itemSourceType === 'inventory'
                ? (inventoryDisplaySlots[itemSlotIndex] ? inventoryDisplaySlots[itemSlotIndex].name : '該DNA')
                : (temporaryBackpackSlots[itemSlotIndex] ? temporaryBackpackSlots[itemSlotIndex].name : '該DNA'));
            confirmationModalBodyEl.innerHTML =`確定刪除DNA碎片 "${itemName}"？此動作無法復原。`;
            if(releaseMonsterImagePlaceholder) releaseMonsterImagePlaceholder.style.display = 'none';
            confirmationModalTitleEl.textContent="刪除確認";
            confirmActionBtn.className = 'danger';
            confirmActionBtn.textContent = '確定刪除';
            confirmActionBtn.onclick = () => {
                if (itemToDeleteInfo) {
                    if (itemToDeleteInfo.sourceType === 'inventory') {
                        inventoryDisplaySlots[itemToDeleteInfo.slotIndex] = null;
                        playerOwnedDNA = playerOwnedDNA.filter(dna => (dna.id || dna.tempId) !== itemToDeleteInfo.id);
                    } else if (itemToDeleteInfo.sourceType === 'temporary') {
                        temporaryBackpackSlots[itemToDeleteInfo.slotIndex] = null;
                    }
                    combinationSlotsData.forEach((comboItem, comboIndex) => {
                        if (comboItem && ((comboItem.id && comboItem.id === itemToDeleteInfo.id) || (comboItem.tempId && comboItem.tempId === itemToDeleteInfo.id))) {
                            clearCombinationSlot(comboIndex, false);
                        }
                    });
                    populateInventory();
                    populateTemporaryBackpack();
                    if (currentLoggedInUser) savePlayerData();
                    itemToDeleteInfo = null;
                }
                closeModal('confirmation-modal');
                updateActionButtonsState();
            };
            openModal('confirmation-modal');
        }

        function handleDragStart(e) {
            const dnaInfo = e.target.dataset.dnaInfo;
            if (!dnaInfo) { e.preventDefault(); return; }
            try { JSON.parse(dnaInfo); } catch (jsonError) { e.preventDefault(); return; }
            e.dataTransfer.effectAllowed = "move";
            e.dataTransfer.setData('application/json', dnaInfo);
            const sourceType = e.target.closest('[data-droptype]').dataset.droptype;
            let sourceIndexStr;
            if (sourceType === 'inventory') sourceIndexStr = e.target.closest('[data-inventory-slot-index]').dataset.inventorySlotIndex;
            else if (sourceType === 'combination') sourceIndexStr = e.target.closest('[data-slot-id]').dataset.slotId;
            else if (sourceType === 'temporary') sourceIndexStr = e.target.closest('[data-slot-index]').dataset.slotIndex;
            else { e.preventDefault(); return; }
            if (sourceIndexStr === undefined || sourceIndexStr === null || String(sourceIndexStr).trim() === "") {
                e.preventDefault(); return;
            }
            e.dataTransfer.setData('text/source-type', sourceType);
            e.dataTransfer.setData('text/source-index', String(sourceIndexStr));
        }

        function setupDropZones() {
            document.querySelectorAll('[data-droptype="combination"], [data-droptype="inventory"], [data-droptype="temporary"], [data-droptype="delete"]').forEach(s=>{
                s.addEventListener('dragover',handleDragOver);
                s.addEventListener('dragleave',handleDragLeave);
                if (s.dataset.droptype === "delete") {
                    s.addEventListener('drop', handleDropOnDeleteSlot);
                } else {
                    s.addEventListener('drop', handleDrop);
                }
                if(s.dataset.droptype==="combination"){s.addEventListener('click',handleComboSlotClick);}
            });
        }
        function handleDragOver(e) {
            e.preventDefault();
            const tS=e.target.closest('[data-droptype]');
            if(tS){
                if(tS.dataset.droptype==="combination"&&!tS.classList.contains('occupied')){tS.classList.add('border-[var(--accent-color)]','bg-[#2f2f4a]');}
                else if((tS.dataset.droptype==="inventory" || tS.dataset.droptype==="temporary") && (tS.classList.contains('inventory-slot-empty') || tS.classList.contains('empty'))){tS.classList.add('drag-over');}
                else if (tS.dataset.droptype === "delete") { tS.classList.add('drag-over'); }
            }
        }
        function handleDragLeave(e) {
            const tS=e.target.closest('[data-droptype]');
            if(tS){tS.classList.remove('border-[var(--accent-color)]','bg-[#2f2f4a]','drag-over');}
        }
        function handleDrop(e) {
            e.preventDefault();
            const targetDropZone = e.target.closest('[data-droptype]');
            if (!targetDropZone || targetDropZone.dataset.droptype === "delete") return;
            targetDropZone.classList.remove('border-[var(--accent-color)]', 'bg-[#2f2f4a]', 'drag-over');
            const dnaDataString = e.dataTransfer.getData('application/json');
            const sourceType = e.dataTransfer.getData('text/source-type');
            const sourceIndexString = e.dataTransfer.getData('text/source-index');
            if (!dnaDataString || !sourceType || sourceIndexString === null || sourceIndexString === undefined || sourceIndexString.trim() === "") { return; }
            const sourceIndex = parseInt(sourceIndexString, 10);
            if (isNaN(sourceIndex)) { return; }
            const droppedDNA = JSON.parse(dnaDataString);
            const targetDropType = targetDropZone.dataset.droptype;
            let moved = false;
            if (targetDropType === "combination") {
                const targetComboSlotIndex = parseInt(targetDropZone.dataset.slotId);
                if (!combinationSlotsData[targetComboSlotIndex]) {
                    combinationSlotsData[targetComboSlotIndex] = droppedDNA;
                    updateCombinationSlotUI(targetComboSlotIndex, droppedDNA);
                    if (sourceType === 'inventory') inventoryDisplaySlots[sourceIndex] = null;
                    else if (sourceType === 'combination' && sourceIndex !== targetComboSlotIndex) clearCombinationSlotUI(sourceIndex);
                    else if (sourceType === 'temporary') temporaryBackpackSlots[sourceIndex] = null;
                    moved = true;
                }
            } else if (targetDropType === "inventory") {
                const targetInventorySlotIndex = parseInt(targetDropZone.dataset.inventorySlotIndex);
                if (!inventoryDisplaySlots[targetInventorySlotIndex]) {
                    inventoryDisplaySlots[targetInventorySlotIndex] = droppedDNA;
                    if (sourceType === 'combination') clearCombinationSlotUI(sourceIndex);
                    else if (sourceType === 'temporary') temporaryBackpackSlots[sourceIndex] = null;
                    else if (sourceType === 'inventory' && sourceIndex !== targetInventorySlotIndex) inventoryDisplaySlots[sourceIndex] = null;
                    moved = true;
                }
            } else if (targetDropType === "temporary") {
                const targetTempSlotIndex = parseInt(targetDropZone.dataset.slotIndex);
                 if (!temporaryBackpackSlots[targetTempSlotIndex]) {
                    temporaryBackpackSlots[targetTempSlotIndex] = droppedDNA;
                    if (sourceType === 'combination') clearCombinationSlotUI(sourceIndex);
                    else if (sourceType === 'inventory') inventoryDisplaySlots[sourceIndex] = null;
                    else if (sourceType === 'temporary' && sourceIndex !== targetTempSlotIndex) temporaryBackpackSlots[sourceIndex] = null;
                    moved = true;
                }
            }
            if (moved) {
                populateInventory();
                populateTemporaryBackpack();
                updateActionButtonsState();
                if (currentLoggedInUser) savePlayerData();
            }
        }

        function updateCombinationSlotUI(comboSlotId, dnaItem) {
            const comboSlotElement = dnaCombinationSlotsContainer?.querySelector(`.dna-slot[data-slot-id="${comboSlotId}"]`);
            if (!comboSlotElement) return;
            if (dnaItem) {
                comboSlotElement.textContent = dnaItem.name;
                comboSlotElement.classList.add('occupied');
                const elementStyle = getElementStyling(dnaItem.type);
                const rarityStyle = getRarityStyling(dnaItem.rarity);
                comboSlotElement.style.backgroundColor = elementStyle.bg;
                comboSlotElement.style.color = rarityStyle.text;
                comboSlotElement.style.borderColor = elementStyle.text;
                comboSlotElement.draggable = true;
                comboSlotElement.dataset.dnaInfo = JSON.stringify(dnaItem);
                comboSlotElement.removeEventListener('dragstart', handleDragStart);
                comboSlotElement.addEventListener('dragstart', handleDragStart);
            } else {
                clearCombinationSlotUI(comboSlotId);
            }
        }

        function clearCombinationSlotUI(comboSlotId) {
            const comboSlotElement = dnaCombinationSlotsContainer?.querySelector(`.dna-slot[data-slot-id="${comboSlotId}"]`);
            if (!comboSlotElement) return;
            combinationSlotsData[comboSlotId] = null;
            comboSlotElement.textContent = `組合槽 ${parseInt(comboSlotId) + 1}`;
            comboSlotElement.classList.remove('occupied');
            comboSlotElement.style.backgroundColor = '';
            comboSlotElement.style.borderColor = '';
            comboSlotElement.style.color = 'var(--text-primary)';
            comboSlotElement.draggable = false;
            delete comboSlotElement.dataset.dnaInfo;
            comboSlotElement.removeEventListener('dragstart', handleDragStart);
        }

        function clearCombinationSlot(comboSlotId, returnToInventory = true) {
            const comboSlotElement = dnaCombinationSlotsContainer?.querySelector(`.dna-slot[data-slot-id="${comboSlotId}"]`);
            if (!comboSlotElement || !combinationSlotsData[comboSlotId]) return;
            const returnedDNA = combinationSlotsData[comboSlotId];
            clearCombinationSlotUI(comboSlotId);
            if (returnToInventory && returnedDNA) {
                const emptyInventorySlotIndex = inventoryDisplaySlots.findIndex((slot, index) => slot === null && index < NUM_INVENTORY_SLOTS);
                if (emptyInventorySlotIndex !== -1) {
                    inventoryDisplaySlots[emptyInventorySlotIndex] = returnedDNA;
                } else {
                    const emptyTempSlotIndex = temporaryBackpackSlots.findIndex(slot => slot === null);
                    if (emptyTempSlotIndex !== -1) {
                        temporaryBackpackSlots[emptyTempSlotIndex] = returnedDNA;
                        populateTemporaryBackpack();
                    } else {
                        playerOwnedDNA.push(returnedDNA);
                        showFeedbackModal("提示", `${returnedDNA.name} 已返回DNA庫，但背包和物品欄均已滿，請整理。`, false, true, false);
                    }
                }
            }
            populateInventory();
            updateActionButtonsState();
            if (currentLoggedInUser) savePlayerData();
        }

        function handleComboSlotClick(e) {
            const cSE=e.target.closest('.dna-slot[data-droptype="combination"]');
            if(!cSE)return;
            const cSI=parseInt(cSE.dataset.slotId);
            if(combinationSlotsData[cSI]){clearCombinationSlot(cSI,true);}
        }

        function generateMonsterSkills(elements, attack, defense, speed, skillLevelBonus = 0) {
            if (!gameSettings.skills || Object.keys(gameSettings.skills).length === 0) {
                console.warn("generateMonsterSkills: gameSettings.skills not loaded.");
                return [{ name: "猛撞", power: 20, crit: 5, probability: 100, story: "基本撞擊。", type: "無", baseLevel: 1, level: 1 }];
            }
            const skillDatabase = gameSettings.skills;
            let potentialSkills = [];
            const getRandomLevelWithBonus = (baseLvl) => Math.min(5, Math.max(1, (baseLvl || 1) + skillLevelBonus + Math.floor(Math.random() * 3) -1));

            elements.forEach(element => {
                if (skillDatabase[element] && Array.isArray(skillDatabase[element])) {
                    skillDatabase[element].forEach(skill => {
                        if (skill && skill.name && !potentialSkills.some(ps => ps.name === skill.name)) {
                            potentialSkills.push({...skill, level: getRandomLevelWithBonus(skill.baseLevel) });
                        }
                    });
                }
            });
            if (skillDatabase['無'] && Array.isArray(skillDatabase['無'])) {
                skillDatabase['無'].forEach(skill => {
                    if (skill && skill.name && potentialSkills.length < 20 && !potentialSkills.some(ps => ps.name === skill.name)) {
                        potentialSkills.push({...skill, level: getRandomLevelWithBonus(skill.baseLevel) });
                    }
                });
            }

            potentialSkills.sort(() => 0.5 - Math.random());
            let selectedSkills = [];
            let totalProbability = 0;
            const maxSkills = 3;
            const maxTotalProbability = 50 + (elements.length * 5) + (skillLevelBonus * 2);

            for (const skill of potentialSkills) {
                if (selectedSkills.length < maxSkills && (totalProbability + (skill.probability || 10)) <= maxTotalProbability) {
                    if (!selectedSkills.find(s => s.name === skill.name)) {
                        selectedSkills.push(skill);
                        totalProbability += (skill.probability || 10);
                    }
                }
                if (selectedSkills.length >= maxSkills) break;
            }
            if (selectedSkills.length === 0 && potentialSkills.length > 0) {
                selectedSkills.push(potentialSkills[0]);
            }
             if (selectedSkills.length === 0) {
                selectedSkills.push({ name: "猛撞", power: 20, crit: 5, probability: 100, story: "基本撞擊。", type: "無", baseLevel: 1, level: 1 });
            }
            return selectedSkills;
        }

        function generatePersonalityObject() {
            if (!gameSettings.personalities || gameSettings.personalities.length === 0) {
                console.warn("generatePersonalityObject: gameSettings.personalities not loaded.");
                return { name: "標準", description: "一個標準的怪獸個性。", colorDark: "#888888", colorLight:"#AAAAAA", color:"#888888" };
            }
            const personalities = gameSettings.personalities;
            const selected = personalities[Math.floor(Math.random() * personalities.length)];
            const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
            return {
                text: selected.description,
                color: currentTheme === 'light' ? selected.colorLight : selected.colorDark,
                name: selected.name
            };
        }

        // Point 7: Hide Top Monster Image if No Battle Monster
        function updateMonsterSnapshotDisplay(monster) {
            const defaultImageUrl = `https://placehold.co/200x150/${document.body.classList.contains('light-theme') ? 'eaeef2' : '010409'}/${document.body.classList.contains('light-theme') ? '57606a' : '8b949e'}?text=無出戰怪獸&font=noto-sans-tc`;
            if (!monsterImageElement || !snapshotAchievementTitle || !snapshotNickname || !snapshotWinLoss || !snapshotEvaluation) return;

            const isAnyMonsterBattling = farmedMonsters.some(m => m.farmStatus && m.farmStatus.isBattling);

            if (!monster || !isAnyMonsterBattling) { // If no specific monster OR no monster is battling
                monsterImageElement.src = defaultImageUrl;
                monsterImageElement.alt = "無出戰怪獸";
                snapshotAchievementTitle.textContent = " "; // Clear title
                snapshotNickname.textContent = currentPlayerNickname || '-'; // Show player name
                snapshotWinLoss.innerHTML = `<span>勝: ${playerStats.wins || 0}</span><span>敗: ${playerStats.losses || 0}</span>`;
                snapshotEvaluation.textContent = '總評價: -';
                if(monsterInfoButton) monsterInfoButton.disabled = true; // Disable button if no monster
                document.getElementById('monster-snapshot-area').style.opacity = 0.7; // Dim the area
                return;
            }

            document.getElementById('monster-snapshot-area').style.opacity = 1; // Full opacity if monster is shown
            let mainElement = monster.elements && monster.elements.length > 0 ? monster.elements[0] : "無";
            const elementStyle = getElementStyling(mainElement);
            const elementColorHex = getComputedStyle(document.documentElement).getPropertyValue(elementStyle.bg.replace(/var\(|\)/g, '')).trim().substring(1);
            const placeholderTextColor = getContrastColor(elementColorHex);
            monsterImageElement.src = `https://placehold.co/200x150/${elementColorHex}/${placeholderTextColor}?text=${encodeURIComponent(monster.nickname)}&font=noto-sans-tc`;
            monsterImageElement.alt = monster.nickname;
            snapshotAchievementTitle.textContent = monster.title || "新秀";
            snapshotNickname.textContent = monster.nickname; // Show monster nickname
            snapshotWinLoss.innerHTML = `<span>勝: ${playerStats.wins || 0}</span><span>敗: ${playerStats.losses || 0}</span>`; // Player's overall win/loss
            snapshotEvaluation.textContent = `總評價: ${monster.score || 0}`;
            if(monsterInfoButton) monsterInfoButton.disabled = false;
        }


        // Point 8: AI Generated Monster Details
        async function generateAndStoreAIDescriptions(monster) {
            if (!monster || (monster.aiPersonality && monster.aiIntroduction && monster.aiEvaluation)) {
                return monster; // Already has descriptions or no monster
            }

            let prompt = `為一個名為 "${monster.nickname}" 的怪獸生成描述性文字。
該怪獸的屬性是：${monster.elements.join('、')}。
稀有度為：${monster.rarity}。
主要數值大致為：生命 ${monster.hp}，攻擊 ${monster.attack}，防禦 ${monster.defense}，速度 ${monster.speed}。

請嚴格按照以下JSON格式提供回應，不要添加任何額外的解釋或開頭/結尾文字：
{
  "personality_text": "一段關於此怪獸個性的描述 (100中文字元以內，例如：性格勇猛，喜歡挑戰強敵，但有時略顯魯莽。)",
  "introduction_text": "一段關於此怪獸的背景或趣味介紹 (150中文字元以內，例如：來自火山深處的火焰精靈，傳說中守護著古老的寶藏。)",
  "evaluation_text": "一段針對此怪獸屬性與數值的綜合評價 (200中文字元以內，例如：此怪獸擁有強大的火系攻擊力，但防禦較弱，適合速攻戰術。建議搭配能提升其生存能力的夥伴。)"
}
`;

            console.log("AI Gen Prompt for " + monster.nickname + ":", prompt);
            showFeedbackModal(`為 ${monster.nickname} 生成AI評價`, "正在與AI溝通，請稍候...", true, false);

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "personality_text": { "type": "STRING" },
                                "introduction_text": { "type": "STRING" },
                                "evaluation_text": { "type": "STRING" }
                            },
                            required: ["personality_text", "introduction_text", "evaluation_text"]
                        }
                    }
                };
                const apiKey = ""; // Per instruction, leave API key empty
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("AI Generation API Error:", response.status, errorText);
                    throw new Error(`AI API請求失敗: ${response.status}. ${errorText}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedJsonText = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(generatedJsonText);

                    monster.aiPersonality = parsedJson.personality_text;
                    monster.aiIntroduction = parsedJson.introduction_text;
                    monster.aiEvaluation = parsedJson.evaluation_text;

                    console.log(`AI Descriptions for ${monster.nickname}:`, parsedJson);
                    showFeedbackModal(`AI評價已生成`, `${monster.nickname} 的新描述已完成！`, false, true, false);

                    const monsterInfoModalEl = document.getElementById('monster-info-modal');
                    if (monsterInfoModalEl && monsterInfoModalEl.style.display === 'flex') {
                        const headerNameEl = monsterInfoModalHeaderContent?.querySelector('.monster-info-name-styled');
                        if (headerNameEl && headerNameEl.textContent === monster.nickname) {
                            updateMonsterInfoModal(monster);
                        }
                    }
                    if (currentLoggedInUser) savePlayerData();
                } else {
                    console.error("AI Generation Unexpected response structure:", result);
                    throw new Error("AI未能生成有效的描述內容。");
                }
            } catch (error) {
                console.error("Error generating AI descriptions for " + monster.nickname + ":", error);
                showFeedbackModal("AI評價生成失敗", `為 ${monster.nickname} 生成描述時出錯: ${error.message}`, false, true, false);
                monster.aiPersonality = monster.aiPersonality || "AI未能生成個性描述。";
                monster.aiIntroduction = monster.aiIntroduction || "AI未能生成介紹。";
                monster.aiEvaluation = monster.aiEvaluation || "AI未能生成評價。";
                 if (currentLoggedInUser) savePlayerData(); // Save even if defaults are set
            }
            return monster;
        }


        async function updateMonsterInfoModal(monster) {
            if (!monsterInfoModalHeaderContent || !monsterDetailsTab || !monsterActivityLogsContainer) return;
            if (!monster) {
                monsterInfoModalHeaderContent.innerHTML = `<h3 class="modal-header">怪物資訊</h3>`;
                monsterDetailsTab.innerHTML = "<p class='text-center p-4'>尚未選擇或組合怪獸。</p>";
                monsterActivityLogsContainer.innerHTML = "<p class='text-center p-4'>尚無活動紀錄。</p>";
                const firstTabButton = document.querySelector('#monster-info-tabs .tab-button');
                if (firstTabButton) openGenericTab({currentTarget: firstTabButton}, 'monster-details-tab', 'monster-info-modal');
                return;
            }

            // Point 8: Check and generate AI descriptions if missing
            if (!monster.aiPersonality || !monster.aiIntroduction || !monster.aiEvaluation) {
                // Show basic info first, then generate AI text
                renderMonsterInfoModalContent(monster); // Render with existing data
                monster = await generateAndStoreAIDescriptions(monster); // This will update monster object and potentially re-render if modal is still open
                // Re-render content if AI generation finished and modal is still for this monster
                const monsterInfoModalEl = document.getElementById('monster-info-modal');
                if (monsterInfoModalEl && monsterInfoModalEl.style.display === 'flex') {
                    const headerNameEl = monsterInfoModalHeaderContent?.querySelector('.monster-info-name-styled');
                    if (headerNameEl && headerNameEl.textContent === monster.nickname) {
                         renderMonsterInfoModalContent(monster); // Re-render with AI text
                    }
                }
            } else {
                 renderMonsterInfoModalContent(monster); // Directly render if AI text exists
            }
        }

        function renderMonsterInfoModalContent(monster) {
             if (!monsterInfoModalHeaderContent || !monsterDetailsTab || !monsterActivityLogsContainer) return;
            monsterInfoModalHeaderContent.innerHTML = `<div class="monster-info-name-styled">${monster.nickname}</div>`;
            let elementCompositionHTML = monster.elementComposition ? Object.entries(monster.elementComposition)
                .map(([element, percent]) => `<span class="element-composition-item" style="color: ${getElementStyling(element).text}; font-weight: bold;">${element}: ${percent}%</span>`)
                .join(', ') : "無";
            if (!elementCompositionHTML || elementCompositionHTML.trim() === "") elementCompositionHTML = "無";

            let skillsHTML = monster.skills && monster.skills.length > 0 ? monster.skills.map(skill => `
                <div class="skill-entry">
                    <div class="skill-name">${skill.name} (<span style="color: ${getElementStyling(skill.type).text};">${skill.type}</span>) - Lv.${skill.level || 1} - ${skill.probability || 0}%</div>
                    <div class="skill-details">威力: ${skill.power || 0}, 爆擊: ${skill.crit || 0}%</div>
                    <div class="skill-details text-base">${skill.story || skill.description || '暫無詳細描述'}</div>
                </div>
            `).join('') : "<p>無可用招式</p>";

            let monsterTitlesHTML = monster.monsterTitles && monster.monsterTitles.length > 0 ? monster.monsterTitles.map(t => `<li>${t}</li>`).join('') : "<li>尚無稱號</li>";
            let monsterMedalsHTML = "";
            for(let i = 0; i < (monster.monsterMedals || 0); i++) { monsterMedalsHTML += `<span class="medal-emoji">🌟</span>`; }
            if((monster.monsterMedals || 0) === 0) monsterMedalsHTML = "<span>尚無獎牌</span>";

            const statDisplay = (label, base, boost = 0, debuff = 0) => {
                let displayHTML = `${base || 0}`;
                if (boost > 0) displayHTML += ` <span class="text-[var(--success-color)]">+${boost}</span>`;
                if (debuff < 0) { displayHTML += ` <span class="text-[var(--danger-color)]">(${debuff})</span>`; }
                const suffix = label === "爆擊率" ? "%" : "";
                return `<div class="details-item"><span class="details-label">${label}:</span> <span class="details-value">${displayHTML}${suffix}</span></div>`;
            };

            const boostedStats = monster.farmStatus && monster.farmStatus.boosts ? monster.farmStatus.boosts : {};
            const personalityObject = monster.personality || (gameSettings.personalities && gameSettings.personalities.length > 0 ? gameSettings.personalities[0] : {name: "未知", text: "個性資料不完整", color: "var(--text-secondary)"});

            let debuffs = { attack: 0, defense: 0, speed: 0, hp: 0, mp: 0, crit: 0 };
            if (monster.healthConditions && monster.healthConditions.length > 0) {
                monster.healthConditions.forEach(condition => {
                    if(condition.effects) {
                        for (const stat in condition.effects) {
                            debuffs[stat] = (debuffs[stat] || 0) + condition.effects[stat];
                        }
                    }
                });
            }
            let healthConditionsHTML = "";
            if (monster.healthConditions && monster.healthConditions.length > 0) {
                healthConditionsHTML = monster.healthConditions.map(condition => {
                    const effectsString = Object.entries(condition.effects || {}).map(([stat, val]) => `${stat.toUpperCase()}${val}`).join(', ');
                    return `<li>${condition.description || "未知狀態"} (${effectsString})</li>`;
                }).join('');
            } else { healthConditionsHTML = "<li>非常健康！</li>"; }

            let resistancesHTML = "<li>無特殊抗性</li>";
            if (monster.resistances && Object.keys(monster.resistances).length > 0) {
                resistancesHTML = Object.entries(monster.resistances)
                    .map(([type, value]) => `<li>${type}抗性: ${value > 0 ? `+${value}`: value}</li>`)
                    .join('');
            }

            const creationTime = monster.creationTime ? (typeof monster.creationTime.toDate === 'function' ? monster.creationTime.toDate().toLocaleString('zh-TW') : new Date(monster.creationTime * 1000).toLocaleString('zh-TW')) : "未知";

            monsterDetailsTab.innerHTML = `
                <div class="details-section"> <h4 class="details-section-title">📊 基本狀態</h4> <div class="details-grid"> ${statDisplay("HP", monster.hp, boostedStats.hp, debuffs.hp)} ${statDisplay("MP", monster.mp, boostedStats.mp, debuffs.mp)} ${statDisplay("攻擊力", monster.attack, boostedStats.attack, debuffs.attack)} ${statDisplay("防禦力", monster.defense, boostedStats.defense, debuffs.defense)} ${statDisplay("速度", monster.speed, boostedStats.speed, debuffs.speed)} ${statDisplay("爆擊率", monster.crit, boostedStats.crit, debuffs.crit)} </div> </div>
                <div class="details-section"> <h4 class="details-section-title">❤️ 健康狀態</h4> <ul class="titles-list">${healthConditionsHTML}</ul> </div>
                <div class="details-section"> <h4 class="details-section-title">🛡️ 特殊抗性</h4> <ul class="titles-list">${resistancesHTML}</ul> </div>
                <div class="details-section"> <div class="creation-time-centered">創造時間: ${creationTime}</div> </div>
                <div class="details-section"> <h4 class="details-section-title">🧬 屬性構成</h4> <div class="details-item"><span class="details-label">主要屬性:</span> <span class="details-value">${monster.elements && monster.elements.length > 0 ? monster.elements.map(el => `<span style="color: ${getElementStyling(el).text}; font-weight:bold;">${el}</span>`).join(', ') : '無'}</span></div> <div class="details-item"><span class="details-label">DNA構成:</span> <span class="details-value">${elementCompositionHTML}</span></div> </div>
                <div class="details-section"> <h4 class="details-section-title">⚔️ 招式列表 (等級/使用機率)</h4> ${skillsHTML} </div>
                <div class="details-section titles-medals-section"> <h4 class="details-section-title">🏅 怪獸成就</h4> <ul class="titles-list">${monsterTitlesHTML}</ul> <h4 class="details-section-title" style="margin-top:10px;">🌟 怪獸獎牌 (${monster.monsterMedals || 0})</h4> <div class="medals-grid">${monsterMedalsHTML}</div> </div>

                <div class="details-section"> <h4 class="details-section-title">🎭 AI生成個性</h4> <p class="ai-generated-text">${monster.aiPersonality || "<i>AI個性描述生成中或尚未生成...</i>"}</p> </div>
                <div class="details-section"> <h4 class="details-section-title">📖 AI生成介紹</h4> <p class="ai-generated-text">${monster.aiIntroduction || "<i>AI介紹生成中或尚未生成...</i>"}</p> </div>
                <div class="details-section"> <h4 class="details-section-title">🤖 AI生成評價</h4> <p class="ai-generated-text">${monster.aiEvaluation || "<i>AI評價生成中或尚未生成...</i>"}</p> </div>
            `;
            updateMonsterActivityLog(monster);
            const firstTabButton = document.querySelector('#monster-info-tabs .tab-button');
            if (firstTabButton && !firstTabButton.classList.contains('active')) { // Only open if not already on it
                 openGenericTab({currentTarget: firstTabButton}, 'monster-details-tab', 'monster-info-modal');
            }
        }


        function openModal(modalId) { const m=document.getElementById(modalId); if(m)m.style.display='flex';}
        function closeModal(modalId) { const m=document.getElementById(modalId); if(m)m.style.display='none';}

        function showFeedbackModal(title, messageOrAiEval, showSpinner, showCloseXButton = true, showMonsterDetails = false, monsterForDetails = null) {
            if (!feedbackModalTitle || !feedbackModalSpinner || !feedbackModalCloseX || !feedbackMonsterDetailsDiv || !feedbackModalMessage) return;
            feedbackModalTitle.textContent = title;
            feedbackModalSpinner.style.display = showSpinner ? 'block' : 'none';
            feedbackModalCloseX.style.display = showCloseXButton ? 'block' : 'none';
            const feedbackMonsterDetailsContent = feedbackMonsterDetailsDiv;
            feedbackMonsterDetailsContent.innerHTML = '';
            if (showMonsterDetails && monsterForDetails) {
                feedbackModalMessage.innerHTML = "";
                feedbackMonsterDetailsDiv.style.display = 'block';
                const personalityObj = monsterForDetails.personality || (gameSettings.personalities && gameSettings.personalities.length > 0 ? gameSettings.personalities[0] : {name: "未知", text: "個性資料不完整", color: "var(--text-secondary)"});
                let elementCompHTML = monsterForDetails.elementComposition ? Object.entries(monsterForDetails.elementComposition)
                    .map(([el, pc]) => `<span style="color:${getElementStyling(el).text}; font-weight:bold;">${el} ${pc}%</span>`)
                    .join(', ') : "無";
                 if (!elementCompHTML || elementCompHTML.trim() === "") elementCompHTML = "無";
                let skillsHTML = monsterForDetails.skills && monsterForDetails.skills.length > 0 ? monsterForDetails.skills.map(s => `
                    <div class="feedback-skill-entry"> <div class="feedback-skill-name">${s.name} (<span style="color:${getElementStyling(s.type).text};">${s.type}</span>) - Lv.${s.level || 1}</div> <div class="feedback-skill-description">${s.story || s.description}</div> </div>`).join('') : "無";
                let resistancesHTML = "無特殊抗性";
                if (monsterForDetails.resistances && Object.keys(monsterForDetails.resistances).length > 0) {
                    resistancesHTML = Object.entries(monsterForDetails.resistances)
                        .map(([type, value]) => `<span style="color:${getElementStyling(type).text};">${type}抗性: ${value > 0 ? `+${value}`: value}</span>`)
                        .join(', ');
                }
                let healthConditionsHTML = "健康狀況良好";
                if (monsterForDetails.healthConditions && monsterForDetails.healthConditions.length > 0) {
                    healthConditionsHTML = monsterForDetails.healthConditions.map(condition => {
                        const effectsString = Object.entries(condition.effects || {}).map(([stat, val]) => `${stat.toUpperCase()}${val}`).join(', ');
                        return `<span>${condition.description || "未知狀態"} (${effectsString})</span>`;
                    }).join('<br>');
                }
                feedbackMonsterDetailsContent.innerHTML = `
                    <div class="details-section !p-2 !mb-2"> <h4 class="details-section-title !text-base !mb-1">📊 基本狀態</h4> <p class="text-base">攻擊: ${monsterForDetails.attack || 0}, 防禦: ${monsterForDetails.defense || 0}, 速度: ${monsterForDetails.speed || 0}, HP: ${monsterForDetails.hp || 0}</p> </div>
                    <div class="details-section !p-2 !mb-2"> <h4 class="details-section-title !text-base !mb-1">❤️ 健康狀態</h4> <p class="text-base">${healthConditionsHTML}</p> </div>
                    <div class="details-section !p-2 !mb-2"> <h4 class="details-section-title !text-base !mb-1">🛡️ 特殊抗性</h4> <p class="text-base">${resistancesHTML}</p> </div>
                    <div class="details-section !p-2 !mb-2"> <h4 class="details-section-title !text-base !mb-1">⚔️ 招式</h4> <div class="text-base">${skillsHTML}</div> </div>
                    <div class="details-section !p-2 !mb-2"> <h4 class="details-section-title !text-base !mb-1">🎭 個性</h4> <p class="text-base personality-text" style="color: ${personalityObj.color};">${personalityObj.text}</p> </div>
                    <div class="details-section !p-2 !mb-2"> <h4 class="details-section-title !text-base !mb-1">📖 介紹</h4> <p class="text-base monster-description-area !p-1 !mt-1">${monsterForDetails.description || "暫無詳細介紹。"}</p> </div>
                    <div class="details-section !p-2"> <h4 id="feedback-ai-eval-title" class="details-section-title !text-base !mb-1">🤖 AI評價</h4> <p class="text-base">${monsterForDetails.aiEvaluation ? monsterForDetails.aiEvaluation.replace(/\n/g, '<br>') : (monsterForDetails.aiPersonality ? "<i>AI評價生成中...</i>" : "<i>AI評價將在稍後生成。</i>")}</p> </div>`;
            } else {
                feedbackMonsterDetailsDiv.style.display = 'none';
                feedbackModalMessage.innerHTML = messageOrAiEval.replace(/\n/g, '<br>');
            }
            openModal('feedback-modal');
        }

        // Point 1 & 4: Farm List Redesign and Remove Info Button
        function populateFarmList() {
            if(!farmedMonstersListContainer) return;
            farmedMonstersListContainer.innerHTML = '';
            if (farmedMonsters.length === 0) {
                farmedMonstersListContainer.innerHTML = '<p class="text-center text-base text-[var(--text-secondary)] py-4">🏡 農場空空如也，快去組合怪獸吧！</p>';
                return;
            }
            const sortedFarmMonsters = [...farmedMonsters].sort((a,b) => {
                if (a.farmStatus && b.farmStatus && a.farmStatus.isBattling && !b.farmStatus.isBattling) return -1;
                if (a.farmStatus && b.farmStatus && !a.farmStatus.isBattling && b.farmStatus.isBattling) return 1;
                return (b.score || 0) - (a.score || 0);
            });

            sortedFarmMonsters.forEach((monster, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'farm-monster-item';
                itemDiv.dataset.monsterId = monster.id;

                const battleBtn = document.createElement('button');
                battleBtn.className = 'farm-battle-btn';
                battleBtn.innerHTML = monster.farmStatus && monster.farmStatus.isBattling ? '<span title="休息">🔴</span>' : '<span title="出戰">🟢</span>';
                battleBtn.onclick = () => toggleBattleStatus(monster.id);

                const nameDiv = document.createElement('div');
                nameDiv.className = 'farm-monster-name';
                nameDiv.textContent = monster.nickname;
                nameDiv.title = monster.nickname; // For overflow

                const statusDiv = document.createElement('div');
                statusDiv.className = 'farm-monster-status';
                updateFarmMonsterStatusDisplay(monster, statusDiv);

                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'farm-monster-score';
                scoreDiv.textContent = `評價: ${monster.score || 0}`;

                const actionsGroupDiv = document.createElement('div');
                actionsGroupDiv.className = 'farm-monster-actions-group';

                const cultivateBtn = document.createElement('button');
                cultivateBtn.className = 'farm-monster-cultivate-btn warning';
                cultivateBtn.textContent = monster.farmStatus && monster.farmStatus.isTraining ? '結束修煉' : '養成';
                cultivateBtn.disabled = (monster.farmStatus && monster.farmStatus.active) || (monster.farmStatus && monster.farmStatus.isBattling);
                if (monster.farmStatus && monster.farmStatus.isTraining) cultivateBtn.onclick = () => pauseTraining(monster.id);
                else cultivateBtn.onclick = () => openCultivationSetupModal(monster.id);

                const releaseBtn = document.createElement('button');
                releaseBtn.className = 'farm-monster-release-btn danger';
                releaseBtn.textContent = '放生';
                releaseBtn.disabled = (monster.farmStatus && monster.farmStatus.active) || (monster.farmStatus && monster.farmStatus.isBattling) || (monster.farmStatus && monster.farmStatus.isTraining);
                releaseBtn.onclick = () => promptReleaseMonster(monster.id);

                actionsGroupDiv.append(cultivateBtn, releaseBtn);

                // Appending elements based on grid-template-areas for mobile if needed, or direct for desktop
                itemDiv.append(battleBtn, nameDiv, statusDiv, scoreDiv, actionsGroupDiv);
                farmedMonstersListContainer.appendChild(itemDiv);
            });
        }

        function toggleBattleStatus(monsterIdToBattle) {
            let newBattlingMonster = null;
            let changed = false;
            farmedMonsters.forEach(m => {
                if (!m.farmStatus) m.farmStatus = {};
                if (m.id === monsterIdToBattle) {
                    if (m.farmStatus.isTraining || m.farmStatus.active) {
                        showFeedbackModal("提示", `${m.nickname} 正在${m.farmStatus.isTraining ? '修煉' : '拾荒'}中，無法出戰。`, false, true, false);
                        return; // Skip this monster
                    }
                    const previousBattleStatus = m.farmStatus.isBattling;
                    m.farmStatus.isBattling = !m.farmStatus.isBattling;
                    if (m.farmStatus.isBattling !== previousBattleStatus) changed = true;

                     addLogEntry(m, m.farmStatus.isBattling ? "🟢 進入出戰狀態。" : "🔴 解除出戰狀態，開始休息。");
                     if (m.farmStatus.isBattling) newBattlingMonster = m;
                } else {
                    if (m.farmStatus.isBattling) changed = true; // If another monster was battling and is now not
                    m.farmStatus.isBattling = false;
                }
            });

            battlingMonsterId = newBattlingMonster ? newBattlingMonster.id : null;
            // Update currentMonster to the new battling one, or first non-battling if none are battling
            if (newBattlingMonster) {
                currentMonster = newBattlingMonster;
            } else {
                currentMonster = farmedMonsters.find(m => m.farmStatus && !m.farmStatus.isBattling && !m.farmStatus.isTraining && !m.farmStatus.active) || (farmedMonsters.length > 0 ? farmedMonsters[0] : null);
            }


            updateMonsterSnapshotDisplay(currentMonster); // Pass the correct monster to display
            if(monsterInfoButton) {
                monsterInfoButton.disabled = !currentMonster; // Disable if no monster is effectively "current"
                if (currentMonster) monsterInfoButton.onclick = () => { updateMonsterInfoModal(currentMonster); openModal('monster-info-modal');};
                else monsterInfoButton.onclick = null;
            }

            populateFarmList();
            if (changed && currentLoggedInUser) savePlayerData();
        }

        function updateFarmMonsterStatusDisplay(monster, statusDivElement) {
            if (!monster.farmStatus) monster.farmStatus = {};
            if (monster.farmStatus.isBattling) {
                statusDivElement.textContent = '出戰中';
                statusDivElement.className = 'farm-monster-status battling';
            } else if (monster.farmStatus.isTraining) {
                const elapsed = Math.floor((Date.now() - (monster.farmStatus.trainingStartTime || Date.now())) / 1000);
                const displayElapsed = Math.min(elapsed, MAX_CULTIVATION_SECONDS); // Cap display at max time
                statusDivElement.textContent = `修煉中... (${displayElapsed}秒)`;
                statusDivElement.className = 'farm-monster-status active';
                if (monster.farmStatus.timerId && elapsed < 0) {
                     clearInterval(monster.farmStatus.timerId);
                     monster.farmStatus.timerId = null;
                     monster.farmStatus.isTraining = false;
                     statusDivElement.textContent = '閒置中';
                     statusDivElement.className = 'farm-monster-status';
                }
            } else if (monster.farmStatus.active) { // For other activities like "拾荒"
                const timeLeft = Math.max(0, Math.floor(((monster.farmStatus.endTime || 0) - Date.now()) / 1000));
                const actionText = '🧺 拾荒中'; // Example, replace with actual activity type if available
                statusDivElement.textContent = `${actionText} (${timeLeft}秒)`;
                statusDivElement.className = 'farm-monster-status active';
                if (timeLeft === 0 && !monster.farmStatus.completed) {
                    monster.farmStatus.completed = true;
                    if(monster.farmStatus.timerId) clearInterval(monster.farmStatus.timerId);
                    monster.farmStatus.timerId = null;
                    statusDivElement.innerHTML = ''; // Clear text
                    const completeBtn = document.createElement('button');
                    completeBtn.textContent = '✅ 收穫';
                    completeBtn.className = 'farm-complete-btn success'; // Ensure this class is styled
                    completeBtn.onclick = (e) => { e.stopPropagation(); handleFarmActionComplete(monster); };
                    statusDivElement.appendChild(completeBtn);
                }
            } else {
                statusDivElement.textContent = '  閒置中';
                statusDivElement.className = 'farm-monster-status';
            }
        }
        function openCultivationSetupModal(monsterId) {
            currentCultivationMonster = farmedMonsters.find(m => m.id === monsterId);
            if (!currentCultivationMonster || !cultivationMonsterName) return;
            cultivationMonsterName.textContent = currentCultivationMonster.nickname;
            if (maxCultivationTimeSpan) maxCultivationTimeSpan.textContent = MAX_CULTIVATION_SECONDS;
            openModal('cultivation-setup-modal');
        }

        // Point 9: Cultivation Time Limit
        if(startCultivationBtn) {
            startCultivationBtn.onclick = () => {
                if (!currentCultivationMonster) return;
                if (!currentCultivationMonster.farmStatus) currentCultivationMonster.farmStatus = {};
                currentCultivationMonster.farmStatus.isTraining = true;
                currentCultivationMonster.farmStatus.trainingStartTime = Date.now();
                currentCultivationMonster.farmStatus.active = false; // Ensure not doing other farm actions
                currentCultivationMonster.farmStatus.type = 'train';
                currentCultivationMonster.farmStatus.boosts = currentCultivationMonster.farmStatus.boosts || { hp: 0, mp: 0, attack: 0, defense: 0, speed: 0, crit: 0};
                addLogEntry(currentCultivationMonster, "🏋️ 開始了新的修煉。");
                closeModal('cultivation-setup-modal');
                populateFarmList();
                if (currentLoggedInUser) savePlayerData();

                if (currentCultivationMonster.farmStatus.timerId) clearInterval(currentCultivationMonster.farmStatus.timerId);
                currentCultivationMonster.farmStatus.timerId = setInterval(() => {
                    const monsterInFarm = farmedMonsters.find(m => m.id === currentCultivationMonster.id);
                    if (!monsterInFarm || !monsterInFarm.farmStatus || !monsterInFarm.farmStatus.isTraining) {
                         if(currentCultivationMonster.farmStatus.timerId) clearInterval(currentCultivationMonster.farmStatus.timerId);
                         currentCultivationMonster.farmStatus.timerId = null;
                         return;
                    }
                    const elapsedSeconds = Math.floor((Date.now() - (currentCultivationMonster.farmStatus.trainingStartTime || Date.now())) / 1000);
                    const farmItem = farmedMonstersListContainer?.querySelector(`.farm-monster-item[data-monster-id="${currentCultivationMonster.id}"]`);
                    if (farmItem) {
                        const statusDiv = farmItem.querySelector('.farm-monster-status');
                        if (statusDiv) updateFarmMonsterStatusDisplay(currentCultivationMonster, statusDiv);
                    }
                    if (elapsedSeconds >= MAX_CULTIVATION_SECONDS) {
                        console.log(`${currentCultivationMonster.nickname} 修煉已達上限 ${MAX_CULTIVATION_SECONDS} 秒。自動結束。`);
                        pauseTraining(currentCultivationMonster.id); // Automatically end training
                    }
                }, 1000);
            };
        }

        function pauseTraining(monsterId) {
            const monster = farmedMonsters.find(m => m.id === monsterId);
            if (!monster || !monster.farmStatus || !monster.farmStatus.isTraining) return;
            if (monster.farmStatus.timerId) {
                clearInterval(monster.farmStatus.timerId);
                monster.farmStatus.timerId = null;
            }
            let trainingDuration = Math.floor((Date.now() - (monster.farmStatus.trainingStartTime || Date.now())) / 1000);
            trainingDuration = Math.min(trainingDuration, MAX_CULTIVATION_SECONDS); // Cap duration at max

            monster.farmStatus.isTraining = false;
            addLogEntry(monster, `修煉結束，共持續 ${trainingDuration} 秒。`);
            resolveTrainingAndShowResults(monster, trainingDuration);
            populateFarmList();
            if (currentLoggedInUser) savePlayerData();
        }

        function resolveTrainingAndShowResults(monster, durationSeconds) {
            let story = `在 ${Math.floor(durationSeconds / 60)}分${durationSeconds % 60}秒 的刻苦修煉中，${monster.nickname} `;
            let growthLogHTML = "";
            itemsFromCurrentTraining = [];
            if (durationSeconds < 10) {
                story += "似乎還沒找到感覺，只是稍微活動了一下筋骨。";
                growthLogHTML = "<p>修煉時間太短，未有明顯成長。</p>";
            } else {
                story += "經歷了嚴酷的挑戰，";
                const growthPoints = Math.max(1, Math.floor(durationSeconds / 20));
                let actualBoosts = 0;
                const statsToBoost = ["hp", "attack", "defense", "speed", "mp", "crit"];
                for (let i = 0; i < growthPoints; i++) {
                    if (Math.random() < 0.6) {
                        const statKey = statsToBoost[Math.floor(Math.random() * statsToBoost.length)];
                        const boostAmount = Math.max(1, Math.floor(Math.random() * ((monster.score || 100) / 400)) + 1 + Math.floor(durationSeconds / 50));
                        monster[statKey] = (monster[statKey] || 0) + boostAmount;
                        if (!monster.farmStatus.boosts) monster.farmStatus.boosts = {};
                        monster.farmStatus.boosts[statKey] = (monster.farmStatus.boosts[statKey] || 0) + boostAmount;
                        growthLogHTML += `<p>${statKey.toUpperCase()}: <span class="text-[var(--success-color)]">+${boostAmount}</span></p>`;
                        actualBoosts++;
                    }
                }
                if (actualBoosts > 0) {
                    story += `成功突破了自身極限！`;
                    monster.score = (monster.score || 0) + actualBoosts * Math.floor(durationSeconds / 10);
                } else {
                    story += `雖然汗水浸濕了大地，但似乎還差臨門一腳。`;
                    growthLogHTML = "<p>本次修煉未有顯著數值成長，但意志更加堅定了！</p>";
                }
                const itemsToFind = Math.floor(durationSeconds / 45);
                if (gameSettings.dnaFragments && gameSettings.dnaFragments.length > 0) {
                    for (let i = 0; i < itemsToFind; i++) {
                        if (Math.random() < 0.4) {
                            const randomDnaIndex = Math.floor(Math.random() * gameSettings.dnaFragments.length);
                            const newItem = JSON.parse(JSON.stringify(gameSettings.dnaFragments[randomDnaIndex]));
                            newItem.baseId = newItem.id;
                            newItem.id = `temp_train_${Date.now()}_${itemsFromCurrentTraining.length}`;
                            itemsFromCurrentTraining.push(newItem);
                        }
                    }
                }
                if (itemsFromCurrentTraining.length > 0) story += ` 並且在途中意外發現了一些稀有的材料！`;
                else story += ` 可惜的是，並未發現任何特別的物品。`;
            }
            if(trainingResultsModalTitle) trainingResultsModalTitle.innerHTML = `🎉 ${monster.nickname} 修煉成果 🎉`;
            if(trainingStoryResult) trainingStoryResult.innerHTML = story;
            if(trainingGrowthResult) trainingGrowthResult.innerHTML = growthLogHTML || "<p>無數值變化。</p>";
            renderTrainingItems();
            openModal('training-results-modal');
            updateMonsterInfoModal(monster);
            updateMonsterSnapshotDisplay(monster === currentMonster ? monster : currentMonster);
        }
        function renderTrainingItems() {
            if(!trainingItemsResult || !addAllToTempBackpackBtn) return;
            trainingItemsResult.innerHTML = '';
            if (itemsFromCurrentTraining.length === 0) {
                trainingItemsResult.innerHTML = "<p>本次修煉未拾獲任何物品。</p>";
                addAllToTempBackpackBtn.style.display = 'none';
                return;
            }
            addAllToTempBackpackBtn.style.display = 'block';
            itemsFromCurrentTraining.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'temp-backpack-item-container p-1 border-b border-[var(--border-color)]';
                const rarityStyle = getRarityStyling(item.rarity);
                const elementStyle = getElementStyling(item.type);
                itemDiv.innerHTML = `
                    <span style="color:${rarityStyle.text}; background-color:${elementStyle.bg}; padding: 2px 4px; border-radius: 3px;">${item.name} (${item.rarity})</span>
                    <button data-item-index="${index}" class="add-one-to-temp-backpack-btn text-base p-1 secondary">➕ 加入背包</button>
                `;
                trainingItemsResult.appendChild(itemDiv);
            });
            document.querySelectorAll('.add-one-to-temp-backpack-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const itemIndex = parseInt(e.target.dataset.itemIndex);
                    const itemToAdd = itemsFromCurrentTraining[itemIndex];
                    if (itemToAdd && !itemToAdd.addedToBackpack) {
                        addToTemporaryBackpack(itemToAdd);
                        itemToAdd.addedToBackpack = true;
                        e.target.textContent = '已加入';
                        e.target.disabled = true;
                    }
                };
            });
        }
        if(addAllToTempBackpackBtn) {
            addAllToTempBackpackBtn.onclick = () => {
                itemsFromCurrentTraining.forEach((item, index) => {
                    if (!item.addedToBackpack) {
                        addToTemporaryBackpack(item);
                        item.addedToBackpack = true;
                        const btn = trainingItemsResult?.querySelector(`.add-one-to-temp-backpack-btn[data-item-index="${index}"]`);
                        if (btn) { btn.textContent = '已加入'; btn.disabled = true; }
                    }
                });
                if (currentLoggedInUser) savePlayerData();
            };
        }
        function closeTrainingResultsModal() {
            const unaddedItems = itemsFromCurrentTraining.filter(item => !item.addedToBackpack);
            if (unaddedItems.length > 0) {
                openModal('reminder-modal');
            } else {
                itemsFromCurrentTraining = [];
                closeModal('training-results-modal');
            }
        }

        if (reminderConfirmCloseBtn) {
            reminderConfirmCloseBtn.onclick = () => {
                itemsFromCurrentTraining = [];
                closeModal('reminder-modal');
                closeModal('training-results-modal');
            };
        }


        function addToTemporaryBackpack(dnaItem) {
            let added = false;
            for (let i = 0; i < NUM_TEMP_BACKPACK_SLOTS; i++) {
                if (temporaryBackpackSlots[i] === null) {
                    const newItem = {...dnaItem};
                    newItem.baseId = dnaItem.baseId || dnaItem.id.split('_')[0] + '_' + dnaItem.id.split('_')[1] + '_' + dnaItem.id.split('_')[2];
                    newItem.id = dnaItem.id || `temp_dna_${Date.now()}_${i}`;
                    temporaryBackpackSlots[i] = newItem;
                    added = true; break;
                }
            }
            if (!added) {
                const newItem = {...dnaItem};
                newItem.baseId = dnaItem.baseId || dnaItem.id.split('_')[0] + '_' + dnaItem.id.split('_')[1] + '_' + dnaItem.id.split('_')[2];
                newItem.id = dnaItem.id || `temp_dna_${Date.now()}_0`;
                temporaryBackpackSlots[0] = newItem; // Overwrite first slot if full
                showFeedbackModal("提示", `臨時背包已滿！ ${dnaItem.name} 已覆蓋最早的物品。`, false, true, false);
            }
            populateTemporaryBackpack();
        }
        function promptReleaseMonster(monsterIdToRelease) {
            const monsterIndex = farmedMonsters.findIndex(m => m.id === monsterIdToRelease);
            if (monsterIndex === -1) return;

            monsterToReleaseInfo = { farmIndex: monsterIndex, id: monsterIdToRelease };
            const monster = farmedMonsters[monsterIndex];
            confirmationModalBodyEl.innerHTML = `確定要放生怪獸 <strong style="color: var(--accent-color);">${monster.nickname}</strong> (總評價: ${monster.score || 0})？<br>此動作無法復原。
                                            <div id="release-monster-image-placeholder" class="flex justify-center my-2">
                                                <img id="release-monster-img-preview-confirm" src="" alt="預覽" class="max-w-[100px] max-h-[75px] object-contain">
                                            </div>`;
            const imgPreviewConfirm = document.getElementById('release-monster-img-preview-confirm');
            if (imgPreviewConfirm) {
                let mainElement = monster.elements && monster.elements.length > 0 ? monster.elements[0] : "無";
                const elementStyle = getElementStyling(mainElement);
                const elementColorHex = getComputedStyle(document.documentElement).getPropertyValue(elementStyle.bg.replace(/var\(|\)/g, '')).trim().substring(1);
                const placeholderTextColor = getContrastColor(elementColorHex);
                imgPreviewConfirm.src = `https://placehold.co/100x75/${elementColorHex}/${placeholderTextColor}?text=${encodeURIComponent(monster.nickname)}&font=noto-sans-tc`;
                imgPreviewConfirm.alt = monster.nickname;
            }
            confirmationModalTitleEl.textContent = "放生確認";
            confirmActionBtn.className = 'danger';
            confirmActionBtn.textContent = '確定放生';
            confirmActionBtn.onclick = () => {
                 if (monsterToReleaseInfo && monsterToReleaseInfo.id) {
                    const releasedMonster = farmedMonsters.find(m => m.id === monsterToReleaseInfo.id);
                    if (releasedMonster) {
                        farmedMonsters = farmedMonsters.filter(m => m.id !== monsterToReleaseInfo.id);
                        showFeedbackModal("放生成功", `${releasedMonster.nickname} 已經回歸大自然了。`, false, true, false);
                        if (currentMonster && currentMonster.id === releasedMonster.id) {
                            currentMonster = farmedMonsters.length > 0 ? farmedMonsters[0] : null;
                            updateMonsterSnapshotDisplay(currentMonster);
                            if(monsterInfoButton) monsterInfoButton.disabled = !currentMonster;
                        }
                         if (battlingMonsterId === releasedMonster.id) {
                            battlingMonsterId = null;
                            // After a monster is released, if it was the battling one,
                            // try to set another monster as battling, or clear if no others.
                            const nextBattlingMonster = farmedMonsters.find(m => m.farmStatus && !m.farmStatus.isTraining && !m.farmStatus.active);
                            if (nextBattlingMonster) {
                                toggleBattleStatus(nextBattlingMonster.id); // Make it battle ready
                            } else {
                                updateMonsterSnapshotDisplay(null); // No monster to show in snapshot
                            }
                        }
                    }
                    populateFarmList();
                    openAndPopulatePlayerInfoModal(playerStats, currentLoggedInUser?.uid);
                    monsterToReleaseInfo = null;
                    if (currentLoggedInUser) savePlayerData();
                }
                closeModal('confirmation-modal'); updateActionButtonsState();
            };
            openModal('confirmation-modal');
        }
        function addLogEntry(monster, message) {
            if (!monster || !message) return;
            const timestamp = new Date().toLocaleString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit'});
            if (!monster.activityLog) monster.activityLog = [];
            monster.activityLog.unshift({ time: timestamp, message: message });
            if (monster.activityLog.length > 20) monster.activityLog.pop();

            const monsterInfoModalEl = document.getElementById('monster-info-modal');
            if (monsterInfoModalEl && monsterInfoModalEl.style.display === 'flex') {
                const headerName = monsterInfoModalHeaderContent?.querySelector('.monster-info-name-styled');
                if (headerName && headerName.textContent === monster.nickname) {
                    updateMonsterActivityLog(monster);
                }
            }
        }
        function updateMonsterActivityLog(monster) {
            if (!monsterActivityLogsContainer) return;
            if (!monster || !monster.activityLog || monster.activityLog.length === 0) {
                monsterActivityLogsContainer.innerHTML = "<p class='text-center text-base text-[var(--text-secondary)] py-4'>尚無活動紀錄。</p>";
                return;
            }
            monsterActivityLogsContainer.innerHTML = monster.activityLog.map(entry => `
                <div class="log-entry"> <span class="log-time">[${entry.time}]</span> <span class="log-message">${entry.message}</span> </div>`).join('');
        }

        let newbieGuideData = [];
        function populateNewbieGuide(searchTerm = "") {
            if(!newbieGuideContentArea) return;
            const guideSource = (gameSettings.newbieGuide && gameSettings.newbieGuide.length > 0) ? gameSettings.newbieGuide : [ { title: "遊戲目標", content: "歡迎來到怪獸養成對戰遊戲！您的目標是透過組合不同的DNA碎片，創造出獨一無二的強大怪獸，並透過養成提升它們的能力，最終在排行榜上名列前茅。" }, { title: "DNA組合", content: "在「DNA組合」區塊，您可以將擁有的「DNA碎片」拖曳到上方的組合槽中。每個DNA碎片都帶有不同的屬性和基礎數值。放入DNA後，點擊「怪物合成」按鈕即可合成新的怪獸。" }];
            newbieGuideContentArea.innerHTML = "";
            const lowerSearchTerm = searchTerm.toLowerCase().trim();
            const filteredData = guideSource.filter(item => item.title.toLowerCase().includes(lowerSearchTerm) || item.content.toLowerCase().includes(lowerSearchTerm));
            if (filteredData.length === 0) { newbieGuideContentArea.innerHTML = "<p class='text-center p-4'>找不到相關的指南內容。</p>"; return; }
            const highlight = (text, term) => { if (!term) return text; const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'); return text.replace(regex, '<mark class="bg-yellow-300 dark:bg-yellow-600 rounded px-1">$1</mark>'); };
            filteredData.forEach(item => { const itemDiv = document.createElement('div'); itemDiv.className = 'mb-4 p-3 rounded-md border border-[var(--border-color)] bg-[var(--bg-primary)]'; itemDiv.innerHTML = ` <h5 class="text-lg font-semibold text-[var(--accent-color)] mb-1">${highlight(item.title, searchTerm)}</h5> <p class="text-base">${highlight(item.content.replace(/\n/g, "<br>"), searchTerm)}</p> `; newbieGuideContentArea.appendChild(itemDiv); });
        }
        if(newbieGuideBtn) newbieGuideBtn.addEventListener('click', () => { populateNewbieGuide(); openModal('newbie-guide-modal'); });
        if(newbieGuideSearchInput) newbieGuideSearchInput.addEventListener('input', (e) => { populateNewbieGuide(e.target.value); });

        async function searchFriends(searchTerm) {
            if(!friendsListContainer) return;
            const lowerSearchTerm = searchTerm.toLowerCase().trim();
            if (!lowerSearchTerm || lowerSearchTerm.length < 1) {
                friendsListContainer.innerHTML = '<p class="text-center text-base text-[var(--text-secondary)]">請輸入至少1個字元進行搜尋。</p>';
                return;
            }
            friendsListContainer.innerHTML = '<p class="text-center text-base text-[var(--text-secondary)]">搜尋中...</p>';
            try {
                const idToken = currentLoggedInUser ? await currentLoggedInUser.getIdToken() : null;
                const headers = idToken ? { 'Authorization': `Bearer ${idToken}` } : {};
                const response = await fetch(`${API_BASE_URL}/players/search?nickname=${encodeURIComponent(lowerSearchTerm)}&limit=10`, { headers });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: "搜尋失敗，請稍後再試。" }));
                    throw new Error(errorData.error || errorData.message);
                }
                const data = await response.json();
                displaySearchedPlayers(data.players || []);
            } catch (error) {
                console.error('搜尋好友失敗:', error);
                friendsListContainer.innerHTML = `<p class="text-center text-base text-[var(--danger-color)]">搜尋失敗：${error.message}</p>`;
            }
        }

        let searchDebounceTimer;
        if(friendsListSearchInput) {
            friendsListSearchInput.addEventListener('input', (e) => {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => {
                    searchFriends(e.target.value);
                }, 300);
            });
        }

        function displaySearchedPlayers(playersToDisplay) {
            if(!friendsListContainer) return;
            friendsListContainer.innerHTML = '';
            if (!playersToDisplay || playersToDisplay.length === 0) {
                friendsListContainer.innerHTML = '<p class="text-center text-base text-[var(--text-secondary)]">找不到符合的玩家。</p>';
                return;
            }
            playersToDisplay.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'friend-item cursor-pointer hover:bg-[var(--bg-slot)] p-2 rounded';
                playerDiv.textContent = player.nickname;
                playerDiv.dataset.uid = player.uid;
                playerDiv.addEventListener('click', async () => {
                    showPlayerInfoPopup(player.uid);
                });
                friendsListContainer.appendChild(playerDiv);
            });
        }

        async function showPlayerInfoPopup(playerUid) {
            if (!playerUid) return;
            showFeedbackModal("讀取中...", "正在獲取玩家資訊...", true, false);
            try {
                const idToken = currentLoggedInUser ? await currentLoggedInUser.getIdToken() : null;
                const headers = idToken ? { 'Authorization': `Bearer ${idToken}` } : {};
                const response = await fetch(`${API_BASE_URL}/player/${playerUid}`, { headers });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: "無法獲取玩家資訊。" }));
                    throw new Error(errorData.error || errorData.message);
                }
                const playerDataFromApi = await response.json();
                openAndPopulatePlayerInfoModal(playerDataFromApi, playerUid);
                closeModal('feedback-modal');
            } catch (error) {
                console.error('獲取玩家資訊彈窗失敗:', error);
                showFeedbackModal("錯誤", `獲取玩家資訊失敗：${error.message}`, false, true, false);
            }
        }

        function openAndPopulatePlayerInfoModal(playerGameData, targetPlayerUid) {
            if (!playerInfoModalBody) return;
            const stats = playerGameData.playerStats || { rank: 'N/A', wins: 0, losses: 0, score: 0, titles: [], achievements: [], medals: 0, nickname: "未知玩家" };
            const ownedMonstersData = playerGameData.farmedMonsters || playerGameData.playerOwnedMonsters || [];
            const nicknameToDisplay = playerGameData.nickname || stats.nickname || "未知玩家";

            let tsH = stats.titles && stats.titles.length > 0 ? stats.titles.map(t => `<li class="player-titles-list-item">${t}</li>`).join('') : `<li>尚無稱號</li>`;
            let acH = stats.achievements && stats.achievements.length > 0 ? stats.achievements.map(a => `<li class="player-titles-list-item">${a}</li>`).join('') : "<li>尚無成就</li>";
            let msH = "";
            for (let i = 0; i < (stats.medals || 0); i++) { msH += `<span class="medal-emoji">🏆</span>`; }
            if ((stats.medals || 0) === 0) msH = "<span>尚無獎牌</span>";

            let ownedMonstersHTML = '<h4 class="details-section-title mt-4">🐾 該玩家的怪獸</h4>';
            if (ownedMonstersData.length === 0) {
                ownedMonstersHTML += '<p class="text-sm text-[var(--text-secondary)]">該玩家尚未擁有任何怪獸或資料未公開。</p>';
            } else {
                const groupedMonsters = ownedMonstersData.reduce((acc, monster) => {
                    const mainElement = monster.elements && monster.elements.length > 0 ? monster.elements[0] : '其他';
                    if (!acc[mainElement]) acc[mainElement] = [];
                    acc[mainElement].push(monster);
                    return acc;
                }, {});
                for (const element in groupedMonsters) {
                    ownedMonstersHTML += `<h5 class="text-sm font-semibold mt-3 mb-1" style="color: ${getElementStyling(element).text};">${element}屬性</h5>`;
                    ownedMonstersHTML += '<ul class="owned-monsters-list">';
                    groupedMonsters[element]
                        .sort((a, b) => (b.score || 0) - (a.score || 0))
                        .forEach(monster => {
                            ownedMonstersHTML += `<li><span class="monster-name">${monster.nickname || '未命名怪獸'}</span> <span class="monster-score">評價: ${monster.score || 0}</span></li>`;
                        });
                    ownedMonstersHTML += '</ul>';
                }
            }
            const isSelf = currentLoggedInUser && targetPlayerUid === currentLoggedInUser.uid;
            playerInfoModalBody.innerHTML = `
                <div class="details-section">
                    <h4 class="details-section-title">玩家檔案 (${isSelf ? "您自己" : "其他玩家"})</h4>
                    <div class="details-item"><span class="details-label">暱稱:</span> <span class="details-value">${nicknameToDisplay}</span></div>
                    <div class="details-item"><span class="details-label">英雄榜排名:</span> <span class="details-value">#${stats.rank || 'N/A'}</span></div>
                    <div class="details-item"><span class="details-label">總勝場:</span> <span class="details-value">${stats.wins || 0}</span></div>
                    <div class="details-item"><span class="details-label">總敗場:</span> <span class="details-value">${stats.losses || 0}</span></div>
                    <div class="details-item"><span class="details-label">總積分:</span> <span class="details-value">${stats.score || 0}</span></div>
                </div>
                <div class="details-section titles-medals-section"> <h4 class="details-section-title">已獲得稱號</h4><ul class="titles-list">${tsH}</ul> </div>
                <div class="details-section titles-medals-section"> <h4 class="details-section-title">玩家成就</h4><ul class="achievements-list">${acH}</ul> </div>
                <div class="details-section titles-medals-section"> <h4 class="details-section-title">勝利獎牌 (${stats.medals || 0})</h4><div class="medals-grid">${msH}</div> </div>
                <div class="details-section">${ownedMonstersHTML}</div>
            `;
            openModal('player-info-modal');
        }


        if(friendsListBtn) friendsListBtn.addEventListener('click', () => {
            if (friendsListSearchInput) friendsListSearchInput.value = "";
            if (friendsListContainer) friendsListContainer.innerHTML = '<p class="text-center text-base text-[var(--text-secondary)]">輸入暱稱搜尋其他玩家。</p>';
            openModal('friends-list-modal');
        });

        if(showMonsterLeaderboardBtn) showMonsterLeaderboardBtn.addEventListener('click', () => { setupMonsterLeaderboardTabs(); populateMonsterLeaderboard(); openModal('monster-leaderboard-modal'); });
        if(showPlayerLeaderboardBtn) showPlayerLeaderboardBtn.addEventListener('click', () => { populatePlayerLeaderboard(); openModal('player-leaderboard-modal'); });

        if(monsterInfoButton) {
            monsterInfoButton.addEventListener('click', () => {
                const monsterToDisplay = battlingMonsterId ? farmedMonsters.find(m => m.id === battlingMonsterId) : currentMonster;
                if (monsterToDisplay) { updateMonsterInfoModal(monsterToDisplay); openModal('monster-info-modal'); }
                else if (currentMonster) { updateMonsterInfoModal(currentMonster); openModal('monster-info-modal'); }
                else { updateMonsterInfoModal(null); openModal('monster-info-modal'); }
            });
        }

        if(playerInfoButton) {
            playerInfoButton.addEventListener('click', () => {
                if (currentLoggedInUser && currentLoggedInUser.uid) {
                    showPlayerInfoPopup(currentLoggedInUser.uid);
                } else {
                    showFeedbackModal("提示", "請先登入以查看您的玩家資訊。", false, true, false);
                }
            });
        }

        if(combineButton) combineButton.addEventListener('click', combineDNA);

        // Point 6: Modal Click Outside - Disable auto-close
        window.onclick = function(event) {
            // if (event.target.classList.contains('modal')) {
            //     const modalId = event.target.id;
            //     // Modals that should NOT close on outside click:
            //     const nonAutoCloseModals = ['feedback-modal', 'confirmation-modal', 'reminder-modal', 'official-announcement-modal'];
            //     if (!nonAutoCloseModals.includes(modalId)) {
            //         // closeModal(modalId); // Commented out to prevent closing
            //     }
            // }
        }

        function updateActionButtonsState() {
            const hasItemsInCombination = combinationSlotsData.some(s=>s!==null);
            if (combineButton) combineButton.disabled = !hasItemsInCombination;

            const isAnyMonsterBattling = farmedMonsters.some(m => m.farmStatus && m.farmStatus.isBattling);
            const monsterForInfo = isAnyMonsterBattling ? (battlingMonsterId ? farmedMonsters.find(m => m.id === battlingMonsterId) : currentMonster) : null;

            if (monsterInfoButton) monsterInfoButton.disabled = !monsterForInfo;
        }
        function resetGameDataForUI() {
            currentMonster = null;
            playerOwnedDNA = [];
            farmedMonsters = [];
            battlingMonsterId = null;
            currentCultivationMonster = null;
            itemsFromCurrentTraining = [];
            playerStats = { rank: 0, wins: 0, losses: 0, score: 0, titles: (gameSettings.titles && gameSettings.titles.length > 0 ? [gameSettings.titles[0]] : ["新手訓練家"]), achievements: [], medals: 0, nickname: currentPlayerNickname };

            combinationSlotsData.fill(null);
            inventoryDisplaySlots.fill(null);
            temporaryBackpackSlots.fill(null);

            createCombinationSlots();
            populateInventory();
            populateTemporaryBackpack();
            populateFarmList();
            updateMonsterSnapshotDisplay(null);
            updateMonsterInfoModal(null);
            // Do not automatically open player info on reset, let user click
            // if(currentLoggedInUser && playerInfoModalBody) openAndPopulatePlayerInfoModal(playerStats, currentLoggedInUser.uid);

            updateActionButtonsState();
            closeAllModals();
        }
        function closeAllModals() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modalElement => {
                if (modalElement && modalElement.id) {
                    closeModal(modalElement.id);
                }
            });
        }
        async function savePlayerData() {
            if (!currentLoggedInUser || !db) return;
            const userId = currentLoggedInUser.uid;
            const processedPlayerOwnedDNA = playerOwnedDNA.map(dna => {
                if (dna && typeof dna.id === 'string' && !dna.baseId) {
                    const parts = dna.id.split('_');
                    if (parts.length >=3 && parts[0] === 'dna' && parts[1] === 'frag') {
                        dna.baseId = `${parts[0]}_${parts[1]}_${parts[2]}`;
                    } else {
                        dna.baseId = dna.id;
                    }
                }
                return {...dna};
            });

            const dataToSave = {
                playerOwnedDNA: processedPlayerOwnedDNA,
                farmedMonsters: farmedMonsters.map(monster => ({...monster})),
                playerStats: {...playerStats},
                lastSave: firebase.firestore.FieldValue.serverTimestamp()
            };
            const userGameDataRef = db.collection('users').doc(userId).collection('gameData').doc('main');
            try {
                await userGameDataRef.set(dataToSave, { merge: true });
                console.log("玩家遊戲數據已儲存到 Firestore。");
            } catch (error) {
                console.error("儲存玩家遊戲數據到 Firestore 失敗:", error);
                showFeedbackModal("儲存失敗", "無法儲存您的遊戲進度，請檢查網路連線。", false, true, false);
            }
        }

        async function loadGameDataForUser(userId, userNickname) {
            console.log(`正在為用戶 ${userNickname} (UID: ${userId}) 加載遊戲數據...`);
            currentPlayerNickname = userNickname;
            if(snapshotNickname) snapshotNickname.textContent = userNickname; // Update snapshot with player name initially
            showFeedbackModal("載入中...", `歡迎回來，${userNickname}！正在載入您的遊戲資料...`, true, false);

            try {
                const idToken = await auth.currentUser?.getIdToken();
                if (!idToken) throw new Error("用戶未登入或 Token 無效。");

                const response = await fetch(`${API_BASE_URL}/player/${userId}`, {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        console.log("後端找不到玩家數據，將初始化新玩家數據。");
                        playerOwnedDNA = [];
                        farmedMonsters = [];
                        playerStats = { rank: 'N/A', wins: 0, losses: 0, score: 0, titles: (gameSettings.titles && gameSettings.titles.length > 0 ? [gameSettings.titles[0]] : ["新手訓練家"]), achievements: [], medals: 0, nickname: userNickname };
                        await saveInitialPlayerDataToBackend(userId, userNickname, playerStats);
                    } else {
                        const errorData = await response.json().catch(() => ({ message: "無法從後端讀取玩家數據。" }));
                        throw new Error(errorData.error || errorData.message);
                    }
                } else {
                    const data = await response.json();
                    playerOwnedDNA = (data.playerOwnedDNA || []).map(dna => {
                        if (dna && typeof dna.id === 'string' && !dna.baseId) {
                             const parts = dna.id.split('_');
                            if (parts.length >=3 && parts[0] === 'dna' && parts[1] === 'frag') {
                                dna.baseId = `${parts[0]}_${parts[1]}_${parts[2]}`;
                            } else {
                                dna.baseId = dna.id;
                            }
                        }
                        return dna;
                    });
                    farmedMonsters = data.farmedMonsters || [];
                    playerStats = data.playerStats || { rank: 'N/A', wins: 0, losses: 0, score: 0, titles: (gameSettings.titles && gameSettings.titles.length > 0 ? [gameSettings.titles[0]] : ["新手訓練家"]), achievements: [], medals: 0, nickname: userNickname };
                    console.log("從後端 API 加載的遊戲數據:", data);
                }
            } catch (error) {
                console.error("從後端 API 加載遊戲數據失敗:", error);
                showFeedbackModal("載入失敗", `無法載入您的遊戲資料：${error.message}。將使用本機預設值。`, false, true, false);
                playerOwnedDNA = [];
                farmedMonsters = [];
                playerStats = { rank: 'N/A', wins: 0, losses: 0, score: 0, titles: (gameSettings.titles && gameSettings.titles.length > 0 ? [gameSettings.titles[0]] : ["新手訓練家"]), achievements: [], medals: 0, nickname: userNickname };
            }

            initializeInventoryDisplay();
            populateFarmList();

            // Set currentMonster based on battling status or first available
            const battlingOne = farmedMonsters.find(m => m.farmStatus && m.farmStatus.isBattling);
            if (battlingOne) {
                currentMonster = battlingOne;
                battlingMonsterId = battlingOne.id;
            } else if (farmedMonsters.length > 0) {
                currentMonster = farmedMonsters[0]; // Default to first if none are battling
                // Optionally, make the first one battle-ready if none are
                // toggleBattleStatus(farmedMonsters[0].id); // This might be too aggressive
            } else {
                currentMonster = null;
                battlingMonsterId = null;
            }

            updateMonsterSnapshotDisplay(currentMonster);
            updateActionButtonsState();
            closeModal('feedback-modal');
        }

        async function saveInitialPlayerDataToBackend(userId, nickname, initialStats) {
            if (!currentLoggedInUser || !db) return;
            const userDocRef = db.collection('users').doc(userId);
            const userProfileData = {
                uid: userId,
                nickname: nickname,
                email: currentLoggedInUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
            };

            let initialOwnedDNA = [];
            if (gameSettings.dnaFragments && gameSettings.dnaFragments.length > 0) {
                const availableDnaForNewPlayer = gameSettings.dnaFragments.filter(
                    f => f.rarity === "普通" || f.rarity === "稀有"
                );
                if (availableDnaForNewPlayer.length > 0) {
                    for (let i = 0; i < 6; i++) { // Give 6 initial DNA
                        const randomDnaTemplate = availableDnaForNewPlayer[Math.floor(Math.random() * availableDnaForNewPlayer.length)];
                        const newDnaInstance = JSON.parse(JSON.stringify(randomDnaTemplate));
                        newDnaInstance.baseId = newDnaInstance.id;
                        newDnaInstance.id = `${newDnaInstance.baseId}_initial_${Date.now()}_${i}`;
                        initialOwnedDNA.push(newDnaInstance);
                    }
                } else {
                    console.warn("無法給予初始DNA，因為設定中沒有普通或稀有等級的DNA。");
                }
            }
            playerOwnedDNA = initialOwnedDNA; // Update global state
            inventoryDisplaySlots.fill(null); // Clear display slots
            initialOwnedDNA.slice(0, NUM_INVENTORY_SLOTS).forEach((dna, index) => {
                inventoryDisplaySlots[index] = dna; // Populate display slots
            });

            const initialGameData = {
                playerOwnedDNA: initialOwnedDNA.map(dna => ({ ...dna })), // Save to DB
                farmedMonsters: [],
                playerStats: initialStats,
                lastSave: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await userDocRef.set(userProfileData, { merge: true });
                const userGameDataRef = userDocRef.collection('gameData').doc('main');
                await userGameDataRef.set(initialGameData);
                console.log("新玩家初始資料已儲存到 Firestore。");
            } catch (error) {
                console.error("儲存新玩家初始資料到 Firestore 失敗:", error);
            }
        }


        async function fetchGameConfigs() {
            console.log("正在從後端獲取遊戲設定...");
            try {
                const response = await fetch(`${API_BASE_URL}/game-configs`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const configs = await response.json();
                gameSettings = {
                    dnaFragments: configs.dna_fragments || [],
                    rarities: configs.rarities || {},
                    skills: configs.skills || {},
                    personalities: configs.personalities || [],
                    titles: configs.titles || ["新手訓練家"],
                    healthConditions: configs.health_conditions || [],
                    newbieGuide: configs.newbie_guide || newbieGuideData
                };
                console.log("遊戲設定已成功從後端載入:", gameSettings);
                newbieGuideData = gameSettings.newbieGuide; // Update local copy for search
                populateNewbieGuide(); // Populate guide with fetched data
                initializeNpcMonsters(); // Initialize NPCs after game settings are loaded
            } catch (error) {
                console.error("獲取遊戲設定失敗:", error);
                showFeedbackModal("錯誤", "無法載入遊戲核心設定，部分功能可能異常。", false, true, false);
                // Fallback basic settings
                gameSettings.rarities = { COMMON: { name: "普通", textVarKey: "--rarity-common-text", statMultiplier: 1.0 }, RARE: { name: "稀有", textVarKey: "--rarity-rare-text", statMultiplier: 1.1 }};
                gameSettings.skills = { '無': [{ name: "猛撞", power: 20, type: "無"}]};
                gameSettings.personalities = [{ name: "標準", description: "標準個性", colorDark: "#888", colorLight: "#AAA"}];
                initializeNpcMonsters(); // Still try to init NPCs with fallback settings
            }
        }

        async function combineDNA() {
            const dnaToCombine = combinationSlotsData.filter(slot => slot !== null);
            if (dnaToCombine.length === 0) {
                showFeedbackModal("提示", "請先放入至少一個DNA碎片進行組合。", false, true, false);
                return;
            }
            if (!currentLoggedInUser) {
                showFeedbackModal("錯誤", "請先登入才能組合怪獸。", false, true, false);
                return;
            }

            const idsToSend = dnaToCombine.map(dna => {
                if (dna.baseId) return dna.baseId;
                if (dna.id && typeof dna.id === 'string') {
                    const parts = dna.id.split('_');
                    if (parts.length >= 3 && parts[0] === 'dna' && parts[1] === 'frag') {
                        return `${parts[0]}_${parts[1]}_${parts[2]}`;
                    }
                }
                return dna.id || dna.tempId;
            });

            showFeedbackModal("組合中...", "正在努力組合新的怪獸...", true, false);
            try {
                const idToken = await currentLoggedInUser.getIdToken();
                const response = await fetch(`${API_BASE_URL}/combine`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({ dna_ids: idsToSend })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `伺服器錯誤 ${response.status}` }));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                let newMonster = await response.json();

                if (newMonster && !newMonster.error) {
                    // Point 8: Generate AI descriptions for the new monster
                    newMonster = await generateAndStoreAIDescriptions(newMonster); // This updates newMonster object

                    const isFirstMonsterEver = farmedMonsters.length === 0 && (!playerStats.achievements || !playerStats.achievements.includes("首次組合怪獸"));

                    if (farmedMonsters.length < MAX_FARM_SLOTS) {
                        farmedMonsters.push(newMonster);
                        addLogEntry(newMonster, "✨ 成功組合誕生！");

                        // Point 3: First monster auto-battle ready
                        if (isFirstMonsterEver) {
                            newMonster.farmStatus.isBattling = true;
                            battlingMonsterId = newMonster.id;
                            currentMonster = newMonster; // Set as current for snapshot
                            addLogEntry(newMonster, "🟢 自動進入出戰狀態 (首次合成)。");
                        }

                    } else {
                        addToTemporaryBackpack(newMonster);
                        showFeedbackModal("農場已滿", `${newMonster.nickname} 已放入您的臨時背包。`, false, true, false);
                        setTimeout(() => {
                            showFeedbackModal(
                                `怪獸 "${newMonster.nickname}" 組合成功！`,
                                `(因農場已滿，已放入臨時背包)`,
                                false, true, true, newMonster
                            );
                        }, 2500);
                    }
                    populateFarmList();
                    updateMonsterSnapshotDisplay(currentMonster); // Update snapshot based on currentMonster
                    if(monsterInfoButton) monsterInfoButton.disabled = !currentMonster;


                    if(playerStats.achievements && !playerStats.achievements.includes("首次組合怪獸")) {
                        playerStats.achievements.push("首次組合怪獸");
                    }
                    savePlayerData();
                     showFeedbackModal(
                        `怪獸 "${newMonster.nickname}" 組合成功！`,
                        ``, false, true, true, newMonster
                    );
                } else {
                    throw new Error(newMonster.error || "後端回傳組合錯誤但未提供詳細訊息。");
                }
            } catch (error) {
                console.error("DNA 組合失敗:", error);
                showFeedbackModal("組合失敗", `DNA組合失敗：${error.message}`, false, true, false);
            } finally {
                combinationSlotsData.fill(null);
                createCombinationSlots();
                updateActionButtonsState();
            }
        }


        // --- Auth Functions ---
        // Point 2: Force Login on Refresh
        function showAuthScreen() {
            authScreen.style.display = 'flex';
            gameContainer.style.display = 'none';
            closeAllModals();
        }

        function showGameScreenAfterLogin() { // Renamed to be specific
            authScreen.style.display = 'none';
            gameContainer.style.display = 'flex';
            gameContainer.style.flexDirection = 'column';
            gameContainer.style.alignItems = 'center';
        }

        showRegisterFormBtn.addEventListener('click', () => openModal('register-modal'));
        showLoginFormBtn.addEventListener('click', () => openModal('login-modal'));

        registerSubmitBtn.addEventListener('click', async () => {
            const nickname = registerNicknameInput.value.trim();
            const password = registerPasswordInput.value;
            registerErrorDiv.textContent = '';
            if (!nickname || !password) {
                registerErrorDiv.textContent = '暱稱和密碼不能為空。'; return;
            }
            if (password.length < 6) {
                registerErrorDiv.textContent = '密碼長度至少需要6位。'; return;
            }
            const emailForAuth = `${nickname.replace(/\s+/g, '_').toLowerCase()}@game.system`;
            showFeedbackModal("註冊中...", "正在為您創建帳號...", true, false);
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(emailForAuth, password);
                currentLoggedInUser = userCredential.user;
                currentPlayerNickname = nickname;

                const userDocRef = db.collection('users').doc(currentLoggedInUser.uid);
                await userDocRef.set({
                    uid: currentLoggedInUser.uid,
                    nickname: nickname,
                    email: currentLoggedInUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                playerStats = { rank: 0, wins: 0, losses: 0, score: 0, titles: (gameSettings.titles || ["新手訓練家"]), achievements: [], medals: 0, nickname: nickname };
                await saveInitialPlayerDataToBackend(currentLoggedInUser.uid, nickname, playerStats);

                closeModal('register-modal');
                closeModal('feedback-modal');
                showGameScreenAfterLogin(); // Use the new function
                await loadGameDataForUser(currentLoggedInUser.uid, nickname);
                if (announcementPlayerName) announcementPlayerName.textContent = nickname;
                openModal('official-announcement-modal');
            } catch (error) {
                console.error("註冊失敗:", error);
                registerErrorDiv.textContent = `註冊失敗：${error.message}`;
                closeModal('feedback-modal');
            }
        });

        loginSubmitBtn.addEventListener('click', async () => {
            const nickname = loginNicknameInput.value.trim();
            const password = loginPasswordInput.value;
            loginErrorDiv.textContent = '';
            if (!nickname || !password) {
                loginErrorDiv.textContent = '暱稱和密碼不能為空。'; return;
            }
            const emailForAuth = `${nickname.replace(/\s+/g, '_').toLowerCase()}@game.system`;
            showFeedbackModal("登入中...", "正在驗證您的身份...", true, false);
            try {
                const userCredential = await auth.signInWithEmailAndPassword(emailForAuth, password);
                currentLoggedInUser = userCredential.user;

                const userDocRef = db.collection('users').doc(currentLoggedInUser.uid);
                const userDocSnap = await userDocRef.get();
                if (userDocSnap.exists) {
                    currentPlayerNickname = userDocSnap.data().nickname || nickname;
                    await userDocRef.update({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() });
                } else {
                    currentPlayerNickname = nickname; // Should not happen if login is successful
                    await userDocRef.set({ nickname: nickname, uid: currentLoggedInUser.uid, email: currentLoggedInUser.email, lastLogin: firebase.firestore.FieldValue.serverTimestamp() }, {merge: true});
                }

                closeModal('login-modal');
                closeModal('feedback-modal');
                showGameScreenAfterLogin(); // Use the new function
                await loadGameDataForUser(currentLoggedInUser.uid, currentPlayerNickname);
                if (announcementPlayerName) announcementPlayerName.textContent = currentPlayerNickname;
                openModal('official-announcement-modal');
            } catch (error) {
                console.error("登入失敗 (原始錯誤):", error);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || (error.message && error.message.includes("INVALID_LOGIN_CREDENTIALS"))) {
                    loginErrorDiv.textContent = '查無此帳號或密碼錯誤。';
                } else {
                    loginErrorDiv.textContent = `登入失敗：${error.message}`;
                }
                closeModal('feedback-modal');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            showFeedbackModal("登出中...", "正在儲存您的進度並登出...", true, false);
            await savePlayerData(); // Save before signing out
            try {
                await auth.signOut();
                // onAuthStateChanged will handle UI reset to authScreen
            } catch (error) {
                console.error("登出失敗:", error);
                showFeedbackModal("錯誤", `登出時發生錯誤: ${error.message}`, false, true, false);
            }
        });

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in (Firebase session might persist across refreshes)
                // However, per Point 2, we don't automatically show game screen here.
                // Game screen is shown only after explicit login/register action.
                currentLoggedInUser = user;
                const userDocRef = db.collection('users').doc(user.uid);
                const userDocSnap = await userDocRef.get();
                if (userDocSnap.exists) {
                    currentPlayerNickname = userDocSnap.data().nickname || user.email.split('@')[0];
                } else {
                    // This case should ideally be handled during registration.
                    // If somehow a user exists in auth but not DB, create a basic profile.
                    currentPlayerNickname = user.email.split('@')[0];
                    await userDocRef.set({
                        uid: user.uid, nickname: currentPlayerNickname, email: user.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                     await saveInitialPlayerDataToBackend(user.uid, currentPlayerNickname, { rank: 0, wins: 0, losses: 0, score: 0, titles: (gameSettings.titles || ["新手訓練家"]), achievements: [], medals: 0, nickname: currentPlayerNickname });
                }
                console.log("Firebase 用戶已登入 (onAuthStateChanged):", currentLoggedInUser.uid, currentPlayerNickname);
                if(playerInfoButton) playerInfoButton.disabled = false;

                // If gameContainer is already visible (meaning login/register just happened),
                // no need to switch back to authScreen.
                // Otherwise, authScreen should remain visible.
                if (gameContainer.style.display === 'none') {
                    showAuthScreen(); // Ensure auth screen is shown if game isn't active
                }

            } else {
                // User is signed out or not signed in
                currentLoggedInUser = null;
                currentPlayerNickname = "";
                console.log("Firebase 用戶已登出或未登入 (onAuthStateChanged)。");
                resetGameDataForUI();
                showAuthScreen(); // Always show auth screen if no user
                if(playerInfoButton) playerInfoButton.disabled = true;
            }
            if (feedbackModal.style.display === 'flex' && (feedbackModalTitle.textContent.includes("載入中") || feedbackModalTitle.textContent.includes("登入中") || feedbackModalTitle.textContent.includes("註冊中") || feedbackModalTitle.textContent.includes("登出中"))) {
                closeModal('feedback-modal');
            }
        });


        // --- Initialization ---
        async function initializeApp() {
            await fetchGameConfigs(); // Fetch configs first, includes NPC init

            const preferredTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(preferredTheme);

            createCombinationSlots();
            setupDropZones();
            updateActionButtonsState();
            populateNewbieGuide(); // Populate guide with default/fetched data

            const firstDnaFarmTab = document.querySelector('#dna-farm-tabs .tab-button');
            if (firstDnaFarmTab) {
                openDnaFarmTab({currentTarget: firstDnaFarmTab}, 'dna-inventory-content');
            }
            // Point 2: Always show auth screen on initial load.
            // onAuthStateChanged will handle if a user session exists, but UI flow
            // will require explicit login/register action to proceed to game.
            showAuthScreen();
        }

        // Event Listeners
        themeSwitcherBtn.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('light-theme') ? 'dark' : 'light';
            applyTheme(newTheme);
        });

        // Start the application
        initializeApp();

    </script>
</body>
</html>
