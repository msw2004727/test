<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂØ©ÂïèÊåëÊà∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Tailwind CSS Â∑≤Á∂ìÂåÖÂê´ */
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #1a202c; 
            color: #e2e8f0; 
            overscroll-behavior-y: contain; 
        }
        .card {
            background-color: #2d3748; 
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .dialogue-area {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #4a5568; 
            padding: 10px;
            border-radius: 8px;
            background-color: #1f2937; 
            min-height: 200px; 
        }
        .dialogue-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 8px;
            max-width: 85%;
            word-wrap: break-word; 
            color: white; 
        }
        .player-bubble { background-color: #4299e1; margin-left: auto; text-align: right; }
        .player-bubble-calm { background-color: #38a169; }
        .player-bubble-angry { background-color: #e53e3e; }
        .player-bubble-provocative { background-color: #d69e2e; }
        .officer-bubble { background-color: #38a169; color: white; margin-left: auto; text-align: right; }
        .ai-bubble { background-color: #4a5568; color: #e2e8f0; margin-right: auto; }

        .keyword, .case-keyword { 
            text-decoration: underline; 
            color: #63b3ed; 
            cursor: pointer; 
            font-weight: 500; 
        }
        .keyword:hover, .case-keyword:hover {
            color: #90cdf4; 
        }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); 
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; padding: 16px;
        }
        .modal-content {
            background-color: #2d3748; padding: 20px; border-radius: 8px;
            width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;
            text-align: left; color: #e2e8f0;
        }
        .modal-content.modal-lg { max-width: 600px; }
        .modal-content h3 { text-align: center; margin-bottom: 16px; }
        .story-summary-text { font-size: 0.9rem; line-height: 1.6;} 
        .story-summary-divider { border-top: 1px solid #4a5568; margin: 12px 0; }
        .personality-block { background-color: #374151; padding: 10px; border-radius: 6px; margin-top: 10px; border: 1px solid #4a5568; }
        #personality-modal { font-style: normal; }
        
        #rights-declaration-modal-content ul { list-style-type: decimal; margin-left: 20px; margin-top: 10px; }
        #rights-declaration-modal-content li { margin-bottom: 8px; line-height: 1.5; }
        #rights-declaration-modal-content p { margin-bottom: 10px; }

        .interrogation-loader{display:flex;flex-direction:column;align-items:center;justify-content:center;width:300px;margin:0 auto;padding:28px 20px 22px 20px;background:#1a2332;border-radius:18px;box-shadow:0 8px 24px #000a,0 2px 8px #14223b33;border:2px solid #356cc9}.badge{display:flex;align-items:center;gap:10px;font-family:'Inter','Noto Sans TC',Arial,sans-serif;font-weight:700;color:#f3f8ff;font-size:1.5rem;margin-bottom:16px;letter-spacing:2px}.badge-icon{font-size:2.3rem;filter:drop-shadow(0 1px 4px #262f51aa);margin-right:4px}.badge-text{letter-spacing:3px;text-shadow:0 2px 8px #356cc9aa}.loading-bar{width:90%;height:14px;border-radius:8px;background:#28344d;overflow:hidden;box-shadow:0 0 0 2px #3e5d96 inset,0 2px 6px #0005;margin-bottom:12px}.loading-fill{height:100%;width:0%;background:linear-gradient(90deg,#3ec6e0,#5e89ee 60%,#ffe57f 100%);border-radius:8px;animation:loadBarAnim 2.2s cubic-bezier(.65,.05,.36,1) infinite}.interrogation-text{color:#8cb5f1;margin-top:6px;font-size:1.1rem;letter-spacing:1.5px;font-family:'Noto Sans TC','Inter',Arial,sans-serif;text-shadow:0 1px 4px #1a2332cc;animation:textAnim 1.6s linear infinite alternate;min-height:1.5em;transition:opacity .5s}@keyframes loadBarAnim{0%{width:0%;opacity:.7}40%{width:87%;opacity:1}95%{width:99%;opacity:1}100%{width:0%;opacity:.7}}@keyframes textAnim{from{opacity:.6;letter-spacing:1px}to{opacity:1;letter-spacing:3px}}.tone-button{color:#e2e8f0;border:1px solid #718096;flex-grow:1;padding:8px 0;transition:background-color .2s,border-color .2s}.tone-button-calm{background-color:#2c5282}.tone-button-calm.active{background-color:#3182ce;border-color:#3182ce;color:#fff}.tone-button-angry{background-color:#9b2c2c}.tone-button-angry.active{background-color:#e53e3e;border-color:#e53e3e;color:#fff}.tone-button-provocative{background-color:#975a16}.tone-button-provocative.active{background-color:#d69e2e;border-color:#d69e2e;color:#fff}.loading-spinner{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;margin:0 auto}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.game-main-area{display:flex;flex-direction:column;height:calc(100vh - 16px);padding:8px}.interrogation-tip{font-size:.75rem;color:#a0aec0;text-align:center;margin-top:4px;padding:4px;background-color:#2a303c;border-radius:4px;min-height:2.5em;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}#suspect-status-details>div{display:flex;flex-direction:column;justify-content:space-around}#suspect-status-card{padding:8px;max-height:6rem;overflow:hidden}#suspect-status-details p{font-size:.68rem;line-height:1.2;margin-bottom:.1rem}@media (min-width:640px){#suspect-status-details p{font-size:.75rem}}.analysis-section-title{font-weight:700;color:#90cdf4;margin-top:10px;margin-bottom:4px}.analysis-section-content{margin-left:10px;white-space:pre-wrap}#initial-loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(26,32,44,.95);z-index:2000;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#e2e8f0}#initial-loading-message{font-size:1.1rem;margin-top:1rem;text-align:center;padding:0 10px}#error-message-area{color:#f56565;background-color:#4a2424;padding:8px 12px;border-radius:4px;margin-top:8px;text-align:center;font-size:.8rem;display:none;border:1px solid #c53030}.achievement-banner{margin-top:16px;padding:8px;background-color:#374151;border-radius:6px;font-size:1.1rem;color:#f6e05e}.confession-color-white{color:#e2e8f0}.confession-color-green{color:#68d391}.confession-color-blue{color:#63b3ed}.confession-color-pink{color:#f687b3}.confession-color-red{color:#fc8181}.confession-color-purple{color:#b794f4}.folder-loader{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:38px 0 22px 0}.folder-stack{position:relative;width:66px;height:56px}.folder{position:absolute;left:0;top:0;width:60px;height:38px;border-radius:5px 8px 6px 6px;background:#f1c672;box-shadow:0 6px 24px #886b3022,0 2px 5px #674f2133;border:2.2px solid #b99e61;z-index:1}.folder1{top:18px;left:8px;background:#d3b16a;z-index:1;transform:rotate(-7deg);box-shadow:0 2px 12px #a28d5e22}.folder2{top:9px;left:4px;background:#ebcc89;z-index:2;transform:rotate(3deg);box-shadow:0 2px 14px #e9c98433}.folder3{top:0;left:0;background:#f6d184;z-index:3;animation:folderShake 1.45s cubic-bezier(.66,-.11,.48,1.31) infinite alternate;box-shadow:0 8px 22px #e6ba6255,0 2px 8px #baa45333}@keyframes folderShake{0%{transform:rotate(-4deg) translateY(0)}15%{transform:rotate(1.2deg) translateY(-2px)}35%{transform:rotate(-1deg) translateY(1px)}65%{transform:rotate(1deg) translateY(-2.2px)}100%{transform:rotate(-2deg) translateY(0)}}.folder-pages{display:flex;align-items:center;justify-content:center;margin:14px 0 4px 0;gap:7px}.page-dot{width:16px;height:8px;background:#e8d199;border-radius:6px;opacity:.35;transition:all .2s;box-shadow:0 2px 6px #9e9e8455;border:1.2px solid #b6a26a}.page-dot.active{background:#f1c672;opacity:1;box-shadow:0 0 0 2px #ffe7ad55,0 4px 8px #e2b64944;border-color:#a2813b}.folder-text{margin-top:16px;color:#e6c175;font-size:1.13rem;font-family:'Noto Sans TC','Inter',Arial,sans-serif;letter-spacing:2px;text-shadow:0 2px 8px #9b782322;animation:fadeText 1.7s linear infinite alternate;min-height:1.8em}@keyframes fadeText{from{opacity:.6;letter-spacing:1px}to{opacity:1;letter-spacing:4px}}

    </style>
</head>
<body class="overscroll-y-contain">
    <audio id="background-music" src="./PensivePiano.mp3" loop></audio>

    <div id="initial-loading-overlay">
      <div class="interrogation-loader">
        <div class="badge">
          <span class="badge-icon">üïµÔ∏è‚Äç‚ôÇÔ∏è</span>
          <span class="badge-text">POLICE</span>
        </div>
        <div class="loading-bar">
          <div id="loading-fill-bar" class="loading-fill"></div>
        </div>
        <div class="interrogation-text" id="loading-animation-text">Ë≠¶ÊñπÊ≠£Âú®Â∏ÉÁΩÆÂÅµË®äÂÆ§‚Ä¶</div>
        <p class="text-sm text-gray-400 mt-1" id="initial-loading-message">ÈÅäÊà≤ÂàùÂßãÂåñ‰∏≠...</p>
      </div>
    </div>

    <div class="game-main-area container mx-auto" style="display: none;">
        <header class="mb-2 flex justify-between items-center">
            <span class="text-xs sm:text-sm text-gray-400 font-normal">
                ÂõûÂêà: <span id="round-count-header">0</span>
            </span>
            <h1 class="text-xl sm:text-2xl font-bold text-blue-400 text-center flex-grow">
                ÂØ©ÂïèÊåëÊà∞
            </h1>
            <span class="text-xs sm:text-sm text-gray-400 font-normal" title="Firebase Áî®Êà∂Ë≠òÂà•Á¢º (ÈÉ®ÂàÜÈ°ØÁ§∫)">
                 UID: <span id="user-id-display">ËºâÂÖ•‰∏≠...</span>
            </span>
        </header>

        <div class="flex gap-2 mb-2">
            <div id="avatar" class="w-20 h-20 sm:w-24 sm:h-24 rounded-md flex-shrink-0 flex flex-col items-center justify-center text-gray-300 text-xs p-0.5 text-center bg-gray-700 shadow">
                <img id="suspect-avatar-img" src="test00.png" alt="Â´åÁäØÈ†≠ÂÉè" class="w-full h-3/4 object-cover rounded-t-sm" onerror="this.onerror=null; this.src='https://placehold.co/80x60/718096/E2E8F0?text=È†≠ÂÉèËºâÂÖ•Â§±Êïó';">
                <div id="suspect-name-display" class="w-full bg-black bg-opacity-70 text-white text-xs py-1 text-center truncate rounded-b-sm h-1/4 flex items-center justify-center">
                    <span id="suspect-status-name">ËÆÄÂèñ‰∏≠...</span>
                </div>
            </div>
            <div id="suspect-status-card" class="flex-grow flex flex-col card">
                 <div id="suspect-status-details" class="grid grid-cols-2 gap-x-2 h-full">
                    <div class="flex flex-col justify-between">
                        <p>üó£Ô∏è<strong>È†ëÊäó:</strong> <span id="confession-meter-text-card" class="confession-color-white">Âº∑Á°¨</span></p>
                        <p>üìà<strong>ÂøÉÁéá:</strong> <span id="heart-rate">--</span> bpm</p>
                        <p>üßç<strong>ËÇ¢È´î:</strong> <span id="body-language" class="italic">ËÆÄÂèñ‰∏≠...</span></p>
                    </div>
                    <div class="flex flex-col justify-between">
                        <p>üò†<strong>Ë°®ÊÉÖ:</strong> <span id="facial-expression" class="italic">ËÆÄÂèñ‰∏≠...</span></p>
                        <p>ü©∏<strong>Ë°ÄÂ£ì:</strong> <span id="blood-pressure">--/--</span></p>
                        <p>üó£Ô∏è<strong>Ë™ûÊ∞£:</strong> <span id="voice-tone" class="italic">ËÆÄÂèñ‰∏≠...</span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-2">
            <button id="show-personal-details-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-md text-sm sm:text-base">üë§ ÂÄã‰∫∫Ë≥áÊñô</button>
            <button id="show-story-summary-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-3 rounded-md text-sm sm:text-base">üìú Ê°à‰ª∂Ê¶ÇË¶Å</button>
        </div>

        <div id="dialogue-area" class="dialogue-area mb-2"></div>

        <div id="interrogation-tip-area" class="interrogation-tip">‚ÄªË≤ºÂøÉÊèêÁ§∫Ôºö ÂÅµË®äÊèêÁ§∫ËºâÂÖ•‰∏≠...</div>
        <div id="error-message-area"></div>
        <div class="mt-auto pt-2">
            <textarea id="player-input" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base" rows="2" placeholder="Ëº∏ÂÖ•ÊÇ®ÁöÑÂïèÈ°å..."></textarea>
            <div class="mt-2 flex gap-1 sm:gap-2">
                <button class="tone-button tone-button-calm active rounded-md text-xs sm:text-sm" data-tone="Âπ≥Á∑©">ÔøΩ Âπ≥Á∑©</button>
                <button class="tone-button tone-button-angry rounded-md ml-1 text-xs sm:text-sm" data-tone="ÊÜ§ÊÄí">üò° ÊÜ§ÊÄí</button>
                <button class="tone-button tone-button-provocative rounded-md ml-1 text-xs sm:text-sm" data-tone="ÊåëÈáÅ">üòè ÊåëÈáÅ</button>
            </div>
            <div class="mt-2 flex gap-2">
                <button id="send-button" class="flex-grow bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 text-sm sm:text-base">
                    ÁôºÈÄÅ
                </button>
                <button id="demand-confession-button" class="w-1/4 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-md transition duration-150 text-xs sm:text-sm">
                    Ë¶ÅÊ±ÇË™çÁΩ™
                </button>
            </div>
        </div>
    </div>

    <div id="intro-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-300">üéâ Ê≠°Ëøé‰æÜÂà∞ÂØ©ÂïèÊåëÊà∞ üéâ</h3>
            <ul class="list-decimal list-inside mt-4 mb-6 space-y-2 text-sm text-gray-200">
                <li>Êú¨ÈÅäÊà≤ÊØèÊ¨°ÈñãÂ±ÄÈÉΩÊòØ<strong class="text-yellow-300">ÂÖ®Êñ∞ÂäáÊú¨</strong>ÔºåÊåëÊà∞ÁÑ°ÈôêÔºÅ</li>
                <li>ÈñãÂ±ÄÂæåË´ãÂÖàÊü•Áúã<strong class="text-indigo-300">„ÄêÊ°à‰ª∂Ê¶ÇË¶Å„Äë</strong>‰∫ÜËß£ÂÅµË®äÈáçÈªû„ÄÇ</li>
                <li>ÂÅµË®äÊôÇÂèØ‰ª•Áî®<strong class="text-green-300">‰∏âÁ®ÆÊÖãÂ∫¶</strong>ËàáÂ´åÁäØÊáâÂ∞ç„ÄÇ</li>
                <li>Êú¨ÈÅäÊà≤‰∏çÊñ∑<strong class="text-pink-300">ÂÑ™Âåñ‰∏≠</strong>ÔºåÊ≠°ËøéÁµ¶‰∫àÂª∫Ë≠∞ÔºÅ</li>
                <li>ÂØ©ÂïèÊàêÂäüËÆìÂ´åÁäØË™çÁΩ™ÔºåÊ≠°Ëøé<strong class="text-teal-300">ÂàÜ‰∫´Êà™Âúñ</strong>ÔºÅ</li>
            </ul>
            <button id="close-intro-modal-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">ÈñãÂßãÂÅµË®ä</button>
        </div>
    </div>

    <div id="personal-details-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-300">üë§ Â´åÁäØÂÄã‰∫∫Ë≥áÊñô</h3>
            <div id="modal-personal-details-content" class="text-sm grid grid-cols-2 gap-x-4">
                <div>
                    <p><strong>ÂßìÂêç:</strong> <span id="suspect-name-modal">ËÆÄÂèñ‰∏≠...</span></p>
                    <p><strong>Âπ¥Á¥Ä:</strong> <span id="age-modal">ËÆÄÂèñ‰∏≠...</span></p>
                    <p><strong>ÊÄßÂà•:</strong> <span id="gender-modal">ËÆÄÂèñ‰∏≠...</span></p>
                    <p><strong>ÁîüÊó•:</strong> <span id="dob-modal">ËÆÄÂèñ‰∏≠...</span></p>
                    <p><strong>ÊòüÂ∫ß:</strong> <span id="zodiac-modal">ËÆÄÂèñ‰∏≠...</span></p>
                    <p><strong>Ë°ÄÂûã:</strong> <span id="blood-type-modal">ËÆÄÂèñ‰∏≠...</span></p>
                </div>
                <div>
                    <p><strong>Â≠∏Ê≠∑:</strong> <span id="education-modal">ËÆÄÂèñ‰∏≠...</span></p>
                    <p><strong>Âá∫ÁîüÂú∞:</strong> <span id="birthplace-modal">ËÆÄÂèñ‰∏≠...</span></p>
                    <p><strong>ËÅ∑Ê•≠:</strong> <span id="occupation-modal">ËÆÄÂèñ‰∏≠...</span></p>
                    <p><strong>ÂÅ•Â∫∑ÁãÄÊÖã:</strong> <span id="health-status-modal">ËÆÄÂèñ‰∏≠...</span></p>
                    <p><strong>Âè£È†≠Á¶™:</strong> <span id="mannerism-modal">ËÆÄÂèñ‰∏≠...</span></p>
                </div>
                <div class="personality-block mt-3 col-span-2">
                    <p class="font-semibold mb-1">üé≠ ÂÄãÊÄßÊ¶ÇËø∞:</p>
                    <p id="personality-modal" class="text-sm">ËÆÄÂèñ‰∏≠...</p>
                </div>
            </div>
            <button onclick="document.getElementById('personal-details-modal').classList.add('hidden')" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">ÈóúÈñâ</button>
        </div>
    </div>

    <div id="story-summary-modal" class="modal hidden">
        <div class="modal-content modal-lg">
            <h3 class="text-xl font-bold text-blue-300">üìú Ê°à‰ª∂Ê¶ÇË¶Å</h3>
            <div id="modal-story-summary-content" class="story-summary-text">
                <div>
                    <p class="font-semibold">Ë¢´ÂÆ≥‰∫∫È©óÂ±çÂ†±Âëä:</p>
                    <span id="autopsy-report-modal-content">ËÆÄÂèñ‰∏≠...</span>
                </div>
                <hr class="story-summary-divider">
                <div>
                    <p class="font-semibold mt-2">Â∞çÂ´åÁäØ‰∏çÂà©ÁöÑÁõÆÂâçË≠âÊìö:</p>
                    <ul id="evidence-list-modal-content" class="list-disc list-inside ml-4"><li>ËÆÄÂèñ‰∏≠...</li></ul>
                </div>
                <hr class="story-summary-divider">
                <div>
                    <p class="font-semibold mt-2">Â´åÁäØË™øÊü•ÁñëÈªû:</p>
                    <ul id="doubts-list-modal-content" class="list-disc list-inside ml-4"><li>ËÆÄÂèñ‰∏≠...</li></ul>
                </div>
            </div>
            <button onclick="document.getElementById('story-summary-modal').classList.add('hidden')" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">ÈóúÈñâ</button>
        </div>
    </div>

    <div id="keyword-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="keyword-modal-title" class="text-xl font-bold text-blue-300 mb-0">üîë ÈóúÈçµÂ≠óË£úÂÖÖ</h3>
            <div id="keyword-folder-loader" class="folder-loader hidden">
                <div class="folder-stack">
                  <div class="folder folder1"></div> <div class="folder folder2"></div> <div class="folder folder3"></div>
                </div>
                <div class="folder-pages" id="keyword-folder-pages-bar"></div>
                <div class="folder-text" id="keyword-folder-page-text">Ë≥áÊñôÊ≠£Âú®Âëà‰∏ä‰∏≠‚Ä¶</div>
            </div>
            <p id="keyword-modal-text" class="mt-2">ÂÖßÂÆπAIÂä†Ëºâ‰∏≠Ë´ãÁ®çÂæå...</p>
            <button onclick="document.getElementById('keyword-modal').classList.add('hidden')" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">ÈóúÈñâ</button>
        </div>
    </div>

    <div id="rights-declaration-modal" class="modal hidden">
        <div class="modal-content modal-lg"> 
            <h3 class="text-xl font-bold text-blue-300">üìú Ê¨äÁõäÂÆ£ÂëäÊõ∏</h3>
            <div id="rights-declaration-modal-content" class="story-summary-text mt-4">
                <p>ËÆÄÂèñ‰∏≠...</p>
            </div>
            <button onclick="document.getElementById('rights-declaration-modal').classList.add('hidden')" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">ÈóúÈñâ</button>
        </div>
    </div>

    <div id="game-over-modal" class="modal hidden">
        <div class="modal-content text-center">
            <h3 id="game-over-title" class="text-2xl font-bold mb-4">‚öñÔ∏è ÂØ©ÂïèÁµêÊùü</h3>
            <p>Á∏ΩÂÖ±ËÄóË≤ªÂõûÂêàÊï∏: <span id="total-rounds">0</span></p>
            <div id="game-analysis-container" class="mt-4 text-left">
                 <p id="game-analysis-text" class="text-sm whitespace-pre-wrap">ÂàÜÊûê‰∏≠...</p>
            </div>
            <div id="achievement-banner" class="achievement-banner hidden">
                üèÖ <span id="achievement-title"></span>
            </div>
            <div class="mt-6 flex justify-center gap-4">
                 <button id="restart-game-button" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md">üîÑ ÈáçÊñ∞ÈñãÂßã</button>
                 <button id="close-game-over-modal-button" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">ÈóúÈñâ</button>
            </div>
        </div>
    </div>

    <div id="ai-thinking-modal" class="modal hidden">
        <div class="modal-content text-center">
            <div class="flex flex-col items-center justify-center min-h-[100px]">
                <p class="text-lg" id="ai-thinking-message">ü§ñ AIÊ≠£Âú®Âä™ÂäõÊÄùËÄÉ‰∏≠...</p>
                <p class="text-sm text-gray-400 mt-1">(Âõ†ÂÖßÂÆπË±êÂØåÂä†ËºâÂæà‰πÖÂ±¨Ê≠£Â∏∏)</p>
                <p class="text-xs text-gray-500 mt-1">(Ââµ‰ΩúËÄÖÈÇÑÂú®Âä™ÂäõÂÑ™Âåñ‰∏≠)</p>
            </div>
            <div class="loading-spinner my-4"></div>
        </div>
    </div>

<script type="module">
    // Firebase SDK Â∞éÂÖ•
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // DOM ÂÖÉÁ¥†Áç≤Âèñ
    const heartRateEl = document.getElementById('heart-rate');
    const bloodPressureEl = document.getElementById('blood-pressure');
    const facialExpressionEl = document.getElementById('facial-expression');
    const bodyLanguageEl = document.getElementById('body-language');
    const voiceToneEl = document.getElementById('voice-tone');
    const suspectStatusNameEl = document.getElementById('suspect-status-name');
    const suspectNameModalEl = document.getElementById('suspect-name-modal');
    const dobModalEl = document.getElementById('dob-modal');
    const zodiacModalEl = document.getElementById('zodiac-modal');
    const bloodTypeModalEl = document.getElementById('blood-type-modal');
    const ageModalEl = document.getElementById('age-modal');
    const genderModalEl = document.getElementById('gender-modal');
    const educationModalEl = document.getElementById('education-modal');
    const birthplaceModalEl = document.getElementById('birthplace-modal');
    const occupationModalEl = document.getElementById('occupation-modal');
    const healthStatusModalEl = document.getElementById('health-status-modal');
    const mannerismModalEl = document.getElementById('mannerism-modal');
    const personalityModalEl = document.getElementById('personality-modal');
    const autopsyReportModalContentEl = document.getElementById('autopsy-report-modal-content');
    const evidenceListModalContentEl = document.getElementById('evidence-list-modal-content');
    const doubtsListModalContentEl = document.getElementById('doubts-list-modal-content');
    const showPersonalDetailsButton = document.getElementById('show-personal-details-button');
    const showStorySummaryButton = document.getElementById('show-story-summary-button');
    const personalDetailsModal = document.getElementById('personal-details-modal');
    const storySummaryModal = document.getElementById('story-summary-modal');
    const dialogueAreaEl = document.getElementById('dialogue-area');
    const playerInputEl = document.getElementById('player-input');
    const sendButton = document.getElementById('send-button');
    const demandConfessionButton = document.getElementById('demand-confession-button');
    const toneButtons = document.querySelectorAll('.tone-button');
    const userIdDisplayEl = document.getElementById('user-id-display');
    const keywordModal = document.getElementById('keyword-modal');
    const keywordModalTitle = document.getElementById('keyword-modal-title');
    const keywordModalText = document.getElementById('keyword-modal-text');
    const keywordFolderLoaderEl = document.getElementById('keyword-folder-loader');
    const keywordFolderPagesBarEl = document.getElementById('keyword-folder-pages-bar');
    const keywordFolderPageTextEl = document.getElementById('keyword-folder-page-text');
    let keywordPageTimer = null;
    const gameOverModal = document.getElementById('game-over-modal');
    const gameOverTitle = document.getElementById('game-over-title');
    const totalRoundsEl = document.getElementById('total-rounds');
    const gameAnalysisContainerEl = document.getElementById('game-analysis-container');
    const gameAnalysisTextEl = document.getElementById('game-analysis-text');
    const achievementBannerEl = document.getElementById('achievement-banner');
    const achievementTitleEl = document.getElementById('achievement-title');
    const restartGameButton = document.getElementById('restart-game-button');
    const closeGameOverModalButton = document.getElementById('close-game-over-modal-button');
    const aiThinkingModal = document.getElementById('ai-thinking-modal');
    const aiThinkingMessageEl = document.getElementById('ai-thinking-message');
    const interrogationTipAreaEl = document.getElementById('interrogation-tip-area');
    const roundCountHeaderEl = document.getElementById('round-count-header');
    const confessionMeterTextCardEl = document.getElementById('confession-meter-text-card');
    const introModal = document.getElementById('intro-modal');
    const closeIntroModalButton = document.getElementById('close-intro-modal-button');
    const initialLoadingOverlay = document.getElementById('initial-loading-overlay');
    const initialLoadingMessageEl = document.getElementById('initial-loading-message');
    const loadingAnimationTextEl = document.getElementById('loading-animation-text');
    const gameMainAreaEl = document.querySelector('.game-main-area');
    const backgroundMusicEl = document.getElementById('background-music');
    const errorMessageAreaEl = document.getElementById('error-message-area');
    
    const rightsDeclarationModal = document.getElementById('rights-declaration-modal');
    const rightsDeclarationModalContentEl = document.getElementById('rights-declaration-modal-content');


    // --- ÈÖçÁΩÆÂçÄÂüü ---
    const BACKEND_URL = 'https://d1d5ef45-d04b-4a1c-be4b-64a0680c6847-00-xxpggv06ka2e.sisko.replit.dev/';
    const firebaseConfig = typeof __firebase_config !== 'undefined'
        ? JSON.parse(__firebase_config) 
        : { 
            apiKey: "AIzaSyCACjjC1S-9gj6hKCyfAedzH9kTf_JZwDE",
            authDomain: "aigame-fb578.firebaseapp.com",
            projectId: "aigame-fb578",
            storageBucket: "aigame-fb578.appspot.com", 
            messagingSenderId: "932095431807",
            appId: "1:932095431807:web:28aab493c770166102db4a"
          };
    
    const rightsDeclarationText = `
        <p>‰æùÊìö„ÄäÂàë‰∫ãË®¥Ë®üÊ≥ï„ÄãÁ¨¨95Ê¢ùÔºå‰Ω†‰∫´Êúâ‰ª•‰∏ãÊ¨äÂà©Ôºö</p>
        <ul>
            <li>‰∏Ä„ÄÅ‰Ω†ÊúâÊ¨ä‰øùÊåÅÁ∑òÈªòÔºåÁÑ°È†àÈÅïËÉåËá™Â∑±‰πãÊÑèÊÄùÈô≥Ëø∞„ÄÇ</li>
            <li>‰∫å„ÄÅ‰Ω†ÊúâÊ¨äÈÅ∏‰ªªËæØË≠∑‰∫∫ÔºåËã•ÈúÄÂæãÂ∏´ÂçîÂä©ÔºåÂèØÁ´ãÂç≥ÊèêÂá∫„ÄÇ</li>
            <li>‰∏â„ÄÅ‰Ω†ÊâÄË™™ÁöÑ‰∏ÄÂàáÔºåÂåÖÊã¨ÁèæÂú®ËàáÂæÄÂæåÁöÑÈô≥Ëø∞ÔºåÂùáÂèØËÉΩ‰ΩúÁÇ∫Êú¨Ê°àË≠âÊìö„ÄÇ</li>
        </ul>
        <p class="mt-2">Ë´ãÁ¢∫Ë™ç‰Ω†ÊòØÂê¶Ê∏ÖÊ•ö‰∏äËø∞Ê¨äÂà©ÔºüËã•ÈúÄÈÄ≤‰∏ÄÊ≠•Ë™™ÊòéÔºåÂèØÁ´ãÂç≥ÊèêÂá∫„ÄÇ</p>
    `;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    let userId = null;
    let currentGameId = null;
    let gameState = {};
    let initialLoadingTipInterval = null;
    let isMusicPlaying = false;

    function showThinkingModal(message = 'AIÊ≠£Âú®Âä™ÂäõÊÄùËÄÉ‰∏≠...') {
        if (aiThinkingModal && aiThinkingMessageEl) {
            aiThinkingMessageEl.textContent = `ü§ñ ${message}`;
            aiThinkingModal.classList.remove('hidden');
        }
    }

    function hideThinkingModal() {
        if (aiThinkingModal) aiThinkingModal.classList.add('hidden');
    }

    function getConfessionMeterTextAndColor(percentage) {
        if (percentage > 80) return { text: "ÊÖãÂ∫¶Âº∑Á°¨", colorClass: "confession-color-white" };
        if (percentage > 60) return { text: "ÊïÖ‰ΩúÈéÆÂÆö", colorClass: "confession-color-green" };
        if (percentage > 40) return { text: "Áï•È°ØÂãïÊêñ", colorClass: "confession-color-blue" };
        if (percentage > 20) return { text: "ÂøÉËôõÊÖå‰∫Ç", colorClass: "confession-color-pink" };
        if (percentage > 0) return { text: "ÁÄïËá®Â¥©ÊΩ∞", colorClass: "confession-color-red" };
        return { text: "Â∑≤ÁÑ∂Ë™çÁΩ™", colorClass: "confession-color-purple" };
    }

    function showErrorMessage(message) {
        if (errorMessageAreaEl) {
            errorMessageAreaEl.textContent = `‚ö†Ô∏è ÈåØË™§Ôºö${message}`;
            errorMessageAreaEl.style.display = 'block';
        }
        console.error("ÈåØË™§Ë®äÊÅØÈ°ØÁ§∫:", message);
    }

    function clearErrorMessage() {
        if (errorMessageAreaEl) {
            errorMessageAreaEl.textContent = '';
            errorMessageAreaEl.style.display = 'none';
        }
    }

    function playBackgroundMusic() {
        if (backgroundMusicEl && backgroundMusicEl.paused && !isMusicPlaying) {
            backgroundMusicEl.loop = true;
            backgroundMusicEl.play()
                .then(() => {
                    isMusicPlaying = true;
                    console.log("ËÉåÊôØÈü≥Ê®ÇÈñãÂßãÊí≠Êîæ„ÄÇ");
                })
                .catch(error => {
                    console.warn("ËÉåÊôØÈü≥Ê®ÇËá™ÂãïÊí≠ÊîæÂ§±Êïó„ÄÇ", error);
                });
        }
    }

    async function initializeFirebaseAndUser() {
        return new Promise(async (resolve, reject) => {
            try {
                await setPersistence(auth, browserLocalPersistence);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("ÂòóË©¶‰ΩøÁî®Ëá™Ë®Ç‰ª§ÁâåÁôªÂÖ• (Canvas Áí∞Â¢É)„ÄÇ");
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    console.log("ÁÑ°Ëá™Ë®Ç‰ª§ÁâåÔºåÂòóË©¶ÂåøÂêçÁôªÂÖ•„ÄÇ");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Ë™çË≠âÈåØË™§:", error);
                if (!auth.currentUser) { 
                    try {
                        console.warn("Áî±ÊñºÂÖàÂâçÁöÑË™çË≠âÈåØË™§ÔºåÂõûÈÄÄÂà∞ÂåøÂêçÁôªÂÖ•„ÄÇ");
                        await signInAnonymously(auth);
                    } catch (anonError) {
                        console.error("Âö¥ÈáçÈåØË™§ÔºöÂåøÂêçÁôªÂÖ•‰πüÂ§±Êïó:", anonError);
                        if (userIdDisplayEl) userIdDisplayEl.textContent = "Ë™çË≠âÂ§±Êïó";
                        showErrorMessage("Firebase Ë™çË≠âÂ§±ÊïóÔºåÈÉ®ÂàÜÁî®Êà∂Áõ∏ÈóúÂäüËÉΩÂèØËÉΩÁÑ°Ê≥ï‰ΩøÁî®„ÄÇ");
                        userId = `local_user_${crypto.randomUUID().substring(0,8)}`;
                        if (userIdDisplayEl) userIdDisplayEl.textContent = "Êú¨Ê©üÁî®Êà∂";
                        console.warn("‰ΩøÁî®Êú¨Âú∞ÁîüÊàêÁöÑÁî®Êà∂ ID„ÄÇ");
                        return resolve(userId); 
                    }
                }
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    if (userIdDisplayEl) userIdDisplayEl.textContent = userId.substring(0, 8) + "...";
                    console.log("‰ΩøÁî®ËÄÖÂ∑≤Ë™çË≠â„ÄÇUID:", userId);
                } else {
                    if (!userId) { 
                        userId = `local_user_${crypto.randomUUID().substring(0,8)}`;
                        if (userIdDisplayEl) userIdDisplayEl.textContent = "Êú¨Ê©üÁî®Êà∂";
                        console.warn("ÁÑ°Â∑≤Ë™çË≠â‰ΩøÁî®ËÄÖÔºå‰ΩøÁî®Êú¨Âú∞ÁîüÊàêÁöÑÁî®Êà∂ ID„ÄÇ");
                    }
                }
                resolve(userId); 
            });
        });
    }

    async function loadOrCreateNewGame() {
        clearErrorMessage();
        if (initialLoadingOverlay) initialLoadingOverlay.style.display = 'flex';
        if (gameMainAreaEl) gameMainAreaEl.style.display = 'none';
        if (initialLoadingMessageEl) initialLoadingMessageEl.textContent = "ÈÄ£Êé•‰º∫ÊúçÂô®‰∏¶ÂâµÂª∫Êñ∞ÈÅäÊà≤...";
        startInitialLoadingAnimation();

        try {
            if (BACKEND_URL === 'YOUR_REPLIT_BACKEND_URL' || !BACKEND_URL.startsWith('https://')) {
                throw new Error("ÂæåÁ´Ø API Á∂≤ÂùÄ (BACKEND_URL) Â∞öÊú™Ê≠£Á¢∫Ë®≠ÂÆö„ÄÇ");
            }

            const userAuthId = await initializeFirebaseAndUser();
            if (!userAuthId) { 
                throw new Error("ÁÑ°Ê≥ïÁç≤ÂèñÁî®Êà∂Ë≠òÂà•Á¢ºÔºåÁÑ°Ê≥ïÂâµÂª∫ÈÅäÊà≤„ÄÇ");
            }

            if (initialLoadingMessageEl) initialLoadingMessageEl.textContent = "Ê≠£Âú®Âêë‰º∫ÊúçÂô®Ë´ãÊ±ÇÊñ∞ÈÅäÊà≤...";

            const response = await fetch(`${BACKEND_URL}game/new`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userAuthId })
            });

            if (initialLoadingMessageEl) initialLoadingMessageEl.textContent = "Ê≠£Âú®ËôïÁêÜ‰º∫ÊúçÂô®ÂõûÊáâ...";

            if (!response.ok) {
                let errorText = `‰º∫ÊúçÂô®ÈåØË™§: ${response.status} ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    errorText = errorData.error || errorText;
                } catch (e) { /* Ëß£Êûê JSON Â§±ÊïóÔºå‰ΩøÁî®ÂéüÂßãÈåØË™§ÊñáÂ≠ó */ }
                throw new Error(errorText);
            }
            gameState = await response.json();
            currentGameId = gameState.gameId;

            if (initialLoadingMessageEl) initialLoadingMessageEl.textContent = "ÈÅäÊà≤Ë≥áÊñôËºâÂÖ•ÂÆåÊàêÔºÅÊ∫ñÂÇôÈñãÂßã...";
            updateUI(gameState); 

            if (initialLoadingOverlay) initialLoadingOverlay.style.display = 'none';
            stopInitialLoadingAnimation();
            if (gameMainAreaEl) gameMainAreaEl.style.display = 'flex';
            if (introModal) introModal.classList.remove('hidden');
            playBackgroundMusic(); 

        } catch (error) {
            console.error("ÂâµÂª∫Êñ∞ÈÅäÊà≤Â§±Êïó:", error);
            const friendlyErrorMessage = `ÂâµÂª∫Êñ∞ÈÅäÊà≤Â§±ÊïóÔºö${error.message} Ë´ãÊ™¢Êü•ÂæåÁ´Ø‰º∫ÊúçÂô® (${BACKEND_URL}) ÊòØÂê¶Ê≠£Âú®ÈÅãË°åÔºå‰∏¶‰∏îÁ∂≤Ë∑ØÈÄ£Á∑öÊ≠£Â∏∏„ÄÇ`;
            if (initialLoadingMessageEl) initialLoadingMessageEl.textContent = friendlyErrorMessage;
            showErrorMessage(friendlyErrorMessage);
            stopInitialLoadingAnimation();
        }
    }
    
    function processTextToKeywordLinks(text, defaultKeywordClass = "keyword") {
        if (typeof text !== 'string') return text;
        return text.replace(/(##|@@)(.*?)\1/g, (match, p1, keywordText) => {
            let keywordClass = defaultKeywordClass;
            let dataType = "keyword"; 

            if (keywordText === "Ê¨äÁõäÂÆ£ÂëäÊõ∏" && p1 === "##") {
                keywordClass = "case-keyword rights-declaration-link"; 
                dataType = "rights-declaration"; 
            } else if (p1 === "##") {
                 keywordClass = "case-keyword"; 
            } else if (p1 === "@@") {
                 keywordClass = "keyword"; 
            }
            return `<span class="${keywordClass}" data-keyword="${keywordText}" data-type="${dataType}">${keywordText}</span>`;
        }).replace(/\n/g, "<br>");
    }


    function updateUI(state) {
        if (!state) {
            console.warn("updateUI Ë¢´Ë™øÁî®ÊôÇ state ÁÇ∫Á©∫„ÄÇ");
            return;
        }
        gameState = state; 

        const suspectAvatarImg = document.getElementById('suspect-avatar-img');
        if (suspectAvatarImg) {
            suspectAvatarImg.src = 'test00.png'; // Á¢∫‰øùË∑ØÂæëÊ≠£Á¢∫
        }

        if (roundCountHeaderEl) roundCountHeaderEl.textContent = state.round ?? '0';

        const meterInfo = getConfessionMeterTextAndColor(state.confessionMeter ?? 100);
        if (confessionMeterTextCardEl) {
            confessionMeterTextCardEl.textContent = meterInfo.text;
            confessionMeterTextCardEl.className = 'confession-color-white'; 
            confessionMeterTextCardEl.classList.add(meterInfo.colorClass);
        }

        if (state.suspect) {
            const suspect = state.suspect;
            if(suspectStatusNameEl) suspectStatusNameEl.textContent = suspect.name ?? "ËÆÄÂèñ‰∏≠...";
            if(heartRateEl) heartRateEl.textContent = suspect.heartRate ?? "--";
            if(bloodPressureEl) bloodPressureEl.textContent = suspect.bloodPressure ?? "--/--";
            if(facialExpressionEl) facialExpressionEl.textContent = suspect.facialExpression ?? "ËÆÄÂèñ‰∏≠...";
            if(bodyLanguageEl) bodyLanguageEl.textContent = suspect.bodyLanguage ?? "ËÆÄÂèñ‰∏≠...";
            if(voiceToneEl) voiceToneEl.textContent = suspect.voiceTone ?? "ËÆÄÂèñ‰∏≠...";

            if(suspectNameModalEl) suspectNameModalEl.textContent = suspect.name ?? "N/A";
            if(ageModalEl) ageModalEl.textContent = suspect.age ?? "N/A";
            if(genderModalEl) genderModalEl.textContent = suspect.gender ?? "N/A";
            if(dobModalEl) dobModalEl.textContent = suspect.dob ?? "N/A";
            if(zodiacModalEl) zodiacModalEl.textContent = suspect.zodiac ?? "N/A";
            if(bloodTypeModalEl) bloodTypeModalEl.textContent = suspect.bloodType ?? "N/A";
            if(educationModalEl) educationModalEl.textContent = suspect.education ?? "N/A";
            if(birthplaceModalEl) birthplaceModalEl.textContent = suspect.birthplace ?? "N/A";
            if(occupationModalEl) occupationModalEl.textContent = suspect.occupation ?? "N/A";
            if(healthStatusModalEl) healthStatusModalEl.textContent = suspect.healthStatus ?? "N/A";
            if(mannerismModalEl) mannerismModalEl.textContent = suspect.mannerism ?? "ÁÑ°";
            if(personalityModalEl) personalityModalEl.textContent = suspect.personality ?? "ËÆÄÂèñ‰∏≠...";
        }

        if (state.caseDetails) {
            const caseDetails = state.caseDetails;
            if(autopsyReportModalContentEl) {
                autopsyReportModalContentEl.innerHTML = processTextToKeywordLinks(caseDetails.autopsyReport, "case-keyword");
            }
            if(evidenceListModalContentEl) {
                evidenceListModalContentEl.innerHTML = (caseDetails.evidence ?? [])
                    .map(e => `<li data-id="${e.id || ''}">${processTextToKeywordLinks(e.text, "case-keyword")}</li>`)
                    .join('');
            }
            if(doubtsListModalContentEl) {
                doubtsListModalContentEl.innerHTML = (caseDetails.doubts ?? [])
                    .map(d => `<li data-id="${d.id || ''}">${processTextToKeywordLinks(d.text, "case-keyword")}</li>`)
                    .join('');
            }
        }

        if (dialogueAreaEl) dialogueAreaEl.innerHTML = ''; 
        if (state.dialogueHistory && Array.isArray(state.dialogueHistory)) {
            state.dialogueHistory.forEach(msg => addMessageToDialogue(msg.speaker, msg.text, msg.tone));
        }

        if (interrogationTipAreaEl && state.interrogationTip) {
            interrogationTipAreaEl.textContent = "‚ÄªË≤ºÂøÉÊèêÁ§∫Ôºö " + state.interrogationTip;
        }
        
        bindKeywordClickEvents(); 

        if (state.gameOver) {
            if(gameOverTitle) gameOverTitle.textContent = (state.confessionMeter != null && state.confessionMeter <= 0) ? "‚öñÔ∏è ÂØ©ÂïèÊàêÂäüÔºÅ" : "‚öñÔ∏è ÂØ©ÂïèÂ§±ÊïóÔºÅ";
            if(totalRoundsEl) totalRoundsEl.textContent = state.round ?? '0';

            if(gameAnalysisContainerEl && typeof state.gameAnalysis === 'object' && state.gameAnalysis.interrogationStyle) {
                gameAnalysisContainerEl.innerHTML = `
                    <p class="analysis-section-title">1. ÂÅµË®äÂì°ÂØ©ÂïèÈ¢®Ê†ºÂàÜÊûê:</p>
                    <p class="analysis-section-content">${state.gameAnalysis.interrogationStyle}</p>
                    <p class="analysis-section-title">2. ËàáÂ´åÁäØÈ¨•Êô∫ÈÅéÁ®ãÊäÄÂ∑ßÂàÜÊûê:</p>
                    <p class="analysis-section-content">${state.gameAnalysis.techniqueAnalysis}</p>
                    <p class="analysis-section-title">3. ÂàÜÊûêÁé©ÂÆ∂Âú®ÁèæÂØ¶‰∏ñÁïåÊΩõÂú®‰∫∫Ê†ºÁâπË≥™:</p>
                    <p class="analysis-section-content">${state.gameAnalysis.playerPersonalityTrait}</p>
                `;
                if(achievementBannerEl && achievementTitleEl && state.gameAnalysis.achievementTitle){
                    achievementTitleEl.textContent = state.gameAnalysis.achievementTitle;
                    achievementBannerEl.classList.remove('hidden');
                } else if (achievementBannerEl) {
                    achievementBannerEl.classList.add('hidden');
                }
            } else if (gameAnalysisContainerEl) { 
                gameAnalysisContainerEl.innerHTML = `<p class="analysis-section-content">${typeof state.gameAnalysis === 'string' ? state.gameAnalysis : "ÂàÜÊûêÁîüÊàêÂ§±ÊïóÊàñÊ†ºÂºè‰∏çÁ¨¶„ÄÇ"}</p>`;
                 if(achievementBannerEl) achievementBannerEl.classList.add('hidden');
            }
            if(gameOverModal) gameOverModal.classList.remove('hidden');
        } else {
            if(gameOverModal) gameOverModal.classList.add('hidden');
        }
    } 

    function bindKeywordClickEvents() {
        document.querySelectorAll('.keyword, .case-keyword').forEach(el => {
            el.onclick = () => {
                const keyword = el.dataset.keyword;
                const type = el.dataset.type; 

                if (type === "rights-declaration") {
                    if (rightsDeclarationModalContentEl && rightsDeclarationModal) {
                        rightsDeclarationModalContentEl.innerHTML = rightsDeclarationText;
                        rightsDeclarationModal.classList.remove('hidden');
                    } else {
                        console.error("Ê¨äÁõäÂÆ£Âëä Modal ÊàñÂÖ∂ÂÖßÂÆπÂÖÉÁ¥†Êú™ÊâæÂà∞„ÄÇ");
                    }
                } else {
                    if (keywordModalTitle) keywordModalTitle.textContent = `üîë ÈóúÊñº„Äå${keyword}„Äç`;
                    fetchKeywordInfo(keyword); 
                    if (keywordModal) keywordModal.classList.remove('hidden'); 
                }
            };
        });
    }

    function addMessageToDialogue(speaker, text, tone = null) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('dialogue-bubble');
        let messageContent = text ?? ""; 

        if (speaker === 'Player') {
            messageDiv.classList.add('player-bubble');
            const displayTone = tone || gameState.selectedTone || "Êú™Áü•";
            messageContent = `(Ë™ûÊ∞£Ôºö${displayTone}) ${messageContent}`;
            switch (displayTone) {
                case 'Âπ≥Á∑©': messageDiv.classList.add('player-bubble-calm'); break;
                case 'ÊÜ§ÊÄí': messageDiv.classList.add('player-bubble-angry'); break;
                case 'ÊåëÈáÅ': messageDiv.classList.add('player-bubble-provocative'); break;
            }
        } else if (speaker === 'Ë≠¶ÂÆò') {
            messageDiv.classList.add('officer-bubble');
            messageContent = `<strong>Ë≠¶ÂÆòÔºö</strong> ${messageContent}`;
        } else { 
            messageDiv.classList.add('ai-bubble');
        }

        messageDiv.innerHTML = processTextToKeywordLinks(messageContent, "keyword"); 

        if (dialogueAreaEl) {
            dialogueAreaEl.appendChild(messageDiv);
            dialogueAreaEl.scrollTop = dialogueAreaEl.scrollHeight; 
        }
        
        bindKeywordClickEvents(); 
    }

    async function fetchKeywordInfo(keyword) {
        if (!currentGameId) {
            console.error("ÈÅäÊà≤ ID Êú™Ë®≠ÂÆöÔºåÁÑ°Ê≥ïÁç≤ÂèñÈóúÈçµÂ≠óË≥áË®ä„ÄÇ");
            if(keywordModalText) keywordModalText.textContent = "ÈåØË™§ÔºöÈÅäÊà≤Êú™ÂàùÂßãÂåñ„ÄÇ";
            return;
        }
        clearErrorMessage();

        if(keywordModalText) keywordModalText.style.display = 'none'; 
        if(keywordFolderLoaderEl) keywordFolderLoaderEl.classList.remove('hidden'); 

        const totalPages = 4; 
        let currentPage = 0;
        if(keywordFolderPagesBarEl) keywordFolderPagesBarEl.innerHTML = ''; 
        function renderKeywordPagesBar() {
            let html = '';
            for (let i = 0; i < totalPages; i++) {
                html += `<div class="page-dot${i === currentPage ? ' active' : ''}"></div>`;
            }
            if(keywordFolderPagesBarEl) keywordFolderPagesBarEl.innerHTML = html;
        }
        function updateKeywordPage() {
            currentPage = (currentPage + 1) % totalPages;
            renderKeywordPagesBar();
            if(keywordFolderPageTextEl) keywordFolderPageTextEl.textContent = `Á¨¨ ${currentPage + 1} / ${totalPages} È†ÅÔºåË≥áÊñôÊ≠£Âú®Âëà‰∏ä‰∏≠‚Ä¶`;
        }
        renderKeywordPagesBar(); 
        if(keywordFolderPageTextEl) keywordFolderPageTextEl.textContent = `Á¨¨ 1 / ${totalPages} È†ÅÔºåË≥áÊñôÊ≠£Âú®Âëà‰∏ä‰∏≠‚Ä¶`;

        if (keywordPageTimer) clearInterval(keywordPageTimer); 
        keywordPageTimer = setInterval(updateKeywordPage, 700); 

        try {
            const response = await fetch(`${BACKEND_URL}game/${currentGameId}/keyword?keyword=${encodeURIComponent(keyword)}`);
            if (!response.ok) {
                let errorText = `‰º∫ÊúçÂô®ÈåØË™§: ${response.status} ${response.statusText}`;
                try { const errorData = await response.json(); errorText = errorData.error || errorText; } catch (e) { /* ignore */ }
                throw new Error(errorText);
            }
            const data = await response.json();
            // console.log(`[DEBUG] fetchKeywordInfo - Received data for "${keyword}":`, data); 

            if (keywordModalText) {
                let cleanText = data.information; 
                if (typeof cleanText === 'string') {
                    cleanText = cleanText.replace(/##(.*?)##/g, '$1');
                    cleanText = cleanText.replace(/@@(.*?)@@/g, '$1');
                    cleanText = cleanText.replace(/\n/g, "<br>");
                } else {
                    cleanText = "ÁÑ°Ê≥ïËºâÂÖ•ÊúâÊïàÁöÑË£úÂÖÖË≥áË®ä„ÄÇ"; 
                }
                keywordModalText.innerHTML = cleanText;
            }
        } catch (error) {
            console.error(`Áç≤ÂèñÈóúÈçµÂ≠ó "${keyword}" Ë≥áË®äÂ§±Êïó:`, error);
            const friendlyErrorMessage = `ÁÑ°Ê≥ïËºâÂÖ•ÈóúÊñº„Äå${keyword}„ÄçÁöÑË≥áË®äÔºö${error.message}`;
            if (keywordModalText) keywordModalText.textContent = friendlyErrorMessage;
            showErrorMessage(friendlyErrorMessage); 
        } finally {
            if (keywordPageTimer) clearInterval(keywordPageTimer); 
            if(keywordFolderLoaderEl) keywordFolderLoaderEl.classList.add('hidden'); 
            if(keywordModalText) keywordModalText.style.display = 'block'; 
        }
    }

    async function handlePlayerTurn(isDemandConfession = false) {
        if (!currentGameId) {
            console.error("ÈÅäÊà≤ ID Êú™Ë®≠ÂÆöÔºåÁÑ°Ê≥ïÂü∑Ë°åÁé©ÂÆ∂Âãï‰Ωú„ÄÇ");
            showErrorMessage("ÈåØË™§ÔºöÈÅäÊà≤Êú™Ê≠£Á¢∫ÂàùÂßãÂåñÔºåË´ãÈáçÊñ∞ËºâÂÖ•„ÄÇ");
            return;
        }
        clearErrorMessage(); // Ê∏ÖÈô§‰πãÂâçÁöÑÈåØË™§Ë®äÊÅØ

        const playerMessage = playerInputEl.value.trim();
        
        // ‰ΩúÂºäÊåá‰ª§Ê™¢Êü•
        const cheatCodes = ["88888888", "88888889", "88888887"];
        if (!isDemandConfession && cheatCodes.includes(playerMessage)) {
            console.log(`ÂÅµÊ∏¨Âà∞‰ΩúÂºäÊåá‰ª§: ${playerMessage}`);
            showThinkingModal(`Ê≠£Âú®ËôïÁêÜ‰ΩúÂºäÊåá‰ª§ ${playerMessage}...`);
            sendButton.disabled = true;
            demandConfessionButton.disabled = true;

            try {
                const response = await fetch(`${BACKEND_URL}game/${currentGameId}/cheat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cheat_code: playerMessage })
                });

                if (!response.ok) {
                    let errorText = `‰ΩúÂºäÊåá‰ª§ÈåØË™§: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || errorText;
                    } catch (e) { /* ignore */ }
                    throw new Error(errorText);
                }
                const updatedGameState = await response.json();
                updateUI(updatedGameState);
                playerInputEl.value = ''; 
            } catch (error) {
                console.error("‰ΩúÂºäÊåá‰ª§ËôïÁêÜÂ§±Êïó:", error);
                showErrorMessage(`‰ΩúÂºäÊåá‰ª§Â§±Êïó: ${error.message}`);
            } finally {
                hideThinkingModal();
                 if (!(gameState && gameState.gameOver)) {
                    sendButton.disabled = false;
                    demandConfessionButton.disabled = false;
                }
            }
            return; 
        }

        // Ê≠£Â∏∏ÁöÑÁé©ÂÆ∂ÂõûÂêàÈÇèËºØ
        if (!isDemandConfession && !playerMessage) return; 

        sendButton.disabled = true;
        demandConfessionButton.disabled = true;
        const originalSendButtonText = sendButton.innerHTML;
        const originalDemandButtonText = demandConfessionButton.textContent;

        if (isDemandConfession) {
            demandConfessionButton.innerHTML = '<div class="loading-spinner !w-4 !h-4 border-t-white mx-auto"></div>';
        } else {
            sendButton.innerHTML = '<div class="loading-spinner !w-5 !h-5 border-t-white"></div>'; 
        }
        showThinkingModal(isDemandConfession ? 'Ê≠£Âú®Ë¶ÅÊ±ÇÂ∞çÊñπË™çÁΩ™...' : 'AIÊ≠£Âú®ÂàÜÊûêÊÇ®ÁöÑËº∏ÂÖ•...');

        const currentTone = gameState.selectedTone || "Âπ≥Á∑©"; 
        const payload = {
            message: isDemandConfession ? "" : playerMessage, 
            tone: isDemandConfession ? "ÊÜ§ÊÄí" : currentTone, 
            isDemandConfession: isDemandConfession
        };

        try {
            const response = await fetch(`${BACKEND_URL}game/${currentGameId}/action`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                let errorText = `‰º∫ÊúçÂô®ÈåØË™§: ${response.status} ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    errorText = errorData.error || errorText;
                    if (errorData.gameState && errorData.error === "ÈÅäÊà≤Â∑≤ÁµêÊùü") {
                        console.warn("ÂòóË©¶Âú®Â∑≤ÁµêÊùüÁöÑÈÅäÊà≤‰∏≠Âü∑Ë°åÂãï‰Ωú„ÄÇ");
                        updateUI(errorData.gameState); 
                        return; 
                    }
                } catch (e) { /* Ëß£Êûê JSON Â§±ÊïóÔºå‰ΩøÁî®ÂéüÂßãÈåØË™§ÊñáÂ≠ó */ }
                throw new Error(errorText);
            }
            const updatedGameState = await response.json();
            updateUI(updatedGameState);
            if (!isDemandConfession) playerInputEl.value = ''; 
        } catch (error) {
            console.error("Áé©ÂÆ∂ÂõûÂêàËôïÁêÜÂ§±Êïó:", error);
            showErrorMessage(`Êìç‰ΩúÂ§±Êïó: ${error.message}`);
        } finally {
            hideThinkingModal();
            if (!(gameState && gameState.gameOver)) {
                sendButton.disabled = false;
                demandConfessionButton.disabled = false;
                sendButton.innerHTML = originalSendButtonText;
                demandConfessionButton.textContent = originalDemandButtonText;
            }
        }
    }

    function restartGame() {
        if(gameOverModal) gameOverModal.classList.add('hidden');
        loadOrCreateNewGame(); 
    }

    const initialLoadingTips = [
        "Ë≠¶ÊñπÊ≠£Âú®Â∏ÉÁΩÆÂÅµË®äÂÆ§‚Ä¶", "Ê™¢Êü•ÈåÑÈü≥ËàáÁõ£ÊéßË®≠ÂÇô‰∏≠‚Ä¶", "Ê°à‰ª∂Ë≥áÊñôË™øÈñ±‰∏≠ÔºåË´ãÁ®çÂÄô‚Ä¶",
        "Â∞áÂ´åÁäØÂ∏∂ÂæÄÂÅµË®äÂÆ§‚Ä¶", "Ê∫ñÂÇôË™øÊü•Ë≠âÊìö‰∏≠‚Ä¶", "Ê™¢Êü•Á≠ÜÈåÑËàáÁõ∏ÈóúÂç∑ÂÆó‚Ä¶",
        "ÈñãÂïüÁèæÂ†¥ÊîùÂΩ±Ê©üËàáÈ∫•ÂÖãÈ¢®‚Ä¶", "ÂÆâÊéíËßÄÂØü‰∫∫Âì°ÈÄ≤ÂÖ•ÊöóÊàø‚Ä¶", "Ê°àÁôºÁèæÂ†¥Ë≥áÊñôÂêåÊ≠•‰∏≠‚Ä¶",
        "Ê™¢Êü•Â´åÁäØÂøÉÁêÜÁãÄÊÖã‚Ä¶", "ÂØ©Ê†∏Ë≠â‰æõÊ∏ÖÂñÆËàáÁ≠ÜÈåÑ‚Ä¶", "ÂÅµË®äÂ∞àÂÆ∂Âç≥Â∞áÈÄ≤ÂÖ•ÁèæÂ†¥‚Ä¶",
        "Ë≠¶ÂÆòÊ≠£Âú®Á©øÊà¥Èò≤Ë≠∑Ë£ùÂÇô‚Ä¶", "Ê∫ñÂÇôÂØ©ÂïèÁ≠ñÁï•ËàáÂ∞çÁ≠ñ‚Ä¶", "Ê°à‰ª∂Ë≥áÊñôÂä†ÂØÜÂÇ≥Ëº∏‰∏≠‚Ä¶"
    ];
    let lastTipIdx = 0;

    function startInitialLoadingAnimation() {
        if (!loadingAnimationTextEl) return;
        loadingAnimationTextEl.textContent = initialLoadingTips[0]; 
        if (initialLoadingTipInterval) clearInterval(initialLoadingTipInterval);
        initialLoadingTipInterval = setInterval(() => {
            let idx;
            do {
                idx = Math.floor(Math.random() * initialLoadingTips.length);
            } while (idx === lastTipIdx && initialLoadingTips.length > 1); 
            lastTipIdx = idx;
            loadingAnimationTextEl.style.opacity = 0;
            setTimeout(() => {
                loadingAnimationTextEl.textContent = initialLoadingTips[idx];
                loadingAnimationTextEl.style.opacity = 1;
            }, 400); 
        }, 3000); 
    }

    function stopInitialLoadingAnimation() {
        if (initialLoadingTipInterval) clearInterval(initialLoadingTipInterval);
        initialLoadingTipInterval = null;
    }


    // --- ‰∫ã‰ª∂Áõ£ËÅΩÂô® ---
    if (closeIntroModalButton) {
        closeIntroModalButton.addEventListener('click', () => {
            if (introModal) introModal.classList.add('hidden');
            playBackgroundMusic(); 
        });
    }
    if (sendButton) sendButton.addEventListener('click', () => handlePlayerTurn(false));
    if (demandConfessionButton) demandConfessionButton.addEventListener('click', () => handlePlayerTurn(true));
    if (closeGameOverModalButton) {
        closeGameOverModalButton.addEventListener('click', () => {
            if (gameOverModal) gameOverModal.classList.add('hidden');
        });
    }
    if (playerInputEl) {
        playerInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); 
                handlePlayerTurn(false);
            }
        });
    }
    toneButtons.forEach(button => {
        button.addEventListener('click', () => {
            toneButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            if (gameState) gameState.selectedTone = button.dataset.tone; 
        });
    });
    if (showPersonalDetailsButton) showPersonalDetailsButton.addEventListener('click', () => personalDetailsModal.classList.remove('hidden'));
    if (showStorySummaryButton) showStorySummaryButton.addEventListener('click', () => storySummaryModal.classList.remove('hidden'));
    if (restartGameButton) restartGameButton.addEventListener('click', restartGame);

    // --- È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂü∑Ë°å ---
    window.addEventListener('load', () => {
        loadOrCreateNewGame();
    });

</script>
</body>
</html>
