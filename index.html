<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€ªç¸é¤Šæˆå°æˆ° Demo - V15 (UIèˆ‡åŠŸèƒ½èª¿æ•´)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Dark Theme (Default) */
            --bg-primary-dark: #0d1117; 
            --bg-panel-dark: #161b22;   
            --bg-slot-dark: #010409;    
            --border-color-dark: #30363d; 
            --text-primary-dark: #c9d1d9; 
            --text-secondary-dark: #8b949e;
            --accent-color-dark: #58a6ff;   
            --accent-hover-dark: #79c0ff; 
            --success-color-dark: #3fb950;  
            --danger-color-dark: #f85149;   
            --danger-hover-dark: #da3633;
            --warning-color-dark: #d29922;  
            --button-text-dark: #c9d1d9; 
            --button-primary-bg-dark: var(--accent-color-dark);
            --button-primary-hover-bg-dark: var(--accent-hover-dark);
            --button-primary-text-dark: #ffffff; 
            
            --button-secondary-bg-dark: #21262d;
            --button-secondary-hover-bg-dark: #30363d;
            --button-secondary-text-dark: var(--text-primary-dark);

            --button-danger-bg-dark: var(--danger-color-dark);
            --button-danger-hover-bg-dark: var(--danger-hover-dark);
            --button-danger-text-dark: #ffffff;

            --button-success-bg-dark: var(--success-color-dark);
            --button-success-hover-bg-dark: color-mix(in srgb, var(--success-color-dark) 85%, black);
            --button-success-text-dark: #ffffff;
            
            --button-warning-bg-dark: var(--warning-color-dark);
            --button-warning-hover-bg-dark: color-mix(in srgb, var(--warning-color-dark) 85%, black);
            --button-warning-text-dark: #ffffff;


            /* Element Colors (Text & Background) Dark Theme */
            --element-fire-text-dark: #f97583;       --element-fire-bg-dark: rgba(249, 117, 131, 0.15);
            --element-water-text-dark: #79c0ff;      --element-water-bg-dark: rgba(121, 192, 255, 0.15);
            --element-wood-text-dark: #56d364;       --element-wood-bg-dark: rgba(86, 211, 100, 0.15);
            --element-gold-text-dark: #e3b341;       --element-gold-bg-dark: rgba(227, 179, 65, 0.2); 
            --element-earth-text-dark: #b08860;      --element-earth-bg-dark: rgba(176, 136, 96, 0.15);
            --element-light-text-dark: #f0f6fc;      --element-light-bg-dark: rgba(200, 200, 210, 0.2); 
            --element-dark-text-dark: #848d97;       --element-dark-bg-dark: rgba(132, 141, 151, 0.15);
            --element-poison-text-dark: #d87ff8;     --element-poison-bg-dark: rgba(216, 127, 248, 0.15);
            --element-wind-text-dark: #6ef0db;       --element-wind-bg-dark: rgba(110, 240, 219, 0.15);
            --element-mix-text-dark: #a0a0c0;        --element-mix-bg-dark: rgba(160, 160, 192, 0.15);   

            /* Rarity Colors (Text & Background) Dark Theme */
            --rarity-common-text-dark: var(--text-primary-dark);         
            --rarity-rare-text-dark: var(--accent-color-dark);           
            --rarity-elite-text-dark: #ff704d; /* More distinct red for Elite */    
            --rarity-legendary-text-dark: var(--element-gold-text-dark); 
            --rarity-mythical-text-dark: var(--element-poison-text-dark);


            /* Light Theme */
            --bg-primary-light: #ffffff;   
            --bg-panel-light: #f6f8fa;     
            --bg-slot-light: #eaeef2;      
            --border-color-light: #d0d7de;   
            --text-primary-light: #1f2328;   
            --text-secondary-light: #57606a;
            --accent-color-light: #0969da;   
            --accent-hover-light: #0550ae;
            --success-color-light: #1a7f37;  
            --danger-color-light: #cf222e;   
            --danger-hover-light: #a40e26;
            --warning-color-light: #9a6700;  
            --button-text-light: #24292f; 
            --button-primary-bg-light: var(--accent-color-light);
            --button-primary-hover-bg-light: var(--accent-hover-light);
            --button-primary-text-light: #ffffff;

            --button-secondary-bg-light: #f0f2f5; /* Slightly different for better contrast */
            --button-secondary-hover-bg-light: #e1e4e8; 
            --button-secondary-text-light: var(--text-primary-light);

            --button-danger-bg-light: var(--danger-color-light);
            --button-danger-hover-bg-light: var(--danger-hover-light);
            --button-danger-text-light: #ffffff;

            --button-success-bg-light: var(--success-color-light);
            --button-success-hover-bg-light: color-mix(in srgb, var(--success-color-light) 85%, black);
            --button-success-text-light: #ffffff;
            
            --button-warning-bg-light: var(--warning-color-light);
            --button-warning-hover-bg-light: color-mix(in srgb, var(--warning-color-light) 85%, black);
            --button-warning-text-light: #ffffff;


            /* Element Colors (Text & Background) Light Theme */
            --element-fire-text-light: #c0392b;       --element-fire-bg-light: rgba(192, 57, 43, 0.1);
            --element-water-text-light: #2980b9;      --element-water-bg-light: rgba(41, 128, 185, 0.1);
            --element-wood-text-light: #1e8449;       --element-wood-bg-light: rgba(30, 132, 73, 0.1);
            --element-gold-text-light: #b08800;       --element-gold-bg-light: rgba(176, 136, 0, 0.15); 
            --element-earth-text-light: #a15c38;      --element-earth-bg-light: rgba(161, 92, 56, 0.1);
            --element-light-text-light: #525252;      --element-light-bg-light: rgba(230, 230, 230, 0.5); 
            --element-dark-text-light: #32383e;       --element-dark-bg-light: rgba(50, 56, 62, 0.1);
            --element-poison-text-light: #732d91;     --element-poison-bg-light: rgba(115, 45, 145, 0.1);
            --element-wind-text-light: #16a085;       --element-wind-bg-light: rgba(22, 160, 133, 0.1);
            --element-mix-text-light: #57606a;        --element-mix-bg-light: rgba(87, 96, 106, 0.1);   

            /* Rarity Colors (Text & Background) Light Theme */
            --rarity-common-text-light: var(--text-primary-light);          
            --rarity-rare-text-light: var(--accent-color-light);            
            --rarity-elite-text-light: #d32f2f;  /* More distinct red for Elite */   
            --rarity-legendary-text-light: var(--element-gold-text-light);  
            --rarity-mythical-text-light: var(--element-poison-text-light); 


            /* Applied Theme Variables */
            --bg-primary: var(--bg-primary-dark);
            --bg-panel: var(--bg-panel-dark);
            --bg-slot: var(--bg-slot-dark);
            --border-color: var(--border-color-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --accent-color: var(--accent-color-dark);
            --accent-hover: var(--accent-hover-dark);
            --success-color: var(--success-color-dark);
            --danger-color: var(--danger-color-dark);
            --danger-hover: var(--danger-hover-dark);
            --warning-color: var(--warning-color-dark);
            
            --button-text: var(--button-text-dark); 
            --button-primary-bg: var(--button-primary-bg-dark);
            --button-primary-hover-bg: var(--button-primary-hover-bg-dark);
            --button-primary-text: var(--button-primary-text-dark);

            --button-secondary-bg: var(--button-secondary-bg-dark);
            --button-secondary-hover-bg: var(--button-secondary-hover-bg-dark);
            --button-secondary-text: var(--button-secondary-text-dark);
            
            --button-danger-bg: var(--button-danger-bg-dark);
            --button-danger-hover-bg: var(--button-danger-hover-bg-dark);
            --button-danger-text: var(--button-danger-text-dark);

            --button-success-bg: var(--button-success-bg-dark);
            --button-success-hover-bg: var(--button-success-hover-bg-dark);
            --button-success-text: var(--button-success-text-dark);
            
            --button-warning-bg: var(--button-warning-bg-dark);
            --button-warning-hover-bg: var(--button-warning-hover-bg-dark);
            --button-warning-text: var(--button-warning-text-dark);

            /* Applied Element Colors */
            --element-fire-text: var(--element-fire-text-dark);       --element-fire-bg: var(--element-fire-bg-dark);
            --element-water-text: var(--element-water-text-dark);      --element-water-bg: var(--element-water-bg-dark);
            --element-wood-text: var(--element-wood-text-dark);       --element-wood-bg: var(--element-wood-bg-dark);
            --element-gold-text: var(--element-gold-text-dark);       --element-gold-bg: var(--element-gold-bg-dark);
            --element-earth-text: var(--element-earth-text-dark);      --element-earth-bg: var(--element-earth-bg-dark);
            --element-light-text: var(--element-light-text-dark);      --element-light-bg: var(--element-light-bg-dark);
            --element-dark-text: var(--element-dark-text-dark);       --element-dark-bg: var(--element-dark-bg-dark);
            --element-poison-text: var(--element-poison-text-dark);     --element-poison-bg: var(--element-poison-bg-dark);
            --element-wind-text: var(--element-wind-text-dark);       --element-wind-bg: var(--element-wind-bg-dark);
            --element-mix-text: var(--element-mix-text-dark);        --element-mix-bg: var(--element-mix-bg-dark);

            /* Applied Rarity Colors */
            --rarity-common-text: var(--rarity-common-text-dark);         
            --rarity-rare-text: var(--rarity-rare-text-dark);           
            --rarity-elite-text: var(--rarity-elite-text-dark);         
            --rarity-legendary-text: var(--rarity-legendary-text-dark); 
            --rarity-mythical-text: var(--rarity-mythical-text-dark);     
        }

        body.light-theme {
            --bg-primary: var(--bg-primary-light);
            --bg-panel: var(--bg-panel-light);
            --bg-slot: var(--bg-slot-light);
            --border-color: var(--border-color-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --accent-color: var(--accent-color-light);
            --accent-hover: var(--accent-hover-light);
            --success-color: var(--success-color-light);
            --danger-color: var(--danger-color-light);
            --danger-hover: var(--danger-hover-light);
            --warning-color: var(--warning-color-light);

            --button-text: var(--button-text-light);
            --button-primary-bg: var(--button-primary-bg-light);
            --button-primary-hover-bg: var(--button-primary-hover-bg-light);
            --button-primary-text: var(--button-primary-text-light);

            --button-secondary-bg: var(--button-secondary-bg-light);
            --button-secondary-hover-bg: var(--button-secondary-hover-bg-light);
            --button-secondary-text: var(--button-secondary-text-light);
            
            --button-danger-bg: var(--button-danger-bg-light);
            --button-danger-hover-bg: var(--button-danger-hover-bg-light);
            --button-danger-text: var(--button-danger-text-light);

            --button-success-bg: var(--button-success-bg-light);
            --button-success-hover-bg: var(--button-success-hover-bg-light);
            --button-success-text: var(--button-success-text-light);

            --button-warning-bg: var(--button-warning-bg-light);
            --button-warning-hover-bg: var(--button-warning-hover-bg-light);
            --button-warning-text: var(--button-warning-text-light);

            /* Applied Element Colors - Light Theme */
            --element-fire-text: var(--element-fire-text-light);       --element-fire-bg: var(--element-fire-bg-light);
            --element-water-text: var(--element-water-text-light);      --element-water-bg: var(--element-water-bg-light);
            --element-wood-text: var(--element-wood-text-light);       --element-wood-bg: var(--element-wood-bg-light);
            --element-gold-text: var(--element-gold-text-light);       --element-gold-bg: var(--element-gold-bg-light);
            --element-earth-text: var(--element-earth-text-light);      --element-earth-bg: var(--element-earth-bg-light);
            --element-light-text: var(--element-light-text-light);      --element-light-bg: var(--element-light-bg-light);
            --element-dark-text: var(--element-dark-text-light);       --element-dark-bg: var(--element-dark-bg-light);
            --element-poison-text: var(--element-poison-text-light);     --element-poison-bg: var(--element-poison-bg-light);
            --element-wind-text: var(--element-wind-text-light);       --element-wind-bg: var(--element-wind-bg-light);
            --element-mix-text: var(--element-mix-text-light);        --element-mix-bg: var(--element-mix-bg-light);

            /* Applied Rarity Colors - Light Theme */
            --rarity-common-text: var(--rarity-common-text-light);         
            --rarity-rare-text: var(--rarity-rare-text-light);           
            --rarity-elite-text: var(--rarity-elite-text-light);         
            --rarity-legendary-text: var(--rarity-legendary-text-light); 
            --rarity-mythical-text: var(--rarity-mythical-text-light);     
        }

        /* Helper classes for element text colors */
        .text-element-fire { color: var(--element-fire-text); }
        .text-element-water { color: var(--element-water-text); }
        .text-element-wood { color: var(--element-wood-text); }
        .text-element-gold { color: var(--element-gold-text); }
        .text-element-earth { color: var(--element-earth-text); }
        .text-element-light { color: var(--element-light-text); }
        .text-element-dark { color: var(--element-dark-text); }
        .text-element-poison { color: var(--element-poison-text); }
        .text-element-wind { color: var(--element-wind-text); }
        .text-element-mix { color: var(--element-mix-text); }

        /* Helper classes for rarity text colors */
        .text-rarity-common { color: var(--rarity-common-text); }
        .text-rarity-rare { color: var(--rarity-rare-text); }
        .text-rarity-elite { color: var(--rarity-elite-text); }
        .text-rarity-legendary { color: var(--rarity-legendary-text); }
        .text-rarity-mythical { color: var(--rarity-mythical-text); }


        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
            font-size: 1rem; /* Default base font size */
        }
        .main-container {
            width: 100%;
            max-width: 700px;
            background-color: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 1px solid var(--border-color);
            position: relative; 
            transition: background-color 0.3s, border-color 0.3s;
        }
        @media (min-width: 768px) {
            .main-container { padding: 20px; gap: 20px; }
        }

        #theme-switcher {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-shadow: none;
        }
        #theme-switcher:hover {
            color: var(--accent-color);
            border-color: var(--accent-color);
        }


        .panel {
            background-color: var(--bg-slot);
            border-radius: 8px;
            padding: 15px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .panel-title-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 5px;
        }
        .panel-title {
            font-size: 1.2rem; 
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 0; border-bottom: none; padding-bottom: 0;
        }
        .panel-title-hint { font-size: 0.875rem; color: var(--text-secondary); } 
        @media (min-width: 768px) { .panel-title { font-size: 1.3rem; } }

        .dna-item, .dna-slot, .inventory-slot-empty, .temp-backpack-slot, .inventory-delete-slot {
            border: 1px solid var(--border-color); 
            border-radius: 5px; padding: 6px; text-align: center; font-size: 0.875rem; 
            transition: background-color 0.2s, box-shadow 0.2s, border-color 0.2s, color 0.2s; 
            position: relative; min-height: 48px; display: flex; 
            align-items: center; justify-content: center;
        }
        .dna-item { cursor: grab; }
        .dna-slot, .temp-backpack-slot, .inventory-delete-slot { cursor: pointer; }
        .inventory-slot-empty, .temp-backpack-slot.empty { color: var(--text-secondary); border-style: dashed; cursor: default; background-color: var(--bg-panel); }
        .inventory-delete-slot {
            background-color: var(--danger-color-dark);
            color: white;
            border-style: dashed;
            border-color: var(--danger-hover-dark);
        }
        body.light-theme .inventory-delete-slot {
            background-color: var(--danger-color-light);
            border-color: var(--danger-hover-light);
        }
        .inventory-delete-slot.drag-over {
            background-color: var(--danger-hover-dark) !important;
            border-color: white !important;
        }
        body.light-theme .inventory-delete-slot.drag-over {
            background-color: var(--danger-hover-light) !important;
        }


        
        @media (min-width: 768px) { .dna-item, .dna-slot, .inventory-slot-empty, .temp-backpack-slot, .inventory-delete-slot { padding: 8px; font-size: 0.9rem; min-height: 55px;} } 
        
        .dna-item:hover, .dna-slot:hover:not(.occupied), .temp-backpack-slot:hover:not(.occupied):not(.empty) { 
            border-color: var(--accent-color); 
            box-shadow: 0 0 6px color-mix(in srgb, var(--accent-color) 30%, transparent); 
        }
        .temp-backpack-slot.empty:hover {
             background-color: var(--accent-hover); border-color: var(--accent-color);
        }
        .dna-slot.occupied, .temp-backpack-slot.occupied { border-style: solid; }
        .inventory-slot-empty.drag-over, .temp-backpack-slot.empty.drag-over { border-color: var(--accent-color); background-color: var(--accent-hover); }

        .monster-snapshot-panel { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .monster-snapshot-area {
            width: 100%; height: 220px; background-color: var(--bg-primary);
            border-radius: 8px; display: grid;
            grid-template-columns: 1fr auto; grid-template-rows: auto auto 1fr auto; 
            position: relative; overflow: hidden; border: 1px solid var(--border-color);
            padding: 8px; box-sizing: border-box;
            transition: background-color 0.3s, border-color 0.3s;
        }
         @media (min-width: 768px) { .monster-snapshot-area { height: 260px; padding: 12px; } }

        .monster-snapshot-img-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 0; }
        .monster-snapshot-img-bg img { max-width: 75%; max-height: 75%; object-fit: contain; opacity: 0.7; }
        body.light-theme .monster-snapshot-img-bg img { opacity: 0.9; }


        .snapshot-achievement-title {
            grid-column: 1 / -1; grid-row: 1 / 2; text-align: center;
            font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); 
            z-index: 1; margin-bottom: 2px; text-shadow: 1px 1px 1px color-mix(in srgb, var(--bg-primary) 50%, transparent);
            background-color: color-mix(in srgb, var(--bg-panel) 50%, transparent);
            padding: 2px 6px; border-radius: 4px; display: inline-block; margin: 0 auto;
        }
        .snapshot-nickname {
            grid-column: 1 / -1; grid-row: 2 / 3; text-align: center;
            font-size: 1.3rem; font-weight: bold; color: var(--accent-color);
            z-index: 1; margin-bottom: 5px; text-shadow: 1px 1px 2px color-mix(in srgb, var(--bg-primary) 70%, transparent);
            padding: 3px 8px; background-color: color-mix(in srgb, var(--bg-slot) 60%, transparent); border-radius: 5px;
            border: 1px solid var(--border-color); display: inline-block; margin: 0 auto;
        }
        .snapshot-win-loss {
            position: absolute; top: 8px; right: 8px;
            font-size: 0.875rem; color: var(--text-secondary); z-index: 2; 
            text-align: right; padding: 3px 5px; background-color: color-mix(in srgb, var(--bg-panel) 70%, transparent); border-radius: 4px;
        }
         .snapshot-win-loss span { display: block; }

        .snapshot-main-content { grid-column: 1 / -1; grid-row: 3 / 4; display: flex; align-items: center; justify-content: center; position: relative; z-index: 1; }
        .snapshot-evaluation {
            position: absolute; 
            bottom: 8px; 
            right: 8px; 
            font-size: 1.1rem; font-weight: bold; color: var(--success-color);
            z-index: 1;
            text-shadow: 1px 1px 2px color-mix(in srgb, var(--bg-primary) 70%, transparent);
            padding: 4px 10px; background-color: color-mix(in srgb, var(--bg-slot) 70%, transparent); border-radius: 5px;
            border: 1px solid var(--border-color);
        }
         @media (min-width: 768px) { .snapshot-evaluation { font-size: 1.2rem; bottom: 12px; right: 12px; } }

        /* General Button Styling */
        button {
            padding: 10px 14px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
        }
        @media (min-width: 768px) { button { padding: 12px 16px; font-size: 0.95rem; } }
        button:active { transform: translateY(1px); }
        button:disabled { 
            background-color: color-mix(in srgb, var(--button-secondary-bg, #888888) 50%, var(--bg-primary, #111111)) !important; 
            color: var(--text-secondary) !important; 
            cursor: not-allowed !important; 
            box-shadow: none !important;
            border: 1px solid color-mix(in srgb, var(--border-color, #555555) 50%, var(--bg-primary, #111111)) !important;
        }
        button:disabled:hover { background-color: color-mix(in srgb, var(--button-secondary-bg, #888888) 50%, var(--bg-primary, #111111)) !important;  }


        /* Primary Action Buttons (Accent Color) */
        button.primary, #theme-switcher /* Theme switcher uses accent */ {
            background-color: var(--button-primary-bg);
            color: var(--button-primary-text);
        }
        button.primary:hover, #theme-switcher:hover {
            background-color: var(--button-primary-hover-bg);
        }
        
        /* Secondary Buttons */
        button.secondary, .top-nav-button, .farm-time-btn { 
            background-color: var(--button-secondary-bg);
            color: var(--button-secondary-text);
            border: 1px solid var(--border-color);
        }
        button.secondary:hover, .top-nav-button:hover, .farm-time-btn:hover {
            background-color: var(--button-secondary-hover-bg);
        }

        /* Danger Buttons */
        button.danger, .farm-monster-item button.farm-monster-release-btn, #confirm-action-btn.danger {
            background-color: var(--button-danger-bg);
            color: var(--button-danger-text);
        }
        button.danger:hover, .farm-monster-item button.farm-monster-release-btn:hover, #confirm-action-btn.danger:hover {
            background-color: var(--button-danger-hover-bg);
        }

        /* Success Buttons */
        button.success, #combine-button, .farm-monster-item button.farm-complete-btn {
            background-color: var(--button-success-bg);
            color: var(--button-success-text);
        }
        button.success:hover, #combine-button:hover, .farm-monster-item button.farm-complete-btn:hover {
            background-color: var(--button-success-hover-bg);
        }
        
        /* Warning Buttons */
        button.warning, .farm-monster-item button.farm-monster-cultivate-btn { 
            background-color: var(--button-warning-bg);
            color: var(--button-warning-text);
        }
        button.warning:hover, .farm-monster-item button.farm-monster-cultivate-btn:hover {
            background-color: var(--button-warning-hover-bg);
        }
        
        /* Farm Battle Button Specific */
        .farm-monster-item button.farm-battle-btn {
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            padding: 0; 
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px; 
            font-size: 1.2rem; 
            line-height: 1; 
            border: none; 
            box-shadow: none; 
        }


        .top-nav-button { 
            width: auto;
            padding: 0.5rem 0.5rem; 
            min-width: 0; 
            font-size: 0.75rem; 
            height: 38px; 
            display: flex; align-items: center; justify-content: center; 
            flex-grow: 1; 
            text-align: center;
            line-height: 1.2; 
            background-color: var(--accent-color); /* Uniform color */
            color: var(--button-primary-text); /* Text color for accent */
            border: 1px solid var(--accent-hover-dark);
        }
        .top-nav-button:hover {
            background-color: var(--accent-hover-dark);
        }
        .top-nav-button:disabled {
             background-color: color-mix(in srgb, var(--accent-color) 50%, var(--bg-primary)) !important;
        }

         .top-buttons-container {
            display: flex;
            justify-content: center;
            align-items: stretch; 
            gap: 0.2rem; 
            margin-top: 0.5rem; 
        }

       
        #combine-button {
            width: auto; min-width:110px; max-width: 160px; margin: 0 auto; display: block;
            font-weight: bold;
        }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.75); align-items: center; justify-content: center; padding: 10px;}
        .modal-content { background-color: var(--bg-panel); color: var(--text-primary); margin: auto; padding: 20px; border-radius: 8px; width: 100%; max-width: 500px; box-shadow: 0 8px 25px rgba(0,0,0,0.5); position: relative; border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s, color 0.3s;}
        .modal-content.large { max-width: 650px; }
        .modal-content.xlarge { max-width: 800px; } 
        .modal-content.feedback-wide { max-width: 600px; } 
        @media (max-width: 640px) { 
            .modal-content.feedback-wide { max-width: 95%; }
        }

        .modal-close { color: var(--text-secondary); position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer;}
        .modal-close:hover, .modal-close:focus { color: var(--text-primary); text-decoration: none; }
        .modal-header { font-size: 1.3rem; font-weight: 600; margin-bottom: 15px; color: var(--accent-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; text-align: center;} 
        .modal-body { font-size: 0.95rem; line-height: 1.6; max-height: 70vh; overflow-y: auto; } 
        .modal-footer { margin-top: 20px; display:flex; justify-content: center; gap: 15px; } 
        .modal-footer button { padding: 12px 25px; font-size: 1rem;} 
        .loading-spinner { border:4px solid var(--border-color); border-top:4px solid var(--accent-color); border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:20px auto; }


        .dna-combination-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 8px; }
        .inventory-grid, .temp-backpack-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); 
            gap: 8px; 
        }
        
        .dna-item-delete-btn { position:absolute;top:-7px;right:-7px;background-color:var(--danger-color);color:var(--button-danger-text);border:1px solid var(--bg-primary);border-radius:50%;width:22px;height:22px;font-size:13px;line-height:20px;text-align:center;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,0.3);}
        .dna-item-delete-btn:hover { background-color: var(--danger-hover); }

        .dna-panel-title { 
            font-size: 1.2rem; font-weight: 600; color: var(--accent-color);
            margin-bottom: 0; border-bottom: none; padding-bottom: 0;
        }
        body.light-theme .dna-panel-title { color: #0550ae; } 
        .dna-panel-hint { font-size: 0.875rem; color: var(--text-secondary); } 
        body.light-theme .dna-panel-hint { color: #424a53; } 


        .details-section { background-color: var(--bg-primary); padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s;}
        .details-section-title { font-size: 1.05rem; font-weight: 500; color: var(--accent-color); margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dashed var(--border-color); } 
        .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px 14px; } 
        .details-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; padding: 5px 0; } 
        .details-label { font-weight: 500; color: var(--text-secondary); margin-right: 10px; white-space: nowrap; }
        .details-value { color: var(--text-primary); font-weight: bold; text-align: right; font-size: 1rem; } 
        .details-value.boosted { color: var(--success-color); font-weight: bold; } 
        .details-value.debuffed { color: var(--danger-color); }
        .creation-time-centered { text-align: center; font-size: 0.875rem; color: var(--text-secondary); margin-top: 10px; }  
        .element-composition-item { font-size: 0.875rem; }  
        .skill-entry { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); } 
        .skill-entry:last-child { border-bottom: none; margin-bottom: 0; }
        .skill-name { font-weight: bold; color: var(--accent-hover); font-size: 0.95rem; } 
        .skill-details { font-size: 0.875rem; color: var(--text-secondary); margin-left: 10px; } 
        .monster-info-header { text-align: center; margin-bottom: 15px; }
        .monster-info-name-styled {
            font-size: 1.6rem; font-weight: bold; color: var(--accent-color);
            padding: 6px 18px; background-color: var(--bg-slot); border-radius: 8px;
            display: inline-block; border: 1px solid var(--border-color);
        }
        .monster-description-area { font-size: 0.9rem; margin-top: 10px; padding: 10px; background-color: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color); line-height: 1.6; } 
        .personality-text { font-style: italic; line-height: 1.6; font-size: 0.9rem;} 


        .action-buttons-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px; }
        
        .scrolling-hints-container { height: 22px; overflow: hidden; position: relative; background-color: var(--bg-primary); border-radius: 4px; padding: 0 10px; margin-top: 10px; border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s;}
        .scrolling-hint-text { position: absolute; width: 100%; text-align: center; line-height: 22px; font-size: 0.875rem; color: var(--text-secondary); animation: scrollHint 15s linear infinite; opacity: 0; }  
        .scrolling-hint-text:nth-child(1) { animation-delay: 0s; } .scrolling-hint-text:nth-child(2) { animation-delay: 5s; } .scrolling-hint-text:nth-child(3) { animation-delay: 10s; }
        @keyframes scrollHint { 0% { opacity: 0; transform: translateY(100%); } 10%, 23% { opacity: 1; transform: translateY(0); } 33% { opacity: 0; transform: translateY(-100%); } 100% { opacity: 0; transform: translateY(-100%); } }

        .tab-buttons { display: flex; flex-wrap: wrap; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); } 
        .tab-button { padding: 10px 15px; cursor: pointer; background-color: transparent; border: none; color: var(--text-secondary); font-size: 0.9rem; border-bottom: 3px solid transparent; margin-bottom: -1px; transition: color 0.2s, border-bottom-color 0.2s; white-space: nowrap; } 
        .tab-button.active { color: var(--accent-color); border-bottom-color: var(--accent-color); font-weight: 500; }
        .tab-content { display: none; } .tab-content.active { display: block; }

        .leaderboard-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; } 
        .leaderboard-table th, .leaderboard-table td { padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); } 
        .leaderboard-table th { color: var(--accent-color); font-weight: 500; cursor: pointer; } 
        .leaderboard-table th:hover { color: var(--accent-hover); }
        .leaderboard-table td { color: var(--text-primary); }
        .leaderboard-table .leaderboard-element-cell span { font-weight: bold; } 
        .leaderboard-table tr:last-child td { border-bottom: none; }
        .leaderboard-table tr:hover td { background-color: var(--bg-slot); } body.light-theme .leaderboard-table tr:hover td { background-color: #f8f9fa; }
        .leaderboard-table .challenge-btn-cell { width: 80px; text-align: center;} 


        .titles-medals-section { margin-top: 15px; }
        .titles-list, .achievements-list, .owned-monsters-list { list-style: none; padding-left: 0; }
        .titles-list li, .achievements-list li, .owned-monsters-list li { background-color: var(--bg-primary); padding: 6px 10px; border-radius: 4px; margin-bottom: 6px; font-size: 0.9rem; border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s;} 
        .owned-monsters-list li { display: flex; justify-content: space-between; align-items: center; }
        .owned-monsters-list .monster-name { font-weight: bold; }
        .owned-monsters-list .monster-score { color: var(--success-color); }
        .medals-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; } 
        .medal-emoji { font-size: 1.3rem; } 

        /* Monster Farm Styles */
        .farm-header-grid {
            display: grid;
            grid-template-columns: minmax(70px, auto) minmax(100px, 1.8fr) minmax(120px, 2fr) minmax(60px, 0.8fr) repeat(3, minmax(70px, auto));
            gap: 8px;
            padding: 8px 8px 4px 8px;
            border-bottom: 2px solid var(--accent-color);
            font-size: 0.875rem; 
            font-weight: 600;
            color: var(--text-secondary);
        }
        .farm-header-grid > div { text-align: left; padding-left: 5px;}


        .farm-monster-item {
            display: grid;
            grid-template-columns: minmax(70px, auto) minmax(100px, 1.8fr) minmax(120px, 2fr) minmax(60px, 0.8fr) repeat(3, minmax(70px, auto));
            gap: 8px;
            align-items: center;
            padding: 10px 8px; 
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem; 
        }
        .farm-monster-item:last-child { border-bottom: none; }
        .farm-monster-item > div, .farm-monster-item > button { text-align: left; }
        .farm-monster-item .farm-monster-name { font-weight: bold; color: var(--accent-hover); }
        .farm-monster-item .farm-monster-status { font-style: italic; color: var(--text-secondary); }
        .farm-monster-item .farm-monster-status.active { color: var(--warning-color); font-weight: bold; }
        .farm-monster-item .farm-monster-status.battling { color: var(--danger-color); font-weight: bold; }
        .farm-monster-item .farm-monster-score { color: var(--success-color); }
        .farm-monster-item button {
            padding: 6px 8px; font-size: 0.875rem; min-width: 60px; 
            margin: 0; 
        }
        
        .farm-monster-item .farm-monster-info-btn { background-color: var(--button-secondary-bg); color: var(--button-secondary-text); border: 1px solid var(--border-color); }
        .farm-monster-item .farm-monster-cultivate-btn { background-color: var(--button-warning-bg); color: var(--button-warning-text); }
        .farm-monster-item .farm-monster-cultivate-btn:hover { background-color: var(--button-warning-hover-bg); }
        
        #release-monster-image-placeholder {
            width: 100px; height: 75px; background-color: var(--bg-slot);
            border: 1px dashed var(--border-color); border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.875rem; color: var(--text-secondary); margin: 10px auto; 
        }
        #release-monster-image-placeholder img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .log-entry {
            padding: 7px; 
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem; 
            color: var(--text-secondary);
        }
        .log-entry:last-child { border-bottom: none; }
        .log-entry .log-time { font-weight: bold; color: var(--text-primary); margin-right: 8px; }
        .log-entry .log-message {}

        .feedback-skill-entry { margin-bottom: 6px; } 
        .feedback-skill-name { font-weight: bold; color: var(--accent-hover); font-size: 0.9rem;} 
        .feedback-skill-description { font-size: 0.875rem; color: var(--text-secondary); margin-left: 10px;} 

        /* Cultivation Modal Styles */
        #cultivation-setup-modal .modal-body, #training-results-modal .modal-body {
            text-align: left;
        }
        #cultivation-setup-modal button, #training-results-modal button {
            margin-top: 10px;
        }
        #start-cultivation-btn { /* Increased height for "é–‹å§‹ä¿®ç…‰" button */
            padding-top: 1rem; 
            padding-bottom: 1rem;
        }
        .cultivation-hint {
            font-size: 0.875rem; 
            color: var(--text-secondary);
            margin-top: 5px;
        }
        .training-result-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--border-color);
        }
        .training-result-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .training-result-section h5 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 8px;
        }
        .training-result-section p, .training-result-section div {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        .temp-backpack-item-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }
        #add-all-to-temp-backpack-btn { 
            padding: 8px 10px; 
            height: auto; 
            font-size: 0.9rem; 
        }
        #newbie-guide-search-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        #newbie-guide-search-results p {
            padding: 5px;
            border-bottom: 1px solid var(--border-color-dark);
        }
         #newbie-guide-search-results p:last-child {
            border-bottom: none;
        }
        
        /* Friends List Modal */
        #friends-list-search-input {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        #friends-list-container {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px;
        }
        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .friend-item:last-child {
            border-bottom: none;
        }
        .friend-item .friend-name {
            font-weight: 500;
        }
        .friend-item .friend-status {
            font-size: 0.875rem; 
            color: var(--text-secondary);
        }
        .friend-item .friend-status.online {
            color: var(--success-color);
        }
        .friend-item .friend-status.offline {
            color: var(--text-secondary);
        }


    </style>
</head>
<body>
    <div class="main-container">
        <button id="theme-switcher" title="åˆ‡æ›ä¸»é¡Œ">
            <span id="theme-icon">ğŸŒ™</span>
        </button>

        <div class="monster-snapshot-panel panel">
            <div id="monster-snapshot-area" class="monster-snapshot-area">
                <div class="monster-snapshot-img-bg">
                    <img id="monster-image" src="https://github.com/msw2004727/MD/blob/images/000.png?raw=true" alt="æ€ªç¸åœ–ç‰‡">
                </div>
                <div id="snapshot-achievement-title" class="snapshot-achievement-title">åˆå‡ºèŒ…å»¬</div>
                <div id="snapshot-nickname" class="snapshot-nickname">-</div>
                <div id="snapshot-win-loss" class="snapshot-win-loss">
                    <span>å‹: 0</span>
                    <span>æ•—: 0</span>
                </div>
                <div id="snapshot-main-content" class="snapshot-main-content">
                </div>
                <div id="snapshot-evaluation" class="snapshot-evaluation">ç¸½è©•åƒ¹: 0</div>
            </div>
            <div class="top-buttons-container">
                <button id="monster-info-button" class="top-nav-button secondary" disabled>æ€ªç‰©è³‡è¨Š</button>
                <button id="player-info-button" class="top-nav-button secondary">ç©å®¶è³‡è¨Š</button>
                <button id="show-monster-leaderboard-btn" class="top-nav-button secondary">æ€ªç¸æ’è¡Œ</button> 
                <button id="show-player-leaderboard-btn" class="top-nav-button secondary">ç©å®¶æ’è¡Œ</button>
                <button id="friends-list-btn" class="top-nav-button secondary">å¥½å‹åå–®</button> 
                <button id="newbie-guide-btn" class="top-nav-button secondary">æ–°æ‰‹ä¸Šè·¯</button>
            </div>
        </div>

        <div class="panel">
            <div class="tab-buttons" id="dna-farm-tabs">
                <button class="tab-button active" onclick="openDnaFarmTab(event, 'dna-inventory-content')">ğŸ§¬ DNAç®¡ç†</button>
                <button class="tab-button" onclick="openDnaFarmTab(event, 'monster-farm-content')">ğŸ¡ æ€ªç‰©è¾²å ´</button>
                <button class="tab-button" onclick="openDnaFarmTab(event, 'exchange-content')">âš–ï¸ äº¤æ˜“æ‰€</button>
                <button class="tab-button" onclick="openDnaFarmTab(event, 'homestead-content')">ğŸ› ï¸ å®¶åœ’å»ºè¨­</button>
                <button class="tab-button" onclick="openDnaFarmTab(event, 'guild-content')">ğŸ›¡ï¸ å·¥æœƒç³»çµ±</button>
            </div>

            <div id="dna-inventory-content" class="tab-content active">
                <div id="dna-combination-panel-wrapper" class="panel mb-4"> 
                    <h2 class="panel-title dna-panel-title">ğŸ§¬ DNAçµ„åˆ</h2>
                    <div id="dna-combination-slots" class="dna-combination-grid mt-2">
                    </div>
                    <div class="action-buttons-grid mt-3">
                        <button id="combine-button" class="success" disabled>æ€ªç‰©åˆæˆ</button>
                    </div>
                </div>

                <div class="panel-title-container" style="border-bottom: none; margin-bottom: 5px;">
                    <h2 class="panel-title dna-panel-title">ğŸ”¬ DNAç¢ç‰‡</h2>
                    <span class="panel-title-hint dna-panel-hint">â€»DNAç¢ç‰‡å¯è‡ªç”±æ‹–æ›³ï¼Œæ‹–æ›³è‡³åƒåœ¾æ¡¶å¯åˆªé™¤</span>
                </div>
                <div id="inventory-items" class="inventory-grid">
                </div>

                <div class="mt-4">
                    <h3 class="panel-title dna-panel-title text-sm mb-2">ğŸ’ è‡¨æ™‚èƒŒåŒ… (æ‹¾å–ç‰©)</h3>
                    <div id="temporary-backpack-items" class="temp-backpack-grid">
                    </div>
                </div>
            </div>

            <div id="monster-farm-content" class="tab-content">
                <div class="panel-title-container" style="border-bottom: none; margin-bottom: 5px;">
                     <h2 class="panel-title dna-panel-title">ğŸ¡ æ€ªç‰©è¾²å ´</h2>
                     <span class="panel-title-hint dna-panel-hint">â€»æœ€å¤šæ”¶ç´10éš»æ€ªç¸</span>
                </div>
                <div id="farm-headers" class="farm-header-grid mt-2">
                    <div>å‡ºæˆ°</div>
                    <div>æ€ªç‰©</div>
                    <div>ç‹€æ…‹</div>
                    <div>ç¸½è©•åƒ¹</div>
                    <div>è³‡è¨Š</div>
                    <div>é¤Šæˆ</div>
                    <div>æ”¾ç”Ÿ</div>
                </div>
                <div id="farmed-monsters-list">
                    <p class="text-center text-sm text-[var(--text-secondary)] py-4">è¾²å ´ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»çµ„åˆæ€ªç¸å§ï¼</p>
                </div>
            </div>
            
            <div id="exchange-content" class="tab-content">
                <p class="text-center text-lg text-[var(--text-secondary)] py-10">âš–ï¸ äº¤æ˜“æ‰€åŠŸèƒ½å°šæœªé–‹æ”¾ï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
            </div>
            <div id="homestead-content" class="tab-content">
                <p class="text-center text-lg text-[var(--text-secondary)] py-10">ğŸ› ï¸ å®¶åœ’å»ºè¨­åŠŸèƒ½å°šæœªé–‹æ”¾ï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
            </div>
            <div id="guild-content" class="tab-content">
                <p class="text-center text-lg text-[var(--text-secondary)] py-10">ğŸ›¡ï¸ å·¥æœƒç³»çµ±åŠŸèƒ½å°šæœªé–‹æ”¾ï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
            </div>


            <div class="scrolling-hints-container">
                <div class="scrolling-hint-text">ğŸ’¡ é‡‘æœ¨æ°´ç«åœŸå±¬æ€§ç›¸ç”Ÿç›¸å‰‹ï¼</div>
                <div class="scrolling-hint-text">ğŸ’¡ ç›¸åŒDNAçµ„åˆç”¢ç”Ÿçš„æ€ªç‰©æ˜¯ç›¸åŒçš„ï¼</div>
                <div class="scrolling-hint-text">ğŸ’¡ æ‹›å¼æ˜¯æ€ªç‰©ä¾æ“šç‰¹æ€§éš¨æ©Ÿé…ç½®ï¼</div>
            </div>
        </div>
    </div>

    <div id="monster-leaderboard-modal" class="modal">
        <div class="modal-content large">
            <span class="modal-close" onclick="closeModal('monster-leaderboard-modal')">&times;</span>
            <h3 class="modal-header">æ€ªç¸æ’è¡Œæ¦œ</h3>
            <div id="monster-leaderboard-element-tabs" class="tab-buttons">
                </div>
            <div id="monster-leaderboard-table-container" class="modal-body">
                <table id="monster-leaderboard-table" class="leaderboard-table"></table>
            </div>
        </div>
    </div>

    <div id="player-leaderboard-modal" class="modal">
        <div class="modal-content large">
            <span class="modal-close" onclick="closeModal('player-leaderboard-modal')">&times;</span>
            <h3 class="modal-header">ç©å®¶è‹±é›„æ¦œ</h3>
            <div id="player-leaderboard-table-container" class="modal-body">
                <table id="player-leaderboard-table" class="leaderboard-table"></table>
            </div>
        </div>
    </div>


    <div id="monster-info-modal" class="modal">
        <div class="modal-content large">
            <span class="modal-close" onclick="closeModal('monster-info-modal')">&times;</span>
            <div id="monster-info-modal-header-content" class="monster-info-header">
            </div>
            <div class="tab-buttons" id="monster-info-tabs">
                <button class="tab-button active" onclick="openGenericTab(event, 'monster-details-tab', 'monster-info-modal')">ğŸ“œ è©³ç´°è³‡è¨Š</button>
                <button class="tab-button" onclick="openGenericTab(event, 'monster-logs-tab', 'monster-info-modal')">ğŸ¾ æ´»å‹•ç´€éŒ„</button>
            </div>
            <div id="monster-details-tab" class="tab-content active modal-body">
                </div>
            <div id="monster-logs-tab" class="tab-content modal-body">
                <div id="monster-activity-logs" class="max-h-[300px] overflow-y-auto">
                    <p class="text-center text-sm text-[var(--text-secondary)] py-4">å°šç„¡æ´»å‹•ç´€éŒ„ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <div id="player-info-modal" class="modal">
        <div class="modal-content large"> <span class="modal-close" onclick="closeModal('player-info-modal')">&times;</span>
            <h3 class="modal-header">ğŸ‘¤ ç©å®¶è³‡è¨Š</h3>
            <div id="player-info-modal-body" class="modal-body">
            </div>
        </div>
    </div>

    <div id="feedback-modal" class="modal">
        <div class="modal-content feedback-wide"> <span id="feedback-modal-close-x" class="modal-close" onclick="closeModal('feedback-modal')">&times;</span> 
            <h3 id="feedback-modal-title" class="modal-header text-center">è™•ç†ä¸­...</h3>
            <div id="feedback-modal-body-content" class="modal-body text-left">
                 <div id="feedback-modal-spinner" class="loading-spinner" style="display: none;"></div>
                 <div id="feedback-modal-message"></div> 
                 <div id="feedback-monster-details" style="display:none;" class="mt-3">
                    </div>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirmation-modal-title" class="modal-header text-center">âš ï¸ æç¤º</h3> <div id="confirmation-modal-body" class="modal-body">
                <div id="release-monster-image-placeholder" style="display:none;">
                    <img id="release-monster-img-preview" src="" alt="é è¦½">
                </div>
            </div>
            <div class="modal-footer"> <button id="confirm-action-btn" class="danger">âœ”ï¸ ç¢ºå®š</button>
                <button id="cancel-action-btn" class="secondary" onclick="closeModal('confirmation-modal')">âŒ å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="cultivation-setup-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="modal-close" onclick="closeModal('cultivation-setup-modal')">&times;</span>
            <h3 id="cultivation-setup-modal-title" class="modal-header">ğŸŒ± æ€ªç¸é¤Šæˆ</h3>
            <div class="modal-body">
                <p class="mb-2">æ­£åœ¨ç‚º <strong id="cultivation-monster-name" class="text-[var(--accent-color)]"></strong> é€²è¡Œé¤Šæˆè¨ˆç•«ã€‚</p>
                <button id="start-cultivation-btn" class="w-full primary">ğŸ’ª é–‹å§‹ä¿®ç…‰</button>
                <p class="cultivation-hint text-base mt-2">æç¤ºï¼šä¿®ç…‰æœŸé–“ï¼Œæ€ªç¸å°‡ç„¡æ³•æ”¾ç”Ÿæˆ–å‡ºæˆ°ã€‚</p>
            </div>
        </div>
    </div>

    <div id="training-results-modal" class="modal">
        <div class="modal-content large">
            <span class="modal-close" onclick="closeTrainingResultsModal()">&times;</span>
            <h3 id="training-results-modal-title" class="modal-header">ğŸ‰ ä¿®ç…‰æˆæœ ğŸ‰</h3>
            <div class="modal-body">
                <div class="training-result-section">
                    <h5>ğŸ“œ å†’éšªæ•…äº‹</h5>
                    <p id="training-story-result"></p>
                </div>
                <div class="training-result-section">
                    <h5>ğŸ“ˆ æˆé•·ç´€éŒ„</h5>
                    <div id="training-growth-result"></div>
                </div>
                <div class="training-result-section">
                    <h5>ğŸ’ æ‹¾ç²ç‰©å“</h5>
                    <div id="training-items-result" class="mb-2"></div>
                    <button id="add-all-to-temp-backpack-btn" class="w-full secondary mt-2">ä¸€éµå…¨æ•¸åŠ å…¥èƒŒåŒ…</button>
                </div>
            </div>
             <div class="modal-footer" style="justify-content: flex-end;">
                <button class="secondary" onclick="closeTrainingResultsModal()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="newbie-guide-modal" class="modal">
        <div class="modal-content large">
            <span class="modal-close" onclick="closeModal('newbie-guide-modal')">&times;</span>
            <h3 class="modal-header">ğŸ“– æ–°æ‰‹ä¸Šè·¯æŒ‡å—</h3>
            <div class="modal-body">
                <input type="text" id="newbie-guide-search-input" placeholder="æœå°‹æŒ‡å—å…§å®¹..." class="mb-4">
                <div id="newbie-guide-content-area" class="max-h-[50vh] overflow-y-auto">
                    </div>
            </div>
        </div>
    </div>
    
    <div id="reminder-modal" class="modal">
        <div class="modal-content" style="max-width: 380px;">
            <h3 id="reminder-modal-title" class="modal-header text-center">æº«é¦¨æé†’</h3>
            <div id="reminder-modal-body" class="modal-body text-center">
                <p>æ‚¨æœ‰å°šæœªåŠ å…¥èƒŒåŒ…çš„ä¿®ç…‰æ‹¾ç²ç‰©å“ï¼Œç¢ºå®šè¦é—œé–‰å—ï¼Ÿé—œé–‰å¾ŒæœªåŠ å…¥çš„ç‰©å“å°‡æœƒæ¶ˆå¤±ã€‚</p>
            </div>
            <div class="modal-footer">
                <button id="reminder-confirm-close-btn" class="danger">ä»è¦é—œé–‰</button>
                <button id="reminder-cancel-btn" class="secondary" onclick="closeModal('reminder-modal')">è¿”å›æŸ¥çœ‹</button>
            </div>
        </div>
    </div>

    <div id="friends-list-modal" class="modal">
        <div class="modal-content large">
            <span class="modal-close" onclick="closeModal('friends-list-modal')">&times;</span>
            <h3 class="modal-header">ğŸ§‘â€ğŸ¤â€ğŸ§‘ å¥½å‹åå–®</h3>
            <div class="modal-body">
                <input type="text" id="friends-list-search-input" placeholder="æœå°‹ç©å®¶æš±ç¨±..." class="mb-3">
                <div id="friends-list-container">
                    <p class="text-center text-sm text-[var(--text-secondary)]">å°šç„¡å¥½å‹ï¼Œå¿«å»æœå°‹ä¸¦æ–°å¢å§ï¼</p>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const monsterImageElement = document.getElementById('monster-image');
        const snapshotAchievementTitle = document.getElementById('snapshot-achievement-title');
        const snapshotNickname = document.getElementById('snapshot-nickname');
        const snapshotWinLoss = document.getElementById('snapshot-win-loss');
        const snapshotEvaluation = document.getElementById('snapshot-evaluation');

        const dnaCombinationPanelWrapper = document.getElementById('dna-combination-panel-wrapper');
        const dnaCombinationSlotsContainer = document.getElementById('dna-combination-slots');
        const combineButton = document.getElementById('combine-button');
        const monsterInfoButton = document.getElementById('monster-info-button');
        const playerInfoButton = document.getElementById('player-info-button');
        const inventoryItemsContainer = document.getElementById('inventory-items');
        const temporaryBackpackItemsContainer = document.getElementById('temporary-backpack-items');
        
        // Leaderboard buttons
        const showMonsterLeaderboardBtn = document.getElementById('show-monster-leaderboard-btn');
        const showPlayerLeaderboardBtn = document.getElementById('show-player-leaderboard-btn');

        const newbieGuideBtn = document.getElementById('newbie-guide-btn');
        const friendsListBtn = document.getElementById('friends-list-btn'); 
        const themeSwitcherBtn = document.getElementById('theme-switcher');
        const themeIcon = document.getElementById('theme-icon');
        
        // Leaderboard Modals and Tables
        const monsterLeaderboardModal = document.getElementById('monster-leaderboard-modal');
        const playerLeaderboardModal = document.getElementById('player-leaderboard-modal');
        const monsterLeaderboardTable = document.getElementById('monster-leaderboard-table');
        const playerLeaderboardTable = document.getElementById('player-leaderboard-table');
        const monsterLeaderboardElementTabs = document.getElementById('monster-leaderboard-element-tabs');


        const monsterInfoModalHeaderContent = document.getElementById('monster-info-modal-header-content');
        const monsterDetailsTab = document.getElementById('monster-details-tab');
        const monsterActivityLogsContainer = document.getElementById('monster-activity-logs');
        const playerInfoModalBody = document.getElementById('player-info-modal-body');

        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackModalTitle = document.getElementById('feedback-modal-title');
        const feedbackModalBodyContent = document.getElementById('feedback-modal-body-content');
        const feedbackModalMessage = document.getElementById('feedback-modal-message');
        const feedbackModalSpinner = document.getElementById('feedback-modal-spinner');
        const feedbackModalCloseX = document.getElementById('feedback-modal-close-x');
        const feedbackMonsterDetailsDiv = document.getElementById('feedback-monster-details');
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationModalBodyEl = document.getElementById('confirmation-modal-body');
        const confirmationModalTitleEl = document.getElementById('confirmation-modal-title');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const releaseMonsterImagePlaceholder = document.getElementById('release-monster-image-placeholder');
        const releaseMonsterImgPreview = document.getElementById('release-monster-img-preview');

        const dnaFarmTabsContainer = document.getElementById('dna-farm-tabs');
        const dnaInventoryContent = document.getElementById('dna-inventory-content'); 
        const monsterFarmContent = document.getElementById('monster-farm-content');
        const farmedMonstersListContainer = document.getElementById('farmed-monsters-list');

        const cultivationSetupModal = document.getElementById('cultivation-setup-modal');
        const cultivationMonsterName = document.getElementById('cultivation-monster-name');
        const startCultivationBtn = document.getElementById('start-cultivation-btn');
        
        const trainingResultsModal = document.getElementById('training-results-modal');
        const trainingResultsModalTitle = document.getElementById('training-results-modal-title');
        const trainingStoryResult = document.getElementById('training-story-result');
        const trainingGrowthResult = document.getElementById('training-growth-result');
        const trainingItemsResult = document.getElementById('training-items-result');
        const addAllToTempBackpackBtn = document.getElementById('add-all-to-temp-backpack-btn');

        const newbieGuideModal = document.getElementById('newbie-guide-modal');
        const newbieGuideSearchInput = document.getElementById('newbie-guide-search-input');
        const newbieGuideContentArea = document.getElementById('newbie-guide-content-area');
        
        const friendsListModal = document.getElementById('friends-list-modal');
        const friendsListSearchInput = document.getElementById('friends-list-search-input');
        const friendsListContainer = document.getElementById('friends-list-container');
        
        const reminderModal = document.getElementById('reminder-modal');
        const reminderConfirmCloseBtn = document.getElementById('reminder-confirm-close-btn');


        // --- Game State & Data ---
        let currentMonster = null; 
        let playerOwnedMonsters = []; 
        let farmedMonsters = []; 
        const MAX_FARM_SLOTS = 10;
        let battlingMonsterId = null; 
        let currentCultivationMonster = null; 
        let itemsFromCurrentTraining = []; 
        let playerFriends = []; // Mock friends list

        const DNA_RARITIES = {
            COMMON: { name: "æ™®é€š", textVarKey: "--rarity-common-text", statMultiplier: 1.0, skillLevelBonus: 0, resistanceBonus: 1 },
            RARE: { name: "ç¨€æœ‰", textVarKey: "--rarity-rare-text", statMultiplier: 1.1, skillLevelBonus: 0, resistanceBonus: 3 },
            ELITE: { name: "èè‹±", textVarKey: "--rarity-elite-text", statMultiplier: 1.25, skillLevelBonus: 1, resistanceBonus: 5 },
            LEGENDARY: { name: "å‚³å¥‡", textVarKey: "--rarity-legendary-text", statMultiplier: 1.45, skillLevelBonus: 2, resistanceBonus: 8 },
            MYTHICAL: { name: "ç¥è©±", textVarKey: "--rarity-mythical-text", statMultiplier: 1.7, skillLevelBonus: 3, resistanceBonus: 12 },
        };
        
        function getRarityData(rarityName) {
            const rarityKey = Object.keys(DNA_RARITIES).find(key => DNA_RARITIES[key].name === rarityName);
            return rarityKey ? DNA_RARITIES[rarityKey] : DNA_RARITIES.COMMON;
        }


        const initialPlayerDNA = [
            // Common
            { id: 'dna_fire_c', name: 'åˆéšç«ç¨®', type: 'ç«', attack: 18, defense: 6, speed: 9, hp: 45, mp: 22, crit: 4, description: 'å¾®å¼±ç‡ƒç‡’çš„ç«ç¨®ã€‚', rarity: DNA_RARITIES.COMMON.name, resistances: {'ç«': 2} },
            { id: 'dna_water_c', name: 'ç´”æ·¨æ°´æ»´', type: 'æ°´', attack: 12, defense: 12, speed: 12, hp: 55, mp: 28, crit: 3, description: 'ç´”æ·¨ä½†æ™®é€šçš„æ°´æ»´ã€‚', rarity: DNA_RARITIES.COMMON.name, resistances: {'æ°´': 2} },
            { id: 'dna_wood_c', name: 'å«©ç¶ è‘‰èŠ½', type: 'æœ¨', attack: 10, defense: 15, speed: 7,  hp: 60, mp: 25, crit: 2, description: 'å……æ»¿ç”Ÿæ©Ÿçš„æ™®é€šè‘‰èŠ½ã€‚', rarity: DNA_RARITIES.COMMON.name, resistances: {'æœ¨': 2} },
            // Rare
            { id: 'dna_earth_r', name: 'å …ç¡¬å²©ç‰‡', type: 'åœŸ', attack: 8, defense: 28, speed: 6,  hp: 85, mp: 15, crit: 3, description: 'è¼ƒç‚ºå …å›ºçš„å²©çŸ³ç¢ç‰‡ã€‚', rarity: DNA_RARITIES.RARE.name, resistances: {'åœŸ': 5} },
            { id: 'dna_wind_r', name: 'å¾®é¢¨ç²¾è¯', type: 'é¢¨', attack: 16, defense: 10, speed: 22, hp: 58, mp: 26, crit: 8, description: 'è˜Šå«å°‘é‡é¢¨ä¹‹åŠ›çš„ç²¾è¯ã€‚', rarity: DNA_RARITIES.RARE.name, resistances: {'é¢¨': 5} },
            { id: 'dna_poison_r', name: 'å¼±æ•ˆæ¯’æ¶²', type: 'æ¯’', attack: 20, defense: 8, speed: 14, hp: 50, mp: 24, crit: 6, description: 'å¸¶æœ‰äº›è¨±æ¯’æ€§çš„æ¶²é«”ã€‚', rarity: DNA_RARITIES.RARE.name, resistances: {'æ¯’': 5} },
            // Elite
            { id: 'dna_dark_e', name: 'æš—å½±æ®˜ç‰‡', type: 'æš—', attack: 28, defense: 7, speed: 12,  hp: 48, mp: 38, crit: 9, description: 'å‡èšäº†éƒ¨åˆ†æš—å½±åŠ›é‡çš„ç¢ç‰‡ã€‚', rarity: DNA_RARITIES.ELITE.name, resistances: {'æš—': 8} },
            { id: 'dna_light_e', name: 'å…‰èŠ’ç¢ç‰‡', type: 'å…‰', attack: 20, defense: 14, speed: 15, hp: 68, mp: 30, crit: 7, description: 'é–ƒè€€è‘—ç´”æ·¨å…‰èŠ’çš„çµæ™¶ç¢ç‰‡ã€‚', rarity: DNA_RARITIES.ELITE.name, resistances: {'å…‰': 8} },
            { id: 'dna_fire_e', name: 'çƒˆç„°æ ¸å¿ƒ', type: 'ç«', attack: 30, defense: 10, speed: 18, hp: 60, mp: 35, crit: 10, description: 'ç‡ƒç‡’æ—ºç››çš„ç«ç„°æ ¸å¿ƒã€‚', rarity: DNA_RARITIES.ELITE.name, resistances: {'ç«': 8, 'æ°´': -3} }, // Example of weakness
            // Legendary
            { id: 'dna_gold_l', name: 'ä¸æœ½é‡‘å±¬', type: 'é‡‘', attack: 25, defense: 35, speed: 10,  hp: 70, mp: 20, crit: 5, description: 'æ¥µå…¶å …ç¡¬ä¸”å¸¶æœ‰ç¥ç§˜åŠ›é‡çš„é‡‘å±¬ã€‚', rarity: DNA_RARITIES.LEGENDARY.name, resistances: {'é‡‘': 12, 'åœŸ': 5} },
            { id: 'dna_water_l', name: 'æ·±æµ·ä¹‹æº', type: 'æ°´', attack: 22, defense: 28, speed: 25, hp: 80, mp: 45, crit: 8, description: 'ä¾†è‡ªæµ·æ´‹æ·±è™•çš„å¼·å¤§æ°´èƒ½çµæ™¶ã€‚', rarity: DNA_RARITIES.LEGENDARY.name, resistances: {'æ°´': 12, 'ç«': -5} },
            // Mythical
            { id: 'dna_ancient_m', name: 'é å¤é¾é­‚', type: 'ç„¡', attack: 40, defense: 40, speed: 40, hp: 120, mp: 60, crit: 15, description: 'è˜Šå«é å¤å·¨é¾éˆé­‚çš„ç¥ç§˜DNAã€‚', rarity: DNA_RARITIES.MYTHICAL.name, resistances: {'ç«':8, 'æ°´':8, 'æœ¨':8, 'é‡‘':8, 'åœŸ':8, 'å…‰': 5, 'æš—': 5} }
        ];

        let playerOwnedDNA = JSON.parse(JSON.stringify(initialPlayerDNA));
        const NUM_INVENTORY_SLOTS = 11; // 11 regular + 1 delete slot = 12 total
        const DELETE_SLOT_INDEX = 11; // The 12th slot (index 11)
        const NUM_TEMP_BACKPACK_SLOTS = 18;
        const NUM_COMBINATION_SLOTS = 5;
        let inventoryDisplaySlots = new Array(NUM_INVENTORY_SLOTS + 1).fill(null); // +1 for delete slot visual
        let temporaryBackpackSlots = new Array(NUM_TEMP_BACKPACK_SLOTS).fill(null);
        let combinationSlotsData = new Array(NUM_COMBINATION_SLOTS).fill(null);
        let itemToDeleteInfo = null; 
        let monsterToReleaseInfo = null; 
        let monsterToChallengeInfo = null; 
        
        const playerNickname = "å°æ˜";
        let playerStats = { rank: 0, wins: 0, losses: 0, score: 0, titles: ["æ–°æ‰‹è¨“ç·´å®¶"], achievements: ["é¦–æ¬¡çµ„åˆæ€ªç¸"], medals: 0 };

        // Mock data for friends list
        const MOCK_ALL_PLAYERS = [
            { name: "å¼·å¤§çš„è¨“ç·´å®¶é˜¿è™", status: "online" }, { name: "ç¥ç§˜çš„è‰è‰çµ²", status: "offline" },
            { name: "æ–°æ‰‹å°èœ", status: "online" }, { name: "å‚³å¥‡å¤§å¸«_é¾å´", status: "offline" },
            { name: "è·¯éçš„é¢¨ä¹‹ä½¿è€…", status: "online" }, { name: "ç«ç„°å¥³çš‡_èæ‹‰", status: "online" }
        ];
        
        // Mock data for leaderboards (will be populated by generateLeaderboards)
        let mockMonsterLeaderboardData = [];
        let mockPlayerLeaderboardData = [];


        // --- Helper Functions ---
        function getContrastColor(hexColor) {
            const currentThemeIsLight = document.body.classList.contains('light-theme');
            if (!hexColor) {
                return currentThemeIsLight ? 'var(--text-primary-light)' : 'var(--text-primary-dark)';
            }

            let R, G, B;
            hexColor = hexColor.replace("#", "");

            if (hexColor.length === 3) {
                R = parseInt(hexColor.substring(0, 1) + hexColor.substring(0, 1), 16);
                G = parseInt(hexColor.substring(1, 2) + hexColor.substring(1, 2), 16);
                B = parseInt(hexColor.substring(2, 3) + hexColor.substring(2, 3), 16);
            } else if (hexColor.length === 6) {
                R = parseInt(hexColor.substring(0, 2), 16);
                G = parseInt(hexColor.substring(2, 4), 16);
                B = parseInt(hexColor.substring(4, 6), 16);
            } else {
                console.warn("Invalid hexColor format for getContrastColor:", hexColor);
                return currentThemeIsLight ? 'var(--text-primary-light)' : 'var(--text-primary-dark)';
            }

            const yiq = (R * 299 + G * 587 + B * 114) / 1000;
            return yiq >= 128 ? 'var(--text-primary-light)' : 'var(--text-primary-dark)';
        }


        // --- Theme Switcher ---
        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                themeIcon.textContent = 'â˜€ï¸'; 
            } else {
                document.body.classList.remove('light-theme');
                themeIcon.textContent = 'ğŸŒ™'; 
            }
            localStorage.setItem('theme', theme);
            updateMonsterSnapshotDisplay(currentMonster); 
            populateInventory(); 
            populateTemporaryBackpack();
        }
        themeSwitcherBtn.addEventListener('click', () => {
            const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
            applyTheme(currentTheme === 'light' ? 'dark' : 'light');
        });


        function initializeInventoryDisplay() {
            // Initialize main inventory slots (excluding the delete slot)
            playerOwnedDNA.slice(0, NUM_INVENTORY_SLOTS).forEach((dna, index) => {
                inventoryDisplaySlots[index] = dna ? {...dna} : null;
            });
            // The last slot (DELETE_SLOT_INDEX) is handled by populateInventory
            populateInventory();
            populateTemporaryBackpack(); 
        }
        
        function createCombinationSlots() {
            dnaCombinationSlotsContainer.innerHTML = '';
            for (let i = 0; i < NUM_COMBINATION_SLOTS; i++) {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'dna-slot';
                slotDiv.dataset.slotId = i;
                slotDiv.dataset.droptype = "combination";
                slotDiv.textContent = `çµ„åˆæ§½ ${i + 1}`;
                slotDiv.addEventListener('dragover', handleDragOver);
                slotDiv.addEventListener('dragleave', handleDragLeave);
                slotDiv.addEventListener('drop', handleDrop);
                slotDiv.addEventListener('click', handleComboSlotClick);
                dnaCombinationSlotsContainer.appendChild(slotDiv);
            }
        }

        function openGenericTab(evt, tabName, modalOrTabContainerId) {
            let i, tabcontent, tablinks;
            const containerElement = document.getElementById(modalOrTabContainerId);
            if (!containerElement) return;

            tabcontent = containerElement.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tablinks = containerElement.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            const currentTabContent = containerElement.querySelector(`#${tabName}`); 
            if(currentTabContent) {
                currentTabContent.style.display = "block";
                currentTabContent.classList.add("active");
            }
            if(evt && evt.currentTarget) { 
                evt.currentTarget.classList.add("active");
            }
        }
        
        function openDnaFarmTab(evt, tabName) {
            const panel = document.getElementById('dna-farm-tabs').closest('.panel');
            if (!panel) return;

            const tabContents = panel.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].style.display = "none";
                tabContents[i].classList.remove("active");
            }

            const tabButtons = panel.getElementsByClassName("tab-button");
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }
            
            const currentTabContent = panel.querySelector(`#${tabName}`);
            if (currentTabContent) {
                currentTabContent.style.display = "block";
                currentTabContent.classList.add("active");
            }
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add("active");
            }
        }


        function getElementStyling(elementType) {
            if (!elementType) return { text: 'var(--element-mix-text)', bg: 'var(--element-mix-bg)' };
            switch(elementType.toLowerCase()) {
                case 'ç«': return { text: 'var(--element-fire-text)', bg: 'var(--element-fire-bg)' };
                case 'æ°´': return { text: 'var(--element-water-text)', bg: 'var(--element-water-bg)' };
                case 'æœ¨': return { text: 'var(--element-wood-text)', bg: 'var(--element-wood-bg)' };
                case 'é‡‘': return { text: 'var(--element-gold-text)', bg: 'var(--element-gold-bg)' }; 
                case 'åœŸ': return { text: 'var(--element-earth-text)', bg: 'var(--element-earth-bg)' };
                case 'å…‰': return { text: 'var(--element-light-text)', bg: 'var(--element-light-bg)' }; 
                case 'æš—': return { text: 'var(--element-dark-text)', bg: 'var(--element-dark-bg)' };
                case 'æ¯’': return { text: 'var(--element-poison-text)', bg: 'var(--element-poison-bg)' };
                case 'é¢¨': return { text: 'var(--element-wind-text)', bg: 'var(--element-wind-bg)' };
                default: return { text: 'var(--element-mix-text)', bg: 'var(--element-mix-bg)' };
            }
        }
        
        function getRarityStyling(rarityName) {
            const rarityData = getRarityData(rarityName); 
            return { 
                text: `var(${rarityData.textVarKey})`, 
            };
        }

        // --- Leaderboard Data Generation and Display ---
        function generateMockLeaderboardData() {
            mockMonsterLeaderboardData = [];
            const mTs = ['ç‚é¾ç‹','æµ·çš‡ä¸»å®°','å¤§åœ°å·¨ç¥','æš´é¢¨é ˜ä¸»','å½±å¤œé­”å›','è–å…‰ä½¿å¾’', 'è™›ç©ºè¡Œè€…', 'æ¬¡å…ƒè£‚éš™ç¸', 'æ˜Ÿç•Œå®ˆè­·ç¥', 'æ··æ²Œç·¨ç¹”è€…'];
            const mNs = ['çƒˆç„°','æ€’æ¿¤','å·¨å²©','ç–¾é¢¨','å¹½å½±','æ™¨æ›¦', 'è™›ç„¡', 'è£‚ç©º', 'æ˜Ÿå¡µ', 'æš—æµ'];
            const es = ['ç«','æ°´','åœŸ','é¢¨','æš—','å…‰','æœ¨','é‡‘','æ¯’', 'ç„¡'];
            for (let i = 0; i < 100; i++) {
                const mainE = es[Math.floor(Math.random() * es.length)];
                mockMonsterLeaderboardData.push({
                    rank: i + 1,
                    title: mTs[Math.floor(Math.random() * mTs.length)],
                    nickname: mNs[Math.floor(Math.random() * mNs.length)] + (Math.floor(Math.random() * 9000) + 1000),
                    mainElement: mainE,
                    elements: [mainE, es[Math.floor(Math.random() * es.length)]], 
                    score: Math.floor(Math.random() * 15000) + 5000,
                    id: `leader_monster_${i}` 
                });
            }

            mockPlayerLeaderboardData = [];
            const pNs = ['æˆ°ç¥é˜¿æ˜','æ³•ç‹å°èŠ±','åˆºå®¢è€ç‹','å¦ç¥è‰è‰','éŠä¿ é˜¿å®','æ™ºè€…å°ç¾', 'å¹»å½±æ—…è€…', 'é›·éœ†ä¸»å®°', 'æ°¸æ†å®ˆæœ›', 'æ·±æ·µä½èª'];
            for (let i = 0; i < 100; i++) {
                const representativeMonster = mockMonsterLeaderboardData[Math.floor(Math.random() * mockMonsterLeaderboardData.length)];
                mockPlayerLeaderboardData.push({
                    rank: i + 1,
                    nickname: pNs[Math.floor(Math.random() * pNs.length)] + (i + 1),
                    wins: Math.floor(Math.random() * 200),
                    losses: Math.floor(Math.random() * 100),
                    score: Math.floor(Math.random() * 50000) + 10000,
                    representativeMonsterName: representativeMonster.nickname,
                    representativeMonsterElements: representativeMonster.elements 
                });
            }
        }
        
        let currentMonsterSort = { column: 'score', order: 'desc' };
        let currentPlayerSort = { column: 'score', order: 'desc' };

        function sortLeaderboardData(data, column, order) {
            return [...data].sort((a, b) => {
                let valA = a[column];
                let valB = b[column];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        function populateMonsterLeaderboard(filterElement = 'æ‰€æœ‰') {
            let filteredData = mockMonsterLeaderboardData;
            if (filterElement !== 'æ‰€æœ‰') {
                filteredData = mockMonsterLeaderboardData.filter(m => m.mainElement === filterElement);
            }
            const sortedData = sortLeaderboardData(filteredData, currentMonsterSort.column, currentMonsterSort.order);

            monsterLeaderboardTable.innerHTML = `<thead><tr>
                <th data-sort="rank">æ’å ${currentMonsterSort.column === 'rank' ? (currentMonsterSort.order === 'asc' ? 'â–²' : 'â–¼') : ''}</th>
                <th data-sort="title">ç¨±è™Ÿ ${currentMonsterSort.column === 'title' ? (currentMonsterSort.order === 'asc' ? 'â–²' : 'â–¼') : ''}</th>
                <th data-sort="nickname">æš±ç¨± ${currentMonsterSort.column === 'nickname' ? (currentMonsterSort.order === 'asc' ? 'â–²' : 'â–¼') : ''}</th>
                <th class="text-center" data-sort="mainElement">ä¸»è¦å±¬æ€§ ${currentMonsterSort.column === 'mainElement' ? (currentMonsterSort.order === 'asc' ? 'â–²' : 'â–¼') : ''}</th>
                <th data-sort="score">ç¸½è©•åƒ¹ ${currentMonsterSort.column === 'score' ? (currentMonsterSort.order === 'asc' ? 'â–²' : 'â–¼') : ''}</th>
                <th class="challenge-btn-cell">æŒ‘æˆ°</th>
            </tr></thead><tbody></tbody>`;
            const tbody = monsterLeaderboardTable.querySelector('tbody');
            sortedData.forEach(monster => {
                const tr = tbody.insertRow();
                tr.insertCell().textContent = monster.rank;
                tr.insertCell().textContent = monster.title;
                tr.insertCell().textContent = monster.nickname;
                const elementCell = tr.insertCell();
                elementCell.className = 'leaderboard-element-cell text-center';
                elementCell.innerHTML = `<span style="color: ${getElementStyling(monster.mainElement).text};">${monster.mainElement}</span>`;
                tr.insertCell().textContent = monster.score;
                
                const challengeCell = tr.insertCell();
                const challengeBtn = document.createElement('button');
                challengeBtn.textContent = 'âš”ï¸';
                challengeBtn.className = 'button tiny primary p-1 text-base';
                challengeBtn.title = `æŒ‘æˆ° ${monster.nickname}`;
                challengeBtn.onclick = () => promptChallengeMonster(monster.nickname, monster.score);
                challengeCell.appendChild(challengeBtn);
                challengeCell.className = 'challenge-btn-cell';
            });
            addSortListenersToTable(monsterLeaderboardTable, 'monster');
        }

        function populatePlayerLeaderboard() {
            const sortedData = sortLeaderboardData(mockPlayerLeaderboardData, currentPlayerSort.column, currentPlayerSort.order);
            playerLeaderboardTable.innerHTML = `<thead><tr>
                <th data-sort="rank">æ’å ${currentPlayerSort.column === 'rank' ? (currentPlayerSort.order === 'asc' ? 'â–²' : 'â–¼') : ''}</th>
                <th data-sort="nickname">æš±ç¨± ${currentPlayerSort.column === 'nickname' ? (currentPlayerSort.order === 'asc' ? 'â–²' : 'â–¼') : ''}</th>
                <th data-sort="wins">å‹å ´ ${currentPlayerSort.column === 'wins' ? (currentPlayerSort.order === 'asc' ? 'â–²' : 'â–¼') : ''}</th>
                <th data-sort="losses">æ•—å ´ ${currentPlayerSort.column === 'losses' ? (currentPlayerSort.order === 'asc' ? 'â–²' : 'â–¼') : ''}</th>
                <th data-sort="score">ç©åˆ† ${currentPlayerSort.column === 'score' ? (currentPlayerSort.order === 'asc' ? 'â–²' : 'â–¼') : ''}</th>
                <th data-sort="representativeMonsterName">ä»£è¡¨æ€ªç¸</th>
            </tr></thead><tbody></tbody>`;
            const tbody = playerLeaderboardTable.querySelector('tbody');
            sortedData.forEach(player => {
                const tr = tbody.insertRow();
                tr.insertCell().textContent = player.rank;
                tr.insertCell().textContent = player.nickname;
                tr.insertCell().textContent = player.wins;
                tr.insertCell().textContent = player.losses;
                tr.insertCell().textContent = player.score;
                const monsterCell = tr.insertCell();
                const elementsText = player.representativeMonsterElements.join('ã€');
                monsterCell.textContent = `${player.representativeMonsterName} (${elementsText})`;
            });
            addSortListenersToTable(playerLeaderboardTable, 'player');
        }
        
        function addSortListenersToTable(tableElement, type) {
            const headers = tableElement.querySelectorAll('th[data-sort]');
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sort;
                    if (type === 'monster') {
                        if (currentMonsterSort.column === sortKey) {
                            currentMonsterSort.order = currentMonsterSort.order === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentMonsterSort.column = sortKey;
                            currentMonsterSort.order = 'desc';
                        }
                        const activeElementTab = monsterLeaderboardElementTabs.querySelector('.tab-button.active');
                        populateMonsterLeaderboard(activeElementTab ? activeElementTab.dataset.element : 'æ‰€æœ‰');
                    } else if (type === 'player') {
                        if (currentPlayerSort.column === sortKey) {
                            currentPlayerSort.order = currentPlayerSort.order === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentPlayerSort.column = sortKey;
                            currentPlayerSort.order = 'desc';
                        }
                        populatePlayerLeaderboard();
                    }
                });
            });
        }

        function setupMonsterLeaderboardTabs() {
            const elements = ['æ‰€æœ‰', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'å…‰', 'æš—', 'æ¯’', 'é¢¨', 'ç„¡'];
            monsterLeaderboardElementTabs.innerHTML = '';
            elements.forEach(el => {
                const tabButton = document.createElement('button');
                tabButton.className = 'tab-button';
                tabButton.textContent = el;
                tabButton.dataset.element = el;
                if (el === 'æ‰€æœ‰') tabButton.classList.add('active');
                tabButton.onclick = (e) => {
                    monsterLeaderboardElementTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    populateMonsterLeaderboard(el);
                };
                monsterLeaderboardElementTabs.appendChild(tabButton);
            });
        }
        
        promptChallengeMonster = (monsterName, monsterScore) => { 
            monsterToChallengeInfo = { name: monsterName, score: monsterScore };
            confirmationModalTitleEl.textContent = "æŒ‘æˆ°ç¢ºèª";
            confirmationModalBodyEl.innerHTML = `ç¢ºå®šè¦æŒ‘æˆ°æ€ªç¸ <strong style="color:var(--accent-color);">${monsterName}</strong> (ç¸½è©•åƒ¹: ${monsterScore})ï¼Ÿ<br><br><strong class="text-[var(--danger-color)]">æ³¨æ„ï¼šå°æˆ°å¾Œï¼Œæˆ°æ•—çš„ä¸€æ–¹å°‡æœƒè¢«å‹æ–¹åå™¬ä¸¦å¸æ”¶å…¶åŠ›é‡ï¼</strong>`;
            releaseMonsterImagePlaceholder.style.display = 'none';
            confirmActionBtn.className = 'danger';
            confirmActionBtn.textContent = 'ç¢ºèªæŒ‘æˆ°';
            
            confirmActionBtn.onclick = () => {
                showFeedbackModal("æŒ‘æˆ°é–‹å§‹ï¼", `ä½ å·²å‘ ${monsterToChallengeInfo.name} ç™¼èµ·æŒ‘æˆ°ï¼<br>(å°æˆ°ç³»çµ±å°šæœªå¯¦è£…)`, false, true, false);
                setTimeout(() => {
                    const playerMonster = battlingMonsterId ? farmedMonsters.find(m => m.id === battlingMonsterId) : currentMonster;
                    if (!playerMonster) {
                        showFeedbackModal("æŒ‘æˆ°å¤±æ•—", "ä½ éœ€è¦å…ˆæŒ‡å®šä¸€éš»å‡ºæˆ°æ€ªç¸æ‰èƒ½æŒ‘æˆ°ï¼", false, true, false);
                        closeModal('confirmation-modal');
                        return;
                    }
                    const challengeSuccess = Math.random() < 0.5; 
                    if (challengeSuccess) {
                        playerMonster.score += Math.floor(monsterToChallengeInfo.score * 0.2);
                        playerMonster.resume.wins++;
                        playerStats.wins++; 
                        addLogEntry(playerMonster, `æˆåŠŸæŒ‘æˆ°ä¸¦å¸æ”¶äº† ${monsterToChallengeInfo.name}ï¼`);
                        showFeedbackModal("æŒ‘æˆ°å‹åˆ©ï¼", `${playerMonster.nickname} æˆ°å‹ä¸¦å¸æ”¶äº† ${monsterToChallengeInfo.name} çš„åŠ›é‡ï¼<br>ç¸½è©•åƒ¹æå‡ï¼`, false, true, false);
                    } else {
                        playerMonster.resume.losses++;
                        playerStats.losses++; 
                        addLogEntry(playerMonster, `æŒ‘æˆ° ${monsterToChallengeInfo.name} å¤±æ•—ï¼Œä¸¦è¢«å…¶å¸æ”¶...`);
                        showFeedbackModal("æŒ‘æˆ°å¤±æ•—...", `${playerMonster.nickname} ä¸æ•µ ${monsterToChallengeInfo.name}ï¼Œä¸å¹¸è¢«å¸æ”¶äº†...`, false, true, false);
                        if (battlingMonsterId === playerMonster.id) battlingMonsterId = null;
                        if (currentMonster && currentMonster.id === playerMonster.id) currentMonster = null;
                        farmedMonsters = farmedMonsters.filter(m => m.id !== playerMonster.id);
                        playerOwnedMonsters = playerOwnedMonsters.filter(m => m.id !== playerMonster.id);
                        populateFarmList();
                        updateMonsterSnapshotDisplay(null);
                    }
                    updatePlayerInfoModal(); 
                    updateMonsterSnapshotDisplay(currentMonster); 
                    closeModal('confirmation-modal');
                }, 1500);
            };
            openModal('confirmation-modal');
        }


        function populateInventory() {
            inventoryItemsContainer.innerHTML = '';
            for (let i = 0; i < NUM_INVENTORY_SLOTS; i++) { // Iterate only for actual item slots
                const item = inventoryDisplaySlots[i];
                const sD = createDnaElement(item, i, 'inventory');
                inventoryItemsContainer.appendChild(sD);
            }
            // Add the delete slot separately
            const deleteSlotDiv = document.createElement('div');
            deleteSlotDiv.className = 'inventory-delete-slot';
            deleteSlotDiv.textContent = 'ğŸ—‘ï¸ åˆªé™¤å€';
            deleteSlotDiv.dataset.droptype = "delete"; // Special droptype
            deleteSlotDiv.dataset.slotIndex = DELETE_SLOT_INDEX; // Mark its index
            deleteSlotDiv.addEventListener('dragover', handleDragOver);
            deleteSlotDiv.addEventListener('dragleave', handleDragLeave);
            deleteSlotDiv.addEventListener('drop', handleDropOnDeleteSlot); // Specific drop handler
            inventoryItemsContainer.appendChild(deleteSlotDiv);
        }
        
        function populateTemporaryBackpack() {
            temporaryBackpackItemsContainer.innerHTML = '';
            for (let i = 0; i < NUM_TEMP_BACKPACK_SLOTS; i++) {
                const item = temporaryBackpackSlots[i];
                const sD = createDnaElement(item, i, 'temporary');
                temporaryBackpackItemsContainer.appendChild(sD);
            }
        }

        function createDnaElement(item, index, sourceType) { 
            const sD = document.createElement('div');
            sD.dataset.droptype = sourceType; 
            
            if (sourceType === 'inventory') {
                sD.dataset.inventorySlotIndex = index;
            } else if (sourceType === 'temporary') {
                sD.dataset.slotIndex = index; 
            }

            if (item) {
                sD.id = `${sourceType}-item-${item.id || item.tempId || `gen-${index}`}-${index}`; 
                sD.className = 'dna-item'; 
                sD.textContent = item.name;
                sD.draggable = true;
                
                const elementStyle = getElementStyling(item.type); 
                const rarityStyle = getRarityStyling(item.rarity); 
                
                sD.style.backgroundColor = elementStyle.bg; 
                sD.style.color = rarityStyle.text;           
                sD.style.borderColor = elementStyle.text;     
                
                sD.dataset.dnaInfo = JSON.stringify(item);
                sD.addEventListener('dragstart', handleDragStart);
                
                // Removed X delete button from here

            } else {
                sD.id = `${sourceType}-empty-${index}`;
                sD.className = sourceType === 'inventory' ? 'inventory-slot-empty' : 'temp-backpack-slot empty';
                sD.textContent = 'ç©ºä½';
            }
            sD.addEventListener('dragover', handleDragOver);
            sD.addEventListener('dragleave', handleDragLeave);
            sD.addEventListener('drop', handleDrop);
            if (sourceType === 'temporary' && item) { 
                sD.title = `é»æ“Šå°‡ ${item.name} ç§»è‡³DNAç¢ç‰‡åº«`;
                sD.onclick = () => moveFromTempToInventory(index);
            }
            return sD;
        }
        
        function moveFromTempToInventory(tempSlotIndex) {
            const itemToMove = temporaryBackpackSlots[tempSlotIndex];
            if (!itemToMove) return;

            const emptyMainSlot = inventoryDisplaySlots.findIndex((slot, index) => slot === null && index < DELETE_SLOT_INDEX); // Exclude delete slot
            if (emptyMainSlot !== -1) {
                inventoryDisplaySlots[emptyMainSlot] = itemToMove;
                temporaryBackpackSlots[tempSlotIndex] = null;
                populateInventory();
                populateTemporaryBackpack();
            } else {
                showFeedbackModal("æç¤º", "DNAç¢ç‰‡åº«å·²æ»¿ï¼è«‹å…ˆæ¸…å‡ºç©ºé–“ã€‚", false, true, false);
            }
        }

        function handleDropOnDeleteSlot(e) {
            e.preventDefault();
            const targetDropZone = e.target.closest('[data-droptype="delete"]');
            if (!targetDropZone) return;
            targetDropZone.classList.remove('drag-over');

            const dnaDataString = e.dataTransfer.getData('application/json');
            const sourceType = e.dataTransfer.getData('text/source-type');
            const sourceIndexString = e.dataTransfer.getData('text/source-index');

            if (!dnaDataString || !sourceType || sourceIndexString === null || sourceIndexString === undefined) return;
            
            const sourceIndex = parseInt(sourceIndexString, 10);
            const droppedDNA = JSON.parse(dnaDataString);

            promptDeleteItem(droppedDNA.id || droppedDNA.tempId, sourceIndex, sourceType, droppedDNA.name);
        }


        function promptDeleteItem(itemId, itemSlotIndex, itemSourceType, itemNameOverride = null) {
            itemToDeleteInfo = { id: itemId, slotIndex: itemSlotIndex, sourceType: itemSourceType };
            const itemName = itemNameOverride || (itemSourceType === 'inventory' 
                ? (inventoryDisplaySlots[itemSlotIndex] ? inventoryDisplaySlots[itemSlotIndex].name : 'è©²DNA')
                : (temporaryBackpackSlots[itemSlotIndex] ? temporaryBackpackSlots[itemSlotIndex].name : 'è©²DNA'));

            confirmationModalBodyEl.innerHTML =`ç¢ºå®šåˆªé™¤DNAç¢ç‰‡ "${itemName}"ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`; 
            releaseMonsterImagePlaceholder.style.display = 'none';
            confirmationModalTitleEl.textContent="åˆªé™¤ç¢ºèª";
            confirmActionBtn.className = 'danger'; 
            confirmActionBtn.textContent = 'ç¢ºå®šåˆªé™¤';
            confirmActionBtn.onclick = () => { 
                if (itemToDeleteInfo) {
                    if (itemToDeleteInfo.sourceType === 'inventory') {
                        inventoryDisplaySlots[itemToDeleteInfo.slotIndex] = null;
                        playerOwnedDNA = playerOwnedDNA.filter(dna => dna.id !== itemToDeleteInfo.id);
                    } else if (itemToDeleteInfo.sourceType === 'temporary') {
                        temporaryBackpackSlots[itemToDeleteInfo.slotIndex] = null;
                    }
                    combinationSlotsData.forEach((comboItem, comboIndex) => {
                        if (comboItem && (comboItem.id === itemToDeleteInfo.id || comboItem.tempId === itemToDeleteInfo.id)) {
                            clearCombinationSlot(comboIndex, false); 
                        }
                    });
                    populateInventory();
                    populateTemporaryBackpack();
                    itemToDeleteInfo = null;
                }
                closeModal('confirmation-modal');
                updateActionButtonsState();
            };
            openModal('confirmation-modal');
        }


        function handleDragStart(e) {
            if (e.target.classList.contains('dna-item-delete-btn')) { // Should not be needed anymore
                e.preventDefault();
                return;
            }

            const dnaInfo = e.target.dataset.dnaInfo;
            if (!dnaInfo) {
                console.error("DragStart Error: DNA info (dataset.dnaInfo) is missing.", e.target);
                e.preventDefault();
                return;
            }
            try { JSON.parse(dnaInfo); } catch (jsonError) {
                console.error("DragStart Error: dataset.dnaInfo is not valid JSON.", dnaInfo, e.target, jsonError);
                e.preventDefault(); return;
            }

            e.dataTransfer.effectAllowed = "move";
            e.dataTransfer.setData('application/json', dnaInfo);

            const sourceType = e.target.dataset.droptype; 
            let sourceIndexStr;

            if (sourceType === 'inventory') {
                sourceIndexStr = e.target.dataset.inventorySlotIndex;
            } else if (sourceType === 'combination') {
                sourceIndexStr = e.target.dataset.slotId; 
            } else if (sourceType === 'temporary') { 
                sourceIndexStr = e.target.dataset.slotIndex; 
            } else {
                console.error("DragStart Error: Unknown or missing dataset.droptype.", e.target.dataset, e.target);
                e.preventDefault();
                return;
            }

            if (sourceIndexStr === undefined || sourceIndexStr === null || String(sourceIndexStr).trim() === "") {
                console.error(`DragStart Error: Missing source index for sourceType '${sourceType}'. Element dataset:`, e.target.dataset, "Element:", e.target);
                e.preventDefault();
                return;
            }
            
            e.dataTransfer.setData('text/source-type', sourceType);
            e.dataTransfer.setData('text/source-index', String(sourceIndexStr));
        }


        function setupDropZones() {
            document.querySelectorAll('[data-droptype="combination"], [data-droptype="inventory"], [data-droptype="temporary"], [data-droptype="delete"]').forEach(s=>{ 
                s.addEventListener('dragover',handleDragOver);
                s.addEventListener('dragleave',handleDragLeave);
                if (s.dataset.droptype === "delete") {
                    s.addEventListener('drop', handleDropOnDeleteSlot);
                } else {
                    s.addEventListener('drop', handleDrop);
                }
                if(s.dataset.droptype==="combination"){s.addEventListener('click',handleComboSlotClick);}
            });
        }
        function handleDragOver(e) {
            e.preventDefault();
            const tS=e.target.closest('[data-droptype]');
            if(tS){
                if(tS.dataset.droptype==="combination"&&!tS.classList.contains('occupied')){tS.classList.add('border-[var(--accent-color)]','bg-[#2f2f4a]');}
                else if((tS.dataset.droptype==="inventory" || tS.dataset.droptype==="temporary") && (tS.classList.contains('inventory-slot-empty') || tS.classList.contains('empty'))){tS.classList.add('drag-over');}
                else if (tS.dataset.droptype === "delete") { tS.classList.add('drag-over'); }
            }
        }
        function handleDragLeave(e) {
            const tS=e.target.closest('[data-droptype]');
            if(tS){tS.classList.remove('border-[var(--accent-color)]','bg-[#2f2f4a]','drag-over');}
        }
        function handleDrop(e) { // This handles drops on non-delete slots
            e.preventDefault();
            const targetDropZone = e.target.closest('[data-droptype]');
            if (!targetDropZone || targetDropZone.dataset.droptype === "delete") return; // Ignore drops on delete slot here

            targetDropZone.classList.remove('border-[var(--accent-color)]', 'bg-[#2f2f4a]', 'drag-over');
            const dnaDataString = e.dataTransfer.getData('application/json');
            const sourceType = e.dataTransfer.getData('text/source-type');
            const sourceIndexString = e.dataTransfer.getData('text/source-index'); 
            
            if (!dnaDataString || !sourceType || sourceIndexString === null || sourceIndexString === undefined || sourceIndexString.trim() === "") { 
                console.error("Drop data error: Missing or invalid core data from dataTransfer.", 
                    {dnaDataString, sourceType, sourceIndexString});
                return;
            }
            
            const sourceIndex = parseInt(sourceIndexString, 10);
            if (isNaN(sourceIndex)) {
                 console.error("Drop data error: sourceIndex is NaN after parseInt.", 
                    {dnaDataString, sourceType, sourceIndexString});
                return;
            }

            const droppedDNA = JSON.parse(dnaDataString); 
            const targetDropType = targetDropZone.dataset.droptype;

            if (targetDropType === "combination") {
                const targetComboSlotIndex = parseInt(targetDropZone.dataset.slotId);
                if (combinationSlotsData[targetComboSlotIndex]) { console.log("Combination slot occupied."); return; }
                
                combinationSlotsData[targetComboSlotIndex] = droppedDNA;
                updateCombinationSlotUI(targetComboSlotIndex, droppedDNA); 

                if (sourceType === 'inventory') inventoryDisplaySlots[sourceIndex] = null;
                else if (sourceType === 'combination' && sourceIndex !== targetComboSlotIndex) clearCombinationSlotUI(sourceIndex); 
                else if (sourceType === 'temporary') temporaryBackpackSlots[sourceIndex] = null;
            
            } else if (targetDropType === "inventory") {
                const targetInventorySlotIndex = parseInt(targetDropZone.dataset.inventorySlotIndex);
                if (targetInventorySlotIndex === DELETE_SLOT_INDEX) return; // Should be handled by handleDropOnDeleteSlot

                if (inventoryDisplaySlots[targetInventorySlotIndex]) { 
                    if (sourceType === 'combination' || sourceType === 'temporary') { 
                        const dnaFromInventory = inventoryDisplaySlots[targetInventorySlotIndex];
                        inventoryDisplaySlots[targetInventorySlotIndex] = droppedDNA;
                        if (sourceType === 'combination') {
                            combinationSlotsData[sourceIndex] = dnaFromInventory;
                            updateCombinationSlotUI(sourceIndex, dnaFromInventory);
                        } else { 
                            temporaryBackpackSlots[sourceIndex] = dnaFromInventory;
                        }
                    } else { console.log("Inventory slot occupied, no swap for inv-inv."); return; }
                } else { 
                    inventoryDisplaySlots[targetInventorySlotIndex] = droppedDNA;
                    if (sourceType === 'combination') clearCombinationSlotUI(sourceIndex);
                    else if (sourceType === 'temporary') temporaryBackpackSlots[sourceIndex] = null;
                    else if (sourceType === 'inventory' && sourceIndex !== targetInventorySlotIndex) inventoryDisplaySlots[sourceIndex] = null;
                }
            } else if (targetDropType === "temporary") { 
                const targetTempSlotIndex = parseInt(targetDropZone.dataset.slotIndex);
                 if (temporaryBackpackSlots[targetTempSlotIndex]) { 
                    if (sourceType === 'combination') { 
                        const dnaFromTemp = temporaryBackpackSlots[targetTempSlotIndex];
                        temporaryBackpackSlots[targetTempSlotIndex] = droppedDNA;
                        combinationSlotsData[sourceIndex] = dnaFromTemp;
                        updateCombinationSlotUI(sourceIndex, dnaFromTemp);
                    } else { console.log("Temp backpack slot occupied, no swap for inv/temp to temp."); return; }
                } else { 
                    temporaryBackpackSlots[targetTempSlotIndex] = droppedDNA;
                    if (sourceType === 'combination') clearCombinationSlotUI(sourceIndex);
                    else if (sourceType === 'inventory') inventoryDisplaySlots[sourceIndex] = null;
                    else if (sourceType === 'temporary' && sourceIndex !== targetTempSlotIndex) temporaryBackpackSlots[sourceIndex] = null;
                }
            }

            populateInventory();
            populateTemporaryBackpack();
            updateActionButtonsState();
        }
        
        function updateCombinationSlotUI(comboSlotId, dnaItem) {
            const comboSlotElement = dnaCombinationSlotsContainer.querySelector(`.dna-slot[data-slot-id="${comboSlotId}"]`);
            if (!comboSlotElement) return;
            if (dnaItem) {
                comboSlotElement.textContent = dnaItem.name;
                comboSlotElement.classList.add('occupied');
                const elementStyle = getElementStyling(dnaItem.type);
                const rarityStyle = getRarityStyling(dnaItem.rarity);
                comboSlotElement.style.backgroundColor = elementStyle.bg;
                comboSlotElement.style.color = rarityStyle.text;
                comboSlotElement.style.borderColor = elementStyle.text;
                comboSlotElement.draggable = true;
                comboSlotElement.dataset.dnaInfo = JSON.stringify(dnaItem);
                comboSlotElement.dataset.droptype = "combination"; 
                comboSlotElement.dataset.slotId = comboSlotId; 
                comboSlotElement.removeEventListener('dragstart', handleDragStart); 
                comboSlotElement.addEventListener('dragstart', handleDragStart);
            } else {
                clearCombinationSlotUI(comboSlotId);
            }
        }


        function clearCombinationSlotUI(comboSlotId) { 
            const comboSlotElement = dnaCombinationSlotsContainer.querySelector(`.dna-slot[data-slot-id="${comboSlotId}"]`);
            if (!comboSlotElement) return;
            
            combinationSlotsData[comboSlotId] = null; 
            comboSlotElement.textContent = `çµ„åˆæ§½ ${comboSlotId + 1}`;
            comboSlotElement.classList.remove('occupied');
            comboSlotElement.style.backgroundColor = '';
            comboSlotElement.style.borderColor = '';
            comboSlotElement.style.color = 'var(--text-primary)';
            comboSlotElement.draggable = false;
            delete comboSlotElement.dataset.dnaInfo;
            comboSlotElement.removeEventListener('dragstart', handleDragStart); 
        }


        function clearCombinationSlot(comboSlotId, returnToInventory = true) {
            const comboSlotElement = dnaCombinationSlotsContainer.querySelector(`.dna-slot[data-slot-id="${comboSlotId}"]`);
            if (!comboSlotElement || !combinationSlotsData[comboSlotId]) return;

            const returnedDNA = combinationSlotsData[comboSlotId];
            clearCombinationSlotUI(comboSlotId); 

            if (returnToInventory) {
                const emptyInventorySlotIndex = inventoryDisplaySlots.findIndex((slot, index) => slot === null && index < DELETE_SLOT_INDEX);
                if (emptyInventorySlotIndex !== -1) {
                    inventoryDisplaySlots[emptyInventorySlotIndex] = returnedDNA;
                } else {
                    const emptyTempSlotIndex = temporaryBackpackSlots.findIndex(slot => slot === null);
                    if (emptyTempSlotIndex !== -1) {
                        temporaryBackpackSlots[emptyTempSlotIndex] = returnedDNA;
                        populateTemporaryBackpack();
                    } else {
                        playerOwnedDNA.push(returnedDNA); 
                        console.warn("No empty slot in inventory or temp backpack to return DNA, added to main DNA list:", returnedDNA.name);
                    }
                }
            }
            populateInventory();
            updateActionButtonsState();
        }

        function handleComboSlotClick(e) {
            const cSE=e.target.closest('.dna-slot[data-droptype="combination"]');
            if(!cSE)return;
            const cSI=parseInt(cSE.dataset.slotId);
            if(combinationSlotsData[cSI]){clearCombinationSlot(cSI,true);}
        }

        // --- Monster Combination & Stats ---
        async function combineDNA() {
            const combinedDNAs = combinationSlotsData.filter(dna => dna !== null);
            if (combinedDNAs.length === 0) {
                showFeedbackModal("æç¤º", "è«‹è‡³å°‘æ”¾å…¥ä¸€å€‹DNAç‰‡æ®µé€²è¡Œçµ„åˆï¼", false, true, false); return;
            }
            let totalAttack = 0, totalDefense = 0, totalSpeed = 0, totalHp = 0, totalMp = 0, totalCrit = 0;
            let types = [], combinedDNADescriptionForAI = "DNAçµ„åˆåŒ…å«ï¼š";
            let monsterElementsCount = {};
            let totalRarityMultiplier = 0;
            let totalSkillLevelBonus = 0;
            let combinedResistances = {};

            combinedDNAs.forEach(dna => {
                const rarityData = getRarityData(dna.rarity);
                totalAttack += dna.attack * rarityData.statMultiplier; 
                totalDefense += dna.defense * rarityData.statMultiplier;
                totalSpeed += dna.speed * rarityData.statMultiplier;
                totalHp += dna.hp * rarityData.statMultiplier;
                totalMp += dna.mp * rarityData.statMultiplier;
                totalCrit += dna.crit; 
                totalRarityMultiplier += rarityData.statMultiplier;
                totalSkillLevelBonus += rarityData.skillLevelBonus;

                if (dna.resistances) {
                    for (const resType in dna.resistances) {
                        combinedResistances[resType] = (combinedResistances[resType] || 0) + dna.resistances[resType] + rarityData.resistanceBonus;
                    }
                }

                if (!types.includes(dna.type)) types.push(dna.type);
                monsterElementsCount[dna.type] = (monsterElementsCount[dna.type] || 0) + 1;
                combinedDNADescriptionForAI += `${dna.name}(${dna.type}, ${dna.rarity}, æè¿°: ${dna.description}) `;
            });
            
            const avgRarityMultiplier = combinedDNAs.length > 0 ? totalRarityMultiplier / combinedDNAs.length : 1;
            const avgSkillLevelBonus = combinedDNAs.length > 0 ? Math.round(totalSkillLevelBonus / combinedDNAs.length) : 0;

            totalAttack = Math.round(totalAttack / combinedDNAs.length * avgRarityMultiplier);
            totalDefense = Math.round(totalDefense / combinedDNAs.length * avgRarityMultiplier);
            totalSpeed = Math.round(totalSpeed / combinedDNAs.length * avgRarityMultiplier);
            totalHp = Math.round(totalHp / combinedDNAs.length * avgRarityMultiplier);
            totalMp = Math.round(totalMp / combinedDNAs.length * avgRarityMultiplier);
            totalCrit = combinedDNAs.length > 0 ? Math.min(Math.floor(totalCrit / combinedDNAs.length), 75) : 0;
            
            let elementComposition = {};
            if (combinedDNAs.length > 0) {
                for (const type in monsterElementsCount) {
                    elementComposition[type] = Math.round((monsterElementsCount[type] / combinedDNAs.length) * 100);
                }
            }
            const primaryElements = Object.keys(elementComposition).sort((a,b) => elementComposition[b] - elementComposition[a]);
            
            showFeedbackModal("æ­£åœ¨åˆæˆæ€ªç‰©...", "", true, false, false); 
            const monsterName = await generateMonsterNameAI(primaryElements, combinedDNAs); 
            const skills = generateMonsterSkills(primaryElements, totalAttack, totalDefense, totalSpeed, avgSkillLevelBonus); 
            const score = Math.floor((totalAttack + totalDefense + totalSpeed + (totalHp/4) + (totalMp/2) + totalCrit*2) * (Object.keys(elementComposition).length || 1) * avgRarityMultiplier * (Math.random() * 0.2 + 0.9));
            const monsterId = `m-${Date.now()}-${Math.random().toString(36).substring(2,7)}`;

            currentMonster = {
                id: monsterId,
                nickname: monsterName, title: "æ–°æ˜Ÿ",
                attack: Math.round(totalAttack), defense: Math.round(totalDefense), speed: Math.round(totalSpeed), 
                hp: Math.round(totalHp), mp: Math.round(totalMp), crit: Math.round(totalCrit),
                elements: primaryElements, 
                elementComposition: elementComposition,
                skills: skills, score: score, 
                creationTime: new Date().toLocaleString('zh-TW', { hour12: false }),
                personality: generatePersonalityObject(), 
                description: generateMonsterDescriptionText(types, monsterElementsCount, totalAttack, totalDefense, totalSpeed), 
                aiEvaluation: null,
                monsterTitles: ["åˆç”Ÿ"], monsterMedals: 0,
                resume: { wins: 0, losses: 0 },
                activityLog: [], 
                healthConditions: [], 
                resistances: combinedResistances, 
                farmStatus: { active: false, type: null, endTime: null, timerId: null, originalStats: null, boosts: {}, isBattling: false, isTraining: false, trainingStartTime: null } 
            };
            
            playerOwnedMonsters.push({...currentMonster});
            if (farmedMonsters.length < MAX_FARM_SLOTS) {
                farmedMonsters.push(currentMonster); 
                addLogEntry(currentMonster, "èª•ç”Ÿä¸¦åŠ å…¥è¾²å ´ã€‚");
            } else {
                 addLogEntry(currentMonster, "èª•ç”Ÿäº†ï¼ä½†è¾²å ´å·²æ»¿ï¼Œç„¡æ³•è‡ªå‹•åŠ å…¥ã€‚");
            }
            
            updateMonsterSnapshotDisplay(currentMonster);
            monsterInfoButton.disabled = false;
            
            getAIEvaluation(currentMonster, combinedDNADescriptionForAI); 

            combinationSlotsData.fill(null);
            createCombinationSlots(); 
            updateActionButtonsState();
            populateFarmList();
        }
        
        async function generateMonsterNameAI(elements, dnas) {
            // Simulated AI Name Generation
            const elementPrefixes = { 'ç«': 'ç‚', 'æ°´': 'æ¾¤', 'æœ¨': 'æ£®', 'é‡‘': 'é‹¼', 'åœŸ': 'å²©', 'å…‰': 'è–', 'æš—': 'å½±', 'æ¯’': 'ç˜´', 'é¢¨': 'åµ', 'ç„¡': 'å…ƒ' };
            const nameSuffixes = ['ç¸', 'éˆ', 'æ€ª', 'é­”', 'ä½¿', 'å›', 'è¡›', 'é¾', 'ç‹¼', 'ç…', 'é³¥', 'èŸ²', 'ç²¾'];
            
            let prefix = "";
            if (elements.length > 0) {
                prefix = elementPrefixes[elements[0]] || '';
                if (elements.length > 1 && Math.random() > 0.5) {
                    prefix += elementPrefixes[elements[1]] || '';
                }
            } else {
                prefix = elementPrefixes['ç„¡'];
            }

            let coreName = "";
            if (dnas.length > 0) {
                const randomDnaName = dnas[Math.floor(Math.random() * dnas.length)].name;
                coreName = randomDnaName.substring(0, Math.min(2, randomDnaName.length -1)); 
            } else {
                coreName = "åˆ";
            }
            
            let suffix = nameSuffixes[Math.floor(Math.random() * nameSuffixes.length)];
            let finalName = prefix + coreName + suffix;
            
            if (finalName.length > 5) { 
                if (prefix.length > 2 && coreName.length > 1) finalName = prefix.substring(0,1) + coreName.substring(0,1) + suffix;
                else if (prefix.length > 1) finalName = prefix.substring(0, Math.max(1, 5 - suffix.length - coreName.length)) + coreName + suffix;
                else if (coreName.length > 1) finalName = prefix + coreName.substring(0, Math.max(1, 5 - suffix.length - prefix.length)) + suffix;
                finalName = finalName.substring(0,5);
            }
            if (finalName.length < 2 && dnas.length > 0) { 
                finalName = dnas[0].name.substring(0,2) + "ç¸";
                finalName = finalName.substring(0,5);
            }
            if (finalName.length < 2) finalName = "å…ƒç¸";


            return finalName; 
        }

        
        function generateMonsterDescriptionText(elements, elementCounts, attack, defense, speed) {
            let desc = `é€™æ˜¯ä¸€éš»æ¥µå…·æ½›åŠ›çš„æ€ªç¸ï¼Œå¾å…¶DNAåºåˆ—ä¸­ï¼Œæˆ‘å€‘å¯ä»¥çœ‹å‡ºå®ƒæ‰¿è¼‰äº†å¤è€è€Œå¼·å¤§çš„åŠ›é‡ã€‚`;
            if (elements.length > 0) {
                desc += `ä¸»è¦çš„å±¬æ€§æ§‹æˆå‚¾å‘æ–¼ ${elements.map(el => `${elementCounts[el] > 1 ? 'é¡¯è‘—çš„' : 'ä¸€çµ²'}${el}å±¬æ€§`).join('èˆ‡')} çš„èåˆï¼Œé€™è³¦äºˆäº†å®ƒç¨ç‰¹çš„æˆ°é¬¥é¢¨æ ¼å’Œç”Ÿå­˜ç­–ç•¥ã€‚`;
            } else {
                desc += "å…¶å±¬æ€§æ§‹æˆå¦‚åŒä¸€å¼µç™½ç´™ï¼Œå……æ»¿äº†ç„¡é™çš„å¯èƒ½æ€§ï¼Œç­‰å¾…è‘—è¨“ç·´å®¶çš„ç™¼æ˜èˆ‡å¼•å°ã€‚";
            }
            
            desc += ` åœ¨åŸºç¤èƒ½åŠ›æ–¹é¢ï¼Œ`;
            if (attack > defense && attack > speed) desc += `å®ƒå±•ç¾å‡ºé©šäººçš„æ”»æ“Šæ½›èƒ½ï¼Œæ¯ä¸€æ¬¡å‡ºæ‰‹éƒ½å¯èƒ½å¸¶ä¾†æ¯€æ»…æ€§çš„æ‰“æ“Šï¼Œæ˜¯å¤©ç”Ÿçš„æ é£Ÿè€…ã€‚`;
            else if (defense > attack && defense > speed) desc += `å®ƒæ“æœ‰å¦‚å ¡å£˜èˆ¬å …å›ºçš„é˜²ç¦¦ï¼Œèƒ½å¤ æŠµç¦¦çŒ›çƒˆçš„æ”»æ“Šï¼Œåœ¨æŒä¹…æˆ°ä¸­ä½”æ“šå„ªå‹¢ã€‚`;
            else if (speed > attack && speed > defense) desc += `å®ƒä»¥é¢¨é¦³é›»æ£çš„é€Ÿåº¦ç©¿æ¢­æ–¼æˆ°å ´ï¼Œè®“æ•µäººé›£ä»¥æ•æ‰å…¶è¹¤å½±ï¼Œæ“…é•·çªè¥²èˆ‡æ¸¸æ“Šã€‚`;
            else if (attack > 20 && defense > 20 && speed > 15) desc += `å®ƒåœ¨æ”»æ“Šã€é˜²ç¦¦å’Œé€Ÿåº¦æ–¹é¢éƒ½é”åˆ°äº†ä»¤äººå°è±¡æ·±åˆ»çš„å¹³è¡¡ï¼Œæ˜¯ä¸€ä½å…¨èƒ½å‹çš„æˆ°å£«ï¼Œèƒ½å¤ é©æ‡‰å„ç¨®è¤‡é›œçš„æˆ°æ³ã€‚`;
            else desc += `å®ƒçš„å„é …èƒ½åŠ›å‡è¡¡ç™¼å±•ï¼Œæ²’æœ‰æ˜é¡¯çš„çŸ­æ¿ï¼Œé€™ä½¿å¾—å®ƒåœ¨å¤šæ•¸æƒ…æ³ä¸‹éƒ½èƒ½ç©©å®šç™¼æ®ï¼Œæ˜¯å€¼å¾—ä¿¡è³´çš„å¤¥ä¼´ã€‚`;
            
            desc += ` é€éç²¾å¿ƒçš„åŸ¹é¤Šå’Œæ­£ç¢ºçš„å¼•å°ï¼Œé€™éš»æ€ªç¸å¿…å®šèƒ½åœ¨ç„¡æ•¸çš„å†’éšªèˆ‡æŒ‘æˆ°ä¸­ç¶»æ”¾å‡ºè€€çœ¼çš„å…‰èŠ’ï¼Œæˆç‚ºå‚³å¥‡èˆ¬çš„å­˜åœ¨ã€‚`;
            
            while(desc.length < 150) {
                desc += "å®ƒçš„çœ¼ç¥ä¸­é–ƒçˆè‘—æ™ºæ…§èˆ‡å‹‡æ°£çš„å…‰èŠ’ã€‚";
            }
            if (desc.length > 200) {
                desc = desc.substring(0, 197) + "...";
            }
            return desc;
        }

        function generateMonsterSkills(elements, attack, defense, speed, skillLevelBonus = 0) {
            const skillDatabase = {
                'ç«': [
                    { name: "ç«èŠ±", power: 25, crit: 5, probability: 20, story: "å™´å°„å¾®å°çš„ç«èŠ±ã€‚", type: "ç«", baseLevel: 1 },
                    { name: "çƒˆç„°ä¹‹é­", power: 35, crit: 8, probability: 18, story: "æ®èˆç«ç„°é•·é­ã€‚", type: "ç«", baseLevel: 2 },
                    { name: "ç‚çˆ†", power: 50, crit: 10, probability: 12, story: "å¼•çˆ†å¼·çƒˆç«ç„°ã€‚", type: "ç«", baseLevel: 3 },
                    { name: "ç†”å²©å™´ç™¼", power: 60, crit: 5, probability: 10, story: "å™´å‡ºæ»¾ç‡™ç†”å²©ã€‚", type: "ç«", baseLevel: 4 },
                    { name: "ç«ç¥é™è‡¨", power: 80, crit: 15, probability: 7, story: "å¬å–šç«ç¥ä¹‹åŠ›ã€‚", type: "ç«", baseLevel: 5 },
                    { name: "ç‡ƒç‡’ä¹‹é­‚", power: 0, crit: 0, probability: 10, story: "æå‡æ”»æ“Šèˆ‡çˆ†æ“Šã€‚", type: "ç«", effect: "buff", stat: ["attack", "crit"], amount: [10, 5], baseLevel: 2 },
                    { name: "ç°ç‡¼æ•£æ’­", power: 20, crit: 0, probability: 15, story: "æ•£æ’­ç°ç‡¼é™ä½æ•µæ–¹å‘½ä¸­ã€‚", type: "ç«", effect: "debuff", stat: "accuracy", amount: -10, baseLevel: 1 },
                    { name: "ç…‰ç„ç«æŸ±", power: 70, crit: 10, probability: 8, story: "å¾åœ°åº•å¬å–šç…‰ç„ç«æŸ±ã€‚", type: "ç«", baseLevel: 4 },
                    { name: "å¤ªé™½æ‹³", power: 40, crit: 5, probability: 16, story: "ç™¼å‡ºå¦‚å¤ªé™½èˆ¬è€€çœ¼çš„ä¸€æ“Šã€‚", type: "ç«", baseLevel: 3 },
                    { name: "ç«ç„°å±éšœ", power: 0, crit: 0, probability: 12, story: "è£½é€ ç«ç„°å±éšœæå‡é˜²ç¦¦ã€‚", type: "ç«", effect: "buff", stat: "defense", amount: 15, baseLevel: 2 },
                    // ... Add 10 more unique ç« skills
                ],
                'æ°´': [
                    { name: "æ°´æ³¡", power: 20, crit: 5, probability: 22, story: "åå‡ºè¼•ç›ˆæ°´æ³¡ã€‚", type: "æ°´", baseLevel: 1 },
                    { name: "æ¿€æµ", power: 40, crit: 7, probability: 17, story: "å¬å–šæ´¶æ¹§æ°´æµã€‚", type: "æ°´", baseLevel: 2 },
                    { name: "å†°å‡å°„ç·š", power: 30, crit: 10, probability: 15, story: "å°„å‡ºå†°å†·å°„ç·šã€‚", type: "æ°´", effect: "debuff", stat: "speed", amount: -10, baseLevel: 2 },
                    { name: "æµ·å˜¯", power: 65, crit: 5, probability: 8, story: "æ€èµ·å·¨å¤§æµ·å˜¯ã€‚", type: "æ°´", baseLevel: 4 },
                    { name: "æ²»ç™’ä¹‹é›¨", power: 0, crit: 0, probability: 12, story: "é™ä¸‹æ²»ç™’é›¨æ°´ã€‚", type: "æ°´", effect: "heal", amount: 30, baseLevel: 3 },
                    { name: "æ°´æµç’°ç¹", power: 0, crit: 0, probability: 10, story: "æå‡è‡ªèº«è¿´é¿ã€‚", type: "æ°´", effect: "buff", stat: "evasion", amount: 10, baseLevel: 2 },
                    { name: "æ¼©æ¸¦é™·é˜±", power: 35, crit: 5, probability: 14, story: "è£½é€ æ°´æµæ¼©æ¸¦å›°ä½æ•µäººã€‚", type: "æ°´", effect: "stun", duration: 1, baseLevel: 3 },
                    { name: "æ·±æµ·å£“åŠ›", power: 55, crit: 10, probability: 9, story: "æ–½åŠ æ·±æµ·å£“åŠ› crushing an opponent.", type: "æ°´", baseLevel: 4 },
                    { name: "é¡èŠ±æ°´æœˆ", power: 0, crit: 0, probability: 11, story: "è£½é€ å¹»å½±è¿·æƒ‘æ•µäººã€‚", type: "æ°´", effect: "confusion", chance: 30, baseLevel: 3 },
                    { name: "ç”Ÿå‘½ä¹‹æ³‰", power: 0, crit: 0, probability: 8, story: "å¤§å¹…å›å¾©è‡ªèº«ç”Ÿå‘½ã€‚", type: "æ°´", effect: "heal_large", amount: 50, baseLevel: 5 },
                    // ... Add 10 more unique æ°´ skills
                ],
                // ... (Add 20 skills for each of the other elements: æœ¨, é‡‘, åœŸ, å…‰, æš—, æ¯’, é¢¨)
                'ç„¡': [ 
                    { name: "çŒ›æ’", power: 30, crit: 5, probability: 15, story: "æ›´åŠ ç”¨åŠ›çš„æ’æ“Šã€‚", type: "ç„¡", baseLevel: 1},
                    { name: "åˆ©çˆªæ®æ“Š", power: 25, crit: 10, probability: 18, story: "ç”¨é‹’åˆ©çš„çˆªå­é€²è¡Œå¤šæ¬¡æ®ç ã€‚", type: "ç„¡", baseLevel: 1},
                    { name: "é ­æ§Œ", power: 35, crit: 3, probability: 12, story: "ç”¨å …ç¡¬çš„é ­éƒ¨çŒ›åŠ›æ’æ“Šæ•µäººã€‚", type: "ç„¡", baseLevel: 2},
                    { name: "é«˜é€Ÿæ˜Ÿæ˜Ÿ", power: 20, crit: 15, probability: 16, story: "å¿«é€Ÿå°„å‡ºå¤šæšèƒ½é‡æ˜Ÿæ˜Ÿã€‚", type: "ç„¡", baseLevel: 1},
                    { name: "è“„åŠ›ä¸€æ“Š", power: 50, crit: 20, probability: 8, story: "çŸ­æš«è“„åŠ›å¾Œç™¼å‡ºå¼·åŠ›ä¸€æ“Šã€‚", type: "ç„¡", baseLevel: 3},
                    { name: "æ¨èº«è¡æ’", power: 70, crit: 5, probability: 7, story: "ä¸é¡§ä¸€åˆ‡åœ°çŒ›çƒˆæ’æ“Šï¼Œè‡ªèº«ä¹Ÿæœƒå—å‚·ã€‚", type: "ç„¡", effect: "recoil", recoilDamage: 0.25, baseLevel: 4},
                    { name: "æ†¤æ€’", power: 0, crit: 0, probability: 10, story: "å› æ†¤æ€’è€Œæå‡æ”»æ“ŠåŠ›ã€‚", type: "ç„¡", effect: "buff", stat: "attack", amount: 15, baseLevel: 2},
                    { name: "å™ªéŸ³", power: 0, crit: 0, probability: 13, story: "ç™¼å‡ºåˆºè€³å™ªéŸ³é™ä½æ•µæ–¹é˜²ç¦¦ã€‚", type: "ç„¡", effect: "debuff", stat: "defense", amount: -10, baseLevel: 1},
                    { name: "è‡ªæˆ‘æ¿€å‹µ", power: 0, crit: 0, probability: 9, story: "æå‡è‡ªèº«æ‰€æœ‰èƒ½åŠ›ã€‚", type: "ç„¡", effect: "all_stats_buff", amount: 3, baseLevel: 3},
                    { name: "æœ€çµ‚æ‰‹æ®µ", power: 100, crit: 0, probability: 5, story: "è€—ç›¡æ‰€æœ‰åŠ›é‡çš„æœ€å¾Œä¸€æ“Šã€‚", type: "ç„¡", effect: "self_ko", baseLevel: 5},
                ]
            };

            let potentialSkills = [];
            const getRandomLevelWithBonus = (baseLvl) => Math.min(5, Math.max(1, baseLvl + skillLevelBonus + Math.floor(Math.random() * 3) -1));


            elements.forEach(element => {
                if (skillDatabase[element]) {
                    skillDatabase[element].forEach(skill => {
                        if (!potentialSkills.some(ps => ps.name === skill.name)) {
                            potentialSkills.push({...skill, level: getRandomLevelWithBonus(skill.baseLevel) });
                        }
                    });
                }
            });
            skillDatabase['ç„¡'].forEach(skill => {
                 if (potentialSkills.length < 20 && !potentialSkills.some(ps => ps.name === skill.name)) {
                    potentialSkills.push({...skill, level: getRandomLevelWithBonus(skill.baseLevel) });
                }
            });
            while (potentialSkills.length < 5 && skillDatabase['ç„¡'].length > 0) {
                let randomGenericSkill = skillDatabase['ç„¡'][Math.floor(Math.random() * skillDatabase['ç„¡'].length)];
                if (!potentialSkills.some(ps => ps.name === randomGenericSkill.name)) {
                    potentialSkills.push({...randomGenericSkill, level: getRandomLevelWithBonus(randomGenericSkill.baseLevel)});
                } else { break; }
            }

            potentialSkills.sort(() => 0.5 - Math.random());
            let selectedSkills = [];
            let totalProbability = 0;
            const maxSkills = 3;
            const maxTotalProbability = 50 + (elements.length * 5) + (skillLevelBonus * 2);

            for (const skill of potentialSkills) {
                if (selectedSkills.length < maxSkills && (totalProbability + skill.probability) <= maxTotalProbability) {
                    if (!selectedSkills.find(s => s.name === skill.name)) { 
                        selectedSkills.push(skill);
                        totalProbability += skill.probability;
                    }
                }
                if (selectedSkills.length === maxSkills) break;
            }
            
            const defaultSkill = {name:"æ™®é€šæ”»æ“Š",type:"ç„¡",power:10,crit:3,probability:10, baseLevel: 1, story: "ä¸€æ¬¡æ¨™æº–çš„æ”»æ“Šã€‚", description: "ä¸€æ¬¡æ¨™æº–çš„æ”»æ“Šã€‚"};
            while(selectedSkills.length < 1){ 
                 if((totalProbability + defaultSkill.probability) <= maxTotalProbability){
                    let skillToAdd = {...defaultSkill, level: getRandomLevelWithBonus(defaultSkill.baseLevel)};
                    if(selectedSkills.some(s => s.name.startsWith("æ™®é€šæ”»æ“Š"))) skillToAdd.name = `æ™®é€šæ”»æ“Š${selectedSkills.filter(s => s.name.startsWith("æ™®é€šæ”»æ“Š")).length + 1}`;
                    if (!selectedSkills.find(s => s.name === skillToAdd.name)) {
                        selectedSkills.push(skillToAdd); 
                        totalProbability += skillToAdd.probability;
                    } else break;
                } else break; 
            }
             while(selectedSkills.length < maxSkills && selectedSkills.length > 0){ 
                const lightAttack = {name:"è¼•æ“Š",type:"ç„¡",power:5,crit:1,probability:5, baseLevel: 1, story: "ä¸€æ¬¡è¼•å¾®çš„è©¦æ¢æ€§æ”»æ“Šã€‚", description: "ä¸€æ¬¡è¼•å¾®çš„æ”»æ“Šã€‚"};
                if((totalProbability + lightAttack.probability) <= maxTotalProbability && !selectedSkills.find(s => s.name === lightAttack.name)){
                    selectedSkills.push({...lightAttack, level: getRandomLevelWithBonus(lightAttack.baseLevel)}); 
                    totalProbability += lightAttack.probability;
                } else { break; }
            }
            return selectedSkills;
        }
        
        function generatePersonalityObject() {
            const personalities = [
                { 
                    name: "å‹‡æ•¢çš„", 
                    description: "å¤©ç”Ÿçš„æˆ°å£«ï¼Œç„¡æ‰€ç•æ‡¼ï¼Œç¸½æ˜¯è¡åœ¨æœ€å‰ç·šã€‚å®ƒçš„å­—å…¸è£¡æ²’æœ‰ã€Œé€€ç¸®ã€äºŒå­—ï¼Œé¢å°å†å¼·å¤§çš„æ•µäººä¹Ÿèƒ½å‹‡å¾€ç›´å‰ï¼Œç”¨ç„¡æ¯”çš„å‹‡æ°£æ„ŸæŸ“è‘—èº«é‚Šçš„æ¯ä¸€å€‹äººã€‚é€™ç¨®å‹‡æ°£ä¸åƒ…é«”ç¾åœ¨æˆ°é¬¥ä¸­ï¼Œä¹Ÿé«”ç¾åœ¨å®ƒå°æœªçŸ¥ä¸–ç•Œæ¢ç´¢çš„æ¸´æœ›ã€‚", 
                    colorDark: "#e74c3c", colorLight: "#c0392b" 
                },
                { 
                    name: "è†½å°çš„", 
                    description: "å¿ƒæ€ç´°è†©ï¼Œå°å‘¨åœçš„é¢¨å¹è‰å‹•éƒ½ç•°å¸¸æ•æ„Ÿã€‚é›–ç„¶å®ƒå¯èƒ½ä¸æ˜¯ç¬¬ä¸€å€‹è¡é‹’é™·é™£çš„å¤¥ä¼´ï¼Œä½†å®ƒçš„è¬¹æ…å¾€å¾€èƒ½å¹«åŠ©éšŠä¼é¿é–‹ä¸å¿…è¦çš„å±éšªã€‚å®ƒæ›´å–œæ­¡åœ¨å®‰å…¨çš„è§’è½è§€å¯Ÿï¼Œé»˜é»˜ç‚ºå¤¥ä¼´å€‘æä¾›æ”¯æ´ã€‚", 
                    colorDark: "#3498db", colorLight: "#2980b9"
                },
                { 
                    name: "å†·é™çš„", 
                    description: "é ­è…¦æ¸…æ™°ï¼Œè‡¨å±ä¸äº‚ï¼Œæ˜¯éšŠä¼ä¸­çš„æ™ºå›Šã€‚ç„¡è«–æˆ°æ³å¤šéº¼æ··äº‚ï¼Œå®ƒç¸½èƒ½ä¿æŒå†·é™ï¼Œåˆ†æå±€å‹¢ï¼Œæ‰¾å‡ºæœ€ä½³çš„æ‡‰å°ç­–ç•¥ã€‚å®ƒçš„å†·é™å¦‚åŒå®šæµ·ç¥é‡ï¼Œè®“å¤¥ä¼´å€‘æ„Ÿåˆ°å®‰å¿ƒã€‚", 
                    colorDark: "#2ecc71", colorLight: "#27ae60" 
                },
                { 
                    name: "æ€¥èºçš„", 
                    description: "è¡Œå‹•æ´¾ï¼Œæƒ³åˆ°ä»€éº¼å°±ç«‹åˆ»å»åšï¼Œå……æ»¿äº†çˆ†ç™¼åŠ›ã€‚å®ƒä¸å–œæ­¡ç­‰å¾…ï¼Œç¸½æ˜¯æ¸´æœ›è‘—ä¸‹ä¸€å ´æˆ°é¬¥æˆ–å†’éšªã€‚é›–ç„¶æœ‰æ™‚æœƒé¡¯å¾—æœ‰äº›é­¯è½ï¼Œä½†å®ƒçš„ç†±æƒ…å’Œè¡å‹å¾€å¾€èƒ½å¸¶å‹•æ•´å€‹éšŠä¼çš„å£«æ°£ã€‚", 
                    colorDark: "#f39c12", colorLight: "#e67e22"
                },
                { 
                    name: "æ¨‚å¤©çš„", 
                    description: "æ°¸é å……æ»¿é™½å…‰å’Œæ´»åŠ›ï¼Œæ˜¯éšŠä¼ä¸­çš„é–‹å¿ƒæœã€‚å³ä½¿é‡åˆ°æŒ«æŠ˜ï¼Œå®ƒä¹Ÿèƒ½ä¸€ç¬‘ç½®ä¹‹ï¼Œç”¨ç©æ¥µçš„æ…‹åº¦å½±éŸ¿å‘¨åœã€‚æœ‰å®ƒåœ¨çš„åœ°æ–¹ï¼Œä¼¼ä¹æ°¸é ä¸æœƒæœ‰é™°éœ¾ï¼Œç¸½æ˜¯å……æ»¿äº†æ­¡è²ç¬‘èªã€‚", 
                    colorDark: "#f1c40f", colorLight: "#f39c12"
                },
                { 
                    name: "æ‚²è§€çš„", 
                    description: "ç¸½æ˜¯å…ˆæƒ³åˆ°æœ€å£çš„æƒ…æ³ï¼Œé¡¯å¾—æœ‰äº›æ†‚é¬±ã€‚ä½†é€™ç¨®æ‚²è§€ä¹Ÿè®“å®ƒåœ¨è¡Œå‹•å‰æ›´åŠ è¬¹æ…ï¼Œèƒ½å¤ é è¦‹æ½›åœ¨çš„é¢¨éšªã€‚å®ƒå…§å¿ƒæ·±è™•å…¶å¯¦æ¸´æœ›è‘—è¢«ç†è§£å’Œé—œæ‡·ï¼ŒæœŸå¾…è‘—ä¸€çµ²å¸Œæœ›çš„æ›™å…‰ã€‚", 
                    colorDark: "#7f8c8d", colorLight: "#566573"
                },
                 { 
                    name: "æ‡¶æƒ°çš„", 
                    description: "èƒ½åè‘—çµ•ä¸ç«™è‘—ï¼Œèƒ½èººè‘—çµ•ä¸åè‘—ï¼Œæ˜¯å€‹æ¨™æº–çš„äº«æ¨‚ä¸»ç¾©è€…ã€‚å®ƒç¸½èƒ½æ‰¾åˆ°æœ€èˆ’é©çš„æ–¹å¼åº¦éæ¯ä¸€å¤©ã€‚ä¸éï¼Œç•¶çœŸæ­£éœ€è¦å®ƒå‡ºåŠ›çš„æ™‚å€™ï¼Œå®ƒå¶çˆ¾ä¹Ÿæœƒçˆ†ç™¼å‡ºé©šäººçš„æ½›åŠ›ï¼Œè®“äººåˆ®ç›®ç›¸çœ‹ã€‚", 
                    colorDark: "#95a5a6", colorLight: "#7f8c8d"
                },
                { 
                    name: "å‹¤å¥®çš„", 
                    description: "å …ä¿¡åŠªåŠ›å°±èƒ½æ”¹è®Šä¸€åˆ‡ï¼Œæ˜¯å€‹ä¸æŠ˜ä¸æ‰£çš„å¯¦å¹¹å®¶ã€‚å®ƒæ—¥å¾©ä¸€æ—¥åœ°åˆ»è‹¦è¨“ç·´ï¼Œä¸æ–·æå‡è‡ªå·±ï¼Œå¾ä¸æ‡ˆæ€ ã€‚å®ƒçš„å‹¤å¥®æ˜¯å®ƒæˆåŠŸçš„åŸºçŸ³ï¼Œä¹Ÿæ˜¯å¤¥ä¼´å€‘å­¸ç¿’çš„æ¦œæ¨£ã€‚", 
                    colorDark: "#27ae60", colorLight: "#1e8449"
                }
            ];
            const selected = personalities[Math.floor(Math.random() * personalities.length)];
            const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
            return {
                text: selected.description,
                color: currentTheme === 'light' ? selected.colorLight : selected.colorDark,
                name: selected.name 
            };
        }


        function updateMonsterSnapshotDisplay(monster) {
            const defaultImageUrl = "https://github.com/msw2004727/MD/blob/images/000.png?raw=true";
            const bgColor = getComputedStyle(document.body).getPropertyValue('--bg-primary').trim().substring(1);
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-secondary').trim().substring(1);

            if (!monster) {
                monsterImageElement.src = defaultImageUrl;
                monsterImageElement.alt = "é è¨­æ€ªç¸åœ–ç‰‡";
                snapshotAchievementTitle.textContent = "å°šæœªå‘½å";
                snapshotNickname.textContent = '-';
                snapshotWinLoss.innerHTML = `<span>å‹: ${playerStats.wins}</span><span>æ•—: ${playerStats.losses}</span>`; 
                snapshotEvaluation.textContent = 'ç¸½è©•åƒ¹: 0';
                return;
            }
            let mainElement = monster.elements.length > 0 ? monster.elements[0] : "æ··åˆ";
            const elementStyle = getElementStyling(mainElement); 
            const elementColorHex = getComputedStyle(document.documentElement).getPropertyValue(elementStyle.bg.replace(/var\(|\)/g, '')).trim().substring(1);
            const placeholderTextColor = getContrastColor(elementColorHex); 
            
            monsterImageElement.src = `https://placehold.co/200x150/${elementColorHex}/${placeholderTextColor}?text=${encodeURIComponent(monster.nickname)}&font=noto-sans-tc`;
            monsterImageElement.alt = monster.nickname;

            snapshotAchievementTitle.textContent = monster.title || "æ–°ç§€";
            snapshotNickname.textContent = monster.nickname;
            snapshotWinLoss.innerHTML = `<span>å‹: ${playerStats.wins}</span><span>æ•—: ${playerStats.losses}</span>`; 
            snapshotEvaluation.textContent = `ç¸½è©•åƒ¹: ${monster.score}`;
        }

        function updateMonsterInfoModal(monster) {
            if (!monster) {
                monsterInfoModalHeaderContent.innerHTML = `<h3 class="modal-header">æ€ªç‰©è³‡è¨Š</h3>`;
                monsterDetailsTab.innerHTML = "<p class='text-center p-4'>å°šæœªé¸æ“‡æˆ–çµ„åˆæ€ªç¸ã€‚</p>";
                monsterActivityLogsContainer.innerHTML = "<p class='text-center p-4'>å°šç„¡æ´»å‹•ç´€éŒ„ã€‚</p>";
                const firstTabButton = document.querySelector('#monster-info-tabs .tab-button');
                if (firstTabButton) openGenericTab({currentTarget: firstTabButton}, 'monster-details-tab', 'monster-info-modal');
                return;
            }
            monsterInfoModalHeaderContent.innerHTML = `<div class="monster-info-name-styled">${monster.nickname}</div>`;
            
            let elementCompositionHTML = Object.entries(monster.elementComposition)
                .map(([element, percent]) => `<span class="element-composition-item" style="color: ${getElementStyling(element).text}; font-weight: bold;">${element}: ${percent}%</span>`)
                .join(', ');
            if (!elementCompositionHTML) elementCompositionHTML = "ç„¡";

            let skillsHTML = monster.skills.map(skill => `
                <div class="skill-entry">
                    <div class="skill-name">${skill.name} (<span style="color: ${getElementStyling(skill.type).text};">${skill.type}</span>) - Lv.${skill.level} - ${skill.probability}%</div>
                    <div class="skill-details">å¨åŠ›: ${skill.power}, çˆ†æ“Š: ${skill.crit}%</div>
                    <div class="skill-details text-base">${skill.story || skill.description || 'æš«ç„¡è©³ç´°æè¿°'}</div>
                </div>
            `).join('');
            if (monster.skills.length === 0) skillsHTML = "<p>ç„¡å¯ç”¨æ‹›å¼</p>";

            let monsterTitlesHTML = monster.monsterTitles.length > 0 ? monster.monsterTitles.map(t => `<li>${t}</li>`).join('') : "<li>å°šç„¡ç¨±è™Ÿ</li>";
            let monsterMedalsHTML = "";
            for(let i = 0; i < monster.monsterMedals; i++) { monsterMedalsHTML += `<span class="medal-emoji">ğŸŒŸ</span>`; }
            if(monster.monsterMedals === 0) monsterMedalsHTML = "<span>å°šç„¡çç‰Œ</span>";

            const statDisplay = (label, base, boost = 0, debuff = 0) => {
                let displayHTML = `${base}`;
                if (boost > 0) displayHTML += ` <span class="text-[var(--success-color)]">+${boost}</span>`;
                if (debuff < 0) { 
                    displayHTML += ` <span class="text-[var(--danger-color)]">(${debuff})</span>`;
                }
                const suffix = label === "çˆ†æ“Šç‡" ? "%" : "";
                return `<div class="details-item"><span class="details-label">${label}:</span> <span class="details-value">${displayHTML}${suffix}</span></div>`;
            };
            
            const boostedStats = monster.farmStatus && monster.farmStatus.boosts ? monster.farmStatus.boosts : {};
            const personalityObject = monster.personality; 

            let debuffs = { attack: 0, defense: 0, speed: 0, hp: 0, mp: 0, crit: 0 };
            if (monster.healthConditions && monster.healthConditions.length > 0) {
                monster.healthConditions.forEach(condition => {
                    for (const stat in condition.effects) {
                        debuffs[stat] = (debuffs[stat] || 0) + condition.effects[stat];
                    }
                });
            }
            
            let healthConditionsHTML = "";
            if (monster.healthConditions && monster.healthConditions.length > 0) {
                healthConditionsHTML = monster.healthConditions.map(condition => {
                    const effectsString = Object.entries(condition.effects).map(([stat, val]) => `${stat.toUpperCase()}${val}`).join(', ');
                    return `<li>${condition.description} (${effectsString})</li>`;
                }).join('');
            } else {
                healthConditionsHTML = "<li>éå¸¸å¥åº·ï¼</li>";
            }
            
            let resistancesHTML = "<li>ç„¡ç‰¹æ®ŠæŠ—æ€§</li>";
            if (monster.resistances && Object.keys(monster.resistances).length > 0) {
                resistancesHTML = Object.entries(monster.resistances)
                    .map(([type, value]) => `<li>${type}æŠ—æ€§: ${value > 0 ? `+${value}`: value}</li>`)
                    .join('');
            }


            monsterDetailsTab.innerHTML = `
                <div class="details-section">
                    <h4 class="details-section-title">ğŸ“Š åŸºæœ¬ç‹€æ…‹</h4>
                    <div class="details-grid">
                        ${statDisplay("HP", monster.hp, boostedStats.hp, debuffs.hp)}
                        ${statDisplay("MP", monster.mp, boostedStats.mp, debuffs.mp)}
                        ${statDisplay("æ”»æ“ŠåŠ›", monster.attack, boostedStats.attack, debuffs.attack)}
                        ${statDisplay("é˜²ç¦¦åŠ›", monster.defense, boostedStats.defense, debuffs.defense)}
                        ${statDisplay("é€Ÿåº¦", monster.speed, boostedStats.speed, debuffs.speed)}
                        ${statDisplay("çˆ†æ“Šç‡", monster.crit, boostedStats.crit, debuffs.crit)}
                    </div>
                </div>
                <div class="details-section">
                    <h4 class="details-section-title">â¤ï¸ å¥åº·ç‹€æ…‹</h4>
                    <ul class="titles-list">${healthConditionsHTML}</ul>
                </div>
                <div class="details-section">
                    <h4 class="details-section-title">ğŸ›¡ï¸ ç‰¹æ®ŠæŠ—æ€§</h4>
                    <ul class="titles-list">${resistancesHTML}</ul>
                </div>
                 <div class="details-section">
                    <div class="creation-time-centered">å‰µé€ æ™‚é–“: ${monster.creationTime}</div>
                </div>
                <div class="details-section">
                    <h4 class="details-section-title">ğŸ§¬ å±¬æ€§æ§‹æˆ</h4>
                    <div class="details-item"><span class="details-label">ä¸»è¦å±¬æ€§:</span> <span class="details-value">${monster.elements.map(el => `<span style="color: ${getElementStyling(el).text}; font-weight:bold;">${el}</span>`).join(', ') || 'ç„¡'}</span></div>
                    <div class="details-item"><span class="details-label">DNAæ§‹æˆ:</span> <span class="details-value">${elementCompositionHTML}</span></div>
                </div>
                <div class="details-section">
                    <h4 class="details-section-title">âš”ï¸ æ‹›å¼åˆ—è¡¨ (ç­‰ç´š/ä½¿ç”¨æ©Ÿç‡)</h4>
                    ${skillsHTML}
                </div>
                 <div class="details-section titles-medals-section">
                    <h4 class="details-section-title">ğŸ… æ€ªç¸æˆå°±</h4>
                    <ul class="titles-list">${monsterTitlesHTML}</ul>
                    <h4 class="details-section-title" style="margin-top:10px;">ğŸŒŸ æ€ªç¸çç‰Œ (${monster.monsterMedals})</h4>
                    <div class="medals-grid">${monsterMedalsHTML}</div>
                </div>
                <div class="details-section">
                    <h4 class="details-section-title">ğŸ­ å€‹æ€§</h4>
                    <p class="personality-text" style="color: ${personalityObject.color};"><strong>${personalityObject.name}:</strong> ${personalityObject.text}</p>
                </div>
                <div class="details-section">
                    <h4 class="details-section-title">ğŸ“– ä»‹ç´¹</h4>
                    <p class="monster-description-area">${monster.description || "é€™éš»æ€ªç¸å……æ»¿ç¥ç§˜æ„Ÿã€‚"}</p>
                </div>
                <div id="ai-evaluation-display-area" class="details-section">
                    <h4 class="details-section-title">ğŸ¤– æ€ªç‰©è©•åƒ¹</h4>
                    <p>${monster.aiEvaluation ? monster.aiEvaluation.replace(/\n/g, '<br>') : "<i>å°šæœªç”¢ç”Ÿè©•åƒ¹æˆ–è©•åƒ¹è®€å–ä¸­...</i>"}</p>
                </div>
            `;
            updateMonsterActivityLog(monster);
            const firstTabButton = document.querySelector('#monster-info-tabs .tab-button');
            if (firstTabButton) openGenericTab({currentTarget: firstTabButton}, 'monster-details-tab', 'monster-info-modal');
        }
        
        function updatePlayerInfoModal() {
            playerStats.rank=Math.floor(Math.random()*100)+1;
            if(playerStats.wins>5&&!playerStats.titles.includes("æˆ°é¬¥æ–°æ‰‹"))playerStats.titles.push("æˆ°é¬¥æ–°æ‰‹");
            if(playerStats.wins>10&&!playerStats.achievements.includes("åæˆ°é”æˆ"))playerStats.achievements.push("åæˆ°é”æˆ");
            if(playerStats.wins>15&&!playerStats.titles.includes("æ ¼é¬¥å®¶"))playerStats.titles.push("æ ¼é¬¥å®¶");

            let tsH=playerStats.titles.length>0?playerStats.titles.map(t=>`<li class="player-titles-list-item">${t}</li>`).join(''):"<li>å°šç„¡ç¨±è™Ÿ</li>";
            let acH=playerStats.achievements.length>0?playerStats.achievements.map(a=>`<li class="player-titles-list-item">${a}</li>`).join(''):"<li>å°šç„¡æˆå°±</li>";
            let msH="";
            for(let i=0;i<playerStats.medals;i++){msH+=`<span class="medal-emoji">ğŸ†</span>`;}
            if(playerStats.medals===0)msH="<span>å°šç„¡çç‰Œ</span>";

            let ownedMonstersHTML = '<h4 class="details-section-title mt-4">ğŸ¾ æ“æœ‰éçš„æ€ªç¸</h4>';
            if (playerOwnedMonsters.length === 0) {
                ownedMonstersHTML += '<p class="text-sm text-[var(--text-secondary)]">å°šæœªæ“æœ‰ä»»ä½•æ€ªç¸ã€‚</p>';
            } else {
                const groupedMonsters = playerOwnedMonsters.reduce((acc, monster) => {
                    const mainElement = monster.elements[0] || 'å…¶ä»–'; 
                    if (!acc[mainElement]) {
                        acc[mainElement] = [];
                    }
                    acc[mainElement].push(monster);
                    return acc;
                }, {});

                for (const element in groupedMonsters) {
                    ownedMonstersHTML += `<h5 class="text-sm font-semibold mt-3 mb-1" style="color: ${getElementStyling(element).text};">${element}å±¬æ€§</h5>`;
                    ownedMonstersHTML += '<ul class="owned-monsters-list">';
                    groupedMonsters[element]
                        .sort((a, b) => b.score - a.score) 
                        .forEach(monster => {
                            ownedMonstersHTML += `<li><span class="monster-name">${monster.nickname}</span> <span class="monster-score">è©•åƒ¹: ${monster.score}</span></li>`;
                        });
                    ownedMonstersHTML += '</ul>';
                }
            }

            playerInfoModalBody.innerHTML=`
                <div class="details-section">
                    <h4 class="details-section-title">ç©å®¶æª”æ¡ˆ</h4>
                    <div class="details-item"><span class="details-label">æš±ç¨±:</span> <span class="details-value">${playerNickname}</span></div>
                    <div class="details-item"><span class="details-label">è‹±é›„æ¦œæ’å:</span> <span class="details-value">#${playerStats.rank}</span></div>
                    <div class="details-item"><span class="details-label">ç¸½å‹å ´:</span> <span class="details-value">${playerStats.wins}</span></div>
                    <div class="details-item"><span class="details-label">ç¸½æ•—å ´:</span> <span class="details-value">${playerStats.losses}</span></div>
                    <div class="details-item"><span class="details-label">ç¸½ç©åˆ†:</span> <span class="details-value">${playerStats.score}</span></div>
                </div>
                <div class="details-section titles-medals-section">
                    <h4 class="details-section-title">å·²ç²å¾—ç¨±è™Ÿ</h4><ul class="titles-list">${tsH}</ul>
                </div>
                <div class="details-section titles-medals-section">
                    <h4 class="details-section-title">ç©å®¶æˆå°±</h4><ul class="achievements-list">${acH}</ul>
                </div>
                <div class="details-section titles-medals-section">
                    <h4 class="details-section-title">å‹åˆ©çç‰Œ (${playerStats.medals})</h4><div class="medals-grid">${msH}</div>
                </div>
                <div class="details-section">${ownedMonstersHTML}</div>`;
        }

        function openModal(modalId) { const m=document.getElementById(modalId); if(m)m.style.display='flex';}
        function closeModal(modalId) { const m=document.getElementById(modalId); if(m)m.style.display='none';}
        
        function showFeedbackModal(title, messageOrAiEval, showSpinner, showCloseXButton = true, showMonsterDetails = false, monsterForDetails = null) {
            feedbackModalTitle.textContent = title;
            feedbackModalSpinner.style.display = showSpinner ? 'block' : 'none';
            feedbackModalCloseX.style.display = showCloseXButton ? 'block' : 'none';
            
            const feedbackMonsterDetailsContent = feedbackMonsterDetailsDiv; 
            feedbackMonsterDetailsContent.innerHTML = ''; 

            if (showMonsterDetails && monsterForDetails) {
                feedbackModalMessage.innerHTML = ""; 
                feedbackMonsterDetailsDiv.style.display = 'block';
                const personalityObj = monsterForDetails.personality; 
                
                let elementCompHTML = Object.entries(monsterForDetails.elementComposition)
                    .map(([el, pc]) => `<span style="color:${getElementStyling(el).text}; font-weight:bold;">${el} ${pc}%</span>`)
                    .join(', ');
                
                let skillsHTML = monsterForDetails.skills.map(s => `
                    <div class="feedback-skill-entry">
                        <div class="feedback-skill-name">${s.name} (<span style="color:${getElementStyling(s.type).text};">${s.type}</span>) - Lv.${s.level}</div>
                        <div class="feedback-skill-description">${s.story || s.description}</div>
                    </div>`).join('');

                let resistancesHTML = "ç„¡ç‰¹æ®ŠæŠ—æ€§";
                if (monsterForDetails.resistances && Object.keys(monsterForDetails.resistances).length > 0) {
                    resistancesHTML = Object.entries(monsterForDetails.resistances)
                        .map(([type, value]) => `<span style="color:${getElementStyling(type).text};">${type}æŠ—æ€§: ${value > 0 ? `+${value}`: value}</span>`)
                        .join(', ');
                }
                
                let healthConditionsHTML = "å¥åº·ç‹€æ³è‰¯å¥½";
                if (monsterForDetails.healthConditions && monsterForDetails.healthConditions.length > 0) {
                    healthConditionsHTML = monsterForDetails.healthConditions.map(condition => {
                        const effectsString = Object.entries(condition.effects).map(([stat, val]) => `${stat.toUpperCase()}${val}`).join(', ');
                        return `<span>${condition.description} (${effectsString})</span>`;
                    }).join('<br>');
                }

                feedbackMonsterDetailsContent.innerHTML = `
                    <div class="details-section !p-2 !mb-2">
                        <h4 class="details-section-title !text-base !mb-1">ğŸ“Š åŸºæœ¬ç‹€æ…‹</h4>
                        <p class="text-base">æ”»æ“Š: ${monsterForDetails.attack}, é˜²ç¦¦: ${monsterForDetails.defense}, é€Ÿåº¦: ${monsterForDetails.speed}, HP: ${monsterForDetails.hp}</p>
                    </div>
                    <div class="details-section !p-2 !mb-2">
                        <h4 class="details-section-title !text-base !mb-1">â¤ï¸ å¥åº·ç‹€æ…‹</h4>
                        <p class="text-base">${healthConditionsHTML}</p>
                    </div>
                    <div class="details-section !p-2 !mb-2">
                        <h4 class="details-section-title !text-base !mb-1">ğŸ›¡ï¸ ç‰¹æ®ŠæŠ—æ€§</h4>
                        <p class="text-base">${resistancesHTML}</p>
                    </div>
                    <div class="details-section !p-2 !mb-2">
                        <h4 class="details-section-title !text-base !mb-1">âš”ï¸ æ‹›å¼</h4>
                        <div class="text-base">${skillsHTML || "ç„¡"}</div>
                    </div>
                    <div class="details-section !p-2 !mb-2">
                        <h4 class="details-section-title !text-base !mb-1">ğŸ­ å€‹æ€§</h4>
                        <p class="text-base personality-text" style="color: ${personalityObj.color};">${personalityObj.text}</p>
                    </div>
                     <div class="details-section !p-2 !mb-2">
                        <h4 class="details-section-title !text-base !mb-1">ğŸ“– ä»‹ç´¹</h4>
                        <p class="text-base monster-description-area !p-1 !mt-1">${monsterForDetails.description || "æš«ç„¡è©³ç´°ä»‹ç´¹ã€‚"}</p>
                    </div>
                     <div class="details-section !p-2">
                        <h4 id="feedback-ai-eval-title" class="details-section-title !text-base !mb-1">ğŸ¤– æ€ªç‰©è©•åƒ¹</h4>
                        <p class="text-base">${monsterForDetails.aiEvaluation ? monsterForDetails.aiEvaluation.replace(/\n/g, '<br>') : "<i>è©•åƒ¹ç”Ÿæˆä¸­...</i>"}</p>
                    </div>
                `;


            } else {
                feedbackMonsterDetailsDiv.style.display = 'none';
                feedbackModalMessage.innerHTML = messageOrAiEval.replace(/\n/g, '<br>');
            }
            openModal('feedback-modal');
        }

        async function getAIEvaluation(monsterInstance, combinedDNADescriptionForAI) {
            const apiKey=""; 
            const apiUrl=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const personalityTextForAI = monsterInstance.personality.name + ": " + monsterInstance.personality.text;
            const prompt=`ä½ æ˜¯ä¸€ä½è³‡æ·±çš„æ€ªç¸é¤ŠæˆéŠæˆ²è¨­è¨ˆå¸«ã€‚ç©å®¶å‰›å‰›é€éDNAçµ„åˆå‰µé€ äº†ä¸€éš»æ–°çš„æ€ªç¸ã€‚
æ€ªç¸è³‡æ–™:
- åç¨±: ${monsterInstance.nickname}
- å€‹æ€§: ${personalityTextForAI}
- ç¨±è™Ÿ: ${monsterInstance.title}
- å±¬æ€§: ${monsterInstance.elements.map(el => `${el} (${monsterInstance.elementComposition[el] || 0}%)`).join(', ')||'ç„¡'}
- åŸºç¤æ•¸å€¼: HP ${monsterInstance.hp}, MP ${monsterInstance.mp}, æ”»æ“Š ${monsterInstance.attack}, é˜²ç¦¦ ${monsterInstance.defense}, é€Ÿåº¦ ${monsterInstance.speed}, çˆ†æ“Š ${monsterInstance.crit}%
- æ‹›å¼: ${monsterInstance.skills.map(s=>`${s.name} (Lv.${s.level} ${s.type}, å¨åŠ› ${s.power}, çˆ†æ“Š ${s.crit}%, æ©Ÿç‡ ${s.probability}%, æ•…äº‹: ${s.story})`).join('; ')||'ç„¡'}
- ç¸½è©•åƒ¹åˆ†æ•¸: ${monsterInstance.score}
- æ€ªç¸æ•´é«”ä»‹ç´¹: ${monsterInstance.description}
çµ„åˆçš„DNAæè¿°: ${combinedDNADescriptionForAI}

è«‹åŸºæ–¼ä»¥ä¸Šè³‡è¨Šï¼Œå°é€™æ¬¡çš„DNAçµ„åˆçµæœçµ¦äºˆä¸€æ®µå……æ»¿è¶£å‘³å’Œæ´å¯Ÿçš„è©•åƒ¹ (å¤§ç´„100-150å­—ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡)ã€‚
è©•åƒ¹æ‡‰åŒ…å«ï¼š
1. å°æ€ªç¸æ•´é«”æ¦‚å¿µçš„çœ‹æ³•ã€‚
2. å„ªé»å’Œæ½›åŠ›ã€‚
3. å¯èƒ½çš„å¼±é»æˆ–å¯ä»¥æ”¹é€²çš„æ–¹å‘ã€‚
4. ä¸€å¥ç¸½çµæ€§çš„è©•èªæˆ–å»ºè­°ã€‚`;

            try{
                const r=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{role:"user",parts:[{text:prompt}]}]})});
                if(!r.ok){
                    const eD=await r.json(); console.error("API Error:",eD);
                    monsterInstance.aiEvaluation=`ç„¡æ³•å–å¾—AIè©•åƒ¹ï¼ŒéŒ¯èª¤ï¼š${r.status} ${r.statusText}.`;
                } else {
                    const res=await r.json();
                    if(res.candidates&&res.candidates[0].content&&res.candidates[0].content.parts[0]){
                        monsterInstance.aiEvaluation=res.candidates[0].content.parts[0].text;
                    }else{
                        monsterInstance.aiEvaluation="AIå›å‚³çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼Œç„¡æ³•é¡¯ç¤ºè©•åƒ¹ã€‚";
                    }
                }
            }catch(e){
                console.error("Fetch error:",e);
                monsterInstance.aiEvaluation=`é€£ç·šåˆ°AIæœå‹™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${e.message}`;
            }
            showFeedbackModal("æ€ªç‰©åˆæˆæˆåŠŸï¼ ğŸ‰", "", false, true, true, monsterInstance);
        }

        function populateFarmList() {
            farmedMonstersListContainer.innerHTML = '';
            if (farmedMonsters.length === 0) {
                farmedMonstersListContainer.innerHTML = '<p class="text-center text-base text-[var(--text-secondary)] py-4">ğŸ¡ è¾²å ´ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»çµ„åˆæ€ªç¸å§ï¼</p>'; // text-sm to text-base
                return;
            }

            farmedMonsters.forEach((monster, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'farm-monster-item';
                itemDiv.dataset.monsterId = monster.id; 

                const battleBtn = document.createElement('button');
                battleBtn.className = 'farm-battle-btn';
                battleBtn.textContent = monster.farmStatus.isBattling ? 'ğŸ”´' : 'ğŸŸ¢'; 
                battleBtn.title = monster.farmStatus.isBattling ? 'ä¼‘æ¯' : 'å‡ºæˆ°';
                battleBtn.onclick = () => toggleBattleStatus(monster.id);


                const nameDiv = document.createElement('div');
                nameDiv.className = 'farm-monster-name';
                nameDiv.textContent = monster.nickname;

                const statusDiv = document.createElement('div');
                statusDiv.className = 'farm-monster-status';
                updateFarmMonsterStatusDisplay(monster, statusDiv);


                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'farm-monster-score';
                scoreDiv.textContent = monster.score;

                const infoBtn = document.createElement('button');
                infoBtn.className = 'farm-monster-info-btn secondary';
                infoBtn.textContent = 'è³‡è¨Š'; 
                infoBtn.onclick = () => {
                    updateMonsterInfoModal(monster);
                    openModal('monster-info-modal');
                };
                
                const cultivateBtn = document.createElement('button');
                cultivateBtn.className = 'farm-monster-cultivate-btn warning'; 
                cultivateBtn.textContent = monster.farmStatus.isTraining ? 'çµæŸä¿®ç…‰' : 'é¤Šæˆ'; 
                cultivateBtn.disabled = monster.farmStatus.active || monster.farmStatus.isBattling; 
                if (monster.farmStatus.isTraining) { 
                    cultivateBtn.onclick = () => pauseTraining(monster.id); 
                } else {
                    cultivateBtn.onclick = () => openCultivationSetupModal(monster.id);
                }


                const releaseBtn = document.createElement('button');
                releaseBtn.className = 'farm-monster-release-btn danger';
                releaseBtn.textContent = 'æ”¾ç”Ÿ'; 
                releaseBtn.disabled = monster.farmStatus.active || monster.farmStatus.isBattling || monster.farmStatus.isTraining;
                releaseBtn.onclick = () => promptReleaseMonster(index); 
                
                itemDiv.append(battleBtn, nameDiv, statusDiv, scoreDiv, infoBtn, cultivateBtn, releaseBtn);
                farmedMonstersListContainer.appendChild(itemDiv);
            });
        }
        
        function toggleBattleStatus(monsterIdToBattle) {
            let newBattlingMonster = null;
            farmedMonsters.forEach(m => {
                if (m.id === monsterIdToBattle) {
                    if (m.farmStatus.isTraining || m.farmStatus.active) { 
                        showFeedbackModal("æç¤º", `${m.nickname} æ­£åœ¨${m.farmStatus.isTraining ? 'ä¿®ç…‰' : 'æ‹¾è’'}ä¸­ï¼Œç„¡æ³•å‡ºæˆ°ã€‚`, false, true, false);
                        return;
                    }
                    m.farmStatus.isBattling = !m.farmStatus.isBattling; 
                     addLogEntry(m, m.farmStatus.isBattling ? "ğŸŸ¢ é€²å…¥å‡ºæˆ°ç‹€æ…‹ã€‚" : "ğŸ”´ è§£é™¤å‡ºæˆ°ç‹€æ…‹ï¼Œé–‹å§‹ä¼‘æ¯ã€‚");
                     if (m.farmStatus.isBattling) {
                        newBattlingMonster = m;
                     }
                } else {
                    m.farmStatus.isBattling = false; 
                }
            });
            battlingMonsterId = newBattlingMonster ? newBattlingMonster.id : null;
            
            if (newBattlingMonster) {
                currentMonster = newBattlingMonster;
            } else if (farmedMonsters.length > 0 && !battlingMonsterId) {
                // If no one is battling, but there are monsters in farm,
                // currentMonster could be the last combined or the first in farm.
                // For simplicity, if unsetting battle, and currentMonster was the one battling, set to null or first in farm.
                if (currentMonster && currentMonster.id === monsterIdToBattle) {
                     currentMonster = farmedMonsters.length > 0 ? farmedMonsters[0] : null;
                }
            } else if (farmedMonsters.length === 0 && playerOwnedMonsters.length === 0) {
                currentMonster = null; // No monsters anywhere
            }
            // If currentMonster is null after above logic, and there are playerOwnedMonsters, pick the first.
            if (!currentMonster && playerOwnedMonsters.length > 0) {
                currentMonster = playerOwnedMonsters[0];
            }


            updateMonsterSnapshotDisplay(currentMonster);
            monsterInfoButton.disabled = !currentMonster;
            if (currentMonster) {
                 monsterInfoButton.onclick = () => { updateMonsterInfoModal(currentMonster); openModal('monster-info-modal');};
            }

            populateFarmList(); 
        }


        function updateFarmMonsterStatusDisplay(monster, statusDivElement) {
            if (monster.farmStatus.isBattling) {
                statusDivElement.textContent = 'å‡ºæˆ°ä¸­'; 
                statusDivElement.classList.add('battling');
                statusDivElement.classList.remove('active');
            } else if (monster.farmStatus.isTraining) { 
                const elapsed = Math.floor((Date.now() - monster.farmStatus.trainingStartTime) / 1000);
                statusDivElement.textContent = `ä¿®ç…‰ä¸­... (${elapsed}ç§’)`; 
                statusDivElement.classList.add('active'); 
                statusDivElement.classList.remove('battling');
            } else if (monster.farmStatus.active) { 
                const timeLeft = Math.max(0, Math.floor((monster.farmStatus.endTime - Date.now()) / 1000));
                const actionText = 'ğŸ§º æ‹¾è’ä¸­';
                statusDivElement.textContent = `${actionText} (${timeLeft}ç§’)`;
                statusDivElement.classList.add('active');
                statusDivElement.classList.remove('battling');

                if (timeLeft === 0 && !monster.farmStatus.completed) { 
                    monster.farmStatus.completed = true; 
                    clearInterval(monster.farmStatus.timerId);
                    monster.farmStatus.timerId = null;
                    statusDivElement.innerHTML = ''; 

                    const completeBtn = document.createElement('button');
                    completeBtn.textContent = 'âœ… æ”¶ç©«';
                    completeBtn.className = 'farm-complete-btn success';
                    completeBtn.onclick = () => handleFarmActionComplete(monster);
                    statusDivElement.appendChild(completeBtn);
                }
            } else {
                statusDivElement.textContent = 'ğŸ¡ é–’ç½®ä¸­';
                statusDivElement.classList.remove('active');
                statusDivElement.classList.remove('battling');
            }
        }
        
        function openCultivationSetupModal(monsterId) {
            currentCultivationMonster = farmedMonsters.find(m => m.id === monsterId);
            if (!currentCultivationMonster) return;
            cultivationMonsterName.textContent = currentCultivationMonster.nickname;
            openModal('cultivation-setup-modal');
        }

        startCultivationBtn.onclick = () => {
            if (!currentCultivationMonster) return;
            
            currentCultivationMonster.farmStatus.isTraining = true;
            currentCultivationMonster.farmStatus.trainingStartTime = Date.now();
            currentCultivationMonster.farmStatus.active = false; 
            currentCultivationMonster.farmStatus.type = 'train'; 
            currentCultivationMonster.farmStatus.boosts = currentCultivationMonster.farmStatus.boosts || { hp: 0, mp: 0, attack: 0, defense: 0, speed: 0, crit: 0};


            addLogEntry(currentCultivationMonster, "ğŸ‹ï¸ é–‹å§‹äº†æ–°çš„ä¿®ç…‰ã€‚");
            closeModal('cultivation-setup-modal');
            populateFarmList(); 
            
            if (currentCultivationMonster.farmStatus.timerId) clearInterval(currentCultivationMonster.farmStatus.timerId);
            currentCultivationMonster.farmStatus.timerId = setInterval(() => {
                const farmItem = farmedMonstersListContainer.querySelector(`.farm-monster-item[data-monster-id="${currentCultivationMonster.id}"]`);
                if (farmItem) {
                    const statusDiv = farmItem.querySelector('.farm-monster-status');
                    if (statusDiv) updateFarmMonsterStatusDisplay(currentCultivationMonster, statusDiv);
                }
                if (!currentCultivationMonster.farmStatus.isTraining) { 
                    clearInterval(currentCultivationMonster.farmStatus.timerId);
                    currentCultivationMonster.farmStatus.timerId = null;
                }
            }, 1000);
        };

        function pauseTraining(monsterId) { 
            const monster = farmedMonsters.find(m => m.id === monsterId);
            if (!monster || !monster.farmStatus.isTraining) return;

            if (monster.farmStatus.timerId) {
                clearInterval(monster.farmStatus.timerId);
                monster.farmStatus.timerId = null;
            }

            const trainingDuration = Math.floor((Date.now() - monster.farmStatus.trainingStartTime) / 1000);
            monster.farmStatus.isTraining = false;

            addLogEntry(monster, `ä¿®ç…‰çµæŸï¼Œå…±æŒçºŒ ${trainingDuration} ç§’ã€‚`); 
            resolveTrainingAndShowResults(monster, trainingDuration);
            populateFarmList();
        }
        
        function resolveTrainingAndShowResults(monster, durationSeconds) {
            let story = `åœ¨ ${Math.floor(durationSeconds / 60)}åˆ†${durationSeconds % 60}ç§’ çš„åˆ»è‹¦ä¿®ç…‰ä¸­ï¼Œ${monster.nickname} `;
            let growthLogHTML = "";
            itemsFromCurrentTraining = []; 

            if (durationSeconds < 10) { 
                story += "ä¼¼ä¹é‚„æ²’æ‰¾åˆ°æ„Ÿè¦ºï¼Œåªæ˜¯ç¨å¾®æ´»å‹•äº†ä¸€ä¸‹ç­‹éª¨ã€‚";
                growthLogHTML = "<p>ä¿®ç…‰æ™‚é–“å¤ªçŸ­ï¼Œæœªæœ‰æ˜é¡¯æˆé•·ã€‚</p>";
            } else {
                story += "ç¶“æ­·äº†åš´é…·çš„æŒ‘æˆ°ï¼Œ";
                const growthPoints = Math.max(1, Math.floor(durationSeconds / 20)); 
                let actualBoosts = 0;
                for (let i = 0; i < growthPoints; i++) {
                    if (Math.random() < 0.6) { 
                        const stats = {hp: "ç”Ÿå‘½å€¼", attack: "æ”»æ“ŠåŠ›", defense: "é˜²ç¦¦åŠ›", speed: "é€Ÿåº¦", mp: "é­”åŠ›å€¼", crit: "çˆ†æ“Šç‡"};
                        const statKey = Object.keys(stats)[Math.floor(Math.random() * Object.keys(stats).length)];
                        const boostAmount = Math.floor(Math.random() * (monster.score / 400)) + 1 + Math.floor(durationSeconds / 50);
                        
                        monster[statKey] += boostAmount;
                        monster.farmStatus.boosts[statKey] = (monster.farmStatus.boosts[statKey] || 0) + boostAmount;
                        growthLogHTML += `<p>${stats[statKey]}: <span class="text-[var(--success-color)]">+${boostAmount}</span></p>`; 
                        actualBoosts++;
                    }
                }
                if (actualBoosts > 0) {
                    story += `æˆåŠŸçªç ´äº†è‡ªèº«æ¥µé™ï¼`;
                    monster.score += actualBoosts * Math.floor(durationSeconds / 10); 
                } else {
                    story += `é›–ç„¶æ±—æ°´æµ¸æ¿•äº†å¤§åœ°ï¼Œä½†ä¼¼ä¹é‚„å·®è‡¨é–€ä¸€è…³ã€‚`;
                    growthLogHTML = "<p>æœ¬æ¬¡ä¿®ç…‰æœªæœ‰é¡¯è‘—æ•¸å€¼æˆé•·ï¼Œä½†æ„å¿—æ›´åŠ å …å®šäº†ï¼</p>";
                }

                const itemsToFind = Math.floor(durationSeconds / 45); 
                for (let i = 0; i < itemsToFind; i++) {
                    if (Math.random() < 0.4) { 
                        const randomDnaIndex = Math.floor(Math.random() * initialPlayerDNA.length);
                        const newItem = JSON.parse(JSON.stringify(initialPlayerDNA[randomDnaIndex])); 
                        newItem.tempId = `temp-${Date.now()}-${itemsFromCurrentTraining.length}`; 
                        itemsFromCurrentTraining.push(newItem);
                    }
                }
                if (itemsFromCurrentTraining.length > 0) {
                    story += ` ä¸¦ä¸”åœ¨é€”ä¸­æ„å¤–ç™¼ç¾äº†ä¸€äº›ç¨€æœ‰çš„ææ–™ï¼`;
                } else {
                    story += ` å¯æƒœçš„æ˜¯ï¼Œä¸¦æœªç™¼ç¾ä»»ä½•ç‰¹åˆ¥çš„ç‰©å“ã€‚`;
                }
            }
            
            trainingResultsModalTitle.innerHTML = `ğŸ‰ ${monster.nickname} ä¿®ç…‰æˆæœ ğŸ‰`;
            trainingStoryResult.innerHTML = story;
            trainingGrowthResult.innerHTML = growthLogHTML || "<p>ç„¡æ•¸å€¼è®ŠåŒ–ã€‚</p>";
            
            renderTrainingItems();
            openModal('training-results-modal');
            updateMonsterInfoModal(monster); 
            updateMonsterSnapshotDisplay(monster === currentMonster ? monster : currentMonster);
        }

        function renderTrainingItems() {
            trainingItemsResult.innerHTML = '';
            if (itemsFromCurrentTraining.length === 0) {
                trainingItemsResult.innerHTML = "<p>æœ¬æ¬¡ä¿®ç…‰æœªæ‹¾ç²ä»»ä½•ç‰©å“ã€‚</p>";
                addAllToTempBackpackBtn.style.display = 'none';
                return;
            }
            addAllToTempBackpackBtn.style.display = 'block';
            itemsFromCurrentTraining.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'temp-backpack-item-container p-1 border-b border-[var(--border-color)]';
                const rarityStyle = getRarityStyling(item.rarity);
                const elementStyle = getElementStyling(item.type);
                itemDiv.innerHTML = `
                    <span style="color:${rarityStyle.text}; background-color:${elementStyle.bg}; padding: 2px 4px; border-radius: 3px;">${item.name} (${item.rarity})</span>
                    <button data-item-index="${index}" class="add-one-to-temp-backpack-btn text-base p-1 secondary">â• åŠ å…¥èƒŒåŒ…</button>
                `;
                trainingItemsResult.appendChild(itemDiv);
            });

            document.querySelectorAll('.add-one-to-temp-backpack-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const itemIndex = parseInt(e.target.dataset.itemIndex);
                    const itemToAdd = itemsFromCurrentTraining[itemIndex];
                    if (itemToAdd && !itemToAdd.addedToBackpack) { 
                        addToTemporaryBackpack(itemToAdd);
                        itemToAdd.addedToBackpack = true; 
                        e.target.textContent = 'å·²åŠ å…¥';
                        e.target.disabled = true;
                    }
                };
            });
        }
        
        addAllToTempBackpackBtn.onclick = () => {
            itemsFromCurrentTraining.forEach((item, index) => {
                if (!item.addedToBackpack) { 
                    addToTemporaryBackpack(item);
                    item.addedToBackpack = true; 
                    const btn = trainingItemsResult.querySelector(`.add-one-to-temp-backpack-btn[data-item-index="${index}"]`);
                    if (btn) {
                        btn.textContent = 'å·²åŠ å…¥';
                        btn.disabled = true;
                    }
                }
            });
        };
        
        function closeTrainingResultsModal() {
            const unaddedItems = itemsFromCurrentTraining.filter(item => !item.addedToBackpack);
            if (unaddedItems.length > 0) {
                openModal('reminder-modal');
            } else {
                itemsFromCurrentTraining = []; 
                closeModal('training-results-modal');
            }
        }

        reminderConfirmCloseBtn.onclick = () => {
            itemsFromCurrentTraining = []; 
            closeModal('reminder-modal');
            closeModal('training-results-modal');
        };


        function addToTemporaryBackpack(dnaItem) {
            let added = false;
            for (let i = 0; i < NUM_TEMP_BACKPACK_SLOTS; i++) {
                if (temporaryBackpackSlots[i] === null) {
                    temporaryBackpackSlots[i] = {...dnaItem}; 
                    added = true;
                    break;
                }
            }
            if (!added) { 
                temporaryBackpackSlots[0] = {...dnaItem}; 
                showFeedbackModal("æç¤º", `è‡¨æ™‚èƒŒåŒ…å·²æ»¿ï¼ ${dnaItem.name} å·²è¦†è“‹æœ€æ—©çš„ç‰©å“ã€‚`, false, true, false);
            }
            populateTemporaryBackpack();
        }


        function promptReleaseMonster(farmIndex) {
            monsterToReleaseInfo = { farmIndex };
            const monster = farmedMonsters[farmIndex];
            confirmationModalBodyEl.innerHTML = `ç¢ºå®šè¦æ”¾ç”Ÿæ€ªç¸ <strong style="color: var(--accent-color);">${monster.nickname}</strong> (ç¸½è©•åƒ¹: ${monster.score})ï¼Ÿ<br>æ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚
                                            <div id="release-monster-image-placeholder" class="flex justify-center my-2">
                                                <img id="release-monster-img-preview-confirm" src="" alt="é è¦½" class="max-w-[100px] max-h-[75px] object-contain">
                                            </div>`;
            
            const imgPreviewConfirm = document.getElementById('release-monster-img-preview-confirm');
            let mainElement = monster.elements.length > 0 ? monster.elements[0] : "æ··åˆ";
            const elementStyle = getElementStyling(mainElement);
            const elementColorHex = getComputedStyle(document.documentElement).getPropertyValue(elementStyle.bg.replace(/var\(|\)/g, '')).trim().substring(1);
            const placeholderTextColor = getContrastColor(elementColorHex);

            imgPreviewConfirm.src = `https://placehold.co/100x75/${elementColorHex}/${placeholderTextColor}?text=${encodeURIComponent(monster.nickname)}&font=noto-sans-tc`;
            imgPreviewConfirm.alt = monster.nickname;
            
            confirmationModalTitleEl.textContent = "æ”¾ç”Ÿç¢ºèª";
            confirmActionBtn.className = 'danger'; 
            confirmActionBtn.textContent = 'ç¢ºå®šæ”¾ç”Ÿ';
            confirmActionBtn.onclick = () => { 
                 if (monsterToReleaseInfo) { 
                    const releasedMonster = farmedMonsters.splice(monsterToReleaseInfo.farmIndex, 1)[0];
                    if (releasedMonster) {
                        showFeedbackModal("æ”¾ç”ŸæˆåŠŸ", `${releasedMonster.nickname} å·²ç¶“å›æ­¸å¤§è‡ªç„¶äº†ã€‚`, false, true, false);
                        if (currentMonster && currentMonster.id === releasedMonster.id) { 
                            currentMonster = null; 
                            updateMonsterSnapshotDisplay(null); 
                            monsterInfoButton.disabled = true;
                        }
                         if (battlingMonsterId === releasedMonster.id) { 
                            battlingMonsterId = null;
                            if (currentMonster && currentMonster.id === releasedMonster.id) currentMonster = null; 
                            updateMonsterSnapshotDisplay(null);
                            monsterInfoButton.disabled = true;
                        }
                    }
                    populateFarmList();
                    updatePlayerInfoModal(); 
                    monsterToReleaseInfo = null;
                }
                closeModal('confirmation-modal');
                updateActionButtonsState();
            };
            openModal('confirmation-modal');
        }

        function addLogEntry(monster, message) {
            const timestamp = new Date().toLocaleString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit'});
            monster.activityLog.unshift({ time: timestamp, message: message }); 
            if (monster.activityLog.length > 20) { 
                monster.activityLog.pop();
            }
            if (document.getElementById('monster-info-modal').style.display === 'flex' &&
                monsterInfoModalHeaderContent.querySelector('.monster-info-name-styled')?.textContent === monster.nickname) {
                updateMonsterActivityLog(monster);
            }
        }

        function updateMonsterActivityLog(monster) {
            if (!monster || !monster.activityLog || monster.activityLog.length === 0) {
                monsterActivityLogsContainer.innerHTML = "<p class='text-center text-base text-[var(--text-secondary)] py-4'>å°šç„¡æ´»å‹•ç´€éŒ„ã€‚</p>"; // text-sm to text-base
                return;
            }
            monsterActivityLogsContainer.innerHTML = monster.activityLog.map(entry => `
                <div class="log-entry">
                    <span class="log-time">[${entry.time}]</span>
                    <span class="log-message">${entry.message}</span>
                </div>
            `).join('');
        }

        // --- Newbie Guide Data & Functions ---
        const newbieGuideData = [
            { title: "éŠæˆ²ç›®æ¨™", content: "æ­¡è¿ä¾†åˆ°æ€ªç¸é¤Šæˆå°æˆ°éŠæˆ²ï¼æ‚¨çš„ç›®æ¨™æ˜¯é€éçµ„åˆä¸åŒçš„DNAç¢ç‰‡ï¼Œå‰µé€ å‡ºç¨ä¸€ç„¡äºŒçš„å¼·å¤§æ€ªç¸ï¼Œä¸¦é€éé¤Šæˆæå‡å®ƒå€‘çš„èƒ½åŠ›ï¼Œæœ€çµ‚åœ¨æ’è¡Œæ¦œä¸Šååˆ—å‰èŒ…ã€‚" },
            { title: "DNAçµ„åˆ", content: "åœ¨ã€ŒDNAçµ„åˆã€å€å¡Šï¼Œæ‚¨å¯ä»¥å°‡æ“æœ‰çš„ã€ŒDNAç¢ç‰‡ã€æ‹–æ›³åˆ°ä¸Šæ–¹çš„çµ„åˆæ§½ä¸­ã€‚æ¯å€‹DNAç¢ç‰‡éƒ½å¸¶æœ‰ä¸åŒçš„å±¬æ€§å’ŒåŸºç¤æ•¸å€¼ã€‚æ”¾å…¥DNAå¾Œï¼Œé»æ“Šã€Œæ€ªç‰©åˆæˆã€æŒ‰éˆ•å³å¯åˆæˆæ–°çš„æ€ªç¸ã€‚" },
            { title: "æ€ªç¸å±¬æ€§", content: "æ€ªç¸æ“æœ‰HPï¼ˆç”Ÿå‘½å€¼ï¼‰ã€MPï¼ˆé­”åŠ›å€¼ï¼‰ã€æ”»æ“ŠåŠ›ã€é˜²ç¦¦åŠ›ã€é€Ÿåº¦å’Œçˆ†æ“Šç‡ç­‰åŸºç¤å±¬æ€§ã€‚æ­¤å¤–ï¼Œæ€ªç¸é‚„æœƒæœ‰ä¸»è¦å±¬æ€§ï¼ˆå¦‚ç«ã€æ°´ã€æœ¨ç­‰ï¼‰å’Œå…ƒç´ æ§‹æˆç™¾åˆ†æ¯”ï¼Œé€™äº›æœƒå½±éŸ¿å…¶æŠ€èƒ½å’Œæˆ°é¬¥é¢¨æ ¼ã€‚" },
            { title: "DNAç¨€æœ‰åº¦", content: "DNAç¢ç‰‡åˆ†ç‚ºä¸åŒç¨€æœ‰åº¦ï¼šæ™®é€šã€ç¨€æœ‰ã€èè‹±ã€å‚³å¥‡ã€ç¥è©±ã€‚ç¨€æœ‰åº¦è¶Šé«˜çš„DNAé€šå¸¸èƒ½çµ„åˆå‡ºæ½›åŠ›æ›´å¼·çš„æ€ªç¸ã€‚DNAç¢ç‰‡çš„æ–‡å­—é¡è‰²æœƒæ¨™ç¤ºå…¶ç¨€æœ‰åº¦ï¼ŒèƒŒæ™¯å‰‡é¡¯ç¤ºå…¶å…ƒç´ å±¬æ€§ã€‚" },
            { title: "æ€ªç‰©è¾²å ´", content: "å‰µé€ å‡ºä¾†çš„æ€ªç¸æœƒé€²å…¥ã€Œæ€ªç‰©è¾²å ´ã€ã€‚åœ¨è¾²å ´ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹æ€ªç¸çš„è³‡è¨Šã€è¨­å®šå…¶å‡ºæˆ°ç‹€æ…‹ï¼ˆåœ“å½¢æŒ‰éˆ•ï¼ŒğŸ”´ ä»£è¡¨å‡ºæˆ°ï¼ŒğŸŸ¢ ä»£è¡¨é–’ç½®ï¼‰ï¼Œæˆ–é€²è¡Œã€Œé¤Šæˆã€ã€‚"},
            { title: "æ€ªç¸é¤Šæˆ", content: "é»æ“Šè¾²å ´ä¸­æ€ªç¸çš„ã€Œé¤Šæˆã€æŒ‰éˆ•ï¼Œå¯ä»¥é–‹å§‹ä¿®ç…‰ã€‚ä¿®ç…‰æœƒæŒçºŒè¨ˆæ™‚ï¼Œæ‚¨å¯ä»¥éš¨æ™‚é»æ“Šã€ŒçµæŸä¿®ç…‰ã€ã€‚ä¿®ç…‰æ™‚é–“è¶Šé•·ï¼Œæ€ªç¸ç²å¾—çš„æˆé•·å’Œæ‹¾ç²ç‰©å“çš„æ©Ÿæœƒå°±è¶Šå¤§ã€‚ä¿®ç…‰æˆæœæœƒé¡¯ç¤ºå†’éšªæ•…äº‹ã€å±¬æ€§æˆé•·å’Œæ‹¾ç²çš„DNAç¢ç‰‡ã€‚"},
            { title: "è‡¨æ™‚èƒŒåŒ…", content: "ä¿®ç…‰æ‹¾ç²çš„DNAç¢ç‰‡æœƒå…ˆé€²å…¥ã€Œä¿®ç…‰æˆæœã€çš„ç‰©å“åˆ—è¡¨ï¼Œæ‚¨å¯ä»¥é¸æ“‡å°‡å®ƒå€‘ã€ŒåŠ å…¥è‡¨æ™‚èƒŒåŒ…ã€æˆ–é€å€‹æ·»åŠ ã€‚è‡¨æ™‚èƒŒåŒ…ä¸­çš„ç‰©å“å¯ä»¥é»æ“Šç§»è‡³ä¸»DNAç¢ç‰‡åº«ï¼Œæˆ–é€éå³ä¸Šè§’çš„XæŒ‰éˆ•åˆªé™¤ã€‚"},
            { title: "å¥åº·ç‹€æ…‹èˆ‡æŠ—æ€§", content: "æ€ªç¸åœ¨æŸäº›æ´»å‹•å¾Œå¯èƒ½æœƒå‡ºç¾è² é¢çš„ã€Œå¥åº·ç‹€æ…‹ã€ï¼Œä¾‹å¦‚ã€Œæ‰‹æŒ‡éª¨æŠ˜ï¼šæ”»æ“ŠåŠ›-3ã€ã€‚é€™äº›ç‹€æ…‹æœƒç›´æ¥å½±éŸ¿æ€ªç¸çš„åŸºç¤æ•¸å€¼ã€‚æ­¤å¤–ï¼Œæ€ªç¸é‚„æ“æœ‰ã€Œç‰¹æ®ŠæŠ—æ€§ã€ï¼Œä¾‹å¦‚ç«å±¬æ€§DNAå¯èƒ½æä¾›ç«æŠ—æ€§ï¼Œé€™äº›æŠ—æ€§èƒ½æ¸›å°‘ç‰¹å®šé¡å‹å‚·å®³æˆ–æ•ˆæœã€‚"},
            { title: "æ’è¡Œæ¦œæŒ‘æˆ°", content: "åœ¨ã€Œæ€ªç¸æ’è¡Œæ¦œã€ä¸­ï¼Œæ‚¨å¯ä»¥é»æ“Šæ€ªç¸æ—çš„ã€Œâš”ï¸ã€æŒ‰éˆ•ä¾†æŒ‘æˆ°å®ƒã€‚è«‹æ³¨æ„ï¼ŒæŒ‘æˆ°å¤±æ•—çš„ä¸€æ–¹å°‡æœƒè¢«å‹æ–¹å¸æ”¶ï¼"},
            { title: "å¥½å‹åå–®", content: "é»æ“Šã€Œå¥½å‹åå–®ã€æŒ‰éˆ•å¯ä»¥æŸ¥çœ‹æ‚¨çš„å¥½å‹ã€‚æ‚¨å¯ä»¥åœ¨æ­¤æœå°‹å…¶ä»–ç©å®¶ä¸¦ï¼ˆæœªä¾†åŠŸèƒ½ï¼‰å°‡ä»–å€‘åŠ ç‚ºå¥½å‹ã€‚"},
            { title: "ä¸»é¡Œåˆ‡æ›", content: "æ‚¨å¯ä»¥é»æ“Šå³ä¸Šè§’çš„ â˜€ï¸/ğŸŒ™ æŒ‰éˆ•ä¾†åˆ‡æ›éŠæˆ²çš„äº®è‰²æˆ–æš—è‰²ä¸»é¡Œï¼Œé¸æ“‡æ‚¨å–œæ­¡çš„è¦–è¦ºé¢¨æ ¼ã€‚"}
        ];

        function populateNewbieGuide(searchTerm = "") {
            newbieGuideContentArea.innerHTML = "";
            const lowerSearchTerm = searchTerm.toLowerCase().trim();
            const filteredData = newbieGuideData.filter(item => 
                item.title.toLowerCase().includes(lowerSearchTerm) || 
                item.content.toLowerCase().includes(lowerSearchTerm)
            );

            if (filteredData.length === 0) {
                newbieGuideContentArea.innerHTML = "<p class='text-center p-4'>æ‰¾ä¸åˆ°ç›¸é—œçš„æŒ‡å—å…§å®¹ã€‚</p>";
                return;
            }

            const highlight = (text, term) => {
                if (!term) return text;
                const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                return text.replace(regex, '<mark class="bg-yellow-300 dark:bg-yellow-600 rounded px-1">$1</mark>');
            };

            filteredData.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'mb-4 p-3 rounded-md border border-[var(--border-color)] bg-[var(--bg-primary)]';
                itemDiv.innerHTML = `
                    <h5 class="text-lg font-semibold text-[var(--accent-color)] mb-1">${highlight(item.title, searchTerm)}</h5>
                    <p class="text-base">${highlight(item.content.replace(/\n/g, "<br>"), searchTerm)}</p> 
                `;
                newbieGuideContentArea.appendChild(itemDiv);
            });
        }
        newbieGuideBtn.addEventListener('click', () => {
            populateNewbieGuide(); 
            openModal('newbie-guide-modal');
        });
        newbieGuideSearchInput.addEventListener('input', (e) => {
            populateNewbieGuide(e.target.value);
        });

        // --- Friends List Functions ---
        function displayFriends(friendsToDisplay) {
            friendsListContainer.innerHTML = '';
            if (friendsToDisplay.length === 0) {
                friendsListContainer.innerHTML = '<p class="text-center text-base text-[var(--text-secondary)]">æ‰¾ä¸åˆ°ç¬¦åˆçš„ç©å®¶æˆ–å°šç„¡å¥½å‹ã€‚</p>'; // text-sm to text-base
                return;
            }
            friendsToDisplay.forEach(friend => {
                const friendDiv = document.createElement('div');
                friendDiv.className = 'friend-item';
                friendDiv.innerHTML = `
                    <span class="friend-name">${friend.name}</span>
                    <span class="friend-status ${friend.status === 'online' ? 'online' : 'offline'}">${friend.status === 'online' ? 'ç·šä¸Š' : 'é›¢ç·š'}</span>
                `;
                friendsListContainer.appendChild(friendDiv);
            });
        }

        function searchFriends(searchTerm) {
            const lowerSearchTerm = searchTerm.toLowerCase().trim();
            if (!lowerSearchTerm) {
                displayFriends(playerFriends); 
                return;
            }
            const foundPlayers = MOCK_ALL_PLAYERS.filter(player => 
                player.name.toLowerCase().includes(lowerSearchTerm)
            );
            displayFriends(foundPlayers); 
        }

        friendsListBtn.addEventListener('click', () => {
            displayFriends(playerFriends); 
            friendsListSearchInput.value = ""; 
            openModal('friends-list-modal');
        });

        friendsListSearchInput.addEventListener('input', (e) => {
            searchFriends(e.target.value);
        });


        showMonsterLeaderboardBtn.addEventListener('click', () => {
            setupMonsterLeaderboardTabs();
            populateMonsterLeaderboard(); 
            openModal('monster-leaderboard-modal');
        });
        showPlayerLeaderboardBtn.addEventListener('click', () => {
            populatePlayerLeaderboard();
            openModal('player-leaderboard-modal');
        });


        monsterInfoButton.addEventListener('click', () => {
            const monsterToDisplay = battlingMonsterId ? farmedMonsters.find(m => m.id === battlingMonsterId) : currentMonster;
            if (monsterToDisplay) {
                 updateMonsterInfoModal(monsterToDisplay);
                 openModal('monster-info-modal');
            } else if (currentMonster) { 
                updateMonsterInfoModal(currentMonster);
                openModal('monster-info-modal');
            } else {
                 updateMonsterInfoModal(null); 
                 openModal('monster-info-modal');
            }
        });
        playerInfoButton.addEventListener('click', () => { updatePlayerInfoModal(); openModal('player-info-modal');});
        combineButton.addEventListener('click', combineDNA);
        
        window.onclick = function(event) {
            if (event.target.classList.contains('modal') && 
                event.target.id !== 'feedback-modal' && 
                event.target.id !== 'confirmation-modal' && 
                event.target.id !== 'cultivation-setup-modal' &&
                event.target.id !== 'training-results-modal' &&
                event.target.id !== 'newbie-guide-modal' && 
                event.target.id !== 'friends-list-modal' && 
                event.target.id !== 'monster-leaderboard-modal' && 
                event.target.id !== 'player-leaderboard-modal' &&  
                event.target.id !== 'reminder-modal' 
                ) {
                closeModal(event.target.id);
            }
        }
        
        // Centralized handler for the main confirm button, specific actions set before opening modal
        // confirmActionBtn.onclick is now set dynamically before opening confirmation modal.


        function updateActionButtonsState() {
            const hasItemsInCombination = combinationSlotsData.some(s=>s!==null);
            combineButton.disabled = !hasItemsInCombination;
            const monsterForInfo = battlingMonsterId ? farmedMonsters.find(m => m.id === battlingMonsterId) : currentMonster;
            monsterInfoButton.disabled = !monsterForInfo;
        }

        function initGame() {
            // Move DNA Combination panel to the DNA Fragments Tab
            const dnaCombinationPanelTarget = document.getElementById('dna-inventory-content');
            const originalDnaCombinationPanel = document.getElementById('dna-combination-panel-wrapper'); 
            
            if (originalDnaCombinationPanel && dnaCombinationPanelTarget) {
                dnaCombinationPanelTarget.insertBefore(originalDnaCombinationPanel, dnaCombinationPanelTarget.firstChild);
            } else {
                console.error("Could not find DNA combination panel wrapper or target for relocation.");
            }


            const preferredTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(preferredTheme);
            createCombinationSlots();
            generateMockLeaderboardData(); 
            initializeInventoryDisplay();
            setupDropZones();
            updateMonsterSnapshotDisplay(null); 
            updateMonsterInfoModal(null);
            updatePlayerInfoModal();
            updateActionButtonsState();
            populateFarmList();
            populateNewbieGuide(); 
            displayFriends(playerFriends); 

            const firstDnaFarmTab = document.querySelector('#dna-farm-tabs .tab-button');
            if (firstDnaFarmTab) {
                openDnaFarmTab({currentTarget: firstDnaFarmTab}, 'dna-inventory-content');
            }
        }
        initGame();
    </script>
</body>
</html>
