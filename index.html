<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯©å•æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
.interrogation-loader {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 300px;
  margin: 0 auto;
  padding: 28px 20px 22px 20px;
  background: #1a2332;
  border-radius: 18px;
  box-shadow: 0 8px 24px #000a, 0 2px 8px #14223b33;
  border: 2px solid #356cc9;
}
.badge {
  display: flex;
  align-items: center;
  gap: 10px;
  font-family: 'Inter', 'Noto Sans TC', Arial, sans-serif;
  font-weight: bold;
  color: #f3f8ff;
  font-size: 1.5rem;
  margin-bottom: 16px;
  letter-spacing: 2px;
}
.badge-icon {
  font-size: 2.3rem;
  filter: drop-shadow(0 1px 4px #262f51aa);
  margin-right: 4px;
}
.badge-text {
  letter-spacing: 3px;
  text-shadow: 0 2px 8px #356cc9aa;
}
.loading-bar {
  width: 90%;
  height: 14px;
  border-radius: 8px;
  background: #28344d;
  overflow: hidden;
  box-shadow: 0 0 0 2px #3e5d96 inset, 0 2px 6px #0005;
  margin-bottom: 12px;
}
.loading-fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg,#3ec6e0,#5e89ee 60%,#ffe57f 100%);
  border-radius: 8px;
  animation: loadBarAnim 2.2s cubic-bezier(.65,.05,.36,1) infinite;
}
@keyframes loadBarAnim {
  0% { width: 0%; opacity: .7; }
  40% { width: 87%; opacity: 1; }
  95% { width: 99%; opacity: 1; }
  100% { width: 0%; opacity: .7; }
}
.interrogation-text {
  color: #8cb5f1;
  margin-top: 6px;
  font-size: 1.1rem;
  letter-spacing: 1.5px;
  font-family: 'Noto Sans TC', 'Inter', Arial, sans-serif;
  text-shadow: 0 1px 4px #1a2332cc;
  animation: textAnim 1.6s linear infinite alternate;
  min-height: 1.5em;
  transition: opacity 0.5s;
}
@keyframes textAnim {
  from { opacity: 0.6; letter-spacing: 1px; }
  to   { opacity: 1; letter-spacing: 3px; }
}

        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #1a202c; 
            color: #e2e8f0; 
            overscroll-behavior-y: contain; 
        }
        .card {
            background-color: #2d3748; 
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .dialogue-area {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #4a5568; 
            padding: 10px;
            border-radius: 8px;
            background-color: #1f2937; 
            min-height: 200px; 
        }
        .dialogue-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 8px;
            max-width: 85%;
            word-wrap: break-word; 
            color: white; 
        }
        .player-bubble {
            background-color: #4299e1; 
            margin-left: auto;
            text-align: right;
        }
        .player-bubble-calm {
            background-color: #38a169; 
        }
        .player-bubble-angry {
            background-color: #e53e3e; 
        }
        .player-bubble-provocative {
            background-color: #d69e2e; 
        }
        .officer-bubble { 
            background-color: #38a169; 
            color: white;
            margin-left: auto; 
            text-align: right;
        }
        .ai-bubble {
            background-color: #4a5568; 
            color: #e2e8f0;
            margin-right: auto;
        }
        .keyword, .case-keyword { 
            text-decoration: underline;
            color: #63b3ed; 
            cursor: pointer;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8); 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 16px;
        }
        .modal-content {
            background-color: #2d3748; 
            padding: 20px;
            border-radius: 8px;
            width: 100%;
            max-width: 500px; 
            max-height: 90vh; 
            overflow-y: auto; 
            text-align: left;
            color: #e2e8f0;
        }
        .modal-content.modal-lg {
            max-width: 600px; 
        }
        .modal-content h3 {
            text-align: center;
            margin-bottom: 16px;
        }
        .story-summary-text {
            font-size: 0.8rem; 
        }
        .story-summary-divider {
            border-top: 1px solid #4a5568; 
            margin: 12px 0;
        }
        .personality-block {
            background-color: #374151; 
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #4a5568;
        }
        #personality-modal {
            font-style: normal; 
        }
        .tone-button {
            color: #e2e8f0;
            border: 1px solid #718096; 
            flex-grow: 1; 
            padding: 8px 0;
        }
        .tone-button-calm { background-color: #2c5282; } 
        .tone-button-calm.active { background-color: #3182ce; border-color: #3182ce; color:white;} 

        .tone-button-angry { background-color: #9b2c2c; } 
        .tone-button-angry.active { background-color: #e53e3e; border-color: #e53e3e; color:white;} 

        .tone-button-provocative { background-color: #975a16; } 
        .tone-button-provocative.active { background-color: #d69e2e; border-color: #d69e2e; color:white;} 
        
        .loading-spinner {
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #3498db; 
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .game-main-area {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 16px); 
            padding: 8px;
        }
        .interrogation-tip {
            font-size: 0.75rem; 
            color: #a0aec0; 
            text-align: center;
            margin-top: 4px; 
            padding: 4px;
            background-color: #2a303c; 
            border-radius: 4px;
            min-height: 2.5em; 
            line-height: 1.3; 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
        }
        #suspect-status-details > div {
            display: flex;
            flex-direction: column;
            justify-content: space-around; 
        }
        #suspect-status-card {
            padding: 8px; 
            max-height: 6rem; 
            overflow: hidden; 
        }
        #suspect-status-details p {
            font-size: 0.68rem; 
            line-height: 1.2; 
            margin-bottom: 0.1rem; 
        }
        @media (min-width: 640px) { 
            #suspect-status-details p {
                font-size: 0.75rem; 
            }
        }
        .analysis-section-title {
            font-weight: bold;
            color: #90cdf4; 
            margin-top: 10px;
            margin-bottom: 4px;
        }
        .analysis-section-content {
            margin-left: 10px;
            white-space: pre-wrap; 
        }
        #initial-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 32, 44, 0.95); 
            z-index: 2000; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #e2e8f0;
        }
        #initial-loading-message {
            font-size: 1.1rem;
            margin-top: 1rem;
        }
        .achievement-banner {
            margin-top: 16px;
            padding: 8px;
            background-color: #374151;
            border-radius: 6px;
            font-size: 1.1rem;
            color: #f6e05e; 
        }
        /* Color classes for confession meter */
        .confession-color-white { color: #E2E8F0; } /* Default light color */
        .confession-color-green { color: #68D391; } /* Green */
        .confession-color-blue { color: #63B3ED; }  /* Blue */
        .confession-color-pink { color: #F687B3; }  /* Pink */
        .confession-color-red { color: #FC8181; }   /* Red */
        .confession-color-purple { color: #B794F4; } /* Purple */


    </style>
</head>
<body class="overscroll-y-contain">
    <audio id="background-music" src="PensivePiano.mp3" autoplay loop onerror="console.error('Audio Error:', event.target.error)"></audio>

<div id="initial-loading-overlay">
  <div class="interrogation-loader">
    <div class="badge">
      <span class="badge-icon">ğŸ•µï¸â€â™‚ï¸</span>
      <span class="badge-text">POLICE</span>
    </div>
    <div class="loading-bar">
      <div class="loading-fill"></div>
    </div>
    <div class="interrogation-text" id="interrogation-text">è­¦æ–¹æ­£åœ¨å¸ƒç½®åµè¨Šå®¤â€¦</div>
    <p class="text-sm text-gray-400 mt-1">(é¦–æ¬¡é–‹å±€ç”Ÿæˆä¸­ï¼Œç­‰å¾…å¾ˆä¹…å±¬æ­£å¸¸ï¼Œè«‹ç¨å€™...)</p>
  </div>
</div>


    <div class="game-main-area container mx-auto" style="display: none;"> 
        <header class="mb-2 flex justify-between items-center">
            <span class="text-xs sm:text-sm text-gray-400 font-normal">
                å›åˆ: <span id="round-count-header">0</span>
            </span>
            <h1 class="text-xl sm:text-2xl font-bold text-blue-400 text-center flex-grow">
                å¯©å•æŒ‘æˆ°
            </h1>
            <span class="text-xs sm:text-sm text-gray-400 font-normal" title="éŠæˆ²é€²åº¦å­˜æª”è­˜åˆ¥ç¢¼">
                 UID: <span id="user-id-display">è¼‰å…¥ä¸­...</span>
            </span>
        </header>


        <div class="flex gap-2 mb-2"> 
            <div id="avatar" class="w-20 h-20 sm:w-24 sm:h-24 rounded-md flex-shrink-0 flex flex-col items-center justify-center text-gray-300 text-xs p-0.5 text-center bg-gray-700 shadow">
                <img id="suspect-avatar-img" src="https://placehold.co/80x60/4A5568/E2E8F0?text=é ­åƒ" alt="å«ŒçŠ¯é ­åƒ" class="w-full h-3/4 object-cover rounded-t-sm" onerror="this.onerror=null; this.src='https://placehold.co/80x60/4A5568/E2E8F0?text=åœ–ç‰‡è¼‰å…¥å¤±æ•—';">
                <div id="suspect-name-display" class="w-full bg-black bg-opacity-70 text-white text-xs py-1 text-center truncate rounded-b-sm h-1/4 flex items-center justify-center">
                    <span id="suspect-status-name">è®€å–ä¸­...</span>
                </div>
            </div>
            <div id="suspect-status-card" class="flex-grow flex flex-col card">
                 <div id="suspect-status-details" class="grid grid-cols-2 gap-x-2 h-full"> 
                    <div class="flex flex-col justify-between"> 
                        <p>ğŸ—£ï¸<strong>é ‘æŠ—:</strong> <span id="confession-meter-text-card" class="confession-color-white">å¼·ç¡¬</span></p>
                        <p>ğŸ“ˆ<strong>å¿ƒç‡:</strong> <span id="heart-rate">75</span> bpm</p>
                        <p>ğŸ§<strong>è‚¢é«”:</strong> <span id="body-language" class="italic">è®€å–ä¸­...</span></p>
                    </div>
                    <div class="flex flex-col justify-between"> 
                        <p>ğŸ˜ <strong>è¡¨æƒ…:</strong> <span id="facial-expression" class="italic">è®€å–ä¸­...</span></p>
                        <p>ğŸ©¸<strong>è¡€å£“:</strong> <span id="blood-pressure">120/80</span></p>
                        <p>ğŸ—£ï¸<strong>èªæ°£:</strong> <span id="voice-tone" class="italic">è®€å–ä¸­...</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-2 mb-2"> 
            <button id="show-personal-details-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-md text-sm sm:text-base">ğŸ‘¤ å€‹äººè³‡æ–™</button>
            <button id="show-story-summary-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-3 rounded-md text-sm sm:text-base">ğŸ“œ æ¡ˆä»¶æ¦‚è¦</button>
        </div>

        <div id="dialogue-area" class="dialogue-area mb-2"></div> 
        
        <div class="interrogation-tip" id="interrogation-tip-area">
            â€»è²¼å¿ƒæç¤ºï¼š åµè¨Šæç¤ºè¼‰å…¥ä¸­...
        </div>

        <div class="mt-auto pt-2"> 
            <textarea id="player-input" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base" rows="2" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..."></textarea>
            <div class="mt-2 flex gap-1 sm:gap-2">
                <button class="tone-button tone-button-calm active rounded-md text-xs sm:text-sm" data-tone="å¹³ç·©">ğŸ˜Œ å¹³ç·©</button>
                <button class="tone-button tone-button-angry rounded-md ml-1 text-xs sm:text-sm" data-tone="æ†¤æ€’">ğŸ˜¡ æ†¤æ€’</button>
                <button class="tone-button tone-button-provocative rounded-md ml-1 text-xs sm:text-sm" data-tone="æŒ‘é‡">ğŸ˜ æŒ‘é‡</button>
            </div>
            <div class="mt-2 flex gap-2">
                <button id="send-button" class="flex-grow bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 text-sm sm:text-base">
                    ç™¼é€
                </button>
                <button id="demand-confession-button" class="w-1/4 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-md transition duration-150 text-xs sm:text-sm">
                    è¦æ±‚èªç½ª
                </button>
            </div>
        </div>
    </div>

    <div id="intro-modal" class="modal hidden"> 
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-300">ğŸ‰ æ­¡è¿ä¾†åˆ°å¯©å•æŒ‘æˆ° ğŸ‰</h3>
            <ul class="list-decimal list-inside mt-4 mb-6 space-y-2 text-sm text-gray-200">
                <li>æœ¬éŠæˆ²æ¯æ¬¡é–‹å±€éƒ½æ˜¯<strong class="text-yellow-300">å…¨æ–°åŠ‡æœ¬</strong>ï¼ŒæŒ‘æˆ°ç„¡é™ï¼</li>
                <li>é–‹å±€å¾Œè«‹å…ˆæŸ¥çœ‹<strong class="text-indigo-300">ã€æ¡ˆä»¶æ¦‚è¦ã€‘</strong>äº†è§£åµè¨Šé‡é»ã€‚</li>
                <li>åµè¨Šæ™‚å¯ä»¥ç”¨<strong class="text-green-300">ä¸‰ç¨®æ…‹åº¦</strong>ä¾†ä¸å«ŒçŠ¯æ‡‰å°ã€‚</li>
                <li>æœ¬éŠæˆ²ä¸æ–·<strong class="text-pink-300">å„ªåŒ–ä¸­</strong>ï¼Œæ­¡è¿çµ¦äºˆå»ºè­°ï¼</li>
                <li>å¯©å•æˆåŠŸè®“å«ŒçŠ¯èªç½ªï¼Œæ­¡è¿<strong class="text-teal-300">åˆ†äº«æˆªåœ–</strong>ï¼</li>
            </ul>
            <button id="close-intro-modal-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">é–‹å§‹åµè¨Š</button>
        </div>
    </div>

    <div id="personal-details-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-300">ğŸ‘¤ å«ŒçŠ¯å€‹äººè³‡æ–™</h3>
            <div id="modal-personal-details-content" class="text-sm">
                <p><strong>å§“å:</strong> <span id="suspect-name-modal">ææ˜</span></p>
                <p><strong>å¹´ç´€:</strong> <span id="age-modal">è®€å–ä¸­...</span></p>
                <p><strong>æ€§åˆ¥:</strong> <span id="gender-modal">è®€å–ä¸­...</span></p>
                <p><strong>ç”Ÿæ—¥:</strong> <span id="dob-modal">è®€å–ä¸­...</span></p> 
                <p><strong>æ˜Ÿåº§:</strong> <span id="zodiac-modal">è®€å–ä¸­...</span></p>
                <p><strong>è¡€å‹:</strong> <span id="blood-type-modal">è®€å–ä¸­...</span></p>
                <p><strong>å­¸æ­·:</strong> <span id="education-modal">è®€å–ä¸­...</span></p>
                <p><strong>å‡ºç”Ÿåœ°:</strong> <span id="birthplace-modal">è®€å–ä¸­...</span></p>
                <p><strong>è·æ¥­:</strong> <span id="occupation-modal">è®€å–ä¸­...</span></p>
                <p><strong>å¥åº·ç‹€æ…‹:</strong> <span id="health-status-modal">è®€å–ä¸­...</span></p>
                <div class="personality-block mt-3">
                    <p class="font-semibold mb-1">ğŸ­ å€‹æ€§æ¦‚è¿°:</p>
                    <p id="personality-modal" class="text-sm">è®€å–ä¸­...</p> 
                </div>
            </div>
            <button onclick="document.getElementById('personal-details-modal').classList.add('hidden')" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
        </div>
    </div>

    <div id="story-summary-modal" class="modal hidden">
        <div class="modal-content modal-lg"> 
            <h3 class="text-xl font-bold text-blue-300">ğŸ“œ æ¡ˆä»¶æ¦‚è¦</h3>
            <div id="modal-story-summary-content" class="story-summary-text">
                <div>
                    <p class="font-semibold">è¢«å®³äººé©—å±å ±å‘Š:</p>
                    <span id="autopsy-report-modal-content">è®€å–ä¸­...</span>
                </div>
                <hr class="story-summary-divider">
                <div>
                    <p class="font-semibold mt-2">å°å«ŒçŠ¯ä¸åˆ©çš„ç›®å‰è­‰æ“š:</p>
                    <ul id="evidence-list-modal-content" class="list-disc list-inside ml-4"><li>è®€å–ä¸­...</li></ul>
                </div>
                <hr class="story-summary-divider">
                <div>
                    <p class="font-semibold mt-2">å«ŒçŠ¯èª¿æŸ¥ç–‘é»:</p>
                    <ul id="doubts-list-modal-content" class="list-disc list-inside ml-4"><li>è®€å–ä¸­...</li></ul>
                </div>
            </div>
            <button onclick="document.getElementById('story-summary-modal').classList.add('hidden')" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
        </div>
    </div>

    <div id="keyword-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="keyword-modal-title" class="text-xl font-bold text-blue-300">ğŸ”‘ é—œéµå­—è£œå……</h3>
            <p id="keyword-modal-text">å…§å®¹AIåŠ è¼‰ä¸­è«‹ç¨å¾Œ...</p> 
            <div id="keyword-loading-spinner" class="loading-spinner my-4 hidden"></div>
            <button onclick="document.getElementById('keyword-modal').classList.add('hidden')" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
        </div>
    </div>

    <div id="game-over-modal" class="modal hidden">
        <div class="modal-content text-center">
            <h3 id="game-over-title" class="text-2xl font-bold mb-4">âš–ï¸ å¯©å•çµæŸ</h3>
            <p>ç¸½å…±è€—è²»å›åˆæ•¸: <span id="total-rounds">0</span></p>
            <div id="game-analysis-container" class="mt-4 text-left"> 
                 <p id="game-analysis-text" class="text-sm whitespace-pre-wrap">åˆ†æä¸­...</p>
            </div>
            <div id="achievement-banner" class="achievement-banner hidden">
                ğŸ… <span id="achievement-title"></span>
            </div>
            <div class="mt-6 flex justify-center gap-4">
                 <button id="restart-game-button" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md">ğŸ”„ é‡æ–°é–‹å§‹</button>
                 <button id="close-game-over-modal-button" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <div id="ai-thinking-modal" class="modal hidden">
        <div class="modal-content text-center">
            <div class="flex flex-col items-center justify-center min-h-[100px]"> 
                <p class="text-lg">ğŸ¤–ç‹—ç¾æ‹¿è³½ï¼ŒAIæ­£åœ¨åŠªåŠ›æ’°å¯«ä¸­...</p>
                <p class="text-sm text-gray-400 mt-1">(å› å…§å®¹è±å¯ŒåŠ è¼‰å¾ˆä¹…å±¬æ­£å¸¸)</p>
                <p class="text-xs text-gray-500 mt-1">(å‰µä½œè€…é‚„åœ¨åŠªåŠ›å„ªåŒ–ä¸­)</p>
            </div>
            <div class="loading-spinner my-4"></div>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const interrogationTips = [
    "è­¦æ–¹æ­£åœ¨å¸ƒç½®åµè¨Šå®¤â€¦",
    "æª¢æŸ¥éŒ„éŸ³èˆ‡ç›£æ§è¨­å‚™ä¸­â€¦",
    "æ¡ˆä»¶è³‡æ–™èª¿é–±ä¸­ï¼Œè«‹ç¨å€™â€¦",
    "å°‡å«ŒçŠ¯å¸¶å¾€åµè¨Šå®¤â€¦",
    "æº–å‚™èª¿æŸ¥è­‰æ“šä¸­â€¦",
    "æª¢æŸ¥ç­†éŒ„èˆ‡ç›¸é—œå·å®—â€¦",
    "é–‹å•Ÿç¾å ´æ”å½±æ©Ÿèˆ‡éº¥å…‹é¢¨â€¦",
    "å®‰æ’è§€å¯Ÿäººå“¡é€²å…¥æš—æˆ¿â€¦",
    "æ¡ˆç™¼ç¾å ´è³‡æ–™åŒæ­¥ä¸­â€¦",
    "æª¢æŸ¥å«ŒçŠ¯å¿ƒç†ç‹€æ…‹â€¦",
    "å¯©æ ¸è­‰ä¾›æ¸…å–®èˆ‡ç­†éŒ„â€¦",
    "åµè¨Šå°ˆå®¶å³å°‡é€²å…¥ç¾å ´â€¦",
    "è­¦å®˜æ­£åœ¨ç©¿æˆ´é˜²è­·è£å‚™â€¦",
    "æº–å‚™å¯©å•ç­–ç•¥èˆ‡å°ç­–â€¦",
    "æ¡ˆä»¶è³‡æ–™åŠ å¯†å‚³è¼¸ä¸­â€¦"
  ];
  const tipElem = document.getElementById('interrogation-text');
  let lastIdx = 0;
  let tipTimer = null;
  function startInterrogationTips() {
    if (!tipElem) return;
    tipElem.textContent = interrogationTips[0];
    tipTimer = setInterval(() => {
      let idx;
      do {
        idx = Math.floor(Math.random() * interrogationTips.length);
      } while (idx === lastIdx);
      lastIdx = idx;
      tipElem.style.opacity = 0;
      setTimeout(() => {
        tipElem.textContent = interrogationTips[idx];
        tipElem.style.opacity = 1;
      }, 400);
    }, 3000); // 3ç§’åˆ‡æ›
  }
  startInterrogationTips();
  // é—œé–‰ overlay æ™‚è«‹å‘¼å« clearInterval(tipTimer);
});
</script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, serverTimestamp, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const heartRateEl = document.getElementById('heart-rate');
        const bloodPressureEl = document.getElementById('blood-pressure');
        const facialExpressionEl = document.getElementById('facial-expression');
        const bodyLanguageEl = document.getElementById('body-language');
        const voiceToneEl = document.getElementById('voice-tone');
        const suspectStatusNameEl = document.getElementById('suspect-status-name'); 
        const suspectNameModalEl = document.getElementById('suspect-name-modal');
        const dobModalEl = document.getElementById('dob-modal');
        const zodiacModalEl = document.getElementById('zodiac-modal');
        const bloodTypeModalEl = document.getElementById('blood-type-modal');
        const ageModalEl = document.getElementById('age-modal');
        const genderModalEl = document.getElementById('gender-modal');
        const educationModalEl = document.getElementById('education-modal');
        const birthplaceModalEl = document.getElementById('birthplace-modal');
        const occupationModalEl = document.getElementById('occupation-modal');
        const healthStatusModalEl = document.getElementById('health-status-modal');
        const personalityModalEl = document.getElementById('personality-modal');
        const autopsyReportModalContentEl = document.getElementById('autopsy-report-modal-content');
        const evidenceListModalContentEl = document.getElementById('evidence-list-modal-content');
        const doubtsListModalContentEl = document.getElementById('doubts-list-modal-content');
        const showPersonalDetailsButton = document.getElementById('show-personal-details-button');
        const showStorySummaryButton = document.getElementById('show-story-summary-button');
        const personalDetailsModal = document.getElementById('personal-details-modal');
        const storySummaryModal = document.getElementById('story-summary-modal');
        const dialogueAreaEl = document.getElementById('dialogue-area');
        const playerInputEl = document.getElementById('player-input');
        const sendButton = document.getElementById('send-button');
        const demandConfessionButton = document.getElementById('demand-confession-button'); 
        const toneButtons = document.querySelectorAll('.tone-button');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const keywordModal = document.getElementById('keyword-modal');
        const keywordModalTitle = document.getElementById('keyword-modal-title');
        const keywordModalText = document.getElementById('keyword-modal-text');
        const keywordLoadingSpinner = document.getElementById('keyword-loading-spinner');
        const gameOverModal = document.getElementById('game-over-modal');
        const gameOverTitle = document.getElementById('game-over-title');
        const totalRoundsEl = document.getElementById('total-rounds'); 
        const gameAnalysisContainerEl = document.getElementById('game-analysis-container'); 
        const gameAnalysisTextEl = document.getElementById('game-analysis-text'); 
        const achievementBannerEl = document.getElementById('achievement-banner');
        const achievementTitleEl = document.getElementById('achievement-title');
        const restartGameButton = document.getElementById('restart-game-button');
        const closeGameOverModalButton = document.getElementById('close-game-over-modal-button'); 
        const aiThinkingModal = document.getElementById('ai-thinking-modal');
        const interrogationTipAreaEl = document.getElementById('interrogation-tip-area');
        const roundCountHeaderEl = document.getElementById('round-count-header'); 
        const confessionMeterTextCardEl = document.getElementById('confession-meter-text-card'); 
        const introModal = document.getElementById('intro-modal'); 
        const closeIntroModalButton = document.getElementById('close-intro-modal-button'); 
        const initialLoadingOverlay = document.getElementById('initial-loading-overlay');
        const initialLoadingMessageEl = document.getElementById('initial-loading-message');
        const gameMainAreaEl = document.querySelector('.game-main-area');
        const backgroundMusicEl = document.getElementById('background-music'); 

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "YOUR_OWN_FIREBASE_API_KEY", 
                authDomain: "YOUR_OWN_FIREBASE_AUTH_DOMAIN", 
                projectId: "YOUR_OWN_FIREBASE_PROJECT_ID", 
                storageBucket: "YOUR_OWN_FIREBASE_STORAGE_BUCKET", 
                messagingSenderId: "YOUR_OWN_FIREBASE_MESSAGING_SENDER_ID",
                appId: "YOUR_OWN_FIREBASE_APP_ID"
              };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('error'); 

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'interrogation-game-public';
        let userId = null;
        let gameId = `game_${Date.now()}`; 
        let gameStateUnsubscribe = null; 

        function getDefaultGameState() {
            return {
                round: 0,
                confessionMeter: 100, 
                suspect: {
                    name: "æœªçŸ¥å«ŒçŠ¯", 
                    dob: "", zodiac: "", bloodType: "", age: 0, gender: "",
                    education: "è®€å–ä¸­...", birthplace: "è®€å–ä¸­...", occupation: "è®€å–ä¸­...", healthStatus: "è®€å–ä¸­...",
                    personality: "è®€å–ä¸­...",
                    heartRate: 75, bloodPressure: "120/80", 
                    facialExpression: "è®€å–ä¸­...", bodyLanguage: "è®€å–ä¸­...", 
                    microAction: "è®€å–ä¸­...", voiceTone: "è®€å–ä¸­..."
                },
                caseDetails: { 
                    autopsyReport: "æ¡ˆä»¶ç”Ÿæˆä¸­...",
                    evidence: [], 
                    doubts: []    
                },
                dialogueHistory: [],
                selectedTone: "å¹³ç·©", 
                gameOver: false,
                gameAnalysis: { interrogationStyle: "", techniqueAnalysis: "", playerPersonalityTrait: "", achievementTitle: "" } 
            };
        }
        let gameState = getDefaultGameState();
        
        function getConfessionMeterTextAndColor(percentage) {
            if (percentage > 80) return { text: "æ…‹åº¦å¼·ç¡¬", colorClass: "confession-color-white" };
            if (percentage > 60) return { text: "æ•…ä½œé®å®š", colorClass: "confession-color-green" };
            if (percentage > 40) return { text: "ç•¥é¡¯å‹•æ–", colorClass: "confession-color-blue" };
            if (percentage > 20) return { text: "å¿ƒè™›æ…Œäº‚", colorClass: "confession-color-pink" };
            if (percentage > 0) return { text: "ç€•è‡¨å´©æ½°", colorClass: "confession-color-red" };
            return { text: "å·²ç„¶èªç½ª", colorClass: "confession-color-purple" };
        }
        
        async function initializeGame() {
             try {
                await setPersistence(auth, browserLocalPersistence); 
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("å˜—è©¦ä½¿ç”¨è‡ªè¨‚ä»¤ç‰Œç™»å…¥ (Canvas ç’°å¢ƒ)ã€‚");
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    console.log("ç„¡è‡ªè¨‚ä»¤ç‰Œï¼Œå˜—è©¦åŒ¿åç™»å…¥ (GitHub Pages / ç¨ç«‹åŸ·è¡Œ)ã€‚");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("åˆå§‹åŒ–æœŸé–“çš„èªè­‰éŒ¯èª¤:", error);
                if (!auth.currentUser) { 
                    try {
                        console.warn("ç”±æ–¼å…ˆå‰çš„èªè­‰éŒ¯èª¤ï¼Œå›é€€åˆ°åŒ¿åç™»å…¥ã€‚");
                        await signInAnonymously(auth);
                    } catch (anonError) {
                        console.error("åš´é‡éŒ¯èª¤ï¼šåŒ¿åç™»å…¥ä¹Ÿå¤±æ•—:", anonError);
                        if(userIdDisplayEl) userIdDisplayEl.textContent = "èªè­‰å¤±æ•—"; 
                    }
                }
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    if(userIdDisplayEl) userIdDisplayEl.textContent = userId.substring(0,8) + "..."; 
                    console.log("ä½¿ç”¨è€…å·²èªè­‰/æœƒè©±å·²é–‹å§‹ã€‚UID:", userId);
                } else {
                    userId = `local_user_${crypto.randomUUID()}`; 
                    if(userIdDisplayEl) userIdDisplayEl.textContent = "æœ¬æ©Ÿ";
                    console.warn("ç„¡å·²èªè­‰ä½¿ç”¨è€…ï¼ŒéŠæˆ²å°‡åœ¨æœ¬åœ°é‹è¡Œï¼Œä¸å„²å­˜åˆ° Firestoreã€‚");
                }
                await loadOrCreateNewGame(); 
            });
        }
        
        async function getGameDocRef() {
            if (!userId || userId.startsWith("local_user_")) { 
                return null;
            }
            return doc(db, "artifacts", appId, "users", userId, "interrogationGames", gameId);
        }
        
        const DEEPSEEK_API_KEY = "sk-19179bb0c0c94acaa53ca82dc1d28bbf"; 
        const DEEPSEEK_API_URL = "https://api.deepseek.com/chat/completions";

        function cleanAIJsonResponse(rawResponse) {
            if (typeof rawResponse !== 'string') return null; 
            let str = rawResponse.trim();
            const firstBrace = str.indexOf('{');
            const lastBrace = str.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                str = str.substring(firstBrace, lastBrace + 1);
            } else {
                const jsonMatch = str.match(/```json\s*([\s\S]*?)\s*```/);
                if (jsonMatch && jsonMatch[1]) { return jsonMatch[1].trim(); }
                const genericMatch = str.match(/```\s*([\s\S]*?)\s*```/);
                if (genericMatch && genericMatch[1]) { return genericMatch[1].trim(); }
            }
            return str; 
        }

        async function callDeepSeekAPI(systemPrompt, userPrompt, forMultipleFields = false) {
            if(aiThinkingModal && initialLoadingOverlay && initialLoadingOverlay.style.display === 'none') { 
                const thinkingText = aiThinkingModal.querySelector('p.text-lg');
                if(thinkingText) thinkingText.textContent = 'ğŸ¤–ç‹—ç¾æ‹¿è³½ï¼ŒAIæ­£åœ¨åŠªåŠ›æ’°å¯«ä¸­...';
                aiThinkingModal.classList.remove('hidden');
            }
            const payload = {
                model: "deepseek-chat", 
                messages: [ { role: "system", content: systemPrompt }, { role: "user", content: userPrompt } ],
                stream: false,
            };
            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${DEEPSEEK_API_KEY}`},
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("DeepSeek API Raw Error Response:", errorBody);
                    throw new Error(`DS API éŒ¯èª¤ ${response.status}: ${errorBody}`);
                }
                const result = await response.json();
                if(aiThinkingModal && initialLoadingOverlay && initialLoadingOverlay.style.display === 'none') aiThinkingModal.classList.add('hidden'); 
                if (result.choices && result.choices.length > 0 && result.choices[0].message && result.choices[0].message.content) {
                    return result.choices[0].message.content;
                } else { 
                    console.error("Unexpected DeepSeek API response structure:", result);
                    throw new Error("æœªé æœŸçš„ DS API éŸ¿æ‡‰çµæ§‹ã€‚"); 
                }
            } catch (error) {
                console.error("èª¿ç”¨ DeepSeek API æ™‚å‡ºéŒ¯:", error);
                if(aiThinkingModal && initialLoadingOverlay && initialLoadingOverlay.style.display === 'none') aiThinkingModal.classList.add('hidden');
                return forMultipleFields ? { error: error.message } : `AI (DS) éŒ¯èª¤: ${error.message.substring(0,100)}`;
            }
        }

        async function generateRandomSuspectName() {
            const lastNames = ["æ", "ç‹", "å¼µ", "åŠ‰", "é™³", "æ¥Š", "é»ƒ", "è¶™", "å³", "å‘¨"];
            const firstNamesMale = ["å‰", "å¼·", "ç£Š", "è»", "å‹‡", "å‚‘", "æ¿¤", "æ˜", "è¶…", "éµ¬"];
            const firstNamesFemale = ["èŠ³", "å¨œ", "æ•", "éœ", "éº—", "è±”", "ä¸¹", "è", "å©·", "é›ª"];
            const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
            const gender = (Math.random() > 0.5) ? "ç”·æ€§" : "å¥³æ€§";
            const firstName = gender === "ç”·æ€§" 
                ? firstNamesMale[Math.floor(Math.random() * firstNamesMale.length)] 
                : firstNamesFemale[Math.floor(Math.random() * firstNamesFemale.length)];
            return { name: lastName + firstName, gender: gender };
        }
        
        async function generateInitialSuspectDetailsAndState() {
            const loadingMessages = [
                "å»ºç«‹å«ŒçŠ¯æª”æ¡ˆ...", "ç¢ºèªå«ŒçŠ¯åŸºæœ¬è³‡æ–™...", "åˆ†æå«ŒçŠ¯æ˜Ÿåº§èˆ‡è¡€å‹...", 
                "æ¨ç®—å«ŒçŠ¯å¹´é½¡...", "è¨­å®šå«ŒçŠ¯å­¸æ­·èƒŒæ™¯...", "éš¨æ©Ÿåˆ†é…å‡ºç”Ÿåœ°å€...", "æŒ‡æ´¾å«ŒçŠ¯è·æ¥­...",
                "è©•ä¼°å«ŒçŠ¯å¥åº·ç‹€æ³...", "æƒæå«ŒçŠ¯ç”Ÿç†ç‰¹å¾µ...", "åˆæ­¥è©•ä¼°å«ŒçŠ¯å¿ƒç†ç‹€æ…‹...", 
                "å»ºç«‹å«ŒçŠ¯å€‹æ€§æ¨¡å‹...", "å´å¯«å«ŒçŠ¯å¯èƒ½å¼±é»...", "æ¨¡æ“¬å«ŒçŠ¯æ‡‰å°æ¨¡å¼...",
                "æ ¡æº–å«ŒçŠ¯åˆå§‹æƒ…ç·’...", "åµè¨Šå®¤æº–å‚™å®Œæˆ..."
            ];
            let msgIdx = 0;
            const updateLoadingMsg = (specificMsg = null) => {
                if(initialLoadingMessageEl) {
                    initialLoadingMessageEl.textContent = specificMsg || (msgIdx < loadingMessages.length ? loadingMessages[msgIdx++] : "æ­£åœ¨é€²è¡Œæœ€å¾Œç¢ºèª...");
                }
            };

            updateLoadingMsg(); 
            const { name, gender } = await generateRandomSuspectName();
            gameState.suspect.name = name;
            gameState.suspect.gender = gender;
            updateLoadingMsg(); 
            const dobTimestamp = Date.now() - Math.floor(Math.random() * 25 + 20) * 365 * 24 * 60 * 60 * 1000; 
            const birthDate = new Date(dobTimestamp);
            gameState.suspect.dob = `${birthDate.getFullYear()}å¹´${birthDate.getMonth() + 1}æœˆ${birthDate.getDate()}æ—¥`;
            updateLoadingMsg(); 
            gameState.suspect.age = new Date().getFullYear() - birthDate.getFullYear();
            gameState.suspect.zodiac = getZodiacSign(birthDate.getDate(), birthDate.getMonth() + 1);
            gameState.suspect.bloodType = ["A", "B", "AB", "O"][Math.floor(Math.random() * 4)] + "å‹";
            
            updateLoadingMsg(); 
            const educations = ["åœ‹ä¸­ç•¢æ¥­", "é«˜ä¸­ç•¢æ¥­", "å°ˆç§‘å­¸æ ¡", "å¤§å­¸ç•¢æ¥­", "å¤§å­¸è‚„æ¥­", "ç¢©å£«ç•¢æ¥­", "åšå£«ç­ç ”ç©¶"];
            gameState.suspect.education = educations[Math.floor(Math.random() * educations.length)];
            
            updateLoadingMsg(); 
            const birthplaces = ["å°åŒ—å¸‚", "æ–°åŒ—å¸‚", "æ¡ƒåœ’å¸‚", "å°ä¸­å¸‚", "å°å—å¸‚", "é«˜é›„å¸‚", "åŸºéš†å¸‚", "æ–°ç«¹å¸‚", "å˜‰ç¾©å¸‚", "å®œè˜­ç¸£", "èŠ±è“®ç¸£", "å°æ±ç¸£", "æ¾æ¹–ç¸£", "é‡‘é–€ç¸£", "é€£æ±Ÿç¸£"];
            gameState.suspect.birthplace = birthplaces[Math.floor(Math.random() * birthplaces.length)];

            updateLoadingMsg(); 
            const occupations = ["è¾¦å…¬å®¤è·å“¡", "å·¥ç¨‹å¸«", "æ•™å¸«", "æœå‹™ç”Ÿ", "è¨ˆç¨‹è»Šå¸æ©Ÿ", "è‡ªç”±å·¥ä½œè€…", "ç„¡æ¥­", "å­¸ç”Ÿ", "å•†äºº", "è—è¡“å®¶", "å»šå¸«", "å·¥äºº"];
            gameState.suspect.occupation = occupations[Math.floor(Math.random() * occupations.length)];

            updateLoadingMsg(); 
            let health = "å¤§è‡´è‰¯å¥½";
            if (Math.random() < 0.15) { 
                const chronic = ["è¼•å¾®é«˜è¡€å£“", "éæ•é«”è³ª", "å¶ç™¼æ€§åé ­ç—›", "è¼•å¾®èƒƒé£Ÿé“é€†æµ", "ç¡çœ å“è³ªä¸ä½³"];
                health = chronic[Math.floor(Math.random() * chronic.length)];
            }
            if (Math.random() < 0.1) { 
                const injury = ["æ‰‹è…•è¼•å¾®æ‹‰å‚·", "è†è“‹æ“¦å‚·", "è…³è¸æ‰­å‚·", "è‚©è†€ç— ç—›"];
                health += (health === "å¤§è‡´è‰¯å¥½" ? "" : "ï¼Œä¸”") + injury[Math.floor(Math.random() * injury.length)];
            }
            gameState.suspect.healthStatus = health;
            
            updateLoadingMsg(); 
            gameState.suspect.heartRate = 70 + Math.floor(Math.random() * 10) - 5; 
            gameState.suspect.bloodPressure = `${115 + Math.floor(Math.random() * 10) - 5}/${75 + Math.floor(Math.random() * 10) - 5}`; 
            
            updateLoadingMsg(); 
            const systemPersonalityPrompt = "ä½ æ˜¯ä¸€ä½éŠæˆ²NPCè¨­è¨ˆå¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹æä¾›çš„å«ŒçŠ¯è©³ç´°è³‡æ–™ï¼Œç”Ÿæˆä¸€æ®µè±å¯Œä¸”å¤šé¢å‘çš„å€‹æ€§æ¦‚è¿°ï¼ˆç´„50-80å­—ï¼‰ã€‚é€™æ®µæè¿°å°‡ä½œç‚ºåµè¨ŠæŠ€å·§çš„é—œéµåƒè€ƒï¼Œæš—ç¤ºå«ŒçŠ¯å¯èƒ½çš„å¼±é»æˆ–æ‡‰å°æ–¹å¼ã€‚ä¸è¦åŒ…å«ä»»ä½•é¡å¤–çš„èªªæ˜ã€æ¨™ç±¤æˆ–JSONæ ¼å¼ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚";
            const userPersonalityPrompt = `ç‚ºä»¥ä¸‹èƒŒæ™¯çš„å¯©å•éŠæˆ²å«ŒçŠ¯ ${gameState.suspect.name} ç”Ÿæˆä¸€æ®µè±å¯Œçš„å€‹æ€§æ¦‚è¿°ï¼š\nå¹´ç´€ï¼š${gameState.suspect.age}æ­²\næ€§åˆ¥ï¼š${gameState.suspect.gender}\næ˜Ÿåº§ï¼š${gameState.suspect.zodiac}\nè¡€å‹ï¼š${gameState.suspect.bloodType}\nå­¸æ­·ï¼š${gameState.suspect.education}\nå‡ºç”Ÿåœ°ï¼š${gameState.suspect.birthplace}\nè·æ¥­ï¼š${gameState.suspect.occupation}\nå¥åº·ç‹€æ…‹ï¼š${gameState.suspect.healthStatus}\n\nè«‹ç¶œåˆä»¥ä¸Šæ‰€æœ‰è³‡è¨Šï¼Œæå¯«ä¸€å€‹ç«‹é«”çš„è§’è‰²å€‹æ€§ï¼Œä¾‹å¦‚ï¼š"æ­¤äºº${gameState.suspect.age}æ­²ï¼Œ${gameState.suspect.occupation}ï¼Œå¾${gameState.suspect.birthplace}ä¾†åˆ°é€™è£¡ã€‚${gameState.suspect.education}çš„èƒŒæ™¯å¯èƒ½ä½¿å…¶æ€è€ƒæ¨¡å¼åå‘[å¯¦éš›/ç†è«–/ä¿å®ˆ/é–‹æ”¾]ã€‚${gameState.suspect.zodiac}å’Œ${gameState.suspect.bloodType}çš„çµ„åˆå¯èƒ½ä½¿å…¶åœ¨å£“åŠ›ä¸‹è¡¨ç¾å‡º[å†·éœ/æ€¥èº/å›ºåŸ·/æ˜“æ€’]çš„ç‰¹è³ªã€‚å¥åº·ç‹€æ³(${gameState.suspect.healthStatus})æˆ–è¨±æœƒå½±éŸ¿å…¶è€åŠ›æˆ–æƒ…ç·’ç©©å®šæ€§ã€‚åµè¨Šæ™‚å¯å˜—è©¦å¾[å…¶è·æ¥­èƒŒæ™¯/çŸ¥è­˜æ°´å¹³/åƒ¹å€¼è§€/æƒ…æ„Ÿé€£çµ]ç­‰è§’åº¦åˆ‡å…¥ã€‚" è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;
            const personalityResponse = await callDeepSeekAPI(systemPersonalityPrompt, userPersonalityPrompt);
            let cleanPersonality = typeof personalityResponse === 'string' ? personalityResponse.trim() : "æ€§æ ¼è¤‡é›œï¼Œéœ€è¬¹æ…æ‡‰å°ã€‚";
            cleanPersonality = cleanPersonality.replace(/```json|```/g, "").trim();
            gameState.suspect.personality = (cleanPersonality && !cleanPersonality.startsWith("AI (DS) Error")) ? cleanPersonality : "æ€§æ ¼è¤‡é›œï¼Œéœ€è¬¹æ…æ‡‰å°ã€‚";
            
            updateLoadingMsg(); 
            const initialObservables = await generateSuspectObservableState("éŠæˆ²å‰›é–‹å§‹ï¼Œåµè¨Šå®¤æ°£æ°›åš´è‚…ã€‚");
            gameState.suspect.facialExpression = initialObservables.facialExpression || "é¢ç„¡è¡¨æƒ…";
            gameState.suspect.bodyLanguage = initialObservables.bodyLanguage || "é›™æ‰‹æ”¾åœ¨æ¡Œä¸Š";
            gameState.suspect.microAction = initialObservables.microAction || "å¶çˆ¾çœ¨çœ¼";
            gameState.suspect.voiceTone = initialObservables.voiceTone || "èªæ°£å¹³éœ";
            updateLoadingMsg(); 
        }

        async function generateNewCaseDetails() {
            const loadingMessages = [
                "æ§‹å»ºå…¨æ–°çŠ¯ç½ªç¾å ´...", "æœé›†åˆæ­¥ç·šç´¢...", "åˆ†æè¢«å®³äººèƒŒæ™¯...", 
                "æ•´ç†é©—å±å ±å‘Šè‰ç¨¿...", "ç¯©é¸é—œéµè­‰ç‰©...", "åˆ—å‡ºåˆæ­¥èª¿æŸ¥ç–‘é»...",
                "äº¤å‰æ¯”å°è­‰æ“šéˆ...", "ç¢ºèªæ¡ˆä»¶æ ¸å¿ƒçŸ›ç›¾..."
            ];
            let msgIdx = 0;
            const updateLoadingMsg = () => {
                if(initialLoadingMessageEl && msgIdx < loadingMessages.length) {
                    initialLoadingMessageEl.textContent = loadingMessages[msgIdx++];
                }
            };
            updateLoadingMsg(); 

            const systemPrompt = "ä½ æ˜¯ä¸€å€‹å°ˆé–€ç”ŸæˆJSONæ ¼å¼æ¡ˆä»¶åŠ‡æƒ…çš„AIã€‚ä½ çš„ä»»å‹™æ˜¯ç‚ºä¸€å€‹å¯©å•éŠæˆ²ç”Ÿæˆä¸€å€‹å…¨æ–°çš„è¬€æ®ºæ¡ˆæ¦‚è¦ã€‚ä½ çš„å›æ‡‰å¿…é ˆ**åƒ…åƒ…æ˜¯**ä¸€å€‹åˆæ³•çš„JSONå°è±¡ï¼ŒåŒ…å«ä¸‰å€‹é ‚å±¤éµï¼š'autopsyReport' (å…¶å€¼ç‚ºå­—ä¸²), 'evidence' (å…¶å€¼ç‚ºå­—ä¸²é™£åˆ—), 'doubts' (å…¶å€¼ç‚ºå­—ä¸²é™£åˆ—)ã€‚åœ¨ 'evidence' å’Œ 'doubts' çš„å­—ä¸²ä¸­ï¼Œè‹¥æåŠå…·é«”çš„ç‰©å“ã€åœ°é»ã€æ™‚é–“æˆ–äº‹ä»¶ï¼Œè«‹ç”¨ ## å°‡å…¶åŒ…è£¹èµ·ä¾†ã€‚**çµ•å°ä¸è¦**åœ¨JSONå°è±¡ä¹‹å¤–åŒ…å«ä»»ä½•æ–‡å­—ã€è§£é‡‹ã€é–‹é ­æˆ–çµå°¾çš„æ¨™è¨˜ (ä¾‹å¦‚ ```json æˆ– ```)ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚";
            const userPrompt = `ç”Ÿæˆä¸€å€‹æ–°çš„è¬€æ®ºæ¡ˆæƒ…ç¯€ã€‚å«ŒçŠ¯æ˜¯ ${gameState.suspect.name} (${gameState.suspect.gender}, ${gameState.suspect.age}æ­²)ã€‚è«‹ç¢ºä¿æ¡ˆä»¶æœ‰åŸºæœ¬é‚è¼¯æ€§ï¼Œè­‰æ“šå’Œç–‘é»è¦æœ‰é—œè¯æ€§ã€‚ä¾‹å¦‚ï¼Œé©—å±å ±å‘Šå¯åŒ…å«æ­»å› ã€æ­»äº¡æ™‚é–“ï¼›è­‰æ“šå¯ä»¥æ˜¯ç¾å ´ç™¼ç¾çš„ç‰©å“ã€ç›®æ“Šè€…è­‰è©ç­‰ï¼›ç–‘é»å¯ä»¥æ˜¯å«ŒçŠ¯çš„ä¸åœ¨å ´è­‰æ˜ç‘•ç–µã€èˆ‡è¢«å®³äººé—œä¿‚ç­‰ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;
            let caseData = null;
            const rawResponse = await callDeepSeekAPI(systemPrompt, userPrompt, true);
            updateLoadingMsg(); 

            const jsonString = cleanAIJsonResponse(rawResponse);
            updateLoadingMsg(); 
            try {
                if (jsonString && !jsonString.startsWith("AI (DS) Error") && typeof jsonString !== 'object') { 
                    caseData = JSON.parse(jsonString);
                    updateLoadingMsg(); 
                } else if (jsonString && typeof jsonString === 'object' && jsonString.error) {
                     console.error("API éŒ¯èª¤ç”Ÿæˆæ¡ˆä»¶:", jsonString.error);
                }  else if (typeof jsonString === 'string' && jsonString.startsWith("AI (DS) Error")) {
                    console.error("API Error (string):", jsonString);
                }
            } catch (e) { 
                console.error("è§£ææ¡ˆä»¶è©³ç´°è³‡æ–™ JSON å¤±æ•—:", e, "æ¸…ç†å¾Œçš„å­—ä¸²:", jsonString, "åŸå§‹éŸ¿æ‡‰:", rawResponse); 
                updateLoadingMsg(); 
            }

            if (caseData && caseData.autopsyReport && Array.isArray(caseData.evidence) && Array.isArray(caseData.doubts)) {
                gameState.caseDetails.autopsyReport = caseData.autopsyReport;
                gameState.caseDetails.evidence = caseData.evidence.map((item, index) => typeof item === 'string' ? { text: item, id: `ev_new_${index}` } : item );
                gameState.caseDetails.doubts = caseData.doubts.map((item, index) => typeof item === 'string' ? { text: item, id: `db_new_${index}` } : item );
                updateLoadingMsg(); 
            } else {
                gameState.caseDetails.autopsyReport = `è¢«å®³è€… ${["å¼µä¸‰","æå››","ç‹äº”"][Math.floor(Math.random()*3)]}ï¼Œæ­»æ–¼å®¶ä¸­ï¼Œåˆæ­¥åˆ¤æ–·ç‚ºä»–æ®ºï¼Œæ­»äº¡æ™‚é–“ç´„ç‚ºæ˜¨æ™šã€‚ç¾å ´ç™¼ç¾ ##ä¸€æŠŠæ°´æœåˆ€##ã€‚`;
                gameState.caseDetails.evidence = [ { text: `åœ¨è¢«å®³è€…é™„è¿‘æ‰¾åˆ°ä¸€æŠŠ ##æ²¾è¡€çš„åˆ€å­##ã€‚`, id: "ev_fb1"}, { text: `é„°å±…è¡¨ç¤ºåœ¨ ##æ˜¨æ™šä¹é»## å·¦å³è½åˆ°æ¿€çƒˆçˆ­åµè²ã€‚`, id: "ev_fb2"}];
                gameState.caseDetails.doubts = [ { text: `å«ŒçŠ¯ ${gameState.suspect.name} è²ç¨±ç•¶æ™‚ç¨è‡ªåœ¨å®¶ã€‚`, id: "db_fb1"}, { text: `å«ŒçŠ¯èˆ‡è¢«å®³è€…åœ¨ ##ä¸‰å¤©å‰## æ›¾å› é‡‘éŒ¢å•é¡Œç™¼ç”Ÿéçˆ­åŸ·ã€‚`, id: "db_fb2"}];
                console.warn("ç”±æ–¼ç”Ÿæˆ/è§£æéŒ¯èª¤ï¼Œä½¿ç”¨é è¨­æ¡ˆä»¶è©³ç´°è³‡æ–™ã€‚");
                updateLoadingMsg(); 
            }
        }

        async function generateOpeningDialogue() {
            if(initialLoadingMessageEl) initialLoadingMessageEl.textContent = "æº–å‚™è­¦å®˜é–‹å ´é™³è¿°...";
            const officerOpeningSystemPrompt = "ä½ æ˜¯åµè¨ŠéŠæˆ²ä¸­çš„é–‹å ´è­¦å®˜ã€‚ä½ çš„ä»»å‹™æ˜¯ç°¡è¿°æ¡ˆæƒ…ä¸¦å‘ŠçŸ¥å«ŒçŠ¯æ¬Šåˆ©ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚";
            const officerOpeningUserPrompt = `å‘å«ŒçŠ¯ ${gameState.suspect.name} ç°¡è¿°åµæŸ¥æ¡ˆä»¶ï¼ˆåŸºæ–¼ä»¥ä¸‹æ¡ˆæƒ…æ¦‚è¦ï¼š${gameState.caseDetails.autopsyReport.substring(0,50)}...ï¼‰ä¸¦å‘ŠçŸ¥å…¶åœ¨å°ç£æ³•å¾‹ä¸‹çš„åŸºæœ¬æ¬Šåˆ©ï¼ˆä½ æœ‰æ¬Šä¿æŒç·˜é»˜ï¼›æœ‰æ¬Šé¸ä»»è¾¯è­·äººï¼›ä½ æ‰€èªªçš„ä¸€åˆ‡éƒ½å¯èƒ½ä½œç‚ºè­‰æ“šï¼‰ã€‚è«‹ç›´æ¥çµ¦å‡ºå®Œæ•´çš„é–‹å ´é™³è¿°ï¼Œèªæ°£åš´è‚…è€Œå°ˆæ¥­ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;
            const officerOpeningText = await callDeepSeekAPI(officerOpeningSystemPrompt, officerOpeningUserPrompt);
            if (officerOpeningText && !officerOpeningText.startsWith("AI (DS) Error")) {
                gameState.dialogueHistory.push({ speaker: "è­¦å®˜", text: officerOpeningText, tone: "å¹³ç·©" });
            } else {
                gameState.dialogueHistory.push({ speaker: "è­¦å®˜", text: `${gameState.suspect.name}ï¼Œæˆ‘å€‘å°±ä¸€å®—è¬€æ®ºæ¡ˆå‘ä½ é€²è¡Œè©¢å•ã€‚ä½ æœ‰æ¬Šä¿æŒç·˜é»˜ï¼Œæ‰€èªªçš„è©±å°‡å¯èƒ½æˆç‚ºè­‰æ“šã€‚ä½ ä¹Ÿæœ‰æ¬Šè˜è«‹å¾‹å¸«ã€‚`, tone: "å¹³ç·©" });
            }
            
            if(initialLoadingMessageEl) initialLoadingMessageEl.textContent = "ç­‰å¾…å«ŒçŠ¯åˆæ­¥å›æ‡‰...";
            const suspectRebuttalSystemPrompt = `ä½ æ˜¯è¬€æ®ºæ¡ˆå«ŒçŠ¯ ${gameState.suspect.name} (å€‹æ€§: ${gameState.suspect.personality})ã€‚ä½ å‰›è½å®Œè­¦å®˜çš„é–‹å ´é™³è¿°åŠæ¬Šåˆ©å‘ŠçŸ¥ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;
            const suspectRebuttalUserPrompt = `é‡å°è­¦å®˜çš„é–‹å ´é™³è¿°ï¼Œç”Ÿæˆä¸€æ®µç°¡çŸ­çš„ç‹¡è¾¯å›æ‡‰ï¼Œä¸¦æåŠå°ç£æ³•å¾‹çš„ç„¡ç½ªæ¨å®šåŸå‰‡ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;
            const suspectRebuttalText = await callDeepSeekAPI(suspectRebuttalSystemPrompt, suspectRebuttalUserPrompt);
            if (suspectRebuttalText && !suspectRebuttalText.startsWith("AI (DS) Error")) {
                gameState.dialogueHistory.push({ speaker: "AI", text: suspectRebuttalText });
            } else {
                gameState.dialogueHistory.push({ speaker: "AI", text: "è­¦å®˜ï¼Œæˆ‘ä¸æ˜ç™½ã€‚æˆ‘æ˜¯æ¸…ç™½çš„ï¼Œæ³•å¾‹ä¸æ˜¯èªªç„¡ç½ªæ¨å®šå—ï¼Ÿ" });
            }
        }
        
        async function generateInterrogationTip() {
            const systemPrompt = "ä½ æ˜¯è³‡æ·±åµæ¢ï¼Œæä¾›åµè¨ŠæŠ€å·§æç¤ºã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚ä½ çš„æç¤ºåº«æ‡‰åŒ…å«è‡³å°‘30ç¨®ä¸åŒçš„æŠ€å·§ï¼Œä¸¦æ ¹æ“šä»¥ä¸‹è³‡è¨Šé¸æ“‡ä¸€å€‹åˆé©ä¸”ç›¡é‡ä¸é‡è¤‡çš„ã€ç°¡çŸ­æ‰¼è¦çš„æç¤ºï¼ˆä¸€å¥è©±ï¼Œä¸è¶…é20å­—ï¼‰ã€‚";
            const userPrompt = `æ ¹æ“šç›®å‰å«ŒçŠ¯ ${gameState.suspect.name} çš„å€‹æ€§ï¼ˆ${gameState.suspect.personality}ï¼‰å’Œé ‘æŠ—åº¦ï¼ˆ${getConfessionMeterTextAndColor(gameState.confessionMeter).text}ï¼‰ï¼Œæä¾›ä¸€å¥ç°¡çŸ­æ‰¼è¦çš„åµè¨ŠæŠ€å·§æç¤ºã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;
            let tip = await callDeepSeekAPI(systemPrompt, userPrompt);
            if (tip && !tip.startsWith("AI (DS) Error")) {
                if(interrogationTipAreaEl) interrogationTipAreaEl.textContent = "â€»è²¼å¿ƒæç¤ºï¼š " + tip.substring(0, 30); 
            } else {
                if(interrogationTipAreaEl) interrogationTipAreaEl.textContent = "â€»è²¼å¿ƒæç¤ºï¼š ä¿æŒå†·éœï¼Œè§€å¯Ÿç´°ç¯€ã€‚"; 
            }
        }

        async function generateGameAnalysis() {
            const systemPrompt = "ä½ æ˜¯æ¡ˆä»¶åˆ†æå“¡ï¼Œè² è²¬åœ¨å¯©å•éŠæˆ²çµæŸå¾Œæä¾›å¿ƒç†æ”»é˜²åˆ†æã€‚ä½ çš„å›æ‡‰å¿…é ˆæ˜¯ JSON æ ¼å¼ï¼ŒåŒ…å«å››å€‹éµï¼š'interrogationStyle' (åµè¨Šå“¡å¯©å•é¢¨æ ¼åˆ†æ), 'techniqueAnalysis' (èˆ‡å«ŒçŠ¯é¬¥æ™ºéç¨‹æŠ€å·§åˆ†æ), 'playerPersonalityTrait' (åˆ†æç©å®¶åœ¨ç¾å¯¦ä¸–ç•Œæ½›åœ¨äººæ ¼ç‰¹è³ª), 'achievementTitle' (æ ¹æ“šæ•´é«”åˆ†æçµ¦äºˆç©å®¶ä¸€å€‹æˆå°±ç¨±è™Ÿï¼Œä¾‹å¦‚ï¼šå‡¶ç¥æƒ¡ç…åµè¨Šå“¡ã€å¿ƒæ€ç´°å¯†åµè¨Šé«˜æ‰‹ã€å†·éœä½ˆå±€è€…ã€æ­¥æ­¥ç‚ºç‡Ÿçš„å¯©å•è€…ã€ç›´è¦ºæ•éŠ³çš„ç›¤å•è€…ç­‰)ã€‚æ¯å€‹éµçš„å€¼éƒ½æ˜¯ä¸€æ®µæ–‡å­—æè¿°ã€‚**çµ•å°ä¸è¦**åœ¨JSONå°è±¡ä¹‹å¤–åŒ…å«ä»»ä½•æ–‡å­—ã€è§£é‡‹ã€é–‹é ­æˆ–çµå°¾çš„æ¨™è¨˜ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚";
            const dialogueSummary = gameState.dialogueHistory.slice(-10).map(msg => `${msg.speaker === "Player" ? "åµè¨Šå“¡" : gameState.suspect.name}(${msg.speaker === "è­¦å®˜" ? "è­¦å®˜" : msg.speaker}): ${msg.text}`).join("\n");
            const userPrompt = `å¯©å•éŠæˆ²å·²çµæŸã€‚å«ŒçŠ¯ ${gameState.suspect.name} ${gameState.confessionMeter <= 0 ? "å·²èªç½ª" : "æœªèªç½ª"}ã€‚ç¸½å…±è€—è²» ${gameState.round} å›åˆã€‚é ‘æŠ—åº¦æœ€çµ‚ç‚º ${getConfessionMeterTextAndColor(gameState.confessionMeter).text} (${gameState.confessionMeter}%)ã€‚\nå«ŒçŠ¯å€‹æ€§ç‚ºï¼š${gameState.suspect.personality}ã€‚\néƒ¨åˆ†å°è©±è¨˜éŒ„æ‘˜è¦ï¼š\n${dialogueSummary}\nè«‹æ ¹æ“šä»¥ä¸Šè³‡è¨Šï¼Œç”ŸæˆJSONæ ¼å¼çš„å¿ƒç†æ”»é˜²åˆ†æã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;
            
            const rawResponse = await callDeepSeekAPI(systemPrompt, userPrompt, true);
            const jsonString = cleanAIJsonResponse(rawResponse);
            let analysisData = { interrogationStyle: "åˆ†æç”Ÿæˆå¤±æ•—ã€‚", techniqueAnalysis: "è«‹æª¢æŸ¥APIé€£ç·šæˆ–æç¤ºè©ã€‚", playerPersonalityTrait: "æœªèƒ½åˆ†æã€‚", achievementTitle: "åµè¨Šæ–°æ‰‹" };

            try {
                if (jsonString && !jsonString.startsWith("AI (DS) Error") && typeof jsonString !== 'object') {
                    const parsed = JSON.parse(jsonString);
                    if (parsed && parsed.interrogationStyle && parsed.techniqueAnalysis && parsed.playerPersonalityTrait && parsed.achievementTitle) {
                        analysisData = parsed;
                    }
                } else if (jsonString && typeof jsonString === 'object' && jsonString.error) {
                    console.error("DS API returned an error for game analysis:", jsonString.error);
                }
            } catch (e) {
                console.error("Failed to parse game analysis JSON:", e, "Cleaned:", jsonString, "Raw:", rawResponse);
            }
            gameState.gameAnalysis = analysisData;
        }


        async function loadOrCreateNewGame() { 
            gameId = `game_${Date.now()}`; 
            gameState = getDefaultGameState(); 
            
            if(initialLoadingOverlay) initialLoadingOverlay.style.display = 'flex';
            if(gameMainAreaEl) gameMainAreaEl.style.display = 'none';

            await generateInitialSuspectDetailsAndState(); 
            updateUI(gameState); 

            await generateNewCaseDetails();
            updateUI(gameState); 

            await generateOpeningDialogue();
            updateUI(gameState); 

            await generateInterrogationTip(); 
            updateUI(gameState); 

            if(initialLoadingOverlay) initialLoadingOverlay.style.display = 'none';
            if(gameMainAreaEl) gameMainAreaEl.style.display = 'flex'; 
            if(introModal) introModal.classList.remove('hidden'); 

            const gameDocRef = await getGameDocRef(); 
            if (gameDocRef) { 
                if (gameStateUnsubscribe) gameStateUnsubscribe(); 
                console.log("é–‹å§‹æ–°éŠæˆ²ï¼Œä½¿ç”¨è€…:", userId, "éŠæˆ² ID:", gameId);
                try {
                    await setDoc(gameDocRef, { ...gameState, createdAt: serverTimestamp(), lastUpdatedAt: serverTimestamp() });
                    console.log("æ–°éŠæˆ²ç‹€æ…‹å·²å„²å­˜åˆ° Firestoreã€‚");
                } catch (error) {
                    console.error("å„²å­˜æ–°éŠæˆ²ç‹€æ…‹åˆ° Firestore æ™‚å‡ºéŒ¯:", error);
                }
                gameStateUnsubscribe = onSnapshot(gameDocRef, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const remoteGameState = docSnapshot.data();
                        if (remoteGameState.lastUpdatedAt && (!gameState.lastUpdatedAt || remoteGameState.lastUpdatedAt.toMillis() > gameState.lastUpdatedAt.toMillis())) {
                            gameState = { ...getDefaultGameState(), ...remoteGameState }; 
                        }
                         if (!gameState.suspect || !gameState.suspect.dob || !gameState.suspect.facialExpression) {
                            console.warn("Suspect details incomplete after Firestore load, re-generating might be needed or check Firestore data.");
                        }
                        updateUI(gameState); 
                    }
                }, (error) => console.error("onSnapshot ç›£è½å™¨éŒ¯èª¤:", error));
            } else {
                console.log("æœ¬åœ°éŠç©ï¼ŒFirestore åŠŸèƒ½ (å„²å­˜/è¼‰å…¥) å·²åœç”¨ã€‚");
            }
        }

        async function saveGameState() { 
            const gameDocRef = await getGameDocRef();
            if (!gameDocRef) { 
                console.log("æœ¬åœ°éŠç©ï¼šéŠæˆ²ç‹€æ…‹æœªå„²å­˜åˆ° Firestoreã€‚");
                return;
            }
            try {
                await setDoc(gameDocRef, { ...gameState, lastUpdatedAt: serverTimestamp() }, { merge: true });
            } catch (error) { console.error("å„²å­˜éŠæˆ²ç‹€æ…‹æ™‚å‡ºéŒ¯:", error); }
        }
        
        function getZodiacSign(day, month) { 
            const zodiacSigns = [
                { sign: "æ‘©ç¾¯åº§", start: [12, 22], end: [1, 19] }, { sign: "æ°´ç“¶åº§", start: [1, 20], end: [2, 18] },
                { sign: "é›™é­šåº§", start: [2, 19], end: [3, 20] }, { sign: "ç™½ç¾Šåº§", start: [3, 21], end: [4, 19] },
                { sign: "é‡‘ç‰›åº§", start: [4, 20], end: [5, 20] }, { sign: "é›™å­åº§", start: [5, 21], end: [6, 21] },
                { sign: "å·¨èŸ¹åº§", start: [6, 22], end: [7, 22] }, { sign: "ç…å­åº§", start: [7, 23], end: [8, 22] },
                { sign: "è™•å¥³åº§", start: [8, 23], end: [9, 22] }, { sign: "å¤©ç§¤åº§", start: [9, 23], end: [10, 23] },
                { sign: "å¤©è åº§", start: [10, 24], end: [11, 22] }, { sign: "å°„æ‰‹åº§", start: [11, 23], end: [12, 21] }
            ];
            for (const z of zodiacSigns) { if ((month === z.start[0] && day >= z.start[1]) || (month === z.end[0] && day <= z.end[1])) { return z.sign; } }
            return "æœªçŸ¥";
        }

        async function getAIResponse(playerMessage, isDemandConfession = false) { 
            const evidenceText = gameState.caseDetails.evidence.map(e => e.text.replace(/<[^>]*>/g, "")).join("ï¼›");
            const doubtsText = gameState.caseDetails.doubts.map(d => d.text.replace(/<[^>]*>/g, "")).join("ï¼›");
            let systemPrompt;
            if (isDemandConfession) {
                systemPrompt = `ä½ æ˜¯éŠæˆ²ä¸­çš„å«ŒçŠ¯AIæ±ºç­–æ¨¡çµ„ã€‚æ ¹æ“šä»¥ä¸‹å«ŒçŠ¯è³‡æ–™å’Œç•¶å‰æƒ…æ³ï¼Œåˆ¤æ–·ç•¶åµè¨Šå“¡ç›´æ¥ã€è¦æ±‚èªç½ªã€æ™‚ï¼Œå«ŒçŠ¯æ˜¯å¦æœƒèªç½ªã€‚ä½ çš„å›ç­”å¿…é ˆæ˜¯ JSON æ ¼å¼ï¼Œåªæœ‰ä¸€å€‹éµ 'confess'ï¼Œå…¶å€¼ç‚ºå¸ƒæ—å€¼ (true æˆ– false)ã€‚å¦‚æœåˆ¤æ–·ç‚ºä¸èªç½ª (false)ï¼Œè«‹åŒæ™‚æä¾›ä¸€å€‹ 'defiantResponse' éµï¼Œå…¶å€¼ç‚ºä¸€æ®µç°¡çŸ­ã€ç¬¦åˆå«ŒçŠ¯å€‹æ€§çš„ç¹é«”ä¸­æ–‡æŠ—æ‹’å›æ‡‰ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡æ€è€ƒä¸¦å›æ‡‰ã€‚
                å«ŒçŠ¯è³‡æ–™ï¼š
                å§“åï¼š${gameState.suspect.name}
                å¹´é½¡ï¼š${gameState.suspect.age}
                è·æ¥­ï¼š${gameState.suspect.occupation}
                å­¸æ­·ï¼š${gameState.suspect.education}
                å‡ºç”Ÿåœ°ï¼š${gameState.suspect.birthplace}
                å¥åº·ç‹€æ…‹ï¼š${gameState.suspect.healthStatus}
                å€‹æ€§æ¦‚è¿°ï¼š${gameState.suspect.personality}
                ç›®å‰é ‘æŠ—åº¦ï¼š${gameState.confessionMeter}% (${getConfessionMeterTextAndColor(gameState.confessionMeter).text})
                æƒ…å¢ƒï¼šåµè¨Šå“¡å‰›å‰›éå¸¸å¼·ç¡¬åœ°ã€è¦æ±‚ä½ ç«‹åˆ»èªç½ªã€ã€‚
                è€ƒé‡å› ç´ ï¼šå¹´ç´€è¼ƒè¼•ã€ç¤¾æœƒç¶“é©—ä¸è¶³ã€å€‹æ€§è†½å°è€…ï¼Œåœ¨é ‘æŠ—åº¦è¼ƒä½æ™‚æ›´å®¹æ˜“å±ˆæœã€‚å¹´ç´€è¼ƒå¤§ã€æœ‰ç¤¾æœƒæ­·ç·´ã€å€‹æ€§é ‘å›ºæˆ–å¤§è†½è€…ï¼Œå³ä½¿é ‘æŠ—åº¦ç¨ä½ï¼Œä¹Ÿå¯èƒ½ç¹¼çºŒæŠµæŠ—ã€‚
                è«‹åˆ¤æ–·æ˜¯å¦èªç½ªï¼Œä¸¦ä»¥JSONæ ¼å¼è¼¸å‡ºã€‚`;
            } else {
                systemPrompt = `ä½ æ˜¯è¬€æ®ºæ¡ˆå«ŒçŠ¯ ${gameState.suspect.name} (å€‹æ€§: ${gameState.suspect.personality})ã€‚\nä½ ç›®å‰çš„é ‘æŠ—åº¦è¢«æè¿°ç‚ºã€Œ${getConfessionMeterTextAndColor(gameState.confessionMeter).text}ã€ã€‚\nç”Ÿç†ç‹€æ…‹ï¼šå¿ƒç‡ ${gameState.suspect.heartRate} bpmï¼Œè¡€å£“ ${gameState.suspect.bloodPressure}ã€‚\nå¤–åœ¨è¡¨ç¾ï¼šè¡¨æƒ… ${gameState.suspect.facialExpression}ï¼Œè‚¢é«” ${gameState.suspect.bodyLanguage}ï¼Œå¾®å‹•ä½œ ${gameState.suspect.microAction || 'ç„¡æ˜é¡¯'}ï¼Œèªæ°£ ${gameState.suspect.voiceTone}ã€‚\nä½ çš„ä¸»è¦ç›®æ¨™æ˜¯é‡å°ç©å®¶çš„æå•é€²è¡Œç›´æ¥ã€ç°¡æ½”çš„å›æ‡‰ï¼Œç›¡å¯èƒ½ä¸æ´©éœ²éå¤šè³‡è¨Šï¼Œé™¤éä½ çš„é ‘æŠ—åº¦å¾ˆä½ï¼ˆä¾‹å¦‚ä½æ–¼30ï¼‰æˆ–æƒ…ç·’è®Šå¾—éå¸¸ä¸ç©©å®šï¼ˆä¾‹å¦‚ï¼Œæ…Œäº‚ã€ç€•è‡¨å´©æ½°ï¼‰ï¼Œé‚£æ™‚æ‰å¯èƒ½é–‹å§‹å¤šè©±ã€èªç„¡å€«æ¬¡æˆ–è©¦åœ–è½‰ç§»è©±é¡Œã€‚\nå¦‚æœä½ çš„æƒ…ç·’è®Šå¾—æ¿€å‹•ã€æ…Œäº‚æˆ–è©¦åœ–èƒ¡è¨€äº‚èªï¼Œä½ å¯ä»¥ç”¨å¤šå€‹ç°¡çŸ­çš„å°è©±æ¡†ä¾†å›æ‡‰ï¼ˆç”¨ "||" åˆ†éš”æ¯å€‹å°è©±æ¡†çš„å…§å®¹ï¼‰ã€‚\nå›ç­”æ™‚ï¼Œå¦‚æœæåˆ°æ¡ˆä»¶ç›¸é—œçš„é—œéµç‰©å“æˆ–åœ°é»ï¼ˆä¾‹å¦‚ï¼šæ§Œå­ã€å…¬å¯“ã€å…¬åœ’ã€åˆ€æ¢°ã€è¢«å®³è€…å§“åã€ç‰¹å®šæ™‚é–“é»ï¼‰ï¼Œè«‹åœ¨è©²è©å½™å‰å¾ŒåŠ ä¸Š @@ï¼Œä¾‹å¦‚ @@æ§Œå­@@ã€‚\nä½ çš„å›ç­”æ‡‰è©²ç°¡æ½”æœ‰åŠ›ï¼Œé™¤éç‰¹å®šæƒ…å¢ƒä¸‹éœ€è¦å±•ç¾æ…Œäº‚ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;
            }
            const userPrompt = isDemandConfession ? `åµè¨Šå“¡è¦æ±‚èªç½ªï¼Œæˆ‘è©²èªå—ï¼Ÿè«‹ä»¥JSONæ ¼å¼ {"confess": boolean, "defiantResponse": "è‹¥ä¸èªç½ªæ™‚çš„ç°¡çŸ­å›æ‡‰"} å›ç­”ã€‚` : `ç›®å‰å°ä½ ä¸åˆ©çš„è­‰æ“šæœ‰ï¼š${evidenceText}ã€‚èª¿æŸ¥äººå“¡å°ä½ çš„ç–‘é»æ˜¯ï¼š${doubtsText}ã€‚å¯©å•è€…ï¼ˆç©å®¶ï¼‰ç”¨ã€Œ${gameState.selectedTone}ã€çš„èªæ°£å•ä½ ï¼šã€Œ${playerMessage}ã€ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;
            
            const response = await callDeepSeekAPI(systemPrompt, userPrompt, isDemandConfession); 
            
            if (isDemandConfession) {
                try {
                    const parsedResponse = JSON.parse(response); 
                    return parsedResponse; 
                } catch (e) {
                    console.error("Error parsing AI confession decision:", e, "Response:", response);
                    return { confess: (gameState.confessionMeter < 15), defiantResponse: "ä½ ä¼‘æƒ³å¥—æˆ‘è©±ï¼" }; 
                }
            }

            if (response && !response.startsWith("AI (DS) Error")) { return response.split("||").map(r => r.trim()); }
            return ["æˆ‘ä¸çŸ¥é“ä½ åœ¨èªªä»€éº¼ã€‚"]; 
        }

        async function getKeywordInfo(keyword) { 
            if(keywordModalText) keywordModalText.textContent = "å…§å®¹AIåŠ è¼‰ä¸­è«‹ç¨å¾Œ..."; 
            if(keywordLoadingSpinner) keywordLoadingSpinner.classList.remove('hidden'); 
            
            const systemPrompt = "ä½ æ˜¯ä¸€ä½åµæ¢åŠ©æ‰‹ï¼Œæä¾›æ¡ˆä»¶ç·šç´¢ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚";
            const userPrompt = `åœ¨ä¸€å€‹è¬€æ®ºæ¡ˆçš„å¯©å•æƒ…å¢ƒä¸­ï¼Œæåˆ°äº†é—œéµå­—ã€Œ${keyword}ã€ã€‚è«‹é‡å°é€™å€‹é—œéµå­—ï¼Œæä¾›ä¸€æ®µç°¡çŸ­ï¼ˆç´„30-50å­—ï¼‰çš„è£œå……è³‡è¨Šæˆ–ç·šç´¢ï¼Œé€™æ®µè³‡è¨Šæ‡‰è©²å°ç©å®¶ï¼ˆå¯©å•è€…ï¼‰æœ‰æ‰€å¹«åŠ©ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé—œéµå­—æ˜¯ã€Œæ§Œå­ã€ï¼Œä½ å¯ä»¥èªªï¼šã€Œè­¦æ–¹åœ¨æ¡ˆç™¼ç¾å ´æ‰¾åˆ°ä¸€æŠŠå¸¶æœ‰è¡€è·¡çš„æ§Œå­ï¼Œä¸Šé¢åŒæ™‚æœ‰è¢«å®³è€…çš„DNAå’Œä¸€æšæ¨¡ç³Šçš„æŒ‡ç´‹ï¼Œæ­£åœ¨é€²è¡Œæ¯”å°ã€‚ã€å¦‚æœé—œéµå­—æ˜¯ã€Œå…¬åœ’ã€ï¼Œä½ å¯ä»¥èªªï¼šã€Œæ ¹æ“šé€šè¨Šè¨˜éŒ„ï¼Œè¢«å®³è€…æ‰‹æ©Ÿæœ€å¾Œçš„è¨Šè™Ÿä½ç½®æ˜¯åœ¨åŸå¸‚ä¸­å¤®å…¬åœ’é™„è¿‘ã€‚ã€è«‹ç›´æ¥çµ¦å‡ºè£œå……è³‡è¨Šï¼Œä¸è¦æœ‰é¡å¤–çš„é–‹é ­æˆ–çµå°¾ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;
            const info = await callDeepSeekAPI(systemPrompt, userPrompt);
            
            if(keywordLoadingSpinner) keywordLoadingSpinner.classList.add('hidden'); 
            if (info && !info.startsWith("AI (DS) Error")) { 
                if(keywordModalText) keywordModalText.textContent = info; 
            } else { 
                if(keywordModalText) keywordModalText.textContent = `é—œæ–¼ã€Œ${keyword}ã€çš„æ›´å¤šè³‡è¨Šç›®å‰ç„¡æ³•å–å¾—ã€‚`; 
            }
        }
        
        async function generateSuspectObservableState(lastAIMessage = "") { 
            const systemPrompt = "ä½ æ˜¯ä¸€å€‹å°ˆé–€è¼¸å‡ºJSONçš„AIã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šæä¾›çš„è³‡è¨Šï¼Œç”Ÿæˆä¸€å€‹æè¿°å«ŒçŠ¯ç•¶å‰å¤–åœ¨è¡¨ç¾çš„JSONå°è±¡ã€‚**çµ•å°ä¸è¦**åœ¨JSONå°è±¡ä¹‹å¤–åŒ…å«ä»»ä½•æ–‡å­—ã€è§£é‡‹ã€é–‹é ­æˆ–çµå°¾çš„æ¨™è¨˜ (ä¾‹å¦‚ ```json æˆ– ```)ã€‚ä½ çš„å›æ‡‰å¿…é ˆ**åƒ…åƒ…æ˜¯**ä¸€å€‹åˆæ³•çš„JSONå°è±¡ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”æ‰€æœ‰æè¿°æ€§çš„å€¼ã€‚";
            const userPrompt = `å«ŒçŠ¯ ${gameState.suspect.name} (å€‹æ€§: ${gameState.suspect.personality})ã€‚\nç›®å‰å¿ƒç‡: ${gameState.suspect.heartRate} bpmï¼Œè¡€å£“: ${gameState.suspect.bloodPressure} mmHgã€‚\né ‘æŠ—åº¦æè¿°ç‚ºã€Œ${getConfessionMeterTextAndColor(gameState.confessionMeter).text}ã€(å…§éƒ¨æ•¸å€¼: ${gameState.confessionMeter}%)ã€‚\nä»–å‰›å‰›èªªäº† (æˆ–è¢«å•äº†): "${lastAIMessage || 'åµè¨Šå‰›é–‹å§‹'}"ã€‚\nè«‹ç”Ÿæˆä¸€å€‹åˆæ³•çš„JSONå°è±¡ï¼ŒåŒ…å«ä»¥ä¸‹å››å€‹éµå€¼å°ï¼Œæ¯å€‹å€¼éƒ½æ˜¯ä¸€æ®µç°¡çŸ­çš„æè¿° (æ¯é …ç´„5-10å­—):\n"facialExpression": (ä¾‹å¦‚ï¼š"å˜´è§’å¾®å¾®æŠ½å‹•", "çœ¼ç¥æœ‰äº›é£„å¿½ä¸å®š", "é¢ç„¡è¡¨æƒ…ä½†çœ‰é ­å¾®è¹™")\n"bodyLanguage": (ä¾‹å¦‚ï¼š"é›™æ‰‹ç·Šæ¡æ”¾åœ¨æ¡Œä¸Š", "åç«‹ä¸å®‰ï¼Œèº«é«”ç¨å¾®å¾Œä»°", "èº«é«”å¾®å¾®å‰å‚¾ï¼Œä¼¼ä¹æƒ³è§£é‡‹")\n"microAction": (ä¾‹å¦‚ï¼š"æ‰‹æŒ‡ä¸è‡ªè¦ºåœ°è¼•æ•²æ¡Œé¢", "ä¸‹æ„è­˜æ’¥å¼„è¡£è§’", "çŸ­æš«åœ°èˆ”äº†èˆ”å˜´å”‡")\n"voiceTone": (ä¾‹å¦‚ï¼š"èªæ°£å¹³æ·¡ï¼Œè½ä¸å‡ºæƒ…ç·’", "è²éŸ³ç•¥é¡¯æ²™å•", "è©¦åœ–ä¿æŒå¼·ç¡¬ä½†ç•¥å¸¶é¡«æŠ–")ã€‚\nè«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”æ‰€æœ‰æè¿°æ€§çš„å€¼ã€‚`;
            const rawResponse = await callDeepSeekAPI(systemPrompt, userPrompt, true); 
            const jsonString = cleanAIJsonResponse(rawResponse);
            try {
                if (jsonString && !jsonString.startsWith("AI (DS) Error") && typeof jsonString !== 'object') {
                    const parsed = JSON.parse(jsonString);
                    if (typeof parsed === 'object' && parsed !== null && 'facialExpression' in parsed && 'bodyLanguage' in parsed && 'microAction' in parsed && 'voiceTone' in parsed) { return parsed; } 
                    else { console.warn("è§£æå¾Œçš„å¯è§€å¯Ÿç‹€æ…‹ JSON æœªé”é æœŸæ ¼å¼:", parsed); }
                } else if (jsonString && typeof jsonString === 'object' && jsonString.error) { console.error("DS API ç‚ºå¯è§€å¯Ÿç‹€æ…‹è¿”å›éŒ¯èª¤:", jsonString.error); }
            } catch (e) { console.error("è§£æå¯è§€å¯Ÿç‹€æ…‹ JSON å¤±æ•—:", e, "æ¸…ç†å¾Œ:", jsonString, "åŸå§‹:", rawResponse); }
            console.warn("ä½¿ç”¨é è¨­å¯è§€å¯Ÿç‹€æ…‹ã€‚");
            return { facialExpression: "é®å®šè‡ªè‹¥", bodyLanguage: "å§¿æ…‹æ”¾é¬†", microAction: "ç„¡æ˜é¡¯", voiceTone: "èªæ°£å¹³ç©©"};
        }

        async function updateSuspectStatus(lastAIMessage = "") { 
            let hrChange = Math.floor(Math.random() * 10) - 5; 
            let bpSysChange = Math.floor(Math.random() * 10) - 5;
            let bpDiaChange = Math.floor(Math.random() * 6) - 3;
            if (gameState.confessionMeter < 50) { 
                hrChange += Math.floor(Math.random() * (gameState.confessionMeter < 25 ? 10 : 5)) + (gameState.confessionMeter < 25 ? 3 : 2); 
                bpSysChange += Math.floor(Math.random() * (gameState.confessionMeter < 25 ? 10 : 5)) + (gameState.confessionMeter < 25 ? 3 : 2);
            } else { 
                 hrChange -= Math.floor(Math.random() * 3); 
                 bpSysChange -= Math.floor(Math.random() * 3);
            }
            gameState.suspect.heartRate = Math.max(60, Math.min(140, gameState.suspect.heartRate + hrChange)); 
            let [sys, dia] = gameState.suspect.bloodPressure.split('/').map(Number);
            sys = Math.max(90, Math.min(190, sys + bpSysChange));
            dia = Math.max(60, Math.min(120, dia + bpDiaChange));
            gameState.suspect.bloodPressure = `${sys}/${dia}`;
            const newObservables = await generateSuspectObservableState(lastAIMessage);
            gameState.suspect.facialExpression = newObservables.facialExpression || gameState.suspect.facialExpression; 
            gameState.suspect.bodyLanguage = newObservables.bodyLanguage || gameState.suspect.bodyLanguage;
            gameState.suspect.microAction = newObservables.microAction || gameState.suspect.microAction;
            gameState.suspect.voiceTone = newObservables.voiceTone || gameState.suspect.voiceTone;
        }

        function updateUI(state) { 
            if (!state) return;

            if(roundCountHeaderEl) roundCountHeaderEl.textContent = state.round; 
            
            const meterInfo = getConfessionMeterTextAndColor(state.confessionMeter);
            if(confessionMeterTextCardEl) {
                confessionMeterTextCardEl.textContent = meterInfo.text;
                confessionMeterTextCardEl.classList.remove('confession-color-white', 'confession-color-green', 'confession-color-blue', 'confession-color-pink', 'confession-color-red', 'confession-color-purple');
                confessionMeterTextCardEl.classList.add(meterInfo.colorClass);
            }
            
            if (state.suspect) {
                if(suspectStatusNameEl) suspectStatusNameEl.textContent = state.suspect.name; 
                if(heartRateEl) heartRateEl.textContent = state.suspect.heartRate;
                if(bloodPressureEl) bloodPressureEl.textContent = state.suspect.bloodPressure;
                if(facialExpressionEl) facialExpressionEl.textContent = state.suspect.facialExpression; 
                if(bodyLanguageEl) bodyLanguageEl.textContent = state.suspect.bodyLanguage;
                if(voiceToneEl) voiceToneEl.textContent = state.suspect.voiceTone;
                
                if(suspectNameModalEl) suspectNameModalEl.textContent = state.suspect.name;
                if(ageModalEl) ageModalEl.textContent = state.suspect.age || "N/A";
                if(genderModalEl) genderModalEl.textContent = state.suspect.gender || "N/A";
                if(dobModalEl) dobModalEl.textContent = state.suspect.dob || "N/A";
                if(zodiacModalEl) zodiacModalEl.textContent = state.suspect.zodiac || "N/A";
                if(bloodTypeModalEl) bloodTypeModalEl.textContent = state.suspect.bloodType || "N/A";
                if(educationModalEl) educationModalEl.textContent = state.suspect.education || "N/A";
                if(birthplaceModalEl) birthplaceModalEl.textContent = state.suspect.birthplace || "N/A";
                if(occupationModalEl) occupationModalEl.textContent = state.suspect.occupation || "N/A";
                if(healthStatusModalEl) healthStatusModalEl.textContent = state.suspect.healthStatus || "N/A";
                if(personalityModalEl) personalityModalEl.textContent = state.suspect.personality || "è®€å–ä¸­...";
            }
            if (state.caseDetails) { 
                if(autopsyReportModalContentEl) autopsyReportModalContentEl.innerHTML = state.caseDetails.autopsyReport.replace(/##(.*?)##/g, '<span class="case-keyword" data-keyword="$1">$1</span>').replace(/\n/g, "<br>");
                if(evidenceListModalContentEl) evidenceListModalContentEl.innerHTML = state.caseDetails.evidence.map(e => `<li data-id="${e.id}">${e.text.replace(/##(.*?)##/g, '<span class="case-keyword" data-keyword="$1">$1</span>')}</li>`).join('');
                if(doubtsListModalContentEl) doubtsListModalContentEl.innerHTML = state.caseDetails.doubts.map(d => `<li data-id="${d.id}">${d.text.replace(/##(.*?)##/g, '<span class="case-keyword" data-keyword="$1">$1</span>')}</li>`).join('');
            }
            if(dialogueAreaEl) dialogueAreaEl.innerHTML = ''; 
            if (state.dialogueHistory) {
                state.dialogueHistory.forEach(msg => addMessageToDialogue(msg.speaker, msg.text, msg.tone)); 
            }
            document.querySelectorAll('.case-keyword').forEach(el => {
                el.onclick = () => {
                    const keyword = el.dataset.keyword;
                    if(keywordModalTitle) keywordModalTitle.textContent = `ğŸ”‘ é—œæ–¼ã€Œ${keyword}ã€`;
                    getKeywordInfo(keyword); 
                    if(keywordModal) keywordModal.classList.remove('hidden');
                };
            });
            if (state.gameOver) {
                if(gameOverTitle) gameOverTitle.textContent = state.confessionMeter <= 0 ? "âš–ï¸ å¯©å•æˆåŠŸï¼" : "âš–ï¸ å¯©å•å¤±æ•—ï¼";
                if(totalRoundsEl) totalRoundsEl.textContent = state.round; 
                
                if(gameAnalysisContainerEl && typeof state.gameAnalysis === 'object' && state.gameAnalysis.interrogationStyle) { 
                    gameAnalysisContainerEl.innerHTML = `
                        <p class="analysis-section-title">1. åµè¨Šå“¡å¯©å•é¢¨æ ¼åˆ†æ:</p>
                        <p class="analysis-section-content">${state.gameAnalysis.interrogationStyle}</p>
                        <p class="analysis-section-title">2. èˆ‡å«ŒçŠ¯é¬¥æ™ºéç¨‹æŠ€å·§åˆ†æ:</p>
                        <p class="analysis-section-content">${state.gameAnalysis.techniqueAnalysis}</p>
                        <p class="analysis-section-title">3. åˆ†æç©å®¶åœ¨ç¾å¯¦ä¸–ç•Œæ½›åœ¨äººæ ¼ç‰¹è³ª:</p>
                        <p class="analysis-section-content">${state.gameAnalysis.playerPersonalityTrait}</p>
                    `;
                    if(achievementBannerEl && achievementTitleEl && state.gameAnalysis.achievementTitle){
                        achievementTitleEl.textContent = state.gameAnalysis.achievementTitle;
                        achievementBannerEl.classList.remove('hidden');
                    } else if (achievementBannerEl) {
                        achievementBannerEl.classList.add('hidden');
                    }
                } else if (gameAnalysisTextEl) { 
                    gameAnalysisTextEl.textContent = typeof state.gameAnalysis === 'string' ? state.gameAnalysis : "åˆ†æç”Ÿæˆå¤±æ•—æˆ–æ ¼å¼ä¸ç¬¦ã€‚";
                     if(achievementBannerEl) achievementBannerEl.classList.add('hidden');
                }

                if(gameOverModal) gameOverModal.classList.remove('hidden');
            } else {
                if(gameOverModal) gameOverModal.classList.add('hidden');
            }
        }

        function addMessageToDialogue(speaker, text, tone = null) { 
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('dialogue-bubble');
            let messageContent = text;
            if (speaker === 'Player') {
                messageDiv.classList.add('player-bubble');
                messageContent = `(èªæ°£ï¼š${tone || 'æœªçŸ¥'}) ${text}`; 
                switch (tone) {
                    case 'å¹³ç·©': messageDiv.classList.add('player-bubble-calm'); break;
                    case 'æ†¤æ€’': messageDiv.classList.add('player-bubble-angry'); break;
                    case 'æŒ‘é‡': messageDiv.classList.add('player-bubble-provocative'); break;
                }
            } else if (speaker === 'è­¦å®˜') { 
                messageDiv.classList.add('officer-bubble'); 
                messageContent = `<strong>è­¦å®˜ï¼š</strong> ${text}`;
            } else { 
                messageDiv.classList.add('ai-bubble');
            }
            const processedText = messageContent.replace(/@@(.*?)@@/g, '<span class="keyword" data-keyword="$1">$1</span>');
            messageDiv.innerHTML = processedText;
            if(dialogueAreaEl) {
                dialogueAreaEl.appendChild(messageDiv);
                dialogueAreaEl.scrollTop = dialogueAreaEl.scrollHeight; 
            }
            messageDiv.querySelectorAll('.keyword').forEach(el => {
                el.onclick = () => {
                    const keyword = el.dataset.keyword;
                    if(keywordModalTitle) keywordModalTitle.textContent = `ğŸ”‘ é—œæ–¼ã€Œ${keyword}ã€`;
                    getKeywordInfo(keyword); 
                    if(keywordModal) keywordModal.classList.remove('hidden');
                };
            });
        }

        async function handlePlayerTurn() { 
            const playerMessage = playerInputEl.value.trim();
            if (!playerMessage) return;
            if (playerMessage === "88888888") { 
                gameState.confessionMeter = 0; 
                await handleConfession(); 
                return;
            }
            sendButton.disabled = true;
            demandConfessionButton.disabled = true;
            sendButton.innerHTML = '<div class="loading-spinner !w-5 !h-5 border-t-white"></div>';
            
            const currentTone = gameState.selectedTone; 
            gameState.round++;
            addMessageToDialogue('Player', playerMessage, currentTone);
            gameState.dialogueHistory.push({ speaker: 'Player', text: playerMessage, tone: currentTone });
            playerInputEl.value = '';

            const aiResponses = await getAIResponse(playerMessage);
            aiResponses.forEach(response => {
                addMessageToDialogue('AI', response);
                gameState.dialogueHistory.push({ speaker: 'AI', text: response });
            });

            let decrease = 5 + Math.floor(Math.random() * 10); 
            if (currentTone === "æŒ‘é‡" && Math.random() < 0.4) decrease += 5; 
            if (currentTone === "æ†¤æ€’" && Math.random() < 0.2) decrease -= 3; 
            if (playerMessage.length > 30 && Math.random() < 0.3) decrease +=3; 
            gameState.confessionMeter = Math.max(0, gameState.confessionMeter - decrease);

            if (gameState.confessionMeter <= 0 && !gameState.gameOver) { 
                await handleConfession();
            } else {
                await updateSuspectStatus(aiResponses.join(" ")); 
                await generateInterrogationTip(); 
                updateUI(gameState); 
                await saveGameState();
            }
            sendButton.disabled = false;
            demandConfessionButton.disabled = false;
            sendButton.innerHTML = 'ç™¼é€';
        }

        async function handleDemandConfessionClick() {
            sendButton.disabled = true;
            demandConfessionButton.disabled = true;
            demandConfessionButton.innerHTML = '<div class="loading-spinner !w-4 !h-4 border-t-white mx-auto"></div>';

            gameState.round++;
            const demandMessage = "æˆ‘è¦æ±‚ä½ ç¾åœ¨å°±èªç½ªï¼";
            addMessageToDialogue('Player', demandMessage, "æ†¤æ€’"); 
            gameState.dialogueHistory.push({ speaker: 'Player', text: demandMessage, tone: "æ†¤æ€’" });

            const aiDecision = await getAIResponse("", true); 

            if (aiDecision && aiDecision.confess === true) {
                 gameState.confessionMeter = 0; 
                await handleConfession();
            } else {
                let defiantResponses = [aiDecision && aiDecision.defiantResponse ? aiDecision.defiantResponse : "ä½ ä¼‘æƒ³å¥—æˆ‘è©±ï¼"];
                
                defiantResponses.forEach(response => {
                    addMessageToDialogue('AI', response);
                    gameState.dialogueHistory.push({ speaker: 'AI', text: response });
                });
                await updateSuspectStatus(defiantResponses.join(" "));
                await generateInterrogationTip();
                updateUI(gameState);
                await saveGameState();
            }
            sendButton.disabled = false;
            demandConfessionButton.disabled = false;
            demandConfessionButton.textContent = 'è¦æ±‚èªç½ª';
        }

        async function handleConfession() {
            gameState.gameOver = true;
            const confessionMsg = `${gameState.suspect.name}: ...å¥½å§ï¼Œæˆ‘æ‰¿èª...æ˜¯æˆ‘åšçš„ã€‚`;
            addMessageToDialogue('AI', confessionMsg);
            gameState.dialogueHistory.push({ speaker: 'AI', text: confessionMsg });
            await generateGameAnalysis(); 
            updateUI(gameState); 
            await saveGameState();
        }


        function restartGame() { 
            loadOrCreateNewGame(); 
            if(gameOverModal) gameOverModal.classList.add('hidden'); 
        }

        if(closeIntroModalButton) { 
            closeIntroModalButton.addEventListener('click', () => {
                if(introModal) introModal.classList.add('hidden');
                if (backgroundMusicEl && backgroundMusicEl.paused) {
                    backgroundMusicEl.play().catch(e => console.error("Error playing music:", e));
                }
            });
        }
        if(sendButton) sendButton.addEventListener('click', handlePlayerTurn);
        if(demandConfessionButton) demandConfessionButton.addEventListener('click', handleDemandConfessionClick);
        if(closeGameOverModalButton) { 
            closeGameOverModalButton.addEventListener('click', () => {
                if(gameOverModal) gameOverModal.classList.add('hidden');
            });
        }

        if(playerInputEl) playerInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handlePlayerTurn(); }
        });
        toneButtons.forEach(button => {
            button.addEventListener('click', () => {
                toneButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                gameState.selectedTone = button.dataset.tone;
            });
        });
        if(showPersonalDetailsButton) showPersonalDetailsButton.addEventListener('click', () => personalDetailsModal.classList.remove('hidden'));
        if(showStorySummaryButton) showStorySummaryButton.addEventListener('click', () => storySummaryModal.classList.remove('hidden'));
        if(restartGameButton) restartGameButton.addEventListener('click', restartGame);

        window.addEventListener('load', () => {
            initializeGame();
            if (backgroundMusicEl) {
                backgroundMusicEl.play().catch(e => {
                    console.log("Background music autoplay was blocked. Will attempt after user interaction.", e);
                });
            }
        });
        
    </script>
</body>
</html>
