<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯©å•æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Tailwind CSS å·²ç¶“åŒ…å« */
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #1a202c; 
            color: #e2e8f0; 
            overscroll-behavior-y: contain; 
        }
        .card {
            background-color: #2d3748; 
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .dialogue-area {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #4a5568; 
            padding: 10px;
            border-radius: 8px;
            background-color: #1f2937; 
            min-height: 200px; 
        }
        .dialogue-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 8px;
            max-width: 85%;
            word-wrap: break-word; 
            color: white; 
        }
        .player-bubble { background-color: #4299e1; margin-left: auto; text-align: right; }
        .player-bubble-calm { background-color: #38a169; }
        .player-bubble-angry { background-color: #e53e3e; }
        .player-bubble-provocative { background-color: #d69e2e; }
        .officer-bubble { background-color: #38a169; color: white; margin-left: auto; text-align: right; }
        .ai-bubble { background-color: #4a5568; color: #e2e8f0; margin-right: auto; }

        .keyword, .case-keyword { 
            text-decoration: underline; 
            color: #63b3ed; 
            cursor: pointer; 
            font-weight: 500; 
        }
        .keyword:hover, .case-keyword:hover {
            color: #90cdf4; 
        }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); 
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; padding: 16px;
        }
        .modal-content {
            background-color: #2d3748; padding: 20px; border-radius: 8px;
            width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;
            text-align: left; color: #e2e8f0;
        }
        .modal-content.modal-lg { max-width: 600px; }
        .modal-content h3 { text-align: center; margin-bottom: 16px; }
        .story-summary-text { font-size: 0.9rem; line-height: 1.6;} /* èª¿æ•´äº†æ¡ˆä»¶æ¦‚è¦æ–‡å­—å¤§å°å’Œè¡Œé«˜ */
        .story-summary-divider { border-top: 1px solid #4a5568; margin: 12px 0; }
        .personality-block { background-color: #374151; padding: 10px; border-radius: 6px; margin-top: 10px; border: 1px solid #4a5568; }
        #personality-modal { font-style: normal; }
        
        /* NEW_STYLE: æ¬Šç›Šå®£å‘Š Modal å…§å®¹æ¨£å¼ */
        #rights-declaration-modal-content ul { list-style-type: decimal; margin-left: 20px; margin-top: 10px; }
        #rights-declaration-modal-content li { margin-bottom: 8px; line-height: 1.5; }
        #rights-declaration-modal-content p { margin-bottom: 10px; }


        /* å…¶ä»–æ¨£å¼ä¿æŒä¸è®Š */
        .interrogation-loader{display:flex;flex-direction:column;align-items:center;justify-content:center;width:300px;margin:0 auto;padding:28px 20px 22px 20px;background:#1a2332;border-radius:18px;box-shadow:0 8px 24px #000a,0 2px 8px #14223b33;border:2px solid #356cc9}.badge{display:flex;align-items:center;gap:10px;font-family:'Inter','Noto Sans TC',Arial,sans-serif;font-weight:700;color:#f3f8ff;font-size:1.5rem;margin-bottom:16px;letter-spacing:2px}.badge-icon{font-size:2.3rem;filter:drop-shadow(0 1px 4px #262f51aa);margin-right:4px}.badge-text{letter-spacing:3px;text-shadow:0 2px 8px #356cc9aa}.loading-bar{width:90%;height:14px;border-radius:8px;background:#28344d;overflow:hidden;box-shadow:0 0 0 2px #3e5d96 inset,0 2px 6px #0005;margin-bottom:12px}.loading-fill{height:100%;width:0%;background:linear-gradient(90deg,#3ec6e0,#5e89ee 60%,#ffe57f 100%);border-radius:8px;animation:loadBarAnim 2.2s cubic-bezier(.65,.05,.36,1) infinite}.interrogation-text{color:#8cb5f1;margin-top:6px;font-size:1.1rem;letter-spacing:1.5px;font-family:'Noto Sans TC','Inter',Arial,sans-serif;text-shadow:0 1px 4px #1a2332cc;animation:textAnim 1.6s linear infinite alternate;min-height:1.5em;transition:opacity .5s}@keyframes loadBarAnim{0%{width:0%;opacity:.7}40%{width:87%;opacity:1}95%{width:99%;opacity:1}100%{width:0%;opacity:.7}}@keyframes textAnim{from{opacity:.6;letter-spacing:1px}to{opacity:1;letter-spacing:3px}}.tone-button{color:#e2e8f0;border:1px solid #718096;flex-grow:1;padding:8px 0;transition:background-color .2s,border-color .2s}.tone-button-calm{background-color:#2c5282}.tone-button-calm.active{background-color:#3182ce;border-color:#3182ce;color:#fff}.tone-button-angry{background-color:#9b2c2c}.tone-button-angry.active{background-color:#e53e3e;border-color:#e53e3e;color:#fff}.tone-button-provocative{background-color:#975a16}.tone-button-provocative.active{background-color:#d69e2e;border-color:#d69e2e;color:#fff}.loading-spinner{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;margin:0 auto}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.game-main-area{display:flex;flex-direction:column;height:calc(100vh - 16px);padding:8px}.interrogation-tip{font-size:.75rem;color:#a0aec0;text-align:center;margin-top:4px;padding:4px;background-color:#2a303c;border-radius:4px;min-height:2.5em;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}#suspect-status-details>div{display:flex;flex-direction:column;justify-content:space-around}#suspect-status-card{padding:8px;max-height:6rem;overflow:hidden}#suspect-status-details p{font-size:.68rem;line-height:1.2;margin-bottom:.1rem}@media (min-width:640px){#suspect-status-details p{font-size:.75rem}}.analysis-section-title{font-weight:700;color:#90cdf4;margin-top:10px;margin-bottom:4px}.analysis-section-content{margin-left:10px;white-space:pre-wrap}#initial-loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(26,32,44,.95);z-index:2000;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#e2e8f0}#initial-loading-message{font-size:1.1rem;margin-top:1rem;text-align:center;padding:0 10px}#error-message-area{color:#f56565;background-color:#4a2424;padding:8px 12px;border-radius:4px;margin-top:8px;text-align:center;font-size:.8rem;display:none;border:1px solid #c53030}.achievement-banner{margin-top:16px;padding:8px;background-color:#374151;border-radius:6px;font-size:1.1rem;color:#f6e05e}.confession-color-white{color:#e2e8f0}.confession-color-green{color:#68d391}.confession-color-blue{color:#63b3ed}.confession-color-pink{color:#f687b3}.confession-color-red{color:#fc8181}.confession-color-purple{color:#b794f4}.folder-loader{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:38px 0 22px 0}.folder-stack{position:relative;width:66px;height:56px}.folder{position:absolute;left:0;top:0;width:60px;height:38px;border-radius:5px 8px 6px 6px;background:#f1c672;box-shadow:0 6px 24px #886b3022,0 2px 5px #674f2133;border:2.2px solid #b99e61;z-index:1}.folder1{top:18px;left:8px;background:#d3b16a;z-index:1;transform:rotate(-7deg);box-shadow:0 2px 12px #a28d5e22}.folder2{top:9px;left:4px;background:#ebcc89;z-index:2;transform:rotate(3deg);box-shadow:0 2px 14px #e9c98433}.folder3{top:0;left:0;background:#f6d184;z-index:3;animation:folderShake 1.45s cubic-bezier(.66,-.11,.48,1.31) infinite alternate;box-shadow:0 8px 22px #e6ba6255,0 2px 8px #baa45333}@keyframes folderShake{0%{transform:rotate(-4deg) translateY(0)}15%{transform:rotate(1.2deg) translateY(-2px)}35%{transform:rotate(-1deg) translateY(1px)}65%{transform:rotate(1deg) translateY(-2.2px)}100%{transform:rotate(-2deg) translateY(0)}}.folder-pages{display:flex;align-items:center;justify-content:center;margin:14px 0 4px 0;gap:7px}.page-dot{width:16px;height:8px;background:#e8d199;border-radius:6px;opacity:.35;transition:all .2s;box-shadow:0 2px 6px #9e9e8455;border:1.2px solid #b6a26a}.page-dot.active{background:#f1c672;opacity:1;box-shadow:0 0 0 2px #ffe7ad55,0 4px 8px #e2b64944;border-color:#a2813b}.folder-text{margin-top:16px;color:#e6c175;font-size:1.13rem;font-family:'Noto Sans TC','Inter',Arial,sans-serif;letter-spacing:2px;text-shadow:0 2px 8px #9b782322;animation:fadeText 1.7s linear infinite alternate;min-height:1.8em}@keyframes fadeText{from{opacity:.6;letter-spacing:1px}to{opacity:1;letter-spacing:4px}}

    </style>
</head>
<body class="overscroll-y-contain">
    <audio id="background-music" src="./PensivePiano.mp3" loop></audio>

    <div id="initial-loading-overlay">
      <div class="interrogation-loader">
        <div class="badge">
          <span class="badge-icon">ğŸ•µï¸â€â™‚ï¸</span>
          <span class="badge-text">POLICE</span>
        </div>
        <div class="loading-bar">
          <div id="loading-fill-bar" class="loading-fill"></div>
        </div>
        <div class="interrogation-text" id="loading-animation-text">è­¦æ–¹æ­£åœ¨å¸ƒç½®åµè¨Šå®¤â€¦</div>
        <p class="text-sm text-gray-400 mt-1" id="initial-loading-message">éŠæˆ²åˆå§‹åŒ–ä¸­...</p>
      </div>
    </div>

    <div class="game-main-area container mx-auto" style="display: none;">
        <header class="mb-2 flex justify-between items-center">
            <span class="text-xs sm:text-sm text-gray-400 font-normal">
                å›åˆ: <span id="round-count-header">0</span>
            </span>
            <h1 class="text-xl sm:text-2xl font-bold text-blue-400 text-center flex-grow">
                å¯©å•æŒ‘æˆ°
            </h1>
            <span class="text-xs sm:text-sm text-gray-400 font-normal" title="Firebase ç”¨æˆ¶è­˜åˆ¥ç¢¼ (éƒ¨åˆ†é¡¯ç¤º)">
                 UID: <span id="user-id-display">è¼‰å…¥ä¸­...</span>
            </span>
        </header>

        <div class="flex gap-2 mb-2">
            <div id="avatar" class="w-20 h-20 sm:w-24 sm:h-24 rounded-md flex-shrink-0 flex flex-col items-center justify-center text-gray-300 text-xs p-0.5 text-center bg-gray-700 shadow">
                <img id="suspect-avatar-img" src="test00.jpg" alt="å«ŒçŠ¯é ­åƒ" class="w-full h-3/4 object-cover rounded-t-sm" onerror="this.onerror=null; this.src='https://placehold.co/80x60/718096/E2E8F0?text=é ­åƒè¼‰å…¥å¤±æ•—';">
                <div id="suspect-name-display" class="w-full bg-black bg-opacity-70 text-white text-xs py-1 text-center truncate rounded-b-sm h-1/4 flex items-center justify-center">
                    <span id="suspect-status-name">è®€å–ä¸­...</span>
                </div>
            </div>
            <div id="suspect-status-card" class="flex-grow flex flex-col card">
                 <div id="suspect-status-details" class="grid grid-cols-2 gap-x-2 h-full">
                    <div class="flex flex-col justify-between">
                        <p>ğŸ—£ï¸<strong>é ‘æŠ—:</strong> <span id="confession-meter-text-card" class="confession-color-white">å¼·ç¡¬</span></p>
                        <p>ğŸ“ˆ<strong>å¿ƒç‡:</strong> <span id="heart-rate">--</span> bpm</p>
                        <p>ğŸ§<strong>è‚¢é«”:</strong> <span id="body-language" class="italic">è®€å–ä¸­...</span></p>
                    </div>
                    <div class="flex flex-col justify-between">
                        <p>ğŸ˜ <strong>è¡¨æƒ…:</strong> <span id="facial-expression" class="italic">è®€å–ä¸­...</span></p>
                        <p>ğŸ©¸<strong>è¡€å£“:</strong> <span id="blood-pressure">--/--</span></p>
                        <p>ğŸ—£ï¸<strong>èªæ°£:</strong> <span id="voice-tone" class="italic">è®€å–ä¸­...</span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-2">
            <button id="show-personal-details-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-md text-sm sm:text-base">ğŸ‘¤ å€‹äººè³‡æ–™</button>
            <button id="show-story-summary-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-3 rounded-md text-sm sm:text-base">ğŸ“œ æ¡ˆä»¶æ¦‚è¦</button>
        </div>

        <div id="dialogue-area" class="dialogue-area mb-2"></div>

        <div id="interrogation-tip-area" class="interrogation-tip">â€»è²¼å¿ƒæç¤ºï¼š åµè¨Šæç¤ºè¼‰å…¥ä¸­...</div>
        <div id="error-message-area"></div>
        <div class="mt-auto pt-2">
            <textarea id="player-input" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base" rows="2" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..."></textarea>
            <div class="mt-2 flex gap-1 sm:gap-2">
                <button class="tone-button tone-button-calm active rounded-md text-xs sm:text-sm" data-tone="å¹³ç·©">ğŸ˜Œ å¹³ç·©</button>
                <button class="tone-button tone-button-angry rounded-md ml-1 text-xs sm:text-sm" data-tone="æ†¤æ€’">ğŸ˜¡ æ†¤æ€’</button>
                <button class="tone-button tone-button-provocative rounded-md ml-1 text-xs sm:text-sm" data-tone="æŒ‘é‡">ğŸ˜ æŒ‘é‡</button>
            </div>
            <div class="mt-2 flex gap-2">
                <button id="send-button" class="flex-grow bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 text-sm sm:text-base">
                    ç™¼é€
                </button>
                <button id="demand-confession-button" class="w-1/4 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-md transition duration-150 text-xs sm:text-sm">
                    è¦æ±‚èªç½ª
                </button>
            </div>
        </div>
    </div>

    <div id="intro-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-300">ğŸ‰ æ­¡è¿ä¾†åˆ°å¯©å•æŒ‘æˆ° ğŸ‰</h3>
            <ul class="list-decimal list-inside mt-4 mb-6 space-y-2 text-sm text-gray-200">
                <li>æœ¬éŠæˆ²æ¯æ¬¡é–‹å±€éƒ½æ˜¯<strong class="text-yellow-300">å…¨æ–°åŠ‡æœ¬</strong>ï¼ŒæŒ‘æˆ°ç„¡é™ï¼</li>
                <li>é–‹å±€å¾Œè«‹å…ˆæŸ¥çœ‹<strong class="text-indigo-300">ã€æ¡ˆä»¶æ¦‚è¦ã€‘</strong>äº†è§£åµè¨Šé‡é»ã€‚</li>
                <li>åµè¨Šæ™‚å¯ä»¥ç”¨<strong class="text-green-300">ä¸‰ç¨®æ…‹åº¦</strong>èˆ‡å«ŒçŠ¯æ‡‰å°ã€‚</li>
                <li>æœ¬éŠæˆ²ä¸æ–·<strong class="text-pink-300">å„ªåŒ–ä¸­</strong>ï¼Œæ­¡è¿çµ¦äºˆå»ºè­°ï¼</li>
                <li>å¯©å•æˆåŠŸè®“å«ŒçŠ¯èªç½ªï¼Œæ­¡è¿<strong class="text-teal-300">åˆ†äº«æˆªåœ–</strong>ï¼</li>
            </ul>
            <button id="close-intro-modal-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">é–‹å§‹åµè¨Š</button>
        </div>
    </div>

    <div id="personal-details-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-300">ğŸ‘¤ å«ŒçŠ¯å€‹äººè³‡æ–™</h3>
            <div id="modal-personal-details-content" class="text-sm grid grid-cols-2 gap-x-4">
                <div>
                    <p><strong>å§“å:</strong> <span id="suspect-name-modal">è®€å–ä¸­...</span></p>
                    <p><strong>å¹´ç´€:</strong> <span id="age-modal">è®€å–ä¸­...</span></p>
                    <p><strong>æ€§åˆ¥:</strong> <span id="gender-modal">è®€å–ä¸­...</span></p>
                    <p><strong>ç”Ÿæ—¥:</strong> <span id="dob-modal">è®€å–ä¸­...</span></p>
                    <p><strong>æ˜Ÿåº§:</strong> <span id="zodiac-modal">è®€å–ä¸­...</span></p>
                    <p><strong>è¡€å‹:</strong> <span id="blood-type-modal">è®€å–ä¸­...</span></p>
                </div>
                <div>
                    <p><strong>å­¸æ­·:</strong> <span id="education-modal">è®€å–ä¸­...</span></p>
                    <p><strong>å‡ºç”Ÿåœ°:</strong> <span id="birthplace-modal">è®€å–ä¸­...</span></p>
                    <p><strong>è·æ¥­:</strong> <span id="occupation-modal">è®€å–ä¸­...</span></p>
                    <p><strong>å¥åº·ç‹€æ…‹:</strong> <span id="health-status-modal">è®€å–ä¸­...</span></p>
                    <p><strong>å£é ­ç¦ª:</strong> <span id="mannerism-modal">è®€å–ä¸­...</span></p>
                </div>
                <div class="personality-block mt-3 col-span-2">
                    <p class="font-semibold mb-1">ğŸ­ å€‹æ€§æ¦‚è¿°:</p>
                    <p id="personality-modal" class="text-sm">è®€å–ä¸­...</p>
                </div>
            </div>
            <button onclick="document.getElementById('personal-details-modal').classList.add('hidden')" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
        </div>
    </div>

    <div id="story-summary-modal" class="modal hidden">
        <div class="modal-content modal-lg">
            <h3 class="text-xl font-bold text-blue-300">ğŸ“œ æ¡ˆä»¶æ¦‚è¦</h3>
            <div id="modal-story-summary-content" class="story-summary-text">
                <div>
                    <p class="font-semibold">è¢«å®³äººé©—å±å ±å‘Š:</p>
                    <span id="autopsy-report-modal-content">è®€å–ä¸­...</span>
                </div>
                <hr class="story-summary-divider">
                <div>
                    <p class="font-semibold mt-2">å°å«ŒçŠ¯ä¸åˆ©çš„ç›®å‰è­‰æ“š:</p>
                    <ul id="evidence-list-modal-content" class="list-disc list-inside ml-4"><li>è®€å–ä¸­...</li></ul>
                </div>
                <hr class="story-summary-divider">
                <div>
                    <p class="font-semibold mt-2">å«ŒçŠ¯èª¿æŸ¥ç–‘é»:</p>
                    <ul id="doubts-list-modal-content" class="list-disc list-inside ml-4"><li>è®€å–ä¸­...</li></ul>
                </div>
            </div>
            <button onclick="document.getElementById('story-summary-modal').classList.add('hidden')" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
        </div>
    </div>

    <div id="keyword-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="keyword-modal-title" class="text-xl font-bold text-blue-300 mb-0">ğŸ”‘ é—œéµå­—è£œå……</h3>
            <div id="keyword-folder-loader" class="folder-loader hidden">
                <div class="folder-stack">
                  <div class="folder folder1"></div> <div class="folder folder2"></div> <div class="folder folder3"></div>
                </div>
                <div class="folder-pages" id="keyword-folder-pages-bar"></div>
                <div class="folder-text" id="keyword-folder-page-text">æ­£åœ¨å‘ˆä¸Šä¸­â€¦</div>
            </div>
            <p id="keyword-modal-text" class="mt-2">å…§å®¹AIåŠ è¼‰ä¸­è«‹ç¨å¾Œ...</p>
            <button onclick="document.getElementById('keyword-modal').classList.add('hidden')" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
        </div>
    </div>

    <div id="rights-declaration-modal" class="modal hidden">
        <div class="modal-content modal-lg"> <h3 class="text-xl font-bold text-blue-300">ğŸ“œ æ¬Šç›Šå®£å‘Šæ›¸</h3>
            <div id="rights-declaration-modal-content" class="story-summary-text mt-4">
                <p>è®€å–ä¸­...</p>
            </div>
            <button onclick="document.getElementById('rights-declaration-modal').classList.add('hidden')" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
        </div>
    </div>
    <div id="game-over-modal" class="modal hidden">
        <div class="modal-content text-center">
            <h3 id="game-over-title" class="text-2xl font-bold mb-4">âš–ï¸ å¯©å•çµæŸ</h3>
            <p>ç¸½å…±è€—è²»å›åˆæ•¸: <span id="total-rounds">0</span></p>
            <div id="game-analysis-container" class="mt-4 text-left">
                 <p id="game-analysis-text" class="text-sm whitespace-pre-wrap">åˆ†æä¸­...</p>
            </div>
            <div id="achievement-banner" class="achievement-banner hidden">
                ğŸ… <span id="achievement-title"></span>
            </div>
            <div class="mt-6 flex justify-center gap-4">
                 <button id="restart-game-button" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md">ğŸ”„ é‡æ–°é–‹å§‹</button>
                 <button id="close-game-over-modal-button" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="ai-thinking-modal" class="modal hidden">
        <div class="modal-content text-center">
            <div class="flex flex-col items-center justify-center min-h-[100px]">
                <p class="text-lg" id="ai-thinking-message">ğŸ¤– AIæ­£åœ¨åŠªåŠ›æ€è€ƒä¸­...</p>
                <p class="text-sm text-gray-400 mt-1">(å› å…§å®¹è±å¯ŒåŠ è¼‰å¾ˆä¹…å±¬æ­£å¸¸)</p>
                <p class="text-xs text-gray-500 mt-1">(å‰µä½œè€…é‚„åœ¨åŠªåŠ›å„ªåŒ–ä¸­)</p>
            </div>
            <div class="loading-spinner my-4"></div>
        </div>
    </div>

<script type="module">
    // Firebase SDK å°å…¥
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // DOM å…ƒç´ ç²å–
    const heartRateEl = document.getElementById('heart-rate');
    const bloodPressureEl = document.getElementById('blood-pressure');
    const facialExpressionEl = document.getElementById('facial-expression');
    const bodyLanguageEl = document.getElementById('body-language');
    const voiceToneEl = document.getElementById('voice-tone');
    const suspectStatusNameEl = document.getElementById('suspect-status-name');
    const suspectNameModalEl = document.getElementById('suspect-name-modal');
    const dobModalEl = document.getElementById('dob-modal');
    const zodiacModalEl = document.getElementById('zodiac-modal');
    const bloodTypeModalEl = document.getElementById('blood-type-modal');
    const ageModalEl = document.getElementById('age-modal');
    const genderModalEl = document.getElementById('gender-modal');
    const educationModalEl = document.getElementById('education-modal');
    const birthplaceModalEl = document.getElementById('birthplace-modal');
    const occupationModalEl = document.getElementById('occupation-modal');
    const healthStatusModalEl = document.getElementById('health-status-modal');
    const mannerismModalEl = document.getElementById('mannerism-modal');
    const personalityModalEl = document.getElementById('personality-modal');
    const autopsyReportModalContentEl = document.getElementById('autopsy-report-modal-content');
    const evidenceListModalContentEl = document.getElementById('evidence-list-modal-content');
    const doubtsListModalContentEl = document.getElementById('doubts-list-modal-content');
    const showPersonalDetailsButton = document.getElementById('show-personal-details-button');
    const showStorySummaryButton = document.getElementById('show-story-summary-button');
    const personalDetailsModal = document.getElementById('personal-details-modal');
    const storySummaryModal = document.getElementById('story-summary-modal');
    const dialogueAreaEl = document.getElementById('dialogue-area');
    const playerInputEl = document.getElementById('player-input');
    const sendButton = document.getElementById('send-button');
    const demandConfessionButton = document.getElementById('demand-confession-button');
    const toneButtons = document.querySelectorAll('.tone-button');
    const userIdDisplayEl = document.getElementById('user-id-display');
    const keywordModal = document.getElementById('keyword-modal');
    const keywordModalTitle = document.getElementById('keyword-modal-title');
    const keywordModalText = document.getElementById('keyword-modal-text');
    const keywordFolderLoaderEl = document.getElementById('keyword-folder-loader');
    const keywordFolderPagesBarEl = document.getElementById('keyword-folder-pages-bar');
    const keywordFolderPageTextEl = document.getElementById('keyword-folder-page-text');
    let keywordPageTimer = null;
    const gameOverModal = document.getElementById('game-over-modal');
    const gameOverTitle = document.getElementById('game-over-title');
    const totalRoundsEl = document.getElementById('total-rounds');
    const gameAnalysisContainerEl = document.getElementById('game-analysis-container');
    const gameAnalysisTextEl = document.getElementById('game-analysis-text');
    const achievementBannerEl = document.getElementById('achievement-banner');
    const achievementTitleEl = document.getElementById('achievement-title');
    const restartGameButton = document.getElementById('restart-game-button');
    const closeGameOverModalButton = document.getElementById('close-game-over-modal-button');
    const aiThinkingModal = document.getElementById('ai-thinking-modal');
    const aiThinkingMessageEl = document.getElementById('ai-thinking-message');
    const interrogationTipAreaEl = document.getElementById('interrogation-tip-area');
    const roundCountHeaderEl = document.getElementById('round-count-header');
    const confessionMeterTextCardEl = document.getElementById('confession-meter-text-card');
    const introModal = document.getElementById('intro-modal');
    const closeIntroModalButton = document.getElementById('close-intro-modal-button');
    const initialLoadingOverlay = document.getElementById('initial-loading-overlay');
    const initialLoadingMessageEl = document.getElementById('initial-loading-message');
    const loadingAnimationTextEl = document.getElementById('loading-animation-text');
    const gameMainAreaEl = document.querySelector('.game-main-area');
    const backgroundMusicEl = document.getElementById('background-music');
    const errorMessageAreaEl = document.getElementById('error-message-area');
    
    // NEW_ELEMENT_GETTER: ç²å–æ¬Šç›Šå®£å‘Š Modal çš„å…ƒç´ 
    const rightsDeclarationModal = document.getElementById('rights-declaration-modal');
    const rightsDeclarationModalContentEl = document.getElementById('rights-declaration-modal-content');


    // --- é…ç½®å€åŸŸ ---
    const BACKEND_URL = 'https://d1d5ef45-d04b-4a1c-be4b-64a0680c6847-00-xxpggv06ka2e.sisko.replit.dev/';
    const firebaseConfig = typeof __firebase_config !== 'undefined'
        ? JSON.parse(__firebase_config) 
        : { 
            apiKey: "AIzaSyCACjjC1S-9gj6hKCyfAedzH9kTf_JZwDE",
            authDomain: "aigame-fb578.firebaseapp.com",
            projectId: "aigame-fb578",
            storageBucket: "aigame-fb578.appspot.com", 
            messagingSenderId: "932095431807",
            appId: "1:932095431807:web:28aab493c770166102db4a"
          };
    
    // NEW_CONTENT: æ¬Šç›Šå®£å‘Šçš„è©³ç´°å…§å®¹ (ä¾†è‡ªæ‚¨çš„åœ–ç‰‡)
    const rightsDeclarationText = `
        <p>ä¾æ“šã€Šåˆ‘äº‹è¨´è¨Ÿæ³•ã€‹ç¬¬95æ¢ï¼Œä½ äº«æœ‰ä»¥ä¸‹æ¬Šåˆ©ï¼š</p>
        <ul>
            <li>ä¸€ã€ä½ æœ‰æ¬Šä¿æŒç·˜é»˜ï¼Œç„¡é ˆé•èƒŒè‡ªå·±ä¹‹æ„æ€é™³è¿°ã€‚</li>
            <li>äºŒã€ä½ æœ‰æ¬Šé¸ä»»è¾¯è­·äººï¼Œè‹¥éœ€å¾‹å¸«å”åŠ©ï¼Œå¯ç«‹å³æå‡ºã€‚</li>
            <li>ä¸‰ã€ä½ æ‰€èªªçš„ä¸€åˆ‡ï¼ŒåŒ…æ‹¬ç¾åœ¨èˆ‡å¾€å¾Œçš„é™³è¿°ï¼Œå‡å¯èƒ½ä½œç‚ºæœ¬æ¡ˆè­‰æ“šã€‚</li>
        </ul>
        <p class="mt-2">è«‹ç¢ºèªä½ æ˜¯å¦æ¸…æ¥šä¸Šè¿°æ¬Šåˆ©ï¼Ÿè‹¥éœ€é€²ä¸€æ­¥èªªæ˜ï¼Œå¯ç«‹å³æå‡ºã€‚</p>
    `;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    let userId = null;
    let currentGameId = null;
    let gameState = {};
    let initialLoadingTipInterval = null;
    let isMusicPlaying = false;

    function showThinkingModal(message = 'AIæ­£åœ¨åŠªåŠ›æ€è€ƒä¸­...') {
        if (aiThinkingModal && aiThinkingMessageEl) {
            aiThinkingMessageEl.textContent = `ğŸ¤– ${message}`;
            aiThinkingModal.classList.remove('hidden');
        }
    }

    function hideThinkingModal() {
        if (aiThinkingModal) aiThinkingModal.classList.add('hidden');
    }

    function getConfessionMeterTextAndColor(percentage) {
        if (percentage > 80) return { text: "æ…‹åº¦å¼·ç¡¬", colorClass: "confession-color-white" };
        if (percentage > 60) return { text: "æ•…ä½œé®å®š", colorClass: "confession-color-green" };
        if (percentage > 40) return { text: "ç•¥é¡¯å‹•æ–", colorClass: "confession-color-blue" };
        if (percentage > 20) return { text: "å¿ƒè™›æ…Œäº‚", colorClass: "confession-color-pink" };
        if (percentage > 0) return { text: "ç€•è‡¨å´©æ½°", colorClass: "confession-color-red" };
        return { text: "å·²ç„¶èªç½ª", colorClass: "confession-color-purple" };
    }

    function showErrorMessage(message) {
        if (errorMessageAreaEl) {
            errorMessageAreaEl.textContent = `âš ï¸ éŒ¯èª¤ï¼š${message}`;
            errorMessageAreaEl.style.display = 'block';
        }
        console.error("éŒ¯èª¤è¨Šæ¯é¡¯ç¤º:", message);
    }

    function clearErrorMessage() {
        if (errorMessageAreaEl) {
            errorMessageAreaEl.textContent = '';
            errorMessageAreaEl.style.display = 'none';
        }
    }

    function playBackgroundMusic() {
        if (backgroundMusicEl && backgroundMusicEl.paused && !isMusicPlaying) {
            backgroundMusicEl.loop = true;
            backgroundMusicEl.play()
                .then(() => {
                    isMusicPlaying = true;
                    console.log("èƒŒæ™¯éŸ³æ¨‚é–‹å§‹æ’­æ”¾ã€‚");
                })
                .catch(error => {
                    console.warn("èƒŒæ™¯éŸ³æ¨‚è‡ªå‹•æ’­æ”¾å¤±æ•—ã€‚", error);
                });
        }
    }

    async function initializeFirebaseAndUser() {
        return new Promise(async (resolve, reject) => {
            try {
                await setPersistence(auth, browserLocalPersistence);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("å˜—è©¦ä½¿ç”¨è‡ªè¨‚ä»¤ç‰Œç™»å…¥ (Canvas ç’°å¢ƒ)ã€‚");
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    console.log("ç„¡è‡ªè¨‚ä»¤ç‰Œï¼Œå˜—è©¦åŒ¿åç™»å…¥ã€‚");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase èªè­‰éŒ¯èª¤:", error);
                if (!auth.currentUser) { 
                    try {
                        console.warn("ç”±æ–¼å…ˆå‰çš„èªè­‰éŒ¯èª¤ï¼Œå›é€€åˆ°åŒ¿åç™»å…¥ã€‚");
                        await signInAnonymously(auth);
                    } catch (anonError) {
                        console.error("åš´é‡éŒ¯èª¤ï¼šåŒ¿åç™»å…¥ä¹Ÿå¤±æ•—:", anonError);
                        if (userIdDisplayEl) userIdDisplayEl.textContent = "èªè­‰å¤±æ•—";
                        showErrorMessage("Firebase èªè­‰å¤±æ•—ï¼Œéƒ¨åˆ†ç”¨æˆ¶ç›¸é—œåŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨ã€‚");
                        userId = `local_user_${crypto.randomUUID().substring(0,8)}`;
                        if (userIdDisplayEl) userIdDisplayEl.textContent = "æœ¬æ©Ÿç”¨æˆ¶";
                        console.warn("ä½¿ç”¨æœ¬åœ°ç”Ÿæˆçš„ç”¨æˆ¶ IDã€‚");
                        return resolve(userId); 
                    }
                }
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    if (userIdDisplayEl) userIdDisplayEl.textContent = userId.substring(0, 8) + "...";
                    console.log("ä½¿ç”¨è€…å·²èªè­‰ã€‚UID:", userId);
                } else {
                    if (!userId) { 
                        userId = `local_user_${crypto.randomUUID().substring(0,8)}`;
                        if (userIdDisplayEl) userIdDisplayEl.textContent = "æœ¬æ©Ÿç”¨æˆ¶";
                        console.warn("ç„¡å·²èªè­‰ä½¿ç”¨è€…ï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆçš„ç”¨æˆ¶ IDã€‚");
                    }
                }
                resolve(userId); 
            });
        });
    }

    async function loadOrCreateNewGame() {
        clearErrorMessage();
        if (initialLoadingOverlay) initialLoadingOverlay.style.display = 'flex';
        if (gameMainAreaEl) gameMainAreaEl.style.display = 'none';
        if (initialLoadingMessageEl) initialLoadingMessageEl.textContent = "é€£æ¥ä¼ºæœå™¨ä¸¦å‰µå»ºæ–°éŠæˆ²...";
        startInitialLoadingAnimation();

        try {
            if (BACKEND_URL === 'YOUR_REPLIT_BACKEND_URL' || !BACKEND_URL.startsWith('https://')) {
                throw new Error("å¾Œç«¯ API ç¶²å€ (BACKEND_URL) å°šæœªæ­£ç¢ºè¨­å®šã€‚");
            }

            const userAuthId = await initializeFirebaseAndUser();
            if (!userAuthId) { 
                throw new Error("ç„¡æ³•ç²å–ç”¨æˆ¶è­˜åˆ¥ç¢¼ï¼Œç„¡æ³•å‰µå»ºéŠæˆ²ã€‚");
            }

            if (initialLoadingMessageEl) initialLoadingMessageEl.textContent = "æ­£åœ¨å‘ä¼ºæœå™¨è«‹æ±‚æ–°éŠæˆ²...";

            const response = await fetch(`${BACKEND_URL}game/new`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userAuthId })
            });

            if (initialLoadingMessageEl) initialLoadingMessageEl.textContent = "æ­£åœ¨è™•ç†ä¼ºæœå™¨å›æ‡‰...";

            if (!response.ok) {
                let errorText = `ä¼ºæœå™¨éŒ¯èª¤: ${response.status} ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    errorText = errorData.error || errorText;
                } catch (e) { /* è§£æ JSON å¤±æ•—ï¼Œä½¿ç”¨åŸå§‹éŒ¯èª¤æ–‡å­— */ }
                throw new Error(errorText);
            }
            gameState = await response.json();
            currentGameId = gameState.gameId;

            if (initialLoadingMessageEl) initialLoadingMessageEl.textContent = "éŠæˆ²è³‡æ–™è¼‰å…¥å®Œæˆï¼æº–å‚™é–‹å§‹...";
            updateUI(gameState); 

            if (initialLoadingOverlay) initialLoadingOverlay.style.display = 'none';
            stopInitialLoadingAnimation();
            if (gameMainAreaEl) gameMainAreaEl.style.display = 'flex';
            if (introModal) introModal.classList.remove('hidden');
            playBackgroundMusic(); 

        } catch (error) {
            console.error("å‰µå»ºæ–°éŠæˆ²å¤±æ•—:", error);
            const friendlyErrorMessage = `å‰µå»ºæ–°éŠæˆ²å¤±æ•—ï¼š${error.message} è«‹æª¢æŸ¥å¾Œç«¯ä¼ºæœå™¨ (${BACKEND_URL}) æ˜¯å¦æ­£åœ¨é‹è¡Œï¼Œä¸¦ä¸”ç¶²è·¯é€£ç·šæ­£å¸¸ã€‚`;
            if (initialLoadingMessageEl) initialLoadingMessageEl.textContent = friendlyErrorMessage;
            showErrorMessage(friendlyErrorMessage);
            stopInitialLoadingAnimation();
        }
    }
    
    // MODIFIED_FUNCTION: processTextToKeywordLinks
    function processTextToKeywordLinks(text, defaultKeywordClass = "keyword") {
        if (typeof text !== 'string') return text;
        // è™•ç† ##é—œéµå­—## æˆ– @@é—œéµå­—@@
        return text.replace(/(##|@@)(.*?)\1/g, (match, p1, keywordText) => {
            let keywordClass = defaultKeywordClass;
            let dataType = "keyword"; // é è¨­ç‚ºä¸€èˆ¬é—œéµå­—

            if (keywordText === "æ¬Šç›Šå®£å‘Šæ›¸" && p1 === "##") {
                keywordClass = "case-keyword rights-declaration-link"; // å¯ä»¥çµ¦äºˆç‰¹å®š class
                dataType = "rights-declaration"; // è¨­ç½®ç‰¹å®š data-type
            } else if (p1 === "##") {
                 keywordClass = "case-keyword"; // æ¡ˆä»¶æ¦‚è¦ä¸­çš„ä¸€èˆ¬é—œéµå­—
            } else if (p1 === "@@") {
                 keywordClass = "keyword"; // å°è©±ä¸­çš„ä¸€èˆ¬é—œéµå­—
            }
            // ç¢ºä¿ data-keyword å±¬æ€§è¢«æ­£ç¢ºè³¦å€¼
            return `<span class="${keywordClass}" data-keyword="${keywordText}" data-type="${dataType}">${keywordText}</span>`;
        }).replace(/\n/g, "<br>");
    }


    function updateUI(state) {
        if (!state) {
            console.warn("updateUI è¢«èª¿ç”¨æ™‚ state ç‚ºç©ºã€‚");
            return;
        }
        gameState = state; 

        const suspectAvatarImg = document.getElementById('suspect-avatar-img');
        if (suspectAvatarImg) {
            suspectAvatarImg.src = 'test00.jpg';
        }

        if (roundCountHeaderEl) roundCountHeaderEl.textContent = state.round ?? '0';

        const meterInfo = getConfessionMeterTextAndColor(state.confessionMeter ?? 100);
        if (confessionMeterTextCardEl) {
            confessionMeterTextCardEl.textContent = meterInfo.text;
            confessionMeterTextCardEl.className = 'confession-color-white'; 
            confessionMeterTextCardEl.classList.add(meterInfo.colorClass);
        }

        if (state.suspect) {
            const suspect = state.suspect;
            if(suspectStatusNameEl) suspectStatusNameEl.textContent = suspect.name ?? "è®€å–ä¸­...";
            if(heartRateEl) heartRateEl.textContent = suspect.heartRate ?? "--";
            if(bloodPressureEl) bloodPressureEl.textContent = suspect.bloodPressure ?? "--/--";
            if(facialExpressionEl) facialExpressionEl.textContent = suspect.facialExpression ?? "è®€å–ä¸­...";
            if(bodyLanguageEl) bodyLanguageEl.textContent = suspect.bodyLanguage ?? "è®€å–ä¸­...";
            if(voiceToneEl) voiceToneEl.textContent = suspect.voiceTone ?? "è®€å–ä¸­...";

            if(suspectNameModalEl) suspectNameModalEl.textContent = suspect.name ?? "N/A";
            if(ageModalEl) ageModalEl.textContent = suspect.age ?? "N/A";
            if(genderModalEl) genderModalEl.textContent = suspect.gender ?? "N/A";
            if(dobModalEl) dobModalEl.textContent = suspect.dob ?? "N/A";
            if(zodiacModalEl) zodiacModalEl.textContent = suspect.zodiac ?? "N/A";
            if(bloodTypeModalEl) bloodTypeModalEl.textContent = suspect.bloodType ?? "N/A";
            if(educationModalEl) educationModalEl.textContent = suspect.education ?? "N/A";
            if(birthplaceModalEl) birthplaceModalEl.textContent = suspect.birthplace ?? "N/A";
            if(occupationModalEl) occupationModalEl.textContent = suspect.occupation ?? "N/A";
            if(healthStatusModalEl) healthStatusModalEl.textContent = suspect.healthStatus ?? "N/A";
            if(mannerismModalEl) mannerismModalEl.textContent = suspect.mannerism ?? "ç„¡";
            if(personalityModalEl) personalityModalEl.textContent = suspect.personality ?? "è®€å–ä¸­...";
        }

        if (state.caseDetails) {
            const caseDetails = state.caseDetails;
            if(autopsyReportModalContentEl) {
                autopsyReportModalContentEl.innerHTML = processTextToKeywordLinks(caseDetails.autopsyReport, "case-keyword");
            }
            if(evidenceListModalContentEl) {
                evidenceListModalContentEl.innerHTML = (caseDetails.evidence ?? [])
                    .map(e => `<li data-id="${e.id || ''}">${processTextToKeywordLinks(e.text, "case-keyword")}</li>`)
                    .join('');
            }
            if(doubtsListModalContentEl) {
                doubtsListModalContentEl.innerHTML = (caseDetails.doubts ?? [])
                    .map(d => `<li data-id="${d.id || ''}">${processTextToKeywordLinks(d.text, "case-keyword")}</li>`)
                    .join('');
            }
        }

        if (dialogueAreaEl) dialogueAreaEl.innerHTML = ''; 
        if (state.dialogueHistory && Array.isArray(state.dialogueHistory)) {
            state.dialogueHistory.forEach(msg => addMessageToDialogue(msg.speaker, msg.text, msg.tone));
        }

        if (interrogationTipAreaEl && state.interrogationTip) {
            interrogationTipAreaEl.textContent = "â€»è²¼å¿ƒæç¤ºï¼š " + state.interrogationTip;
        }
        
        bindKeywordClickEvents(); 

        if (state.gameOver) {
            if(gameOverTitle) gameOverTitle.textContent = (state.confessionMeter != null && state.confessionMeter <= 0) ? "âš–ï¸ å¯©å•æˆåŠŸï¼" : "âš–ï¸ å¯©å•å¤±æ•—ï¼";
            if(totalRoundsEl) totalRoundsEl.textContent = state.round ?? '0';

            if(gameAnalysisContainerEl && typeof state.gameAnalysis === 'object' && state.gameAnalysis.interrogationStyle) {
                gameAnalysisContainerEl.innerHTML = `
                    <p class="analysis-section-title">1. åµè¨Šå“¡å¯©å•é¢¨æ ¼åˆ†æ:</p>
                    <p class="analysis-section-content">${state.gameAnalysis.interrogationStyle}</p>
                    <p class="analysis-section-title">2. èˆ‡å«ŒçŠ¯é¬¥æ™ºéç¨‹æŠ€å·§åˆ†æ:</p>
                    <p class="analysis-section-content">${state.gameAnalysis.techniqueAnalysis}</p>
                    <p class="analysis-section-title">3. åˆ†æç©å®¶åœ¨ç¾å¯¦ä¸–ç•Œæ½›åœ¨äººæ ¼ç‰¹è³ª:</p>
                    <p class="analysis-section-content">${state.gameAnalysis.playerPersonalityTrait}</p>
                `;
                if(achievementBannerEl && achievementTitleEl && state.gameAnalysis.achievementTitle){
                    achievementTitleEl.textContent = state.gameAnalysis.achievementTitle;
                    achievementBannerEl.classList.remove('hidden');
                } else if (achievementBannerEl) {
                    achievementBannerEl.classList.add('hidden');
                }
            } else if (gameAnalysisContainerEl) { 
                gameAnalysisContainerEl.innerHTML = `<p class="analysis-section-content">${typeof state.gameAnalysis === 'string' ? state.gameAnalysis : "åˆ†æç”Ÿæˆå¤±æ•—æˆ–æ ¼å¼ä¸ç¬¦ã€‚"}</p>`;
                 if(achievementBannerEl) achievementBannerEl.classList.add('hidden');
            }
            if(gameOverModal) gameOverModal.classList.remove('hidden');
        } else {
            if(gameOverModal) gameOverModal.classList.add('hidden');
        }
    } 

    // MODIFIED_FUNCTION: bindKeywordClickEvents
    function bindKeywordClickEvents() {
        document.querySelectorAll('.keyword, .case-keyword').forEach(el => {
            el.onclick = () => {
                const keyword = el.dataset.keyword;
                const type = el.dataset.type; // ç²å– data-type å±¬æ€§

                if (type === "rights-declaration") {
                    // è™•ç†æ¬Šç›Šå®£å‘Šæ›¸çš„é»æ“Š
                    if (rightsDeclarationModalContentEl && rightsDeclarationModal) {
                        rightsDeclarationModalContentEl.innerHTML = rightsDeclarationText;
                        rightsDeclarationModal.classList.remove('hidden');
                    } else {
                        console.error("æ¬Šç›Šå®£å‘Š Modal æˆ–å…¶å…§å®¹å…ƒç´ æœªæ‰¾åˆ°ã€‚");
                    }
                } else {
                    // è™•ç†ä¸€èˆ¬é—œéµå­—çš„é»æ“Š
                    if (keywordModalTitle) keywordModalTitle.textContent = `ğŸ”‘ é—œæ–¼ã€Œ${keyword}ã€`;
                    fetchKeywordInfo(keyword); 
                    if (keywordModal) keywordModal.classList.remove('hidden'); 
                }
            };
        });
    }

    function addMessageToDialogue(speaker, text, tone = null) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('dialogue-bubble');
        let messageContent = text ?? ""; 

        if (speaker === 'Player') {
            messageDiv.classList.add('player-bubble');
            const displayTone = tone || gameState.selectedTone || "æœªçŸ¥";
            messageContent = `(èªæ°£ï¼š${displayTone}) ${messageContent}`;
            switch (displayTone) {
                case 'å¹³ç·©': messageDiv.classList.add('player-bubble-calm'); break;
                case 'æ†¤æ€’': messageDiv.classList.add('player-bubble-angry'); break;
                case 'æŒ‘é‡': messageDiv.classList.add('player-bubble-provocative'); break;
            }
        } else if (speaker === 'è­¦å®˜') {
            messageDiv.classList.add('officer-bubble');
            messageContent = `<strong>è­¦å®˜ï¼š</strong> ${messageContent}`;
        } else { 
            messageDiv.classList.add('ai-bubble');
        }

        // å°è©±ä¸­ä½¿ç”¨ "keyword" class ä½œç‚ºé è¨­ï¼ŒprocessTextToKeywordLinks å…§éƒ¨æœƒè™•ç†ç‰¹æ®Šæƒ…æ³
        messageDiv.innerHTML = processTextToKeywordLinks(messageContent, "keyword"); 

        if (dialogueAreaEl) {
            dialogueAreaEl.appendChild(messageDiv);
            dialogueAreaEl.scrollTop = dialogueAreaEl.scrollHeight; 
        }
        
        bindKeywordClickEvents(); 
    }

    async function fetchKeywordInfo(keyword) {
        if (!currentGameId) {
            console.error("éŠæˆ² ID æœªè¨­å®šï¼Œç„¡æ³•ç²å–é—œéµå­—è³‡è¨Šã€‚");
            if(keywordModalText) keywordModalText.textContent = "éŒ¯èª¤ï¼šéŠæˆ²æœªåˆå§‹åŒ–ã€‚";
            return;
        }
        clearErrorMessage();

        if(keywordModalText) keywordModalText.style.display = 'none'; 
        if(keywordFolderLoaderEl) keywordFolderLoaderEl.classList.remove('hidden'); 

        const totalPages = 4; 
        let currentPage = 0;
        if(keywordFolderPagesBarEl) keywordFolderPagesBarEl.innerHTML = ''; 
        function renderKeywordPagesBar() {
            let html = '';
            for (let i = 0; i < totalPages; i++) {
                html += `<div class="page-dot${i === currentPage ? ' active' : ''}"></div>`;
            }
            if(keywordFolderPagesBarEl) keywordFolderPagesBarEl.innerHTML = html;
        }
        function updateKeywordPage() {
            currentPage = (currentPage + 1) % totalPages;
            renderKeywordPagesBar();
            if(keywordFolderPageTextEl) keywordFolderPageTextEl.textContent = `ç¬¬ ${currentPage + 1} / ${totalPages} é ï¼Œæ­£åœ¨å‘ˆä¸Šä¸­â€¦`;
        }
        renderKeywordPagesBar(); 
        if(keywordFolderPageTextEl) keywordFolderPageTextEl.textContent = `ç¬¬ 1 / ${totalPages} é ï¼Œæ­£åœ¨å‘ˆä¸Šä¸­â€¦`;

        if (keywordPageTimer) clearInterval(keywordPageTimer); 
        keywordPageTimer = setInterval(updateKeywordPage, 700); 

        try {
            const response = await fetch(`${BACKEND_URL}game/${currentGameId}/keyword?keyword=${encodeURIComponent(keyword)}`);
            if (!response.ok) {
                let errorText = `ä¼ºæœå™¨éŒ¯èª¤: ${response.status} ${response.statusText}`;
                try { const errorData = await response.json(); errorText = errorData.error || errorText; } catch (e) { /* ignore */ }
                throw new Error(errorText);
            }
            const data = await response.json();
            console.log(`[DEBUG] fetchKeywordInfo - Received data for "${keyword}":`, data); // ä¿ç•™èª¿è©¦æ—¥èªŒ

            if (keywordModalText) {
                let cleanText = data.information;
                if (typeof cleanText === 'string') {
                    // æ­¥é©Ÿ 1: ç§»é™¤ ##é—œéµå­—## æ¨™è¨˜ï¼Œåªä¿ç•™é—œéµå­—æœ¬èº«
                    cleanText = cleanText.replace(/##(.*?)##/g, '$1');
                    // æ­¥é©Ÿ 2: ç§»é™¤ @@é—œéµå­—@@ æ¨™è¨˜ï¼Œåªä¿ç•™é—œéµå­—æœ¬èº«
                    cleanText = cleanText.replace(/@@(.*?)@@/g, '$1');
                    // æ­¥é©Ÿ 3: è™•ç†æ›è¡Œç¬¦
                    cleanText = cleanText.replace(/\n/g, "<br>");
                } else {
                    cleanText = "ç„¡æ³•è¼‰å…¥æœ‰æ•ˆçš„è£œå……è³‡è¨Šã€‚"; // æˆ–å…¶ä»–é©ç•¶çš„é è¨­æ–‡å­—
                }
                keywordModalText.innerHTML = cleanText;
            }
        } catch (error) {
            console.error(`ç²å–é—œéµå­— "${keyword}" è³‡è¨Šå¤±æ•—:`, error);
            const friendlyErrorMessage = `ç„¡æ³•è¼‰å…¥é—œæ–¼ã€Œ${keyword}ã€çš„è³‡è¨Šï¼š${error.message}`;
            if (keywordModalText) keywordModalText.textContent = friendlyErrorMessage;
            showErrorMessage(friendlyErrorMessage); 
        } finally {
            if (keywordPageTimer) clearInterval(keywordPageTimer); 
            if(keywordFolderLoaderEl) keywordFolderLoaderEl.classList.add('hidden'); 
            if(keywordModalText) keywordModalText.style.display = 'block'; 
        }
    }

    async function handlePlayerTurn(isDemandConfession = false) {
        if (!currentGameId) {
            console.error("éŠæˆ² ID æœªè¨­å®šï¼Œç„¡æ³•åŸ·è¡Œç©å®¶å‹•ä½œã€‚");
            showErrorMessage("éŒ¯èª¤ï¼šéŠæˆ²æœªæ­£ç¢ºåˆå§‹åŒ–ï¼Œè«‹é‡æ–°è¼‰å…¥ã€‚");
            return;
        }
        clearErrorMessage(); 

    async function handlePlayerTurn(isDemandConfession = false) {
        if (!currentGameId) {
            console.error("éŠæˆ² ID æœªè¨­å®šï¼Œç„¡æ³•åŸ·è¡Œç©å®¶å‹•ä½œã€‚");
            showErrorMessage("éŒ¯èª¤ï¼šéŠæˆ²æœªæ­£ç¢ºåˆå§‹åŒ–ï¼Œè«‹é‡æ–°è¼‰å…¥ã€‚");
            return;
        }
        clearErrorMessage();

        const playerMessage = playerInputEl.value.trim();
        
        // CHEAT_CODE_HANDLING_START
        const cheatCodes = ["88888888", "88888889", "88888887"];
        if (!isDemandConfession && cheatCodes.includes(playerMessage)) {
            console.log(`åµæ¸¬åˆ°ä½œå¼ŠæŒ‡ä»¤: ${playerMessage}`);
            showThinkingModal(`æ­£åœ¨è™•ç†ä½œå¼ŠæŒ‡ä»¤ ${playerMessage}...`);
            sendButton.disabled = true;
            demandConfessionButton.disabled = true;

            try {
                const response = await fetch(`${BACKEND_URL}game/${currentGameId}/cheat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cheat_code: playerMessage })
                });

                if (!response.ok) {
                    let errorText = `ä½œå¼ŠæŒ‡ä»¤éŒ¯èª¤: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || errorText;
                    } catch (e) { /* ignore */ }
                    throw new Error(errorText);
                }
                const updatedGameState = await response.json();
                updateUI(updatedGameState);
                playerInputEl.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
            } catch (error) {
                console.error("ä½œå¼ŠæŒ‡ä»¤è™•ç†å¤±æ•—:", error);
                showErrorMessage(`ä½œå¼ŠæŒ‡ä»¤å¤±æ•—: ${error.message}`);
            } finally {
                hideThinkingModal();
                 if (!(gameState && gameState.gameOver)) {
                    sendButton.disabled = false;
                    demandConfessionButton.disabled = false;
                }
            }
            return; // ä½œå¼ŠæŒ‡ä»¤è™•ç†å®Œç•¢ï¼Œä¸å†åŸ·è¡Œå¾ŒçºŒæ­£å¸¸é‚è¼¯
        }
        // CHEAT_CODE_HANDLING_END

        // åŸæœ‰çš„ç©å®¶å›åˆé‚è¼¯ (å¦‚æœä¸æ˜¯ä½œå¼ŠæŒ‡ä»¤)
        if (!isDemandConfession && !playerMessage) return; 

        sendButton.disabled = true;
        demandConfessionButton.disabled = true;
        const originalSendButtonText = sendButton.innerHTML;
        const originalDemandButtonText = demandConfessionButton.textContent;

        if (isDemandConfession) {
            demandConfessionButton.innerHTML = '<div class="loading-spinner !w-4 !h-4 border-t-white mx-auto"></div>';
        } else {
            sendButton.innerHTML = '<div class="loading-spinner !w-5 !h-5 border-t-white"></div>'; 
        }
        showThinkingModal(isDemandConfession ? 'æ­£åœ¨è¦æ±‚å°æ–¹èªç½ª...' : 'AIæ­£åœ¨åˆ†ææ‚¨çš„è¼¸å…¥...');

        const currentTone = gameState.selectedTone || "å¹³ç·©"; 
        const payload = {
            message: isDemandConfession ? "" : playerMessage, 
            tone: isDemandConfession ? "æ†¤æ€’" : currentTone, 
            isDemandConfession: isDemandConfession
        };

        try {
            const response = await fetch(`${BACKEND_URL}game/${currentGameId}/action`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                let errorText = `ä¼ºæœå™¨éŒ¯èª¤: ${response.status} ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    errorText = errorData.error || errorText;
                    if (errorData.gameState && errorData.error === "éŠæˆ²å·²çµæŸ") {
                        console.warn("å˜—è©¦åœ¨å·²çµæŸçš„éŠæˆ²ä¸­åŸ·è¡Œå‹•ä½œã€‚");
                        updateUI(errorData.gameState); 
                        return; 
                    }
                } catch (e) { /* è§£æ JSON å¤±æ•—ï¼Œä½¿ç”¨åŸå§‹éŒ¯èª¤æ–‡å­— */ }
                throw new Error(errorText);
            }
            const updatedGameState = await response.json();
            updateUI(updatedGameState);
            if (!isDemandConfession) playerInputEl.value = ''; 
        } catch (error) {
            console.error("ç©å®¶å›åˆè™•ç†å¤±æ•—:", error);
            showErrorMessage(`æ“ä½œå¤±æ•—: ${error.message}`);
        } finally {
            hideThinkingModal();
            if (!(gameState && gameState.gameOver)) {
                sendButton.disabled = false;
                demandConfessionButton.disabled = false;
                sendButton.innerHTML = originalSendButtonText;
                demandConfessionButton.textContent = originalDemandButtonText;
            }
        }
    }

    function restartGame() {
        if(gameOverModal) gameOverModal.classList.add('hidden');
        loadOrCreateNewGame(); 
    }

    const initialLoadingTips = [
        "è­¦æ–¹æ­£åœ¨å¸ƒç½®åµè¨Šå®¤â€¦", "æª¢æŸ¥éŒ„éŸ³èˆ‡ç›£æ§è¨­å‚™ä¸­â€¦", "æ¡ˆä»¶è³‡æ–™èª¿é–±ä¸­ï¼Œè«‹ç¨å€™â€¦",
        "å°‡å«ŒçŠ¯å¸¶å¾€åµè¨Šå®¤â€¦", "æº–å‚™èª¿æŸ¥è­‰æ“šä¸­â€¦", "æª¢æŸ¥ç­†éŒ„èˆ‡ç›¸é—œå·å®—â€¦",
        "é–‹å•Ÿç¾å ´æ”å½±æ©Ÿèˆ‡éº¥å…‹é¢¨â€¦", "å®‰æ’è§€å¯Ÿäººå“¡é€²å…¥æš—æˆ¿â€¦", "æ¡ˆç™¼ç¾å ´è³‡æ–™åŒæ­¥ä¸­â€¦",
        "æª¢æŸ¥å«ŒçŠ¯å¿ƒç†ç‹€æ…‹â€¦", "å¯©æ ¸è­‰ä¾›æ¸…å–®èˆ‡ç­†éŒ„â€¦", "åµè¨Šå°ˆå®¶å³å°‡é€²å…¥ç¾å ´â€¦",
        "è­¦å®˜æ­£åœ¨ç©¿æˆ´é˜²è­·è£å‚™â€¦", "æº–å‚™å¯©å•ç­–ç•¥èˆ‡å°ç­–â€¦", "æ¡ˆä»¶è³‡æ–™åŠ å¯†å‚³è¼¸ä¸­â€¦"
    ];
    let lastTipIdx = 0;

    function startInitialLoadingAnimation() {
        if (!loadingAnimationTextEl) return;
        loadingAnimationTextEl.textContent = initialLoadingTips[0]; 
        if (initialLoadingTipInterval) clearInterval(initialLoadingTipInterval);
        initialLoadingTipInterval = setInterval(() => {
            let idx;
            do {
                idx = Math.floor(Math.random() * initialLoadingTips.length);
            } while (idx === lastTipIdx && initialLoadingTips.length > 1); 
            lastTipIdx = idx;
            loadingAnimationTextEl.style.opacity = 0;
            setTimeout(() => {
                loadingAnimationTextEl.textContent = initialLoadingTips[idx];
                loadingAnimationTextEl.style.opacity = 1;
            }, 400); 
        }, 3000); 
    }

    function stopInitialLoadingAnimation() {
        if (initialLoadingTipInterval) clearInterval(initialLoadingTipInterval);
        initialLoadingTipInterval = null;
    }


    // --- äº‹ä»¶ç›£è½å™¨ ---
    if (closeIntroModalButton) {
        closeIntroModalButton.addEventListener('click', () => {
            if (introModal) introModal.classList.add('hidden');
            playBackgroundMusic(); 
        });
    }
    if (sendButton) sendButton.addEventListener('click', () => handlePlayerTurn(false));
    if (demandConfessionButton) demandConfessionButton.addEventListener('click', () => handlePlayerTurn(true));
    if (closeGameOverModalButton) {
        closeGameOverModalButton.addEventListener('click', () => {
            if (gameOverModal) gameOverModal.classList.add('hidden');
        });
    }
    if (playerInputEl) {
        playerInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); 
                handlePlayerTurn(false);
            }
        });
    }
    toneButtons.forEach(button => {
        button.addEventListener('click', () => {
            toneButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            if (gameState) gameState.selectedTone = button.dataset.tone; 
        });
    });
    if (showPersonalDetailsButton) showPersonalDetailsButton.addEventListener('click', () => personalDetailsModal.classList.remove('hidden'));
    if (showStorySummaryButton) showStorySummaryButton.addEventListener('click', () => storySummaryModal.classList.remove('hidden'));
    if (restartGameButton) restartGameButton.addEventListener('click', restartGame);

    // --- é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ ---
    window.addEventListener('load', () => {
        loadOrCreateNewGame();
    });

</script>
</body>
</html>
