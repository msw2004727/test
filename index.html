<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯©å•æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Tailwind CSS å·²ç¶“åŒ…å«ï¼Œé€™è£¡ä¿ç•™æ‚¨åŸæœ‰çš„è‡ªè¨‚æ¨£å¼ */
        /* Loader å‹•ç•«æ¨£å¼ */
        .interrogation-loader {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          width: 300px;
          margin: 0 auto;
          padding: 28px 20px 22px 20px;
          background: #1a2332;
          border-radius: 18px;
          box-shadow: 0 8px 24px #000a, 0 2px 8px #14223b33;
          border: 2px solid #356cc9;
        }
        .badge {
          display: flex;
          align-items: center;
          gap: 10px;
          font-family: 'Inter', 'Noto Sans TC', Arial, sans-serif;
          font-weight: bold;
          color: #f3f8ff;
          font-size: 1.5rem;
          margin-bottom: 16px;
          letter-spacing: 2px;
        }
        .badge-icon {
          font-size: 2.3rem;
          filter: drop-shadow(0 1px 4px #262f51aa);
          margin-right: 4px;
        }
        .badge-text {
          letter-spacing: 3px;
          text-shadow: 0 2px 8px #356cc9aa;
        }
        .loading-bar {
          width: 90%;
          height: 14px;
          border-radius: 8px;
          background: #28344d;
          overflow: hidden;
          box-shadow: 0 0 0 2px #3e5d96 inset, 0 2px 6px #0005;
          margin-bottom: 12px;
        }
        .loading-fill {
          height: 100%;
          width: 0%;
          background: linear-gradient(90deg,#3ec6e0,#5e89ee 60%,#ffe57f 100%);
          border-radius: 8px;
          animation: loadBarAnim 2.2s cubic-bezier(.65,.05,.36,1) infinite;
        }
        @keyframes loadBarAnim {
          0% { width: 0%; opacity: .7; }
          40% { width: 87%; opacity: 1; }
          95% { width: 99%; opacity: 1; }
          100% { width: 0%; opacity: .7; }
        }
        .interrogation-text { /* ç”¨æ–¼è¼‰å…¥å‹•ç•«ä¸­çš„æ–‡å­— */
          color: #8cb5f1;
          margin-top: 6px;
          font-size: 1.1rem;
          letter-spacing: 1.5px;
          font-family: 'Noto Sans TC', 'Inter', Arial, sans-serif;
          text-shadow: 0 1px 4px #1a2332cc;
          animation: textAnim 1.6s linear infinite alternate;
          min-height: 1.5em;
          transition: opacity 0.5s;
        }
        @keyframes textAnim {
          from { opacity: 0.6; letter-spacing: 1px; }
          to   { opacity: 1; letter-spacing: 3px; }
        }

        /* åŸºæœ¬æ¨£å¼ */
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #1a202c; /* æ·±è—ç°è‰²èƒŒæ™¯ */
            color: #e2e8f0; /* æ·ºç°è‰²æ–‡å­— */
            overscroll-behavior-y: contain; /* é˜²æ­¢åœ¨è¡Œå‹•è£ç½®ä¸Šæ»‘å‹•æ™‚è§¸ç™¼é é¢åˆ·æ–° */
        }
        .card {
            background-color: #2d3748; /* å¡ç‰‡èƒŒæ™¯è‰² */
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .dialogue-area {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #4a5568; /* é‚Šæ¡†é¡è‰² */
            padding: 10px;
            border-radius: 8px;
            background-color: #1f2937; /* å°è©±å€åŸŸèƒŒæ™¯è‰² */
            min-height: 200px; /* æœ€å°é«˜åº¦ */
        }
        .dialogue-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 8px;
            max-width: 85%;
            word-wrap: break-word; /* è‡ªå‹•æ›è¡Œ */
            color: white; /* æ°£æ³¡æ–‡å­—é¡è‰² */
        }
        /* ç©å®¶ç™¼è¨€æ°£æ³¡ */
        .player-bubble { background-color: #4299e1; margin-left: auto; text-align: right; }
        .player-bubble-calm { background-color: #38a169; }
        .player-bubble-angry { background-color: #e53e3e; }
        .player-bubble-provocative { background-color: #d69e2e; }
        /* è­¦å®˜ç™¼è¨€æ°£æ³¡ */
        .officer-bubble { background-color: #38a169; color: white; margin-left: auto; text-align: right; }
        /* AI (å«ŒçŠ¯) ç™¼è¨€æ°£æ³¡ */
        .ai-bubble { background-color: #4a5568; color: #e2e8f0; margin-right: auto; }

        .keyword, .case-keyword { text-decoration: underline; color: #63b3ed; cursor: pointer; }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; padding: 16px;
        }
        .modal-content {
            background-color: #2d3748; padding: 20px; border-radius: 8px;
            width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;
            text-align: left; color: #e2e8f0;
        }
        .modal-content.modal-lg { max-width: 600px; }
        .modal-content h3 { text-align: center; margin-bottom: 16px; }
        .story-summary-text { font-size: 0.8rem; }
        .story-summary-divider { border-top: 1px solid #4a5568; margin: 12px 0; }
        .personality-block { background-color: #374151; padding: 10px; border-radius: 6px; margin-top: 10px; border: 1px solid #4a5568; }
        #personality-modal { font-style: normal; }

        /* èªæ°£æŒ‰éˆ•æ¨£å¼ */
        .tone-button {
            color: #e2e8f0; border: 1px solid #718096;
            flex-grow: 1; padding: 8px 0; transition: background-color 0.2s, border-color 0.2s;
        }
        .tone-button-calm { background-color: #2c5282; }
        .tone-button-calm.active { background-color: #3182ce; border-color: #3182ce; color:white; }
        .tone-button-angry { background-color: #9b2c2c; }
        .tone-button-angry.active { background-color: #e53e3e; border-color: #e53e3e; color:white; }
        .tone-button-provocative { background-color: #975a16; }
        .tone-button-provocative.active { background-color: #d69e2e; border-color: #d69e2e; color:white; }

        /* è¼‰å…¥ä¸­ Spinner */
        .loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 24px; height: 24px;
            animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* éŠæˆ²ä¸»å€åŸŸä½ˆå±€ */
        .game-main-area { display: flex; flex-direction: column; height: calc(100vh - 16px); padding: 8px; }
        .interrogation-tip {
            font-size: 0.75rem; color: #a0aec0; text-align: center;
            margin-top: 4px; padding: 4px; background-color: #2a303c;
            border-radius: 4px; min-height: 2.5em; line-height: 1.3;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        /* å«ŒçŠ¯ç‹€æ…‹å¡ç‰‡ç´°ç¯€ */
        #suspect-status-details > div { display: flex; flex-direction: column; justify-content: space-around; }
        #suspect-status-card { padding: 8px; max-height: 6rem; overflow: hidden; }
        #suspect-status-details p { font-size: 0.68rem; line-height: 1.2; margin-bottom: 0.1rem; }
        @media (min-width: 640px) { #suspect-status-details p { font-size: 0.75rem; } }

        /* éŠæˆ²çµæŸåˆ†æå€å¡Š */
        .analysis-section-title { font-weight: bold; color: #90cdf4; margin-top: 10px; margin-bottom: 4px; }
        .analysis-section-content { margin-left: 10px; white-space: pre-wrap; }

        /* åˆå§‹è¼‰å…¥è¦†è“‹å±¤ */
        #initial-loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(26, 32, 44, 0.95); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #e2e8f0;
        }
        #initial-loading-message { font-size: 1.1rem; margin-top: 1rem; text-align: center; padding: 0 10px;}
        #error-message-area {
            color: #f56565;
            background-color: #4A2424;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 8px;
            text-align: center;
            font-size: 0.8rem;
            display: none;
            border: 1px solid #c53030;
        }

        /* æˆå°±æ©«å¹… */
        .achievement-banner { margin-top: 16px; padding: 8px; background-color: #374151; border-radius: 6px; font-size: 1.1rem; color: #f6e05e; }

        /* é ‘æŠ—åº¦é¡è‰² */
        .confession-color-white { color: #E2E8F0; } .confession-color-green { color: #68D391; }
        .confession-color-blue { color: #63B3ED; }  .confession-color-pink { color: #F687B3; }
        .confession-color-red { color: #FC8181; }   .confession-color-purple { color: #B794F4; }

        /* è³‡æ–™å¤¾è¼‰å…¥å‹•ç•« */
        .folder-loader { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 38px 0 22px 0; }
        .folder-stack { position: relative; width: 66px; height: 56px; }
        .folder {
          position: absolute; left: 0; top: 0; width: 60px; height: 38px;
          border-radius: 5px 8px 6px 6px; background: #f1c672;
          box-shadow: 0 6px 24px #886b3022, 0 2px 5px #674f2133;
          border: 2.2px solid #b99e61; z-index: 1;
        }
        .folder1 { top: 18px; left: 8px; background: #d3b16a; z-index: 1; transform: rotate(-7deg); box-shadow: 0 2px 12px #a28d5e22; }
        .folder2 { top: 9px; left: 4px; background: #ebcc89; z-index: 2; transform: rotate(3deg); box-shadow: 0 2px 14px #e9c98433; }
        .folder3 { top: 0; left: 0; background: #f6d184; z-index: 3; animation: folderShake 1.45s cubic-bezier(.66,-0.11,.48,1.31) infinite alternate; box-shadow: 0 8px 22px #e6ba6255, 0 2px 8px #baa45333; }
        @keyframes folderShake { 0%   { transform: rotate(-4deg) translateY(0px);} 15%  { transform: rotate(1.2deg) translateY(-2px);} 35%  { transform: rotate(-1deg) translateY(1px);} 65%  { transform: rotate(1deg) translateY(-2.2px);} 100% { transform: rotate(-2deg) translateY(0px);} }
        .folder-pages { display: flex; align-items: center; justify-content: center; margin: 14px 0 4px 0; gap: 7px; }
        .page-dot { width: 16px; height: 8px; background: #e8d199; border-radius: 6px; opacity: 0.35; transition: all .2s; box-shadow: 0 2px 6px #9e9e8455; border: 1.2px solid #b6a26a; }
        .page-dot.active { background: #f1c672; opacity: 1; box-shadow: 0 0 0 2px #ffe7ad55, 0 4px 8px #e2b64944; border-color: #a2813b; }
        .folder-text { margin-top: 16px; color: #e6c175; font-size: 1.13rem; font-family: 'Noto Sans TC', 'Inter', Arial, sans-serif; letter-spacing: 2px; text-shadow: 0 2px 8px #9b782322; animation: fadeText 1.7s linear infinite alternate; min-height: 1.8em; }
        @keyframes fadeText { from { opacity: 0.6; letter-spacing: 1px; } to   { opacity: 1; letter-spacing: 4px;  } }
    </style>
</head>
<body class="overscroll-y-contain">
    <audio id="background-music" src="./PensivePiano.mp3" loop></audio>

    <div id="initial-loading-overlay">
      <div class="interrogation-loader">
        <div class="badge">
          <span class="badge-icon">ğŸ•µï¸â€â™‚ï¸</span>
          <span class="badge-text">POLICE</span>
        </div>
        <div class="loading-bar">
          <div class="loading-fill"></div>
        </div>
        <div class="interrogation-text" id="loading-animation-text">è­¦æ–¹æ­£åœ¨å¸ƒç½®åµè¨Šå®¤â€¦</div>
        <p class="text-sm text-gray-400 mt-1" id="initial-loading-message">éŠæˆ²åˆå§‹åŒ–ä¸­...</p>
      </div>
    </div>

    <div class="game-main-area container mx-auto" style="display: none;">
        <header class="mb-2 flex justify-between items-center">
            <span class="text-xs sm:text-sm text-gray-400 font-normal">
                å›åˆ: <span id="round-count-header">0</span>
            </span>
            <h1 class="text-xl sm:text-2xl font-bold text-blue-400 text-center flex-grow">
                å¯©å•æŒ‘æˆ°
            </h1>
            <span class="text-xs sm:text-sm text-gray-400 font-normal" title="Firebase ç”¨æˆ¶è­˜åˆ¥ç¢¼ (éƒ¨åˆ†é¡¯ç¤º)">
                 UID: <span id="user-id-display">è¼‰å…¥ä¸­...</span>
            </span>
        </header>

        <div class="flex gap-2 mb-2">
            <div id="avatar" class="w-20 h-20 sm:w-24 sm:h-24 rounded-md flex-shrink-0 flex flex-col items-center justify-center text-gray-300 text-xs p-0.5 text-center bg-gray-700 shadow">
                <img id="suspect-avatar-img" src="https://placehold.co/80x60/4A5568/E2E8F0?text=å«ŒçŠ¯" alt="å«ŒçŠ¯é ­åƒ" class="w-full h-3/4 object-cover rounded-t-sm" onerror="this.onerror=null; this.src='https://placehold.co/80x60/718096/E2E8F0?text=é ­åƒè¼‰å…¥å¤±æ•—';">
                <div id="suspect-name-display" class="w-full bg-black bg-opacity-70 text-white text-xs py-1 text-center truncate rounded-b-sm h-1/4 flex items-center justify-center">
                    <span id="suspect-status-name">è®€å–ä¸­...</span>
                </div>
            </div>
            <div id="suspect-status-card" class="flex-grow flex flex-col card">
                 <div id="suspect-status-details" class="grid grid-cols-2 gap-x-2 h-full">
                    <div class="flex flex-col justify-between">
                        <p>ğŸ—£ï¸<strong>é ‘æŠ—:</strong> <span id="confession-meter-text-card" class="confession-color-white">å¼·ç¡¬</span></p>
                        <p>ğŸ“ˆ<strong>å¿ƒç‡:</strong> <span id="heart-rate">--</span> bpm</p>
                        <p>ğŸ§<strong>è‚¢é«”:</strong> <span id="body-language" class="italic">è®€å–ä¸­...</span></p>
                    </div>
                    <div class="flex flex-col justify-between">
                        <p>ğŸ˜ <strong>è¡¨æƒ…:</strong> <span id="facial-expression" class="italic">è®€å–ä¸­...</span></p>
                        <p>ğŸ©¸<strong>è¡€å£“:</strong> <span id="blood-pressure">--/--</span></p>
                        <p>ğŸ—£ï¸<strong>èªæ°£:</strong> <span id="voice-tone" class="italic">è®€å–ä¸­...</span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-2">
            <button id="show-personal-details-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-md text-sm sm:text-base">ğŸ‘¤ å€‹äººè³‡æ–™</button>
            <button id="show-story-summary-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-3 rounded-md text-sm sm:text-base">ğŸ“œ æ¡ˆä»¶æ¦‚è¦</button>
        </div>

        <div id="dialogue-area" class="dialogue-area mb-2"></div>

        <div id="interrogation-tip-area" class="interrogation-tip">â€»è²¼å¿ƒæç¤ºï¼š åµè¨Šæç¤ºè¼‰å…¥ä¸­...</div>
        <div id="error-message-area"></div>
        <div class="mt-auto pt-2">
            <textarea id="player-input" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base" rows="2" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..."></textarea>
            <div class="mt-2 flex gap-1 sm:gap-2">
                <button class="tone-button tone-button-calm active rounded-md text-xs sm:text-sm" data-tone="å¹³ç·©">ğŸ˜Œ å¹³ç·©</button>
                <button class="tone-button tone-button-angry rounded-md ml-1 text-xs sm:text-sm" data-tone="æ†¤æ€’">ğŸ˜¡ æ†¤æ€’</button>
                <button class="tone-button tone-button-provocative rounded-md ml-1 text-xs sm:text-sm" data-tone="æŒ‘é‡">ğŸ˜ æŒ‘é‡</button>
            </div>
            <div class="mt-2 flex gap-2">
                <button id="send-button" class="flex-grow bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 text-sm sm:text-base">
                    ç™¼é€
                </button>
                <button id="demand-confession-button" class="w-1/4 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-md transition duration-150 text-xs sm:text-sm">
                    è¦æ±‚èªç½ª
                </button>
            </div>
        </div>
    </div>

    <div id="intro-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-300">ğŸ‰ æ­¡è¿ä¾†åˆ°å¯©å•æŒ‘æˆ° ğŸ‰</h3>
            <ul class="list-decimal list-inside mt-4 mb-6 space-y-2 text-sm text-gray-200">
                <li>æœ¬éŠæˆ²æ¯æ¬¡é–‹å±€éƒ½æ˜¯<strong class="text-yellow-300">å…¨æ–°åŠ‡æœ¬</strong>ï¼ŒæŒ‘æˆ°ç„¡é™ï¼</li>
                <li>é–‹å±€å¾Œè«‹å…ˆæŸ¥çœ‹<strong class="text-indigo-300">ã€æ¡ˆä»¶æ¦‚è¦ã€‘</strong>äº†è§£åµè¨Šé‡é»ã€‚</li>
                <li>åµè¨Šæ™‚å¯ä»¥ç”¨<strong class="text-green-300">ä¸‰ç¨®æ…‹åº¦</strong>èˆ‡å«ŒçŠ¯æ‡‰å°ã€‚</li>
                <li>æœ¬éŠæˆ²ä¸æ–·<strong class="text-pink-300">å„ªåŒ–ä¸­</strong>ï¼Œæ­¡è¿çµ¦äºˆå»ºè­°ï¼</li>
                <li>å¯©å•æˆåŠŸè®“å«ŒçŠ¯èªç½ªï¼Œæ­¡è¿<strong class="text-teal-300">åˆ†äº«æˆªåœ–</strong>ï¼</li>
            </ul>
            <button id="close-intro-modal-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">é–‹å§‹åµè¨Š</button>
        </div>
    </div>

    <div id="personal-details-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-300">ğŸ‘¤ å«ŒçŠ¯å€‹äººè³‡æ–™</h3>
            <div id="modal-personal-details-content" class="text-sm grid grid-cols-2 gap-x-4">
                <div>
                    <p><strong>å§“å:</strong> <span id="suspect-name-modal">è®€å–ä¸­...</span></p>
                    <p><strong>å¹´ç´€:</strong> <span id="age-modal">è®€å–ä¸­...</span></p>
                    <p><strong>æ€§åˆ¥:</strong> <span id="gender-modal">è®€å–ä¸­...</span></p>
                    <p><strong>ç”Ÿæ—¥:</strong> <span id="dob-modal">è®€å–ä¸­...</span></p>
                    <p><strong>æ˜Ÿåº§:</strong> <span id="zodiac-modal">è®€å–ä¸­...</span></p>
                    <p><strong>è¡€å‹:</strong> <span id="blood-type-modal">è®€å–ä¸­...</span></p>
                </div>
                <div>
                    <p><strong>å­¸æ­·:</strong> <span id="education-modal">è®€å–ä¸­...</span></p>
                    <p><strong>å‡ºç”Ÿåœ°:</strong> <span id="birthplace-modal">è®€å–ä¸­...</span></p>
                    <p><strong>è·æ¥­:</strong> <span id="occupation-modal">è®€å–ä¸­...</span></p>
                    <p><strong>å¥åº·ç‹€æ…‹:</strong> <span id="health-status-modal">è®€å–ä¸­...</span></p>
                    <p><strong>å£é ­ç¦ª:</strong> <span id="mannerism-modal">è®€å–ä¸­...</span></p>
                </div>
                <div class="personality-block mt-3 col-span-2">
                    <p class="font-semibold mb-1">ğŸ­ å€‹æ€§æ¦‚è¿°:</p>
                    <p id="personality-modal" class="text-sm">è®€å–ä¸­...</p>
                </div>
            </div>
            <button onclick="document.getElementById('personal-details-modal').classList.add('hidden')" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
        </div>
    </div>

    <div id="story-summary-modal" class="modal hidden">
        <div class="modal-content modal-lg">
            <h3 class="text-xl font-bold text-blue-300">ğŸ“œ æ¡ˆä»¶æ¦‚è¦</h3>
            <div id="modal-story-summary-content" class="story-summary-text">
                <div>
                    <p class="font-semibold">è¢«å®³äººé©—å±å ±å‘Š:</p>
                    <span id="autopsy-report-modal-content">è®€å–ä¸­...</span>
                </div>
                <hr class="story-summary-divider">
                <div>
                    <p class="font-semibold mt-2">å°å«ŒçŠ¯ä¸åˆ©çš„ç›®å‰è­‰æ“š:</p>
                    <ul id="evidence-list-modal-content" class="list-disc list-inside ml-4"><li>è®€å–ä¸­...</li></ul>
                </div>
                <hr class="story-summary-divider">
                <div>
                    <p class="font-semibold mt-2">å«ŒçŠ¯èª¿æŸ¥ç–‘é»:</p>
                    <ul id="doubts-list-modal-content" class="list-disc list-inside ml-4"><li>è®€å–ä¸­...</li></ul>
                </div>
            </div>
            <button onclick="document.getElementById('story-summary-modal').classList.add('hidden')" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
        </div>
    </div>

    <div id="keyword-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="keyword-modal-title" class="text-xl font-bold text-blue-300 mb-0">ğŸ”‘ é—œéµå­—è£œå……</h3>
            <div id="keyword-folder-loader" class="folder-loader hidden">
                <div class="folder-stack">
                  <div class="folder folder1"></div> <div class="folder folder2"></div> <div class="folder folder3"></div>
                </div>
                <div class="folder-pages" id="keyword-folder-pages-bar"></div>
                <div class="folder-text" id="keyword-folder-page-text">æ­£åœ¨å‘ˆä¸Šä¸­â€¦</div>
            </div>
            <p id="keyword-modal-text" class="mt-2">å…§å®¹AIåŠ è¼‰ä¸­è«‹ç¨å¾Œ...</p>
            <button onclick="document.getElementById('keyword-modal').classList.add('hidden')" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
        </div>
    </div>

    <div id="game-over-modal" class="modal hidden">
        <div class="modal-content text-center">
            <h3 id="game-over-title" class="text-2xl font-bold mb-4">âš–ï¸ å¯©å•çµæŸ</h3>
            <p>ç¸½å…±è€—è²»å›åˆæ•¸: <span id="total-rounds">0</span></p>
            <div id="game-analysis-container" class="mt-4 text-left">
                 <p id="game-analysis-text" class="text-sm whitespace-pre-wrap">åˆ†æä¸­...</p>
            </div>
            <div id="achievement-banner" class="achievement-banner hidden">
                ğŸ… <span id="achievement-title"></span>
            </div>
            <div class="mt-6 flex justify-center gap-4">
                 <button id="restart-game-button" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md">ğŸ”„ é‡æ–°é–‹å§‹</button>
                 <button id="close-game-over-modal-button" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="ai-thinking-modal" class="modal hidden">
        <div class="modal-content text-center">
            <div class="flex flex-col items-center justify-center min-h-[100px]">
                <p class="text-lg" id="ai-thinking-message">ğŸ¤– AIæ­£åœ¨åŠªåŠ›æ€è€ƒä¸­...</p>
                <p class="text-sm text-gray-400 mt-1">(å› å…§å®¹è±å¯ŒåŠ è¼‰å¾ˆä¹…å±¬æ­£å¸¸)</p>
                <p class="text-xs text-gray-500 mt-1">(å‰µä½œè€…é‚„åœ¨åŠªåŠ›å„ªåŒ–ä¸­)</p>
            </div>
            <div class="loading-spinner my-4"></div>
        </div>
    </div>

<script type="module">
    // Firebase SDK å°å…¥
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // DOM å…ƒç´ ç²å–
    const heartRateEl = document.getElementById('heart-rate');
    const bloodPressureEl = document.getElementById('blood-pressure');
    const facialExpressionEl = document.getElementById('facial-expression');
    const bodyLanguageEl = document.getElementById('body-language');
    const voiceToneEl = document.getElementById('voice-tone');
    const suspectStatusNameEl = document.getElementById('suspect-status-name');
    const suspectNameModalEl = document.getElementById('suspect-name-modal');
    const dobModalEl = document.getElementById('dob-modal');
    const zodiacModalEl = document.getElementById('zodiac-modal');
    const bloodTypeModalEl = document.getElementById('blood-type-modal');
    const ageModalEl = document.getElementById('age-modal');
    const genderModalEl = document.getElementById('gender-modal');
    const educationModalEl = document.getElementById('education-modal');
    const birthplaceModalEl = document.getElementById('birthplace-modal');
    const occupationModalEl = document.getElementById('occupation-modal');
    const healthStatusModalEl = document.getElementById('health-status-modal');
    const mannerismModalEl = document.getElementById('mannerism-modal');
    const personalityModalEl = document.getElementById('personality-modal');
    const autopsyReportModalContentEl = document.getElementById('autopsy-report-modal-content');
    const evidenceListModalContentEl = document.getElementById('evidence-list-modal-content');
    const doubtsListModalContentEl = document.getElementById('doubts-list-modal-content');
    const showPersonalDetailsButton = document.getElementById('show-personal-details-button');
    const showStorySummaryButton = document.getElementById('show-story-summary-button');
    const personalDetailsModal = document.getElementById('personal-details-modal');
    const storySummaryModal = document.getElementById('story-summary-modal');
    const dialogueAreaEl = document.getElementById('dialogue-area');
    const playerInputEl = document.getElementById('player-input');
    const sendButton = document.getElementById('send-button');
    const demandConfessionButton = document.getElementById('demand-confession-button');
    const toneButtons = document.querySelectorAll('.tone-button');
    const userIdDisplayEl = document.getElementById('user-id-display');
    const keywordModal = document.getElementById('keyword-modal');
    const keywordModalTitle = document.getElementById('keyword-modal-title');
    const keywordModalText = document.getElementById('keyword-modal-text');
    const keywordFolderLoaderEl = document.getElementById('keyword-folder-loader');
    const keywordFolderPagesBarEl = document.getElementById('keyword-folder-pages-bar');
    const keywordFolderPageTextEl = document.getElementById('keyword-folder-page-text');
    let keywordPageTimer = null;
    const gameOverModal = document.getElementById('game-over-modal');
    const gameOverTitle = document.getElementById('game-over-title');
    const totalRoundsEl = document.getElementById('total-rounds');
    const gameAnalysisContainerEl = document.getElementById('game-analysis-container');
    const gameAnalysisTextEl = document.getElementById('game-analysis-text');
    const achievementBannerEl = document.getElementById('achievement-banner');
    const achievementTitleEl = document.getElementById('achievement-title');
    const restartGameButton = document.getElementById('restart-game-button');
    const closeGameOverModalButton = document.getElementById('close-game-over-modal-button');
    const aiThinkingModal = document.getElementById('ai-thinking-modal');
    const aiThinkingMessageEl = document.getElementById('ai-thinking-message');
    const interrogationTipAreaEl = document.getElementById('interrogation-tip-area');
    const roundCountHeaderEl = document.getElementById('round-count-header');
    const confessionMeterTextCardEl = document.getElementById('confession-meter-text-card');
    const introModal = document.getElementById('intro-modal');
    const closeIntroModalButton = document.getElementById('close-intro-modal-button');
    const initialLoadingOverlay = document.getElementById('initial-loading-overlay');
    const initialLoadingMessageEl = document.getElementById('initial-loading-message');
    const loadingAnimationTextEl = document.getElementById('loading-animation-text');
    const gameMainAreaEl = document.querySelector('.game-main-area');
    const backgroundMusicEl = document.getElementById('background-music');
    const errorMessageAreaEl = document.getElementById('error-message-area');

    // --- é…ç½®å€åŸŸ ---
    // å¾Œç«¯ API ç¶²å€ (å·²æ ¹æ“šæ‚¨æä¾›çš„ Replit ç¶²å€æ›´æ–°)
    const BACKEND_URL = 'https://d1d5ef45-d04b-4a1c-be4b-64a0680c6847-00-xxpggv06ka2e.sisko.replit.dev/';

    // Firebase è¨­å®š (å·²æ ¹æ“šæ‚¨æä¾›çš„é‡‘é‘°æ›´æ–°)
    const firebaseConfig = typeof __firebase_config !== 'undefined'
        ? JSON.parse(__firebase_config) // ä¸»è¦ç”¨æ–¼ Canvas ç’°å¢ƒ
        : { // ç”¨æ–¼ GitHub Pages æˆ–å…¶ä»–ç¨ç«‹éƒ¨ç½²ç’°å¢ƒ
            apiKey: "AIzaSyCACjjC1S-9gj6hKCyfAedzH9kTf_JZwDE",
            authDomain: "aigame-fb578.firebaseapp.com",
            projectId: "aigame-fb578",
            storageBucket: "aigame-fb578.appspot.com", // é€šå¸¸æ˜¯ .appspot.com
            messagingSenderId: "932095431807",
            appId: "1:932095431807:web:28aab493c770166102db4a"
          };
    // --- é…ç½®å€åŸŸçµæŸ ---

    // åˆå§‹åŒ– Firebase App å’Œ Auth
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // å…¨åŸŸè®Šæ•¸
    let userId = null;
    let currentGameId = null;
    let gameState = {};
    let initialLoadingTipInterval = null;
    let isMusicPlaying = false;

    // --- è¼”åŠ©å‡½æ•¸ ---
    function showThinkingModal(message = 'AIæ­£åœ¨åŠªåŠ›æ€è€ƒä¸­...') {
        if (aiThinkingModal && aiThinkingMessageEl) {
            aiThinkingMessageEl.textContent = `ğŸ¤– ${message}`;
            aiThinkingModal.classList.remove('hidden');
        }
    }

    function hideThinkingModal() {
        if (aiThinkingModal) aiThinkingModal.classList.add('hidden');
    }

    function getConfessionMeterTextAndColor(percentage) {
        if (percentage > 80) return { text: "æ…‹åº¦å¼·ç¡¬", colorClass: "confession-color-white" };
        if (percentage > 60) return { text: "æ•…ä½œé®å®š", colorClass: "confession-color-green" };
        if (percentage > 40) return { text: "ç•¥é¡¯å‹•æ–", colorClass: "confession-color-blue" };
        if (percentage > 20) return { text: "å¿ƒè™›æ…Œäº‚", colorClass: "confession-color-pink" };
        if (percentage > 0) return { text: "ç€•è‡¨å´©æ½°", colorClass: "confession-color-red" };
        return { text: "å·²ç„¶èªç½ª", colorClass: "confession-color-purple" };
    }

    function showErrorMessage(message) {
        if (errorMessageAreaEl) {
            errorMessageAreaEl.textContent = `âš ï¸ éŒ¯èª¤ï¼š${message}`;
            errorMessageAreaEl.style.display = 'block';
        }
        console.error("éŒ¯èª¤è¨Šæ¯é¡¯ç¤º:", message);
    }

    function clearErrorMessage() {
        if (errorMessageAreaEl) {
            errorMessageAreaEl.textContent = '';
            errorMessageAreaEl.style.display = 'none';
        }
    }

    function playBackgroundMusic() {
        if (backgroundMusicEl && backgroundMusicEl.paused && !isMusicPlaying) {
            backgroundMusicEl.loop = true;
            backgroundMusicEl.play()
                .then(() => {
                    isMusicPlaying = true;
                    console.log("èƒŒæ™¯éŸ³æ¨‚é–‹å§‹æ’­æ”¾ã€‚");
                })
                .catch(error => {
                    console.warn("èƒŒæ™¯éŸ³æ¨‚è‡ªå‹•æ’­æ”¾å¤±æ•—ã€‚", error);
                });
        }
    }

    // --- Firebase èªè­‰ ---
    async function initializeFirebaseAndUser() {
        return new Promise(async (resolve, reject) => {
            try {
                await setPersistence(auth, browserLocalPersistence);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("å˜—è©¦ä½¿ç”¨è‡ªè¨‚ä»¤ç‰Œç™»å…¥ (Canvas ç’°å¢ƒ)ã€‚");
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    console.log("ç„¡è‡ªè¨‚ä»¤ç‰Œï¼Œå˜—è©¦åŒ¿åç™»å…¥ã€‚");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase èªè­‰éŒ¯èª¤:", error);
                if (!auth.currentUser) {
                    try {
                        console.warn("ç”±æ–¼å…ˆå‰çš„èªè­‰éŒ¯èª¤ï¼Œå›é€€åˆ°åŒ¿åç™»å…¥ã€‚");
                        await signInAnonymously(auth);
                    } catch (anonError) {
                        console.error("åš´é‡éŒ¯èª¤ï¼šåŒ¿åç™»å…¥ä¹Ÿå¤±æ•—:", anonError);
                        if (userIdDisplayEl) userIdDisplayEl.textContent = "èªè­‰å¤±æ•—";
                        showErrorMessage("Firebase èªè­‰å¤±æ•—ï¼Œéƒ¨åˆ†ç”¨æˆ¶ç›¸é—œåŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨ã€‚");
                        return reject("Firebase Auth failed");
                    }
                }
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    if (userIdDisplayEl) userIdDisplayEl.textContent = userId.substring(0, 8) + "...";
                    console.log("ä½¿ç”¨è€…å·²èªè­‰ã€‚UID:", userId);
                } else {
                    userId = `local_user_${crypto.randomUUID().substring(0,8)}`;
                    if (userIdDisplayEl) userIdDisplayEl.textContent = "æœ¬æ©Ÿç”¨æˆ¶";
                    console.warn("ç„¡å·²èªè­‰ä½¿ç”¨è€… (å¯èƒ½åŒ¿åç™»å…¥å¤±æ•—æˆ–æœªåŸ·è¡Œ)ã€‚");
                }
                resolve(userId);
            });
        });
    }

    // --- éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---
    async function loadOrCreateNewGame() {
        clearErrorMessage();
        if (initialLoadingOverlay) initialLoadingOverlay.style.display = 'flex';
        if (gameMainAreaEl) gameMainAreaEl.style.display = 'none';
        if (initialLoadingMessageEl) initialLoadingMessageEl.textContent = "é€£æ¥ä¼ºæœå™¨ä¸¦å‰µå»ºæ–°éŠæˆ²";
        startInitialLoadingAnimation();

        try {
            // æª¢æŸ¥ BACKEND_URL æ˜¯å¦ç‚ºé è¨­ä½”ä½ç¬¦æˆ–æ ¼å¼ä¸æ­£ç¢º
            if (BACKEND_URL === 'YOUR_REPLIT_BACKEND_URL' || !BACKEND_URL.startsWith('https://')) {
                 // æ­¤è™•çš„ BACKEND_URL å·²è¢«æ›¿æ›ï¼Œæ‰€ä»¥é€™å€‹æª¢æŸ¥ç†è«–ä¸Šä¸æœƒè§¸ç™¼ï¼Œä½†ä¿ç•™ä»¥é˜²è¬ä¸€
                throw new Error("å¾Œç«¯ API ç¶²å€ (BACKEND_URL) å°šæœªæ­£ç¢ºè¨­å®šã€‚");
            }
             // æª¢æŸ¥ Firebase è¨­å®šæ˜¯å¦ä»ç‚ºä½”ä½ç¬¦ (å¯é¸ï¼Œå› ç‚ºç”¨æˆ¶å·²æä¾›)
            if (firebaseConfig.apiKey === "AIzaSyCACjjC1S-9gj6hKCyfAedzH9kTf_JZwDE" && firebaseConfig.projectId === "aigame-fb578") {
                 console.log("Firebase è¨­å®šå·²æ›´æ–°ã€‚");
            } else if (firebaseConfig.apiKey.startsWith("YOUR_REAL_FIREBASE")) {
                 console.warn("Firebase è¨­å®šä¼¼ä¹ä»ç‚ºä½”ä½ç¬¦ï¼Œè«‹ç¢ºèªå·²å¡«å…¥çœŸå¯¦é‡‘é‘°ã€‚");
            }


            const userAuthId = await initializeFirebaseAndUser();

            const response = await fetch(`${BACKEND_URL}game/new`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userAuthId })
            });

            if (!response.ok) {
                let errorText = `ä¼ºæœå™¨éŒ¯èª¤: ${response.status} ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    errorText = errorData.error || errorText;
                } catch (e) { /* è§£æ JSON å¤±æ•—ï¼Œä½¿ç”¨åŸå§‹éŒ¯èª¤æ–‡å­— */ }
                throw new Error(errorText);
            }
            gameState = await response.json();
            currentGameId = gameState.gameId;

            if (initialLoadingMessageEl) initialLoadingMessageEl.textContent = "éŠæˆ²è³‡æ–™è¼‰å…¥å®Œæˆï¼";
            updateUI(gameState);

            if (initialLoadingOverlay) initialLoadingOverlay.style.display = 'none';
            stopInitialLoadingAnimation();
            if (gameMainAreaEl) gameMainAreaEl.style.display = 'flex';
            if (introModal) introModal.classList.remove('hidden');
            playBackgroundMusic();

        } catch (error) {
            console.error("å‰µå»ºæ–°éŠæˆ²å¤±æ•—:", error);
            const friendlyErrorMessage = `å‰µå»ºæ–°éŠæˆ²å¤±æ•—ï¼š${error.message} è«‹æª¢æŸ¥å¾Œç«¯ä¼ºæœå™¨ (${BACKEND_URL}) æ˜¯å¦æ­£åœ¨é‹è¡Œï¼Œä¸¦ä¸”ç¶²è·¯é€£ç·šæ­£å¸¸ã€‚`;
            if (initialLoadingMessageEl) initialLoadingMessageEl.textContent = friendlyErrorMessage;
            showErrorMessage(friendlyErrorMessage);
            stopInitialLoadingAnimation();
        }
    }

    function updateUI(state) {
        if (!state) {
            console.warn("updateUI è¢«èª¿ç”¨æ™‚ state ç‚ºç©ºã€‚");
            showErrorMessage("ç„¡æ³•æ›´æ–°éŠæˆ²ç•Œé¢ï¼šç„¡æ•ˆçš„éŠæˆ²ç‹€æ…‹ã€‚");
            return;
        }
        gameState = state;

        if (roundCountHeaderEl) roundCountHeaderEl.textContent = state.round ?? '0';

        const meterInfo = getConfessionMeterTextAndColor(state.confessionMeter ?? 100);
        if (confessionMeterTextCardEl) {
            confessionMeterTextCardEl.textContent = meterInfo.text;
            confessionMeterTextCardEl.className = 'confession-color-white';
            confessionMeterTextCardEl.classList.add(meterInfo.colorClass);
        }

        if (state.suspect) {
            const suspect = state.suspect;
            if(suspectStatusNameEl) suspectStatusNameEl.textContent = suspect.name ?? "è®€å–ä¸­...";
            if(heartRateEl) heartRateEl.textContent = suspect.heartRate ?? "--";
            if(bloodPressureEl) bloodPressureEl.textContent = suspect.bloodPressure ?? "--/--";
            if(facialExpressionEl) facialExpressionEl.textContent = suspect.facialExpression ?? "è®€å–ä¸­...";
            if(bodyLanguageEl) bodyLanguageEl.textContent = suspect.bodyLanguage ?? "è®€å–ä¸­...";
            if(voiceToneEl) voiceToneEl.textContent = suspect.voiceTone ?? "è®€å–ä¸­...";

            if(suspectNameModalEl) suspectNameModalEl.textContent = suspect.name ?? "N/A";
            if(ageModalEl) ageModalEl.textContent = suspect.age ?? "N/A";
            if(genderModalEl) genderModalEl.textContent = suspect.gender ?? "N/A";
            if(dobModalEl) dobModalEl.textContent = suspect.dob ?? "N/A";
            if(zodiacModalEl) zodiacModalEl.textContent = suspect.zodiac ?? "N/A";
            if(bloodTypeModalEl) bloodTypeModalEl.textContent = suspect.bloodType ?? "N/A";
            if(educationModalEl) educationModalEl.textContent = suspect.education ?? "N/A";
            if(birthplaceModalEl) birthplaceModalEl.textContent = suspect.birthplace ?? "N/A";
            if(occupationModalEl) occupationModalEl.textContent = suspect.occupation ?? "N/A";
            if(healthStatusModalEl) healthStatusModalEl.textContent = suspect.healthStatus ?? "N/A";
            if(mannerismModalEl) mannerismModalEl.textContent = suspect.mannerism ?? "ç„¡";
            if(personalityModalEl) personalityModalEl.textContent = suspect.personality ?? "è®€å–ä¸­...";
        }

        if (state.caseDetails) {
            const caseDetails = state.caseDetails;
            const processKeywords = (text) => (text ?? "è®€å–ä¸­...").replace(/##(.*?)##/g, '<span class="case-keyword" data-keyword="$1">$1</span>').replace(/\n/g, "<br>");

            if(autopsyReportModalContentEl) autopsyReportModalContentEl.innerHTML = processKeywords(caseDetails.autopsyReport);
            if(evidenceListModalContentEl) evidenceListModalContentEl.innerHTML = (caseDetails.evidence ?? []).map(e => `<li data-id="${e.id}">${processKeywords(e.text)}</li>`).join('');
            if(doubtsListModalContentEl) doubtsListModalContentEl.innerHTML = (caseDetails.doubts ?? []).map(d => `<li data-id="${d.id}">${processKeywords(d.text)}</li>`).join('');
        }

        if (dialogueAreaEl) dialogueAreaEl.innerHTML = '';
        if (state.dialogueHistory && Array.isArray(state.dialogueHistory)) {
            state.dialogueHistory.forEach(msg => addMessageToDialogue(msg.speaker, msg.text, msg.tone));
        }

        if (interrogationTipAreaEl && state.interrogationTip) {
            interrogationTipAreaEl.textContent = "â€»è²¼å¿ƒæç¤ºï¼š " + state.interrogationTip;
        }

        document.querySelectorAll('.case-keyword, .keyword').forEach(el => {
            el.onclick = () => {
                const keyword = el.dataset.keyword;
                if (keywordModalTitle) keywordModalTitle.textContent = `ğŸ”‘ é—œæ–¼ã€Œ${keyword}ã€`;
                fetchKeywordInfo(keyword);
                if (keywordModal) keywordModal.classList.remove('hidden');
            };
        });

        if (state.gameOver) {
            if(gameOverTitle) gameOverTitle.textContent = (state.confessionMeter != null && state.confessionMeter <= 0) ? "âš–ï¸ å¯©å•æˆåŠŸï¼" : "âš–ï¸ å¯©å•å¤±æ•—ï¼";
            if(totalRoundsEl) totalRoundsEl.textContent = state.round ?? '0';

            if(gameAnalysisContainerEl && typeof state.gameAnalysis === 'object' && state.gameAnalysis.interrogationStyle) {
                gameAnalysisContainerEl.innerHTML = `
                    <p class="analysis-section-title">1. åµè¨Šå“¡å¯©å•é¢¨æ ¼åˆ†æ:</p>
                    <p class="analysis-section-content">${state.gameAnalysis.interrogationStyle}</p>
                    <p class="analysis-section-title">2. èˆ‡å«ŒçŠ¯é¬¥æ™ºéç¨‹æŠ€å·§åˆ†æ:</p>
                    <p class="analysis-section-content">${state.gameAnalysis.techniqueAnalysis}</p>
                    <p class="analysis-section-title">3. åˆ†æç©å®¶åœ¨ç¾å¯¦ä¸–ç•Œæ½›åœ¨äººæ ¼ç‰¹è³ª:</p>
                    <p class="analysis-section-content">${state.gameAnalysis.playerPersonalityTrait}</p>
                `;
                if(achievementBannerEl && achievementTitleEl && state.gameAnalysis.achievementTitle){
                    achievementTitleEl.textContent = state.gameAnalysis.achievementTitle;
                    achievementBannerEl.classList.remove('hidden');
                } else if (achievementBannerEl) {
                    achievementBannerEl.classList.add('hidden');
                }
            } else if (gameAnalysisTextEl) {
                gameAnalysisTextEl.textContent = typeof state.gameAnalysis === 'string' ? state.gameAnalysis : "åˆ†æç”Ÿæˆå¤±æ•—æˆ–æ ¼å¼ä¸ç¬¦ã€‚";
                 if(achievementBannerEl) achievementBannerEl.classList.add('hidden');
            }
            if(gameOverModal) gameOverModal.classList.remove('hidden');
        } else {
            if(gameOverModal) gameOverModal.classList.add('hidden');
        }
    }

    function addMessageToDialogue(speaker, text, tone = null) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('dialogue-bubble');
        let messageContent = text ?? "";

        if (speaker === 'Player') {
            messageDiv.classList.add('player-bubble');
            const displayTone = tone || gameState.selectedTone || "æœªçŸ¥";
            messageContent = `(èªæ°£ï¼š${displayTone}) ${messageContent}`;
            switch (displayTone) {
                case 'å¹³ç·©': messageDiv.classList.add('player-bubble-calm'); break;
                case 'æ†¤æ€’': messageDiv.classList.add('player-bubble-angry'); break;
                case 'æŒ‘é‡': messageDiv.classList.add('player-bubble-provocative'); break;
            }
        } else if (speaker === 'è­¦å®˜') {
            messageDiv.classList.add('officer-bubble');
            messageContent = `<strong>è­¦å®˜ï¼š</strong> ${messageContent}`;
        } else {
            messageDiv.classList.add('ai-bubble');
        }

        const processedText = messageContent.replace(/@@(.*?)@@/g, '<span class="keyword" data-keyword="$1">$1</span>');
        messageDiv.innerHTML = processedText;

        if (dialogueAreaEl) {
            dialogueAreaEl.appendChild(messageDiv);
            dialogueAreaEl.scrollTop = dialogueAreaEl.scrollHeight;
        }

        messageDiv.querySelectorAll('.keyword').forEach(el => {
            el.onclick = () => {
                const keyword = el.dataset.keyword;
                if (keywordModalTitle) keywordModalTitle.textContent = `ğŸ”‘ é—œæ–¼ã€Œ${keyword}ã€`;
                fetchKeywordInfo(keyword);
                if (keywordModal) keywordModal.classList.remove('hidden');
            };
        });
    }

    async function fetchKeywordInfo(keyword) {
        if (!currentGameId) {
            console.error("éŠæˆ² ID æœªè¨­å®šï¼Œç„¡æ³•ç²å–é—œéµå­—è³‡è¨Šã€‚");
            if(keywordModalText) keywordModalText.textContent = "éŒ¯èª¤ï¼šéŠæˆ²æœªåˆå§‹åŒ–ã€‚";
            return;
        }
        clearErrorMessage();

        if(keywordModalText) keywordModalText.style.display = 'none';
        if(keywordFolderLoaderEl) keywordFolderLoaderEl.classList.remove('hidden');

        const totalPages = 4; let currentPage = 0;
        if(keywordFolderPagesBarEl) keywordFolderPagesBarEl.innerHTML = '';
        function renderKeywordPagesBar() { let html = ''; for (let i = 0; i < totalPages; i++) { html += `<div class="page-dot${i === currentPage ? ' active' : ''}"></div>`; } if(keywordFolderPagesBarEl) keywordFolderPagesBarEl.innerHTML = html; }
        function updateKeywordPage() { currentPage = (currentPage + 1) % totalPages; renderKeywordPagesBar(); if(keywordFolderPageTextEl) keywordFolderPageTextEl.textContent = `ç¬¬ ${currentPage + 1} / ${totalPages} é ï¼Œæ­£åœ¨å‘ˆä¸Šä¸­â€¦`; }
        renderKeywordPagesBar(); if(keywordFolderPageTextEl) keywordFolderPageTextEl.textContent = `ç¬¬ 1 / ${totalPages} é ï¼Œæ­£åœ¨å‘ˆä¸Šä¸­â€¦`;
        if (keywordPageTimer) clearInterval(keywordPageTimer);
        keywordPageTimer = setInterval(updateKeywordPage, 700);

        try {
            const response = await fetch(`${BACKEND_URL}game/${currentGameId}/keyword?keyword=${encodeURIComponent(keyword)}`);
            if (!response.ok) {
                let errorText = `ä¼ºæœå™¨éŒ¯èª¤: ${response.status} ${response.statusText}`;
                try { const errorData = await response.json(); errorText = errorData.error || errorText; } catch (e) { /* ignore */ }
                throw new Error(errorText);
            }
            const data = await response.json();
            if(keywordModalText) keywordModalText.textContent = data.information || `é—œæ–¼ã€Œ${keyword}ã€çš„è³‡è¨Šç›®å‰ç„¡æ³•å–å¾—ã€‚`;
        } catch (error) {
            console.error(`ç²å–é—œéµå­— "${keyword}" è³‡è¨Šå¤±æ•—:`, error);
            const friendlyErrorMessage = `ç„¡æ³•è¼‰å…¥é—œæ–¼ã€Œ${keyword}ã€çš„è³‡è¨Šï¼š${error.message}`;
            if(keywordModalText) keywordModalText.textContent = friendlyErrorMessage;
            showErrorMessage(friendlyErrorMessage);
        } finally {
            if (keywordPageTimer) clearInterval(keywordPageTimer);
            if(keywordFolderLoaderEl) keywordFolderLoaderEl.classList.add('hidden');
            if(keywordModalText) keywordModalText.style.display = 'block';
        }
    }

    async function handlePlayerTurn(isDemandConfession = false) {
        if (!currentGameId) {
            console.error("éŠæˆ² ID æœªè¨­å®šï¼Œç„¡æ³•åŸ·è¡Œç©å®¶å‹•ä½œã€‚");
            showErrorMessage("éŒ¯èª¤ï¼šéŠæˆ²æœªæ­£ç¢ºåˆå§‹åŒ–ï¼Œè«‹é‡æ–°è¼‰å…¥ã€‚");
            return;
        }
        clearErrorMessage();

        const playerMessage = playerInputEl.value.trim();
        if (!isDemandConfession && !playerMessage) return;

        sendButton.disabled = true;
        demandConfessionButton.disabled = true;
        const originalSendButtonText = sendButton.innerHTML;
        const originalDemandButtonText = demandConfessionButton.textContent;

        if (isDemandConfession) {
            demandConfessionButton.innerHTML = '<div class="loading-spinner !w-4 !h-4 border-t-white mx-auto"></div>';
        } else {
            sendButton.innerHTML = '<div class="loading-spinner !w-5 !h-5 border-t-white"></div>';
        }
        showThinkingModal(isDemandConfession ? 'æ­£åœ¨è¦æ±‚å°æ–¹èªç½ª...' : 'AIæ­£åœ¨åˆ†ææ‚¨çš„è¼¸å…¥...');

        const currentTone = gameState.selectedTone || "å¹³ç·©";
        const payload = {
            message: isDemandConfession ? "" : playerMessage,
            tone: isDemandConfession ? "æ†¤æ€’" : currentTone,
            isDemandConfession: isDemandConfession
        };

        try {
            const response = await fetch(`${BACKEND_URL}game/${currentGameId}/action`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                let errorText = `ä¼ºæœå™¨éŒ¯èª¤: ${response.status} ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    errorText = errorData.error || errorText;
                    if (errorData.gameState && errorData.error === "éŠæˆ²å·²çµæŸ") {
                        console.warn("å˜—è©¦åœ¨å·²çµæŸçš„éŠæˆ²ä¸­åŸ·è¡Œå‹•ä½œã€‚");
                        updateUI(errorData.gameState);
                        return;
                    }
                } catch (e) { /* ignore */ }
                throw new Error(errorText);
            }
            const updatedGameState = await response.json();
            updateUI(updatedGameState);
            if (!isDemandConfession) playerInputEl.value = '';
        } catch (error) {
            console.error("ç©å®¶å›åˆè™•ç†å¤±æ•—:", error);
            showErrorMessage(`æ“ä½œå¤±æ•—: ${error.message}`);
        } finally {
            hideThinkingModal();
            sendButton.disabled = false;
            demandConfessionButton.disabled = false;
            sendButton.innerHTML = originalSendButtonText;
            demandConfessionButton.textContent = originalDemandButtonText;
        }
    }

    function restartGame() {
        if(gameOverModal) gameOverModal.classList.add('hidden');
        loadOrCreateNewGame();
    }

    const initialLoadingTips = [
        "è­¦æ–¹æ­£åœ¨å¸ƒç½®åµè¨Šå®¤â€¦", "æª¢æŸ¥éŒ„éŸ³èˆ‡ç›£æ§è¨­å‚™ä¸­â€¦", "æ¡ˆä»¶è³‡æ–™èª¿é–±ä¸­ï¼Œè«‹ç¨å€™â€¦",
        "å°‡å«ŒçŠ¯å¸¶å¾€åµè¨Šå®¤â€¦", "æº–å‚™èª¿æŸ¥è­‰æ“šä¸­â€¦", "æª¢æŸ¥ç­†éŒ„èˆ‡ç›¸é—œå·å®—â€¦",
        "é–‹å•Ÿç¾å ´æ”å½±æ©Ÿèˆ‡éº¥å…‹é¢¨â€¦", "å®‰æ’è§€å¯Ÿäººå“¡é€²å…¥æš—æˆ¿â€¦", "æ¡ˆç™¼ç¾å ´è³‡æ–™åŒæ­¥ä¸­â€¦",
        "æª¢æŸ¥å«ŒçŠ¯å¿ƒç†ç‹€æ…‹â€¦", "å¯©æ ¸è­‰ä¾›æ¸…å–®èˆ‡ç­†éŒ„â€¦", "åµè¨Šå°ˆå®¶å³å°‡é€²å…¥ç¾å ´â€¦",
        "è­¦å®˜æ­£åœ¨ç©¿æˆ´é˜²è­·è£å‚™â€¦", "æº–å‚™å¯©å•ç­–ç•¥èˆ‡å°ç­–â€¦", "æ¡ˆä»¶è³‡æ–™åŠ å¯†å‚³è¼¸ä¸­â€¦"
    ];
    let lastTipIdx = 0;

    function startInitialLoadingAnimation() {
        if (!loadingAnimationTextEl) return;
        loadingAnimationTextEl.textContent = initialLoadingTips[0];
        if (initialLoadingTipInterval) clearInterval(initialLoadingTipInterval);
        initialLoadingTipInterval = setInterval(() => {
            let idx;
            do { idx = Math.floor(Math.random() * initialLoadingTips.length); } while (idx === lastTipIdx);
            lastTipIdx = idx;
            loadingAnimationTextEl.style.opacity = 0;
            setTimeout(() => {
                loadingAnimationTextEl.textContent = initialLoadingTips[idx];
                loadingAnimationTextEl.style.opacity = 1;
            }, 400);
        }, 3000);
    }

    function stopInitialLoadingAnimation() {
        if (initialLoadingTipInterval) clearInterval(initialLoadingTipInterval);
        initialLoadingTipInterval = null;
    }

    // --- äº‹ä»¶ç›£è½å™¨ ---
    if (closeIntroModalButton) {
        closeIntroModalButton.addEventListener('click', () => {
            if (introModal) introModal.classList.add('hidden');
            playBackgroundMusic();
        });
    }
    if (sendButton) sendButton.addEventListener('click', () => handlePlayerTurn(false));
    if (demandConfessionButton) demandConfessionButton.addEventListener('click', () => handlePlayerTurn(true));
    if (closeGameOverModalButton) {
        closeGameOverModalButton.addEventListener('click', () => {
            if (gameOverModal) gameOverModal.classList.add('hidden');
        });
    }
    if (playerInputEl) {
        playerInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handlePlayerTurn(false);
            }
        });
    }
    toneButtons.forEach(button => {
        button.addEventListener('click', () => {
            toneButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            if (gameState) gameState.selectedTone = button.dataset.tone;
        });
    });
    if (showPersonalDetailsButton) showPersonalDetailsButton.addEventListener('click', () => personalDetailsModal.classList.remove('hidden'));
    if (showStorySummaryButton) showStorySummaryButton.addEventListener('click', () => storySummaryModal.classList.remove('hidden'));
    if (restartGameButton) restartGameButton.addEventListener('click', restartGame);

    // --- é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ ---
    window.addEventListener('load', () => {
        loadOrCreateNewGame();
    });

</script>
</body>
</html>
